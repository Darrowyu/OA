<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makriteç”³è¯·ä¹¦ç®¡ç†ç³»ç»Ÿ</title>

    <!-- æ·»åŠ ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMjU2M0VCIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9ImZlYXRoZXIgZmVhdGhlci1jbGlwYm9hcmQiPjxwYXRoIGQ9Ik0xNiA0aDJhMiAyIDAgMCAxIDIgMnYxNGEyIDIgMCAwIDEtMiAySDZhMiAyIDAgMCAxLTItMlY2YTIgMiAwIDAgMSAyLTJoMiI+PC9wYXRoPjxyZWN0IHg9IjgiIHk9IjIiIHdpZHRoPSI4IiBoZWlnaHQ9IjQiIHJ4PSIxIiByeT0iMSI+PC9yZWN0PjxsaW5lIHgxPSI5IiB5MT0iOS4xMDQiIHgyPSIxNSIgeTI9IjkuMTA0Ij48L2xpbmU+PGxpbmUgeDE9IjkiIHkxPSIxMiIgeDI9IjEyIiB5Mj0iMTIiPjwvbGluZT48bGluZSB4MT0iOSIgeTE9IjE1IiB4Mj0iMTUiIHkyPSIxNSI+PC9saW5lPjwvc3ZnPg==">

    <!-- ç›´æ¥åŠ è½½æœ¬åœ°Tailwind CSS -->
    <script src="js/libs/tailwindcss.js"></script>

    <!-- åŠ è½½ç”¨æˆ·ç®¡ç†é¡µé¢æ ·å¼ -->
    <link rel="stylesheet" href="css/user-management.css">

    <!-- åŠ è½½å“åº”å¼æ¨¡æ€æ¡†æ ·å¼ -->
    <link rel="stylesheet" href="css/responsive-modal.css">

    <!-- åŠ è½½ç½‘ç»œè¯Šæ–­å·¥å…· -->
    <script src="js/network-diagnostics.js"></script>

    <!-- åŠ è½½å¢å¼ºçš„APIè¯·æ±‚å·¥å…· -->
    <script src="js/api.js"></script>

    <!-- æ·»åŠ å…³é”®CSSå†…è” -->
    <style>
        /* å…³é”®æ¸²æŸ“è·¯å¾„CSS */
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
            color: #111827;
        }
        #loginPage {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .hidden {
            display: none !important;
        }
        /* æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
        .modal-container {
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            flex-shrink: 0;
        }

        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .modal-footer {
            flex-shrink: 0;
        }

        /* è¯¦æƒ…æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸæ ·å¼ */
        #detailModal .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        /* é˜²æ­¢æ¨¡æ€æ¡†å†…å®¹è¿‡é•¿å¯¼è‡´é¡µé¢æ»šåŠ¨ */
        body.modal-open {
            overflow: hidden;
        }

        /* æ¨¡æ€æ¡†å“åº”å¼è°ƒæ•´ */
        @media (max-width: 640px) {
            #detailModal .relative {
                margin: 0.5rem;
                width: calc(100% - 1rem);
                max-height: 95vh;
            }

            #detailModal .p-4 {
                padding: 0.75rem;
            }

            #detailModal .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            #detailModal .text-2xl {
                font-size: 1.25rem;
                line-height: 1.75rem;
            }
        }
    </style>

    <!-- å»¶è¿ŸåŠ è½½éå…³é”®CSSå’ŒJS -->
    <script>
        // æ–‡ä»¶ä¸Šä¼ ç¡®è®¤å¯¹è¯æ¡†
        function showFileUploadConfirmation(callback) {
            const confirmed = confirm('è¯·ç¡®è®¤æ‚¨ä¸Šä¼ çš„é™„ä»¶æ–‡æ¡£åç§°ç¬¦åˆè§„èŒƒï¼Œé¿å…ç”³è¯·ä¸é€šè¿‡ã€‚\n\nå‘½åç¤ºä¾‹ï¼š"20250101çŸ¥è…¾xxxæŠ¥ä»·å•"\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ä¸Šä¼ ï¼Œç‚¹å‡»"å–æ¶ˆ"é‡æ–°é€‰æ‹©æ–‡ä»¶ã€‚');
            if (confirmed && callback) {
                callback();
            }
            return confirmed;
        }

        // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
        document.addEventListener('DOMContentLoaded', function() {
            // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loadingIndicator';
            loadingIndicator.innerHTML = `
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</p>
            `;
            document.body.appendChild(loadingIndicator);

            // å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº
            setTimeout(function() {
                // Tailwind CSS å·²åœ¨å¤´éƒ¨ç›´æ¥åŠ è½½ï¼Œæ— éœ€å†æ¬¡åŠ è½½

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                document.getElementById('loadingIndicator').style.display = 'none';

                // å»¶è¿ŸåŠ è½½å…¶ä»–JSåº“
                setTimeout(function() {
                    // ä»…åœ¨éœ€è¦æ—¶åŠ è½½html2canvaså’ŒjsPDF
                    window.loadPdfLibraries = function() {
                        return new Promise((resolve) => {
                            if (window.html2canvas && window.jspdf) {
                                resolve();
                                return;
                            }

                            const html2canvasScript = document.createElement('script');
                            html2canvasScript.src = 'js/libs/html2canvas.min.js';

                            const jsPdfScript = document.createElement('script');
                            jsPdfScript.src = 'js/libs/jspdf.umd.min.js';

                            let loadedCount = 0;
                            const checkBothLoaded = () => {
                                loadedCount++;
                                if (loadedCount === 2) {
                                    resolve();
                                }
                            };

                            html2canvasScript.onload = checkBothLoaded;
                            jsPdfScript.onload = checkBothLoaded;

                            document.head.appendChild(html2canvasScript);
                            document.head.appendChild(jsPdfScript);
                        });
                    };

                    // åŠ è½½PDF.jsåº“ç”¨äºç§»åŠ¨ç«¯PDFé¢„è§ˆ
                    window.loadPdfJsLibrary = function() {
                        return new Promise((resolve, reject) => {
                            if (window.pdfjsLib) {
                                resolve();
                                return;
                            }

                            const pdfJsScript = document.createElement('script');
                            pdfJsScript.src = 'js/libs/pdf.min.js';

                            pdfJsScript.onload = function() {
                                // è®¾ç½®PDF.js worker
                                if (window.pdfjsLib) {
                                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/libs/pdf.worker.min.js';
                                    resolve();
                                } else {
                                    reject(new Error('PDF.jsåŠ è½½å¤±è´¥'));
                                }
                            };

                            pdfJsScript.onerror = function() {
                                reject(new Error('PDF.jsè„šæœ¬åŠ è½½å¤±è´¥'));
                            };

                            document.head.appendChild(pdfJsScript);
                        });
                    };

                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.opacity = '0';
                        loadingIndicator.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            loadingIndicator.remove();
                        }, 500);
                    }
                }, 100);
            }, 0);
        });
    </script>
</head>
<body class="bg-gray-100">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="flex items-center justify-center h-screen">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <div class="flex justify-center mb-4">
                <div class="h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center shadow-md">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xpcGJvYXJkIj48cGF0aCBkPSJNMTYgNGgyYTIgMiAwIDAgMSAyIDJ2MTRhMiAyIDAgMCAxLTIgMkg2YTIgMiAwIDAgMS0yLTJWNmEyIDIgMCAwIDEgMi0yaDIiPjwvcGF0aD48cmVjdCB4PSI4IiB5PSIyIiB3aWR0aD0iOCIgaGVpZ2h0PSI0IiByeD0iMSIgcnk9IjEiPjwvcmVjdD48bGluZSB4MT0iOSIgeTE9IjkuMTA0IiB4Mj0iMTUiIHkyPSI5LjEwNCI+PC9saW5lPjxsaW5lIHgxPSI5IiB5MT0iMTIiIHgyPSIxMiIgeTI9IjEyIj48L2xpbmU+PGxpbmUgeDE9IjkiIHkxPSIxNSIgeDI9IjE1IiB5Mj0iMTUiPjwvbGluZT48L3N2Zz4="
                    alt="ç”³è¯·ç³»ç»ŸLogo" class="h-10 w-10">
                </div>
            </div>
            <h2 class="text-2xl font-bold text-center mb-6">ç™»å½•</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">è´¦å·</label>
                    <input type="text" id="loginUsername" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">å¯†ç </label>
                    <input type="password" id="loginPassword" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">ç™»å½•</button>
            </form>
            <div class="mt-4 text-center">
                <button id="changePasswordBtn" class="text-blue-600 hover:text-blue-800 text-sm">ä¿®æ”¹å¯†ç </button>
            </div>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-center mb-4">
                <div class="h-12 w-12 bg-blue-600 rounded-full flex items-center justify-center shadow-md">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xpcGJvYXJkIj48cGF0aCBkPSJNMTYgNGgyYTIgMiAwIDAgMSAyIDJ2MTRhMiAyIDAgMCAxLTIgMkg2YTIgMiAwIDAgMS0yLTJWNmEyIDIgMCAwIDEgMi0yaDIiPjwvcGF0aD48cmVjdCB4PSI4IiB5PSIyIiB3aWR0aD0iOCIgaGVpZ2h0PSI0IiByeD0iMSIgcnk9IjEiPjwvcmVjdD48bGluZSB4MT0iOSIgeTE9IjkuMTA0IiB4Mj0iMTUiIHkyPSI5LjEwNCI+PC9saW5lPjxsaW5lIHgxPSI5IiB5MT0iMTIiIHgyPSIxMiIgeTI9IjEyIj48L2xpbmU+PGxpbmUgeDE9IjkiIHkxPSIxNSIgeDI9IjE1IiB5Mj0iMTUiPjwvbGluZT48L3N2Zz4="
                    alt="ç”³è¯·ç³»ç»ŸLogo" class="h-8 w-8">
                </div>
            </div>
            <h2 class="text-xl font-bold mb-4 text-center">ä¿®æ”¹å¯†ç </h2>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="cpUsername" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <p class="text-gray-500 text-xs mt-1">å¯ä»¥ä½¿ç”¨ç”¨æˆ·åæˆ–ç”¨æˆ·ä»£ç </p>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">å½“å‰å¯†ç </label>
                    <input type="password" id="cpCurrentPassword" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ç¡®è®¤å½“å‰å¯†ç </label>
                    <input type="password" id="cpConfirmCurrentPassword" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">æ–°å¯†ç </label>
                    <input type="password" id="cpNewPassword" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">ç¡®è®¤ä¿®æ”¹</button>
                    <button type="button" id="cancelChangePassword" class="flex-1 bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400">å–æ¶ˆ</button>
                </div>
            </form>
            <p id="cpError" class="text-red-500 text-center mt-4 hidden"></p>
            <p id="cpSuccess" class="text-green-500 text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="customConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-center">è¯·æ³¨æ„</h2>
            <p id="customConfirmMessage" class="text-center mb-6">æ‚¨æœªå¡«å†™ç”³è¯·/é‡‡è´­é‡‘é¢ï¼Œç‚¹å‡»<span class="text-blue-600 font-bold">ç¡®è®¤</span>åˆ™ç›´æ¥æäº¤ç”³è¯·ï¼Œç‚¹å‡»<span class="text-gray-800 font-bold">è¿”å›å¡«å†™</span>å®Œæˆé‡‘é¢å¡«å†™</p>
            <div class="flex space-x-4 justify-center">
                <button id="customConfirmYes" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">ç¡®è®¤</button>
                <button id="customConfirmNo" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">è¿”å›å¡«å†™</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainApp" class="hidden">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  - ç®€åŒ–ç‰ˆ -->
        <nav class="bg-blue-600 text-white p-4 shadow-lg md:hidden">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center w-full justify-between">
                    <button id="menuToggleBtn" class="focus:outline-none mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <!-- ç§»åŠ¨ç«¯å±…ä¸­æ˜¾ç¤ºæ ‡é¢˜ï¼Œç‚¹å‡»å¯è¿”å›ä¸»é¡µ -->
                    <div class="flex items-center flex-grow justify-center">
                        <div class="h-8 w-8 mr-2 bg-white rounded-full flex items-center justify-center shadow-sm">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMjU2M0VCIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9ImZlYXRoZXIgZmVhdGhlci1jbGlwYm9hcmQiPjxwYXRoIGQ9Ik0xNiA0aDJhMiAyIDAgMCAxIDIgMnYxNGEyIDIgMCAwIDEtMiAySDZhMiAyIDAgMCAxLTItMlY2YTIgMiAwIDAgMSAyLTJoMiI+PC9wYXRoPjxyZWN0IHg9IjgiIHk9IjIiIHdpZHRoPSI4IiBoZWlnaHQ9IjQiIHJ4PSIxIiByeT0iMSI+PC9yZWN0PjxsaW5lIHgxPSI5IiB5MT0iOS4xMDQiIHgyPSIxNSIgeTI9IjkuMTA0Ij48L2xpbmU+PGxpbmUgeDE9IjkiIHkxPSIxMiIgeDI9IjEyIiB5Mj0iMTIiPjwvbGluZT48bGluZSB4MT0iOSIgeTE9IjE1IiB4Mj0iMTUiIHkyPSIxNSI+PC9saW5lPjwvc3ZnPg=="
                            alt="ç”³è¯·ç³»ç»ŸLogo" class="h-6 w-6">
                        </div>
                        <h1 class="text-2xl font-bold cursor-pointer" onclick="goToHomePage()">ç”³è¯·ä¹¦ç®¡ç†ç³»ç»Ÿ</h1>
                    </div>

                    <!-- ç§»åŠ¨ç«¯å³ä¾§æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’® -->
                    <div class="flex items-center">
                        <button onclick="toggleUserInfo()" class="focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- ç§»åŠ¨ç«¯ç”¨æˆ·ä¿¡æ¯ä¸‹æ‹‰èœå• -->
                <div id="userInfoDropdown" class="hidden absolute right-0 top-16 bg-blue-700 text-white p-3 rounded-bl-lg shadow-lg z-40 w-48">
                    <div id="mobileCurrentUserInfo" class="text-sm mb-2"></div>
                    <button onclick="logout()" class="w-full text-left py-2 px-3 rounded hover:bg-blue-600">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </nav>

        <!-- PCç«¯å¸ƒå±€å®¹å™¨ -->
        <div class="flex h-screen md:h-screen md:bg-gray-100">
            <!-- PCç«¯ä¾§è¾¹æ  -->
            <div id="pcSidebar" class="hidden md:flex md:flex-col md:w-64 bg-white border-r border-gray-200 shadow-sm md:rounded-lg md:border-0 md:fixed md:left-4 md:top-4 md:bottom-4 md:z-30">
                <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="h-16 w-16 mr-3 flex items-center justify-center cursor-pointer" onclick="goToHomePage()">
                            <img src="img/Makrite-logo.png" alt="Makrite Logo" class="h-12 w-auto object-contain">
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">ç”³è¯·ä¹¦ç®¡ç†ç³»ç»Ÿ</h2>
                        </div>
                    </div>
                </div>

                <!-- ä¾§è¾¹æ å¯¼èˆªèœå• -->
                <div class="flex-1 px-4 pb-4 space-y-1 overflow-hidden">
                    <button onclick="showSection('new')" class="pc-nav-btn w-full text-left py-3 px-4 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 transition-colors flex items-center font-medium" data-section="new">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        æ–°å»ºç”³è¯·
                    </button>
                    <button onclick="showSection('history')" class="pc-nav-btn w-full text-left py-3 px-4 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 transition-colors flex items-center" data-section="history">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        ç”³è¯·è®°å½•
                    </button>
                    <button id="pcPendingApprovalBtn" onclick="showSection('pendingApproval')" class="pc-nav-btn w-full text-left py-3 px-4 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 hidden transition-colors flex items-center justify-between" data-section="pendingApproval">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            å¾…å®¡æ ¸
                        </div>
                        <span id="pcPendingCount" class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full hidden">0</span>
                    </button>
                    <button id="pcApprovedBtn" onclick="showSection('approved')" class="pc-nav-btn w-full text-left py-3 px-4 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 hidden transition-colors flex items-center" data-section="approved">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        å·²å®¡æ ¸
                    </button>

                    <button id="pcSystemSettingsBtn" onclick="showSection('systemSettings')" class="pc-nav-btn w-full text-left py-3 px-4 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 hidden transition-colors flex items-center" data-section="systemSettings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        ç³»ç»Ÿè®¾ç½®
                    </button>
                    <button id="pcManageUsersBtn" onclick="showSection('manageUsers')" class="pc-nav-btn w-full text-left py-3 px-4 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 hidden transition-colors flex items-center" data-section="manageUsers">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        ç”¨æˆ·ç®¡ç†
                    </button>
                </div>

                <!-- ä¾§è¾¹æ åº•éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1 min-w-0">
                            <div class="h-10 w-10 bg-gray-300 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div id="pcCurrentUserInfo" class="text-sm font-medium text-gray-900 truncate"></div>
                            </div>
                        </div>
                        <button onclick="logout()" class="ml-3 bg-gray-100 hover:bg-gray-200 text-gray-700 p-2.5 rounded-lg transition-colors flex items-center justify-center flex-shrink-0" title="é€€å‡ºç™»å½•">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

        <!-- ä¾§è¾¹å¯¼èˆªèœå• - ä»…åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤º -->
        <div id="sideMenu" class="fixed inset-y-0 left-0 transform -translate-x-full bg-blue-700 bg-opacity-80 text-white w-64 z-30 transition-transform duration-300 ease-in-out shadow-xl overflow-y-auto backdrop-blur-md md:hidden">
            <div class="p-3 border-b border-blue-800 border-opacity-50">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">åŠŸèƒ½èœå•</h2>
                    <button id="closeMenuBtn" class="focus:outline-none text-white hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-3 space-y-2">
                <button onclick="showSection('new'); toggleMenuMobile();" class="side-nav-btn w-full text-left py-2 px-3 rounded hover:bg-blue-600 hover:bg-opacity-70 active-indicator" data-section="new">
                    <span class="inline-block w-5 mr-1">ğŸ“</span>æ–°å»ºç”³è¯·
                </button>
                <button onclick="showSection('history'); toggleMenuMobile();" class="side-nav-btn w-full text-left py-2 px-3 rounded hover:bg-blue-600 hover:bg-opacity-70" data-section="history">
                    <span class="inline-block w-5 mr-1">ğŸ“‹</span>ç”³è¯·è®°å½•
                </button>
                <button id="sidePendingApprovalBtn" onclick="showSection('pendingApproval'); toggleMenuMobile();" class="side-nav-btn w-full text-left py-2 px-3 rounded hover:bg-blue-600 hover:bg-opacity-70 hidden" data-section="pendingApproval">
                    <span class="inline-block w-5 mr-1">â³</span>å¾…å®¡æ ¸
                    <span id="sidePendingCount" class="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full hidden">0</span>
                </button>
                <button id="sideApprovedBtn" onclick="showSection('approved'); toggleMenuMobile();" class="side-nav-btn w-full text-left py-2 px-3 rounded hover:bg-blue-600 hover:bg-opacity-70 hidden" data-section="approved">
                    <span class="inline-block w-5 mr-1">âœ…</span>å·²å®¡æ ¸
                </button>
                <button id="sideSystemSettingsBtn" onclick="showSection('systemSettings'); toggleMenuMobile();" class="side-nav-btn w-full text-left py-2 px-3 rounded hover:bg-blue-600 hover:bg-opacity-70 hidden" data-section="systemSettings">
                    <span class="inline-block w-5 mr-1">âš™ï¸</span>ç³»ç»Ÿè®¾ç½®
                </button>
                <button id="sideManageUsersBtn" onclick="showSection('manageUsers'); toggleMenuMobile();" class="side-nav-btn w-full text-left py-2 px-3 rounded hover:bg-blue-600 hover:bg-opacity-70 hidden" data-section="manageUsers">
                    <span class="inline-block w-5 mr-1">ğŸ‘¥</span>ç”¨æˆ·ç®¡ç†
                </button>
                <!-- åˆ·æ–°æ•°æ®æŒ‰é’®å·²åˆ é™¤ -->
            </div>
        </div>

            <!-- PCç«¯ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 md:overflow-y-auto bg-white shadow-lg md:rounded-lg md:ml-72 md:mr-4 md:mt-4 md:mb-4">
                <main class="w-full mt-8 px-4 md:px-6 transition-all duration-300 md:mt-0 md:p-6">
            <!-- æ–°å»ºç”³è¯·è¡¨å• -->
            <section id="newSection" class="bg-white p-6 rounded-lg shadow-md space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800">æ–°å»ºç”³è¯·ä¹¦</h2>
                <form id="applicationForm" class="space-y-4">
                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 mb-2">ç”³è¯·äººå§“å</label>
                            <input type="text" id="applicant" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 bg-gray-100 cursor-not-allowed" readonly>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 mb-2">ç”³è¯·éƒ¨é—¨</label>
                            <input type="text" id="department" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 bg-gray-100 cursor-not-allowed" readonly>
                        </div>
                    </div>
                    <div class="flex">
                        <div class="w-1/2">
                            <label class="block text-gray-700 mb-2">ç”³è¯·æ—¥æœŸ</label>
                            <input type="date" id="applyDate" required class="w-full p-2 border rounded-md">
                        </div>
                        <div class="w-1/2"></div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ç”³è¯·å†…å®¹</label>
                        <textarea id="content" rows="5" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 mb-2">ç”³è¯·/é‡‡è´­é‡‘é¢</label>
                            <div class="flex space-x-2">
                                <select id="currency" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 w-24">
                                    <option value="CNY">äººæ°‘å¸</option>
                                    <option value="USD">ç¾å…ƒ</option>
                                </select>
                                <input type="number" id="amount" min="0" step="0.01" class="flex-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥é‡‘é¢">
                            </div>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 mb-2">ç´§æ€¥ç¨‹åº¦</label>
                            <select id="priority" class="w-full p-2 border rounded-md">
                                <option value="normal">æ™®é€š</option>
                                <option value="medium">ä¸­ç­‰</option>
                                <option value="high">ç´§æ€¥</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">é€‰æ‹©å®¡æ‰¹å‚é•¿</label>
                        <div id="directorsList" class="max-h-40 overflow-y-auto border rounded-md p-2">
                            <p class="text-gray-500 text-center">åŠ è½½ä¸­...</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">å¦‚æœæ‚¨çš„ç”³è¯·ä¸éœ€è¦ç»è¿‡å‚é•¿å®¡æ‰¹ï¼Œè¯·ç›´æ¥é€‰æ‹©æ€»ç›‘è¿›è¡Œå®¡æ‰¹</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">é™„ä»¶ä¸Šä¼ </label>
                        <div class="border-2 border-dashed border-gray-300 p-4 rounded-md">
                            <input type="file" id="attachments" name="attachments" multiple class="hidden" accept=".pdf">
                            <div id="fileInputArea" class="text-center cursor-pointer" onclick="document.getElementById('attachments').click()">
                                <p class="text-gray-500">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
                                <p class="text-sm text-gray-400">æ”¯æŒæ ¼å¼ï¼šPDFï¼ˆå•ä¸ªæ–‡ä»¶â‰¤10MBï¼Œæ€»å¤§å°â‰¤15MBï¼‰</p>
                            </div>
                            <div id="fileList" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" id="submitBtn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200">
                            <span id="submitBtnText">æäº¤ç”³è¯·</span>
                            <svg id="submitBtnSpinner" class="hidden animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        <button type="button" onclick="previewApplicationTemplate()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">é¢„è§ˆç”³è¯·ä¹¦</button>
                    </div>
                </form>
            </section>

            <!-- ç”³è¯·è®°å½• -->
            <section id="historySection" class="hidden bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">ç”³è¯·è®°å½•</h2>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div id="applicationStatsCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- æ€»ç”³è¯·é‡‘é¢å¡ç‰‡ -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">æ€»ç”³è¯·é‡‘é¢</h3>
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="space-y-1">
                            <div class="text-xl font-bold text-blue-600" id="totalCnyAmount">Â¥0.00</div>
                            <div class="text-xl font-bold text-blue-500" id="totalUsdAmount">$0.00</div>
                        </div>
                    </div>

                    <!-- å¾…å®¡æ ¸é‡‘é¢å¡ç‰‡ -->
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">å¾…å®¡æ ¸é‡‘é¢</h3>
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="space-y-1">
                            <div class="text-xl font-bold text-yellow-600" id="pendingCnyAmount">Â¥0.00</div>
                            <div class="text-xl font-bold text-yellow-500" id="pendingUsdAmount">$0.00</div>
                        </div>
                    </div>

                    <!-- å·²é€šè¿‡é‡‘é¢å¡ç‰‡ -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">å·²é€šè¿‡é‡‘é¢</h3>
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="space-y-1">
                            <div class="text-xl font-bold text-green-600" id="approvedCnyAmount">Â¥0.00</div>
                            <div class="text-xl font-bold text-green-500" id="approvedUsdAmount">$0.00</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4 flex flex-wrap justify-between items-center gap-y-2">
                    <div class="flex flex-wrap space-x-4 gap-y-2">
                        <select id="timeRange" class="p-2 border rounded-md" onchange="updateHistoryList()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="week">æœ¬å‘¨</option>
                            <option value="month">æœ¬æœˆ</option>
                            <option value="year">æœ¬å¹´</option>
                        </select>
                        <select id="searchField" class="p-2 border rounded-md">
                            <option value="applicant">ç”³è¯·äºº</option>
                            <option value="content" selected>ç”³è¯·å†…å®¹</option>
                        </select>
                        <div class="relative w-64">
                            <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹..." class="p-2 pr-8 border rounded-md w-full">
                            <button type="button" id="clearSearchInput" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <button onclick="searchApplications()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">æœç´¢</button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div id="exportDateRangeContainer" class="hidden">
                            <div class="flex items-center space-x-2">
                                <input type="date" id="exportStartDate" class="p-2 border rounded-md" title="å¼€å§‹æ—¥æœŸ">
                                <span class="text-gray-500">è‡³</span>
                                <input type="date" id="exportEndDate" class="p-2 border rounded-md" title="ç»“æŸæ—¥æœŸ">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button id="toggleExportDateRange" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 mr-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="exportApplicationsToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                å¯¼å‡ºExcel
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-3 text-left">ç”³è¯·ç¼–å·</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·äºº</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·éƒ¨é—¨</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·æ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left">ç´§æ€¥ç¨‹åº¦</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·å†…å®¹</th>
                                <th class="px-6 py-3 text-right">ç”³è¯·é‡‘é¢</th>
                                <th class="px-6 py-3 text-left">çŠ¶æ€</th>
                                <th class="px-6 py-3 text-left">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsList" class="divide-y divide-gray-200"></tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="6" class="px-6 py-3 text-right font-bold">åˆè®¡ï¼š</td>
                                <td class="px-6 py-3 text-right font-bold text-blue-600" id="currentPageTotalAmount">Â¥0.00</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div id="historyPagination" class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        å…± <span id="historyTotalItems">0</span> æ¡è®°å½•ï¼Œæ¯é¡µ 10 æ¡
                    </div>
                    <div class="flex space-x-2">
                        <button id="historyPrevPage" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€é¡µ</button>
                        <div id="historyPageNumbers" class="flex space-x-1"></div>
                        <button id="historyNextPage" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </section>

            <!-- å¾…å®¡æ ¸é¡µé¢ -->
            <section id="pendingApprovalSection" class="hidden bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">å¾…å®¡æ ¸ç”³è¯·</h2>
                    <button id="manualRefreshBtn" onclick="manualRefreshPendingList()" class="flex items-center px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm" title="åˆ·æ–°åˆ—è¡¨">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        åˆ·æ–°
                    </button>
                </div>

                <!-- ç§»åŠ¨ç«¯å¡ç‰‡å¼æ˜¾ç¤º -->
                <div id="pendingApprovalCards" class="hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            å¾…å®¡æ ¸: <span id="currentCardIndex">1</span>/<span id="totalCards">0</span>
                        </div>
                        <div class="flex space-x-2">
                            <button id="prevCardBtn" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€ä¸ª</button>
                            <button id="nextCardBtn" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€ä¸ª</button>
                        </div>
                    </div>
                    <div id="pendingCardContainer" class="bg-white rounded-lg shadow-md p-4 border border-gray-200">
                        <!-- å¡ç‰‡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- PCç«¯è¡¨æ ¼æ˜¾ç¤º -->
                <div id="pendingApprovalTable" class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-3 text-left">ç”³è¯·ç¼–å·</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·äºº</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·éƒ¨é—¨</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·æ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left">ç´§æ€¥ç¨‹åº¦</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·å†…å®¹</th>
                                <th class="px-6 py-3 text-left">çŠ¶æ€</th>
                                <th class="px-6 py-3 text-left">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="pendingApprovalList" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <!-- æ·»åŠ å¾…å®¡æ ¸åˆ†é¡µæ§ä»¶ -->
                <div class="mt-4 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        å…± <span id="pendingTotalItems">0</span> æ¡è®°å½•
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="pendingPrevPage" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€é¡µ</button>
                        <div id="pendingPageNumbers" class="flex space-x-1"></div>
                        <button id="pendingNextPage" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </section>

            <!-- å·²å®¡æ ¸é¡µé¢ -->
            <section id="approvedSection" class="hidden bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">å·²å®¡æ ¸ç”³è¯·</h2>
                <!-- å·²å®¡æ ¸ç»Ÿè®¡å¡ç‰‡ -->
                <div id="approvedStatsCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">å®¡æ ¸æ€»é‡‘é¢</h3>
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="space-y-1">
                            <div class="text-xl font-bold text-blue-600" id="approvedTotalCny">Â¥0.00</div>
                            <div class="text-xl font-bold text-blue-500" id="approvedTotalUsd">$0.00</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">é€šè¿‡é‡‘é¢</h3>
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="space-y-1">
                            <div class="text-xl font-bold text-green-600" id="approvedPassCny">Â¥0.00</div>
                            <div class="text-xl font-bold text-green-500" id="approvedPassUsd">$0.00</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">æ‹’ç»é‡‘é¢</h3>
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="space-y-1">
                            <div class="text-xl font-bold text-red-600" id="approvedRejectCny">Â¥0.00</div>
                            <div class="text-xl font-bold text-red-500" id="approvedRejectUsd">$0.00</div>
                        </div>
                    </div>
                </div>
                <div class="mb-4 flex flex-wrap space-x-4 gap-y-2">
                    <select id="approvedTimeRange" class="p-2 border rounded-md" onchange="updateApprovedList()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="year">æœ¬å¹´</option>
                    </select>
                    <select id="approvedStatusFilter" class="p-2 border rounded-md" onchange="updateApprovedList()">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="approved">é€šè¿‡ç”³è¯·</option>
                        <option value="rejected">æ‹’ç»ç”³è¯·</option>
                    </select>
                    <select id="approvedSearchField" class="p-2 border rounded-md">
                        <option value="applicant">ç”³è¯·äºº</option>
                        <option value="content" selected>ç”³è¯·å†…å®¹</option>
                    </select>
                    <div class="relative w-64">
                        <input type="text" id="approvedSearchInput" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹..." class="p-2 pr-8 border rounded-md w-full">
                        <button type="button" id="clearApprovedSearchInput" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <button onclick="searchApprovedApplications()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">æœç´¢</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-3 text-left">ç”³è¯·ç¼–å·</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·äºº</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·éƒ¨é—¨</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·æ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left">ç´§æ€¥ç¨‹åº¦</th>
                                <th class="px-6 py-3 text-left">ç”³è¯·å†…å®¹</th>
                                <th class="px-6 py-3 text-left">çŠ¶æ€</th>
                                <th class="px-6 py-3 text-left">å®¡æ ¸ç»“æœ</th>
                                <th class="px-6 py-3 text-left">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="approvedList" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <!-- æ·»åŠ å·²å®¡æ ¸åˆ†é¡µæ§ä»¶ -->
                <div class="mt-4 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        å…± <span id="approvedTotalItems">0</span> æ¡è®°å½•
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="approvedPrevPage" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€é¡µ</button>
                        <div id="approvedPageNumbers" class="flex space-x-1"></div>
                        <button id="approvedNextPage" class="px-3 py-1 border rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </section>

            <!-- ç³»ç»Ÿè®¾ç½®ï¼ˆä»… admin å¯è§ï¼‰ -->
            <section id="systemSettingsSection" class="hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ç³»ç»Ÿè®¾ç½®</h2>
                    <p class="text-sm text-gray-600 mt-1">ç®¡ç†ç³»ç»Ÿé…ç½®ã€æ•°æ®å½’æ¡£å’Œæé†’ç­–ç•¥</p>
                </div>

                <!-- å¡ç‰‡å¼å¸ƒå±€ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <!-- æ•°æ®å½’æ¡£ç®¡ç†å¡ç‰‡ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-800">æ•°æ®å½’æ¡£ç®¡ç†</h3>
                        </div>

                        <div class="space-y-4">
                            <!-- å½’æ¡£ç»Ÿè®¡ä¿¡æ¯ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-blue-600" id="activeAppsCount">-</div>
                                        <div class="text-xs text-gray-600">æ´»è·ƒç”³è¯·</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-green-600" id="archivedAppsCount">-</div>
                                        <div class="text-xs text-gray-600">å·²å½’æ¡£ç”³è¯·</div>
                                    </div>
                                </div>
                                <div class="border-t pt-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-600">ä¸»æ–‡ä»¶å¤§å°</span>
                                        <span class="text-sm font-semibold" id="mainFileSize">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">å¯å½’æ¡£æ•°é‡</span>
                                        <span class="text-sm font-semibold text-orange-600" id="archivableCount">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- å½’æ¡£è¯´æ˜ -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <div class="flex items-start">
                                    <svg class="w-4 h-4 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="text-xs text-blue-800">
                                        <p class="font-medium mb-1">å½’æ¡£è¯´æ˜ï¼š</p>
                                        <ul class="space-y-1 ml-4 list-disc">
                                            <li>è‡ªåŠ¨å½’æ¡£3ä¸ªæœˆå‰çš„å·²å®Œæˆç”³è¯·</li>
                                            <li>å½’æ¡£åæ•°æ®ä»å¯æ­£å¸¸æŸ¥è¯¢</li>
                                            <li>ä¸»æ–‡ä»¶å¤§å°å°†æ˜¾è‘—å‡å°</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex space-x-3">
                                <button onclick="loadArchiveStats()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors text-sm">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    åˆ·æ–°ç»Ÿè®¡
                                </button>
                                <button onclick="executeArchive()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                    </svg>
                                    æ‰§è¡Œå½’æ¡£
                                </button>
                            </div>

                            <!-- å½’æ¡£å†å² -->
                            <div id="archiveHistory" class="hidden">
                                <div class="border-t pt-3">
                                    <p class="text-sm font-medium text-gray-700 mb-2">å½’æ¡£æ–‡ä»¶åˆ—è¡¨ï¼š</p>
                                    <div id="archiveFilesList" class="space-y-1 max-h-32 overflow-y-auto">
                                        <!-- å½’æ¡£æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é‚®ä»¶æé†’è®¾ç½®å¡ç‰‡ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-800">é‚®ä»¶æé†’è®¾ç½®</h3>
                        </div>


                        <div class="space-y-4">
                            <!-- æé†’ç­–ç•¥è¯´æ˜ -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                <div class="flex items-start">
                                    <svg class="w-4 h-4 text-green-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="text-xs text-green-800">
                                        <p class="font-medium mb-1">æé†’è¯´æ˜ï¼š</p>
                                        <ul class="space-y-1 ml-4 list-disc">
                                            <li>ç³»ç»ŸæŒ‰å®¡æ‰¹å±‚çº§ç‹¬ç«‹è®¡æ—¶</li>
                                            <li>å¯è®¾ç½®ä¸åŒä¼˜å…ˆçº§çš„æé†’é—´éš”</li>
                                            <li>æ”¯æŒå·¥ä½œæ—¥å’Œæ—¶é—´æ®µé™åˆ¶</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- æŒ‰ä¼˜å…ˆçº§è®¾ç½® - ç®€åŒ–ç‰ˆ -->
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-3">æé†’é—´éš”è®¾ç½®</h5>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="border rounded-lg p-3">
                                        <h6 class="font-medium text-red-600 mb-2">ç´§æ€¥ç”³è¯·</h6>
                                        <div class="space-y-2">
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">åˆå§‹å»¶è¿Ÿ:</label>
                                                <input type="number" id="highPriorityDelay" min="1" max="12" value="4" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">æ­£å¸¸é—´éš”:</label>
                                                <input type="number" id="highPriorityNormal" min="1" max="12" value="4" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">ä¸­æœŸé—´éš”:</label>
                                                <input type="number" id="highPriorityMedium" min="1" max="6" value="2" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">ç´§æ€¥é—´éš”:</label>
                                                <input type="number" id="highPriorityUrgent" min="1" max="3" value="1" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border rounded-lg p-3">
                                        <h6 class="font-medium text-yellow-600 mb-2">ä¸­ç­‰ç”³è¯·</h6>
                                        <div class="space-y-2">
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">åˆå§‹å»¶è¿Ÿ:</label>
                                                <input type="number" id="mediumPriorityDelay" min="1" max="24" value="8" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">æ­£å¸¸é—´éš”:</label>
                                                <input type="number" id="mediumPriorityNormal" min="1" max="12" value="8" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">ä¸­æœŸé—´éš”:</label>
                                                <input type="number" id="mediumPriorityMedium" min="1" max="8" value="4" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">ç´§æ€¥é—´éš”:</label>
                                                <input type="number" id="mediumPriorityUrgent" min="1" max="4" value="2" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border rounded-lg p-3">
                                        <h6 class="font-medium text-green-600 mb-2">æ™®é€šç”³è¯·</h6>
                                        <div class="space-y-2">
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">åˆå§‹å»¶è¿Ÿ:</label>
                                                <input type="number" id="lowPriorityDelay" min="1" max="24" value="12" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">æ­£å¸¸é—´éš”:</label>
                                                <input type="number" id="lowPriorityNormal" min="1" max="24" value="12" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">ä¸­æœŸé—´éš”:</label>
                                                <input type="number" id="lowPriorityMedium" min="1" max="12" value="6" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">ç´§æ€¥é—´éš”:</label>
                                                <input type="number" id="lowPriorityUrgent" min="1" max="6" value="3" class="w-16 p-1 border rounded text-xs">
                                                <span class="text-xs text-gray-600">å°æ—¶</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>

                        <!-- æ—¶é—´æ§åˆ¶è®¾ç½® - æŠ˜å æ˜¾ç¤º -->
                        <div class="mt-4">
                            <button onclick="toggleTimeControl()" class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700">â° æ—¶é—´æ§åˆ¶è®¾ç½®</span>
                                <svg id="timeControlIcon" class="w-4 h-4 text-gray-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="timeControlContent" class="hidden mt-3">

                            <div class="space-y-6">
                                <!-- å·¥ä½œæ—¥å’Œå·¥ä½œæ—¶é—´è®¾ç½® -->
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <input type="checkbox" id="enableWorkingDays" class="rounded text-blue-600 focus:ring-blue-500">
                                        <label for="enableWorkingDays" class="text-sm font-semibold text-gray-800 flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            å¯ç”¨å·¥ä½œæ—¥å’Œå·¥ä½œæ—¶é—´é™åˆ¶
                                        </label>
                                    </div>
                                    <div id="workingDaysSettings" class="ml-7 hidden">
                                        <!-- å·¥ä½œæ—¥é€‰æ‹© -->
                                        <div class="mb-5">
                                            <label class="block text-sm font-medium text-gray-700 mb-3">é€‰æ‹©å·¥ä½œæ—¥:</label>
                                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                                <div class="grid grid-cols-7 gap-3">
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay1" value="1" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨ä¸€</span>
                                                    </label>
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay2" value="2" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨äºŒ</span>
                                                    </label>
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay3" value="3" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨ä¸‰</span>
                                                    </label>
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay4" value="4" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨å››</span>
                                                    </label>
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay5" value="5" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨äº”</span>
                                                    </label>
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay6" value="6" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨å…­</span>
                                                    </label>
                                                    <label class="flex flex-col items-center space-y-2 p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors">
                                                        <input type="checkbox" id="workDay7" value="7" class="rounded text-blue-600 focus:ring-blue-500">
                                                        <span class="text-xs font-medium text-gray-700">å‘¨æ—¥</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- å·¥ä½œæ—¶é—´è®¾ç½® -->
                                        <div class="bg-white rounded-lg p-3 border border-gray-200">
                                            <label class="block text-sm font-medium text-gray-700 mb-3">å·¥ä½œæ—¶é—´èŒƒå›´:</label>
                                            <div class="flex items-center space-x-4">
                                                <div class="flex-1">
                                                    <label class="block text-xs text-gray-600 mb-2">å¼€å§‹æ—¶é—´</label>
                                                    <input type="time" id="workingStartTime" value="09:00" class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                </div>
                                                <div class="flex items-center pt-6">
                                                    <span class="text-gray-400 text-sm">è‡³</span>
                                                </div>
                                                <div class="flex-1">
                                                    <label class="block text-xs text-gray-600 mb-2">ç»“æŸæ—¶é—´</label>
                                                    <input type="time" id="workingEndTime" value="18:00" class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- è‡ªå®šä¹‰è·³è¿‡æ—¥æœŸè®¾ç½® -->
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <input type="checkbox" id="enableCustomDates" class="rounded text-green-600 focus:ring-green-500">
                                        <label for="enableCustomDates" class="text-sm font-semibold text-gray-800 flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            å¯ç”¨è‡ªå®šä¹‰è·³è¿‡æ—¥æœŸ
                                        </label>
                                    </div>
                                    <div id="customDatesSettings" class="ml-7 hidden">
                                        <div class="mb-5">
                                            <label class="block text-sm font-medium text-gray-700 mb-3">æ·»åŠ è·³è¿‡æ—¥æœŸ:</label>
                                            <div class="bg-white rounded-lg p-4 border border-gray-200 space-y-3">
                                                <!-- å•ä¸ªæ—¥æœŸæ·»åŠ  -->
                                                <div class="flex items-center space-x-3">
                                                    <div class="flex-shrink-0">
                                                        <label class="block text-xs text-gray-600 mb-1">å•ä¸ªæ—¥æœŸ</label>
                                                        <input type="date" id="newSkipDate" class="p-2 border border-gray-300 rounded-md text-sm w-40 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                                    </div>
                                                    <button onclick="addSkipDate()" class="mt-5 bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors">
                                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        æ·»åŠ 
                                                    </button>
                                                </div>

                                                <!-- åˆ†éš”çº¿ -->
                                                <div class="flex items-center">
                                                    <div class="flex-1 border-t border-gray-200"></div>
                                                    <span class="px-3 text-xs text-gray-500 bg-white">æˆ–</span>
                                                    <div class="flex-1 border-t border-gray-200"></div>
                                                </div>

                                                <!-- æ—¥æœŸèŒƒå›´æ·»åŠ  -->
                                                <div class="flex items-center space-x-3">
                                                    <div class="flex-shrink-0">
                                                        <label class="block text-xs text-gray-600 mb-1">å¼€å§‹æ—¥æœŸ</label>
                                                        <input type="date" id="rangeStartDate" class="p-2 border border-gray-300 rounded-md text-sm w-40 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                                    </div>
                                                    <div class="flex items-center pt-5">
                                                        <span class="text-gray-400 text-sm">è‡³</span>
                                                    </div>
                                                    <div class="flex-shrink-0">
                                                        <label class="block text-xs text-gray-600 mb-1">ç»“æŸæ—¥æœŸ</label>
                                                        <input type="date" id="rangeEndDate" class="p-2 border border-gray-300 rounded-md text-sm w-40 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                                    </div>
                                                    <button onclick="addDateRange()" class="mt-5 bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700 transition-colors">
                                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                                        </svg>
                                                        æ‰¹é‡æ·»åŠ 
                                                    </button>
                                                </div>

                                                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                                    <div class="flex items-start">
                                                        <svg class="w-4 h-4 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                        <p class="text-xs text-blue-700">
                                                            <strong>æç¤ºï¼š</strong>å¯ä»¥å•ä¸ªæ·»åŠ ç‰¹å®šæ—¥æœŸï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ—¥æœŸèŒƒå›´è¿›è¡Œæ‰¹é‡æ·»åŠ ï¼ˆå¦‚èŠ‚å‡æ—¥æœŸé—´ï¼‰
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-3">å·²è®¾ç½®çš„è·³è¿‡æ—¥æœŸ:</label>
                                            <div id="skipDatesList" class="bg-white rounded-lg border border-gray-200 p-3 space-y-2 max-h-48 overflow-y-auto">
                                                <!-- è·³è¿‡æ—¥æœŸåˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="mt-4 flex space-x-3">
                            <button onclick="saveReminderStrategies()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors text-sm">
                                ä¿å­˜è®¾ç½®
                            </button>
                            <button onclick="triggerReminderCheck()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                ç«‹å³æ£€æŸ¥
                            </button>
                        </div>
                    </div>

                    <!-- ç³»ç»Ÿç»Ÿè®¡å¡ç‰‡ -->
                    <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-800">ç³»ç»Ÿç»Ÿè®¡</h3>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalReminders">-</div>
                                <div class="text-xs text-gray-600 mt-1">ä»Šæ—¥æé†’</div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="pendingApplications">-</div>
                                <div class="text-xs text-gray-600 mt-1">å¾…å®¡æ‰¹</div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-red-600" id="urgentApplications">-</div>
                                <div class="text-xs text-gray-600 mt-1">ç´§æ€¥ç”³è¯·</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-green-600" id="avgResponseTime">-</div>
                                <div class="text-xs text-gray-600 mt-1">å¹³å‡å“åº”(å°æ—¶)</div>
                            </div>
                        </div>

                        <button onclick="loadReminderStats()" class="mt-4 w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors text-sm">
                            åˆ·æ–°ç»Ÿè®¡æ•°æ®
                        </button>
                    </div>

                </div>
            </section>


            </section>



            <!-- ç”¨æˆ·ç®¡ç†ï¼ˆä»… admin å¯è§ï¼‰ -->
            <section id="manageUsersSection" class="hidden bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">ç”¨æˆ·ç®¡ç†</h2>

                <div class="overflow-x-auto">
                    <div id="deleteModeAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
                        <p class="font-bold">åˆ é™¤æ¨¡å¼å·²å¯ç”¨</p>
                        <p>ç‚¹å‡»ç”¨æˆ·è¡Œå³ä¾§çš„"Ã—"æŒ‰é’®å¯ä»¥åˆ é™¤å¯¹åº”ç”¨æˆ·ã€‚ç‚¹å‡»"å–æ¶ˆåˆ é™¤"æŒ‰é’®å¯é€€å‡ºåˆ é™¤æ¨¡å¼ã€‚</p>
                    </div>

                    <!-- ç”¨æˆ·æœç´¢æ¡†å’Œæ“ä½œæŒ‰é’® -->
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="userSearchInput" placeholder="æœç´¢ç”¨æˆ·åæˆ–ç”¨æˆ·ä»£ç ..." class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 w-64">
                            <button onclick="searchUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">æœç´¢</button>
                            <button onclick="resetUserSearch()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">é‡ç½®</button>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                æ·»åŠ æ–°ç”¨æˆ·
                            </button>
                            <button id="toggleDeleteModeBtn" onclick="toggleDeleteMode()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                åˆ é™¤ç”¨æˆ·
                            </button>
                            <button onclick="exportUsers()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">å¯¼å‡ºç”¨æˆ·CSV</button>
                            <label for="importUsersInput" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 cursor-pointer inline-block">
                                å¯¼å…¥ç”¨æˆ·CSV
                                <input type="file" id="importUsersInput" accept=".csv" class="hidden" onchange="importUsers(event)">
                            </label>
                        </div>

                        <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">è§†å›¾:</span>
                            <button id="cardViewBtn" onclick="switchToCardView()" class="px-3 py-1 bg-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-400 transition-colors">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                å¡ç‰‡
                            </button>
                            <button id="tableViewBtn" onclick="switchToTableView()" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition-colors">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                è¡¨æ ¼
                            </button>
                        </div>
                    </div>

                    <!-- ç”¨æˆ·å¡ç‰‡ç½‘æ ¼å¸ƒå±€ -->
                    <div id="usersGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- ç”¨æˆ·å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- è¡¨æ ¼å¸ƒå±€ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
                    <div id="usersTable" class="">
                        <table class="min-w-full table-auto bg-white rounded-lg shadow-sm overflow-hidden">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200">
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">ç”¨æˆ·ä¿¡æ¯</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">è§’è‰²æƒé™</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">éƒ¨é—¨</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">çŠ¶æ€</th>
                                    <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div id="usersPagination" class="flex justify-center items-center mt-4 space-x-2">
                        <button id="prevPageBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šä¸€é¡µ</button>
                        <span id="paginationInfo" class="text-gray-600">ç¬¬ <span id="currentPage">1</span> é¡µï¼Œå…± <span id="totalPages">1</span> é¡µ</span>
                        <button id="nextPageBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </section>

            <!-- ç¼–è¾‘ç”³è¯·æ¨¡æ€æ¡† -->
            <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
                <div class="relative mx-auto my-10 bg-white rounded-lg p-6 w-full max-w-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">ç¼–è¾‘ç”³è¯·</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                    </div>
                    <div class="max-h-[70vh] overflow-y-auto pr-2">
                    <form id="editForm" class="space-y-4">
                        <input type="hidden" id="editId">
                        <div>
                            <label class="block text-gray-700 mb-2">ç”³è¯·äººå§“å</label>
                            <input type="text" id="editApplicant" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ç”³è¯·éƒ¨é—¨</label>
                            <select id="editApplicationDepartment" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="ç”Ÿäº§éƒ¨">ç”Ÿäº§éƒ¨</option>
                                <option value="é‡‡è´­éƒ¨">é‡‡è´­éƒ¨</option>
                                <option value="å·¥ç¨‹éƒ¨">å·¥ç¨‹éƒ¨</option>
                                <option value="æœºç”µéƒ¨">æœºç”µéƒ¨</option>
                                <option value="ç ”å‘éƒ¨">ç ”å‘éƒ¨</option>
                                <option value="å“ç®¡éƒ¨">å“ç®¡éƒ¨</option>
                                <option value="è´¢åŠ¡éƒ¨">è´¢åŠ¡éƒ¨</option>
                                <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                <option value="ä¸šåŠ¡éƒ¨">ä¸šåŠ¡éƒ¨</option>
                                <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                <option value="åå‹¤éƒ¨">åå‹¤éƒ¨</option>
                                <option value="ä»“å‚¨éƒ¨">ä»“å‚¨éƒ¨</option>
                                <option value="ç»ç†å®¤">ç»ç†å®¤</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ç”³è¯·æ—¥æœŸ</label>
                            <input type="date" id="editDate" required class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ç”³è¯·å†…å®¹</label>
                            <textarea id="editContent" rows="5" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ç”³è¯·/é‡‡è´­é‡‘é¢</label>
                            <div class="flex space-x-2">
                                <select id="editCurrency" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 w-24">
                                    <option value="CNY">äººæ°‘å¸</option>
                                    <option value="USD">ç¾å…ƒ</option>
                                </select>
                                <input type="number" id="editAmount" min="0" step="0.01" class="flex-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥é‡‘é¢">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ç´§æ€¥ç¨‹åº¦</label>
                            <select id="editPriority" class="w-full p-2 border rounded-md">
                                <option value="normal">æ™®é€š</option>
                                <option value="medium">ä¸­ç­‰</option>
                                <option value="high">ç´§æ€¥</option>
                            </select>
                        </div>
                            <div>
                                <label class="block text-gray-700 mb-2">é€‰æ‹©å®¡æ‰¹å‚é•¿</label>
                                <div id="editDirectorsList" class="max-h-40 overflow-y-auto border rounded-md p-2">
                                    <p class="text-gray-500 text-center">åŠ è½½ä¸­...</p>
                                </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">é™„ä»¶ä¸Šä¼ </label>
                            <div class="border-2 border-dashed border-gray-300 p-4 rounded-md">
                                <input type="file" id="editAttachments" name="attachments" multiple class="hidden" accept=".pdf">
                                <div id="editFileInputArea" class="text-center cursor-pointer" onclick="document.getElementById('editAttachments').click()">
                                    <p class="text-gray-500">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
                                    <p class="text-sm text-gray-400">æ”¯æŒæ ¼å¼ï¼šPDFï¼ˆå•ä¸ªæ–‡ä»¶â‰¤10MBï¼Œæ€»å¤§å°â‰¤15MBï¼‰</p>
                                </div>
                                <div id="editFileList" class="mt-4 space-y-2"></div>
                                <div class="mt-2 p-2 bg-blue-50 text-blue-700 rounded-md text-sm">
                                    <p class="font-medium">æç¤ºï¼š</p>
                                    <p>1. å¦‚æœç”³è¯·å¤„äºå¾…å‚é•¿å®¡æ ¸çŠ¶æ€ï¼Œæ‚¨å¯ä»¥éšæ—¶ä¿®æ”¹ç”³è¯·å†…å®¹å’Œé™„ä»¶</p>
                                    <p>2. å¦‚æœç”³è¯·å·²è¿›å…¥å®¡æ‰¹æµç¨‹ä½†ä¸€å¼€å§‹æ²¡æœ‰æ·»åŠ é™„ä»¶ï¼Œæ‚¨ä»å¯ä»¥æ·»åŠ é™„ä»¶</p>
                                    <p>3. ä¸€æ—¦ç”³è¯·æœ€ç»ˆå®¡æ ¸å®Œæˆï¼ˆå·²é€šè¿‡/å·²æ‹’ç»ï¼‰ï¼Œå°†æ— æ³•å†ä¿®æ”¹</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">ä¿å­˜ä¿®æ”¹</button>
                            <button type="button" onclick="closeEditModal()" class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700">å–æ¶ˆ</button>
                        </div>
                    </form>
                    </div>
                </div>
            </div>

            <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
            <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="relative mx-auto my-4 bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                    <!-- æ ‡é¢˜æ  -->
                    <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                        <h2 class="text-2xl font-bold">ç”³è¯·è¯¦æƒ…</h2>
                        <button onclick="closeDetail()" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                    <div class="border-b flex-shrink-0">
                        <div class="flex">
                            <button id="tab-basic" class="px-6 py-3 border-b-2 border-blue-500 font-medium text-blue-600">åŸºæœ¬ä¿¡æ¯</button>
                            <button id="tab-approvals" class="px-6 py-3 text-gray-500 hover:text-gray-700">å®¡æ‰¹è®°å½•</button>
                            <button id="tab-attachments" class="px-6 py-3 text-gray-500 hover:text-gray-700">é™„ä»¶ç®¡ç†</button>
                        </div>
                    </div>

                    <!-- å†…å®¹åŒºåŸŸ - ä½¿ç”¨flex-growè®©å†…å®¹åŒºåŸŸè‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ -->
                    <div class="flex-grow overflow-y-auto p-4">
                        <!-- åŸºæœ¬ä¿¡æ¯æ ‡ç­¾é¡µ -->
                        <div id="content-basic" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- å·¦ä¾§åŸºæœ¬ä¿¡æ¯ -->
                                <div class="space-y-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-lg mb-3 text-gray-800">ç”³è¯·ä¿¡æ¯</h3>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ç”³è¯·ç¼–å·</span>
                                                <span id="detail-code" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ç”³è¯·äºº</span>
                                                <span id="detail-applicant" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ç”³è¯·éƒ¨é—¨</span>
                                                <span id="detail-department" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ç”³è¯·æ—¥æœŸ</span>
                                                <span id="detail-date" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">å½“å‰çŠ¶æ€</span>
                                                <span id="detail-status" class="font-medium"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç”³è¯·é‡‘é¢å¡ç‰‡ -->
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-lg mb-2 text-blue-800">ç”³è¯·é‡‘é¢</h3>
                                        <div class="text-center">
                                            <span id="detail-amount" class="text-2xl font-bold text-blue-700"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- å³ä¾§ç”³è¯·å†…å®¹ -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-lg mb-3 text-gray-800">ç”³è¯·å†…å®¹</h3>
                                    <div id="detail-content" class="whitespace-pre-wrap bg-white p-3 rounded border overflow-y-auto" style="max-height: 300px;"></div>
                                </div>
                            </div>

                            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                            <div class="flex flex-wrap gap-3 justify-center mt-4">
                                <button id="detail-view-template" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                    æŸ¥çœ‹ç”³è¯·ä¹¦
                                </button>
                                <button id="detail-withdraw" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 hidden">
                                    æ’¤å›å®¡æ‰¹
                                </button>
                            </div>
                        </div>

                        <!-- å®¡æ‰¹è®°å½•æ ‡ç­¾é¡µ -->
                        <div id="content-approvals" class="hidden space-y-4">
                            <!-- å‚é•¿å®¡æ‰¹è®°å½• -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">å‚é•¿å®¡æ‰¹</h3>
                                <div id="detail-directors-approvals" class="space-y-3 max-h-[200px] overflow-y-auto pr-2"></div>
                            </div>

                            <!-- æ€»ç›‘å®¡æ‰¹è®°å½• -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">æ€»ç›‘å®¡æ‰¹</h3>
                                <div id="detail-chief-approval" class="space-y-3"></div>
                            </div>

                            <!-- ç»ç†å®¡æ‰¹è®°å½• -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">ç»ç†å®¡æ‰¹</h3>
                                <div id="detail-managers-approvals" class="space-y-3 max-h-[200px] overflow-y-auto pr-2"></div>
                            </div>

                            <!-- CEOå®¡æ‰¹è®°å½• -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">CEOå®¡æ‰¹</h3>
                                <div id="detail-ceo" class="space-y-3"></div>
                            </div>
                        </div>

                        <!-- é™„ä»¶ç®¡ç†æ ‡ç­¾é¡µ -->
                        <div id="content-attachments" class="hidden space-y-4">
                            <!-- åˆå§‹é™„ä»¶ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">åˆå§‹é™„ä»¶</h3>
                                <div id="detail-attachments" class="space-y-2 max-h-[200px] overflow-y-auto pr-2"></div>
                            </div>

                            <!-- å®¡æ‰¹é™„ä»¶ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-3 text-gray-800">å®¡æ‰¹é™„ä»¶</h3>
                                <div id="detail-approval-attachments" class="space-y-2 max-h-[200px] overflow-y-auto pr-2"></div>
                            </div>

                            <!-- ä¸Šä¼ æ–°é™„ä»¶ (ä»…åœ¨å®¡æ‰¹æ—¶æ˜¾ç¤º) -->
                            <div id="detail-upload-section" class="bg-blue-50 p-4 rounded-lg hidden">
                                <h3 class="font-semibold text-lg mb-3 text-blue-800">ä¸Šä¼ æ–°é™„ä»¶</h3>
                                <input type="file" id="detail-new-attachments" multiple class="w-full p-2 border rounded-md" accept=".pdf">
                                <div id="detail-new-attachments-list" class="mt-2 space-y-2 max-h-[150px] overflow-y-auto"></div>
                                <button id="detail-confirm-attachments" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">ç¡®è®¤é™„ä»¶</button>
                            </div>
                        </div>
                    </div>

                    <!-- å®¡æ‰¹æ“ä½œåŒºåŸŸ (ä»…åœ¨å®¡æ‰¹æ—¶æ˜¾ç¤º) -->
                    <div id="detail-approval-actions" class="hidden border-t p-4 bg-gray-50 flex-shrink-0">
                        <div class="space-y-3">
                            <h3 class="text-lg font-semibold text-gray-800">å®¡æ‰¹æ“ä½œ</h3>

                            <!-- ç»ç†é€‰æ‹©åŒºåŸŸ (ä»…æ€»ç›‘å¯è§) - ä¼˜åŒ–ç‰ˆæœ¬ -->
                            <div id="detail-managers-selection" class="hidden space-y-2">
                                <!-- å¯æŠ˜å æ ‡é¢˜æ  -->
                                <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg cursor-pointer" onclick="toggleManagersSelection()">
                                    <div class="flex items-center space-x-2">
                                        <svg id="managers-toggle-icon" class="w-5 h-5 text-blue-600 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                        <label class="text-gray-700 font-medium cursor-pointer">é€‰æ‹©ä¸‹ä¸€é˜¶æ®µå®¡æ‰¹ç»ç†</label>
                                    </div>
                                    <span id="detail-selected-managers-summary" class="text-sm text-blue-600 font-medium">ç‚¹å‡»å±•å¼€é€‰æ‹©</span>
                                </div>

                                <!-- å¯æŠ˜å å†…å®¹åŒºåŸŸ -->
                                <div id="managers-selection-content" class="hidden space-y-3 bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm text-blue-600">æç¤ºï¼šå¦‚æœä¸é€‰æ‹©ä»»ä½•ç»ç†ï¼Œç”³è¯·å°†åœ¨æ‚¨å®¡æ‰¹é€šè¿‡åæµè½¬ç»™CEOè¿›è¡Œæœ€ç»ˆå®¡æ‰¹</p>
                                    <div id="detail-managers-list" class="max-h-[120px] overflow-y-auto border rounded-md p-2 bg-white"></div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span id="detail-selected-managers-count" class="text-sm text-gray-500">å·²é€‰æ‹© 0 ä½ç»ç†</span>
                                        <button id="detail-confirm-managers" class="bg-green-600 text-white px-4 py-1 rounded-md hover:bg-green-700 transition-colors">ç¡®è®¤é€‰æ‹©</button>
                                    </div>
                                    <div id="detail-managers-confirm-status" class="mt-2 hidden">
                                        <p class="text-green-600 font-medium">âœ“ å·²ç¡®è®¤é€‰æ‹©çš„ç»ç†</p>
                                    </div>
                                </div>
                            </div>

                            <!-- å®¡æ‰¹å¤‡æ³¨ -->
                            <div>
                                <label class="block text-gray-700 mb-2">å®¡æ‰¹å¤‡æ³¨</label>
                                <textarea id="detail-approval-comment" class="w-full p-2 border rounded-md" rows="2" placeholder="è¯·è¾“å…¥å®¡æ‰¹å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                            </div>

                            <!-- å®¡æ‰¹æŒ‰é’® -->
                            <div class="flex space-x-4 justify-center">
                                <button id="detail-approve" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
                                    é€šè¿‡
                                </button>
                                <button id="detail-reject" class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700">
                                    æ‹’ç»
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
            <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 overflow-y-auto">
                <div class="relative mx-auto my-10 bg-white rounded-lg p-4 w-full max-w-4xl max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold" id="previewFileName">æ–‡ä»¶é¢„è§ˆ</h2>
                        <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                    </div>
                    <div class="flex-1 bg-gray-100 rounded overflow-hidden" style="min-height: 60vh;">
                        <!-- PCç«¯PDFå’Œæ–‡æ¡£é¢„è§ˆ -->
                        <iframe id="previewFrame" class="w-full h-full border-0 hidden" style="min-height: 70vh;"></iframe>

                        <!-- ç§»åŠ¨ç«¯PDFé¢„è§ˆå®¹å™¨ -->
                        <div id="mobilePdfPreview" class="w-full h-full hidden relative" style="min-height: 70vh;">
                            <!-- PDFé¡µé¢ä¿¡æ¯æ˜¾ç¤º -->
                            <div id="pdfNavigation" class="flex justify-center items-center p-2 bg-gray-200 border-b">
                                <span id="pageInfo" class="text-sm font-semibold">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                            </div>
                            <!-- PDFæ¸²æŸ“å®¹å™¨ -->
                            <div id="pdfContainer" class="flex-1 overflow-auto p-2 bg-white" style="height: calc(100% - 40px);">
                                <canvas id="pdfCanvas" class="w-full border shadow-sm mx-auto block"></canvas>
                            </div>
                            <!-- åŠ è½½æç¤º -->
                            <div id="pdfLoadingIndicator" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                                    <div class="text-gray-600">æ­£åœ¨åŠ è½½PDF...</div>
                                </div>
                            </div>
                            <!-- æ»‘åŠ¨æç¤º -->
                            <div id="swipeHint" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-xs opacity-0 transition-opacity duration-300">
                                â† æ»‘åŠ¨ç¿»é¡µ â†’
                            </div>
                        </div>

                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                        <div id="imagePreview" class="w-full h-full flex items-center justify-center hidden" style="min-height: 70vh;">
                            <img id="previewImage" class="max-w-full max-h-full object-contain" alt="å›¾ç‰‡é¢„è§ˆ">
                        </div>
                        <!-- ä¸æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ç±»å‹ -->
                        <div id="unsupportedPreview" class="w-full h-full flex flex-col items-center justify-center hidden bg-gray-50" style="min-height: 70vh;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-lg font-medium text-gray-600">æ— æ³•é¢„è§ˆæ­¤ç±»å‹çš„æ–‡ä»¶</p>
                            <p class="text-sm text-gray-500 mt-2">è¯·ä¸‹è½½åæŸ¥çœ‹</p>
                            <a id="unsupportedDownloadLink" href="#" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors" download>ä¸‹è½½æ–‡ä»¶</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”³è¯·ä¹¦æ¨¡æ¿é¢„è§ˆæ¨¡æ€æ¡† -->
            <div id="applicationTemplateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-start overflow-y-auto hidden z-50 p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full relative">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-bold">ç”³è¯·ä¹¦</h2>
                        <button onclick="closeApplicationTemplate()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 overflow-auto" style="max-height: 80vh;">
                        <div class="a4-page" id="applicationTemplatePage">
                            <div id="applicationTemplateContent"></div>
                        </div>
                    </div>
                    <div class="p-4 border-t flex justify-end space-x-2 template-actions">
                        <button onclick="downloadApplicationTemplate()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            ä¸‹è½½
                        </button>
                        <button onclick="closeApplicationTemplate()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">
                            å…³é—­
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
            <div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 w-full max-w-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">ç¼–è¾‘ç”¨æˆ·</h2>
                        <button onclick="closeEditUserModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                    </div>
                    <form id="editUserForm" class="space-y-4">
                        <input type="hidden" id="editTargetUsername">

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">ç”¨æˆ·ä»£ç </label>
                                <input type="text" id="editUserCode" class="w-full p-2 border rounded-md"
                                       oninput="validateUserCodeRealtime(this)"
                                       placeholder="6ä½å­—æ¯æˆ–æ•°å­—">
                                <div id="editUserCodeError" class="text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">è§’è‰²</label>
                                <select id="editRole" class="w-full p-2 border rounded-md" onchange="toggleEditDepartment()">
                                    <option value="user">æ™®é€šç”¨æˆ·</option>
                                    <option value="readonly">ç”¨æˆ·(åªè¯»)</option>
                                    <option value="director">å‚é•¿</option>
                                    <option value="chief">æ€»ç›‘</option>
                                    <option value="manager">ç»ç†</option>
                                    <option value="ceo">CEO</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div id="editDepartmentField">
                                <label class="block text-gray-700 mb-2">éƒ¨é—¨</label>
                                <select id="editUserDepartment" class="w-full p-2 border rounded-md">
                                    <option value="ç”Ÿäº§éƒ¨">ç”Ÿäº§éƒ¨</option>
                                    <option value="é‡‡è´­éƒ¨">é‡‡è´­éƒ¨</option>
                                    <option value="å·¥ç¨‹éƒ¨">å·¥ç¨‹éƒ¨</option>
                                    <option value="æœºç”µéƒ¨">æœºç”µéƒ¨</option>
                                    <option value="ç ”å‘éƒ¨">ç ”å‘éƒ¨</option>
                                    <option value="å“ç®¡éƒ¨">å“ç®¡éƒ¨</option>
                                    <option value="è´¢åŠ¡éƒ¨">è´¢åŠ¡éƒ¨</option>
                                    <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                    <option value="ä¸šåŠ¡éƒ¨">ä¸šåŠ¡éƒ¨</option>
                                    <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                    <option value="åå‹¤éƒ¨">åå‹¤éƒ¨</option>
                                    <option value="ä»“å‚¨éƒ¨">ä»“å‚¨éƒ¨</option>
                                    <option value="ç»ç†å®¤">ç»ç†å®¤</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">é‚®ç®±</label>
                                <input type="email" id="editEmail" class="w-full p-2 border rounded-md"
                                       oninput="validateEmailRealtime(this)">
                                <div id="editEmailError" class="text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2">æ–°å¯†ç </label>
                            <input type="password" id="editPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹" class="w-full p-2 border rounded-md"
                                   oninput="validatePasswordRealtime(this)">
                            <div id="editPasswordError" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2">ç”µå­ç­¾å</label>
                            <input type="file" id="editSignature" accept="image/*" class="w-full p-2 border rounded-md">
                            <div id="editSignaturePreview" class="mt-2 hidden">
                                <img id="editSignatureImage" src="" alt="ç”µå­ç­¾åé¢„è§ˆ" class="max-h-16">
                            </div>
                        </div>

                        <div class="col-span-2">
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-md">
                                <input type="checkbox" id="editUserCanSubmitApplication" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="editUserCanSubmitApplication" class="text-gray-700 font-medium">ç”³è¯·æƒé™</label>
                                <span class="text-sm text-gray-500">å…è®¸æ­¤ç”¨æˆ·æäº¤ç”³è¯·</span>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-4">
                            <button type="button" onclick="closeEditUserModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- æ·»åŠ æ–°ç”¨æˆ·æ¨¡æ€æ¡† -->
            <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">æ·»åŠ æ–°ç”¨æˆ·</h2>
                        <button onclick="closeAddUserModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                    </div>
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">ç”¨æˆ·å</label>
                                <input type="text" id="newUsername" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">å¯†ç </label>
                                <input type="password" id="newPassword" required class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">ç”¨æˆ·ä»£ç </label>
                                <input type="text" id="newUserCode" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">è§’è‰²</label>
                                <select id="newUserRole" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                                    <option value="user">æ™®é€šç”¨æˆ·</option>
                                    <option value="readonly">ç”¨æˆ·(åªè¯»)</option>
                                    <option value="director">å‚é•¿</option>
                                    <option value="chief">æ€»ç›‘</option>
                                    <option value="manager">ç»ç†</option>
                                    <option value="ceo">CEO</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="email" id="newUserEmail" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="newUserDepartmentField">
                                <label class="block text-gray-700 mb-2">éƒ¨é—¨</label>
                                <select id="newUserDepartment" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                                    <option value="ç”Ÿäº§éƒ¨">ç”Ÿäº§éƒ¨</option>
                                    <option value="é‡‡è´­éƒ¨">é‡‡è´­éƒ¨</option>
                                    <option value="å·¥ç¨‹éƒ¨">å·¥ç¨‹éƒ¨</option>
                                    <option value="æœºç”µéƒ¨">æœºç”µéƒ¨</option>
                                    <option value="ç ”å‘éƒ¨">ç ”å‘éƒ¨</option>
                                    <option value="å“ç®¡éƒ¨">å“ç®¡éƒ¨</option>
                                    <option value="è´¢åŠ¡éƒ¨">è´¢åŠ¡éƒ¨</option>
                                    <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                    <option value="ä¸šåŠ¡éƒ¨">ä¸šåŠ¡éƒ¨</option>
                                    <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                    <option value="åå‹¤éƒ¨">åå‹¤éƒ¨</option>
                                    <option value="ä»“å‚¨éƒ¨">ä»“å‚¨éƒ¨</option>
                                    <option value="ç»ç†å®¤">ç»ç†å®¤</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2">ç”µå­ç­¾å <span class="text-sm text-gray-500">(ä¸Šä¼ å›¾ç‰‡)</span></label>
                            <input type="file" id="newUserSignature" accept="image/*" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <div id="signaturePreview" class="mt-2 hidden">
                                <img id="signatureImage" src="" alt="ç”µå­ç­¾åé¢„è§ˆ" class="max-h-16">
                                <button type="button" id="clearSignature" class="text-red-500 text-sm mt-1">æ¸…é™¤</button>
                            </div>
                        </div>

                        <div class="col-span-1 md:col-span-2">
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-md">
                                <input type="checkbox" id="newUserCanSubmitApplication" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="newUserCanSubmitApplication" class="text-gray-700 font-medium">ç”³è¯·æƒé™</label>
                                <span class="text-sm text-gray-500">å…è®¸æ­¤ç”¨æˆ·æäº¤ç”³è¯·</span>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-4">
                            <button type="button" onclick="closeAddUserModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">æ·»åŠ ç”¨æˆ·</button>
                        </div>
                    </form>
                </div>
            </div>
                </main>
            </div>
        </div>

        <!-- åŠé€æ˜é®ç½©å±‚ - ä»…åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤º -->
        <div id="menuOverlay" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm z-20 hidden" onclick="toggleMenu()"></div>
    </div>



    <script>
        let currentUser = null;
        let currentRole = null;
        let currentDepartment = null;
        let currentUserCanSubmitApplication = false;
        let applications = [];
        let allUsers = [];
        let currentUserPage = 1;
        let usersPerPage = 10;
        // åˆ é™¤æ¨¡å¼æ ‡å¿—
        let deleteMode = false;

        // è§’è‰²æ˜ å°„
        const roleMap = {
            'admin': 'ç®¡ç†å‘˜',
            'user': 'æ™®é€šç”¨æˆ·',
            'director': 'å‚é•¿',
            'chief': 'æ€»ç›‘',
            'manager': 'ç»ç†',
            'ceo': 'CEO',
            'readonly': 'ç”¨æˆ·(åªè¯»)'
        };

        // ä¼˜å…ˆçº§æ˜ å°„
        const priorityMap = {
            'normal': 'æ™®é€š',
            'medium': 'ä¸­ç­‰',
            'high': 'ç´§æ€¥'
        };

        // å®¡æ‰¹çŠ¶æ€çš„ä¸­æ–‡æ˜ å°„
        const statusMap = {
            'pending': 'å¾…å®¡æ‰¹',
            'approved': 'é€šè¿‡',
            'rejected': 'æ‹’ç»'
        };

        // è·å–åŠ¨æ€ç”³è¯·çŠ¶æ€è¯´æ˜
        function getApplicationStatusDesc(status, app) {
            switch (status) {
                case 'å¾…å‚é•¿å®¡æ ¸':
                    return 'ç­‰å¾…é€‰ä¸­çš„å‚é•¿å®¡æ‰¹';

                case 'å¾…æ€»ç›‘å®¡æ‰¹':
                    // æ£€æŸ¥æ˜¯å¦ç»è¿‡äº†å‚é•¿å®¡æ‰¹
                    const hasDirectorApprovals = app && app.approvals && app.approvals.directors &&
                        Object.keys(app.approvals.directors).length > 0 &&
                        Object.values(app.approvals.directors).some(d => d.status === 'approved');

                    if (hasDirectorApprovals) {
                        return 'æ‰€æœ‰å‚é•¿å·²å®¡æ‰¹é€šè¿‡ï¼Œç­‰å¾…æ€»ç›‘å®¡æ‰¹';
                    } else {
                        return 'ç­‰å¾…æ€»ç›‘å®¡æ‰¹';
                    }

                case 'å¾…ç»ç†å®¡æ‰¹':
                    // æ£€æŸ¥å®¡æ‰¹æµç¨‹
                    const hasDirectorApprovalsForManager = app && app.approvals && app.approvals.directors &&
                        Object.values(app.approvals.directors).some(d => d.status === 'approved');
                    const hasChiefApprovalForManager = app && app.approvals && app.approvals.chief &&
                        app.approvals.chief.status === 'approved';

                    if (hasDirectorApprovalsForManager && hasChiefApprovalForManager) {
                        return 'æ€»ç›‘å·²å®¡æ‰¹é€šè¿‡ï¼Œç­‰å¾…é€‰ä¸­çš„ç»ç†å®¡æ‰¹';
                    } else if (hasChiefApprovalForManager) {
                        return 'æ€»ç›‘å·²å®¡æ‰¹é€šè¿‡ï¼Œç­‰å¾…é€‰ä¸­çš„ç»ç†å®¡æ‰¹';
                    } else {
                        return 'ç­‰å¾…é€‰ä¸­çš„ç»ç†å®¡æ‰¹';
                    }

                case 'å¾…CEOå®¡æ‰¹':
                    // æ£€æŸ¥å®¡æ‰¹æµç¨‹
                    const hasDirectorApprovalsForCEO = app && app.approvals && app.approvals.directors &&
                        Object.values(app.approvals.directors).some(d => d.status === 'approved');
                    const hasChiefApprovalForCEO = app && app.approvals && app.approvals.chief &&
                        app.approvals.chief.status === 'approved';
                    const hasManagerApprovals = app && app.approvals && app.approvals.managers &&
                        Object.keys(app.approvals.managers).length > 0 &&
                        Object.values(app.approvals.managers).some(m => m.status === 'approved');

                    if (hasManagerApprovals) {
                        return 'ç»ç†å·²å®¡æ‰¹é€šè¿‡ï¼Œç­‰å¾…CEOæœ€ç»ˆå®¡æ‰¹';
                    } else {
                        return 'ç­‰å¾…CEOæœ€ç»ˆå®¡æ‰¹';
                    }

                case 'å·²é€šè¿‡':
                    return 'å®¡æ‰¹æµç¨‹å·²å®Œæˆï¼Œç”³è¯·é€šè¿‡';

                case 'å·²æ‹’ç»':
                    return 'ç”³è¯·è¢«æ‹’ç»';

                default:
                    return status;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {

            // æ·»åŠ ç½‘ç»œæ¢å¤ç›‘å¬å™¨
            window.addEventListener('networkRecovered', () => {
                showNetworkStatus('ç½‘ç»œå·²æ¢å¤ï¼Œæ­£åœ¨é‡æ–°åŠ è½½æ•°æ®...', 'success');

                // é‡æ–°åŠ è½½å¿…è¦æ•°æ®ï¼Œç­¾åæ•°æ®æŒ‰éœ€åŠ è½½
                setTimeout(() => {
                    // æ¸…ç†ç¼“å­˜ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
                    clearAllCaches();
                    clearAllApprovalCaches();

                    // é‡æ–°åŠ è½½ç”³è¯·æ•°æ®
                    loadApplications(1, 10, 'date', 'desc', true, true);

                    // ç®¡ç†å‘˜é‡æ–°åŠ è½½ç”¨æˆ·ç®¡ç†æ•°æ®
                    if (currentRole === 'admin') {
                        loadUsers();
                    }
                }, 1000);
            });

            // åˆå§‹åŒ–ç¼–è¾‘ç”¨æˆ·è¡¨å•äº‹ä»¶ç›‘å¬
            document.getElementById('editUserForm').addEventListener('submit', handleEditUserSubmit);

            // åˆå§‹åŒ–ä¿®æ”¹å¯†ç ç›¸å…³äº‹ä»¶ç›‘å¬
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const cancelChangePasswordBtn = document.getElementById('cancelChangePassword');
            const changePasswordForm = document.getElementById('changePasswordForm');

            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', showChangePasswordModal);
            }

            if (cancelChangePasswordBtn) {
                cancelChangePasswordBtn.addEventListener('click', hideChangePasswordModal);
            }

            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', handleChangePassword);
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½• - åªä½¿ç”¨sessionStorageç¡®ä¿ä¼šè¯çº§åˆ«å­˜å‚¨
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                currentUser = sessionStorage.getItem('username');
                currentRole = sessionStorage.getItem('role');
                currentDepartment = sessionStorage.getItem('department');
                currentUserCanSubmitApplication = sessionStorage.getItem('canSubmitApplication') === 'true';

                // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢ä½†ä¸å¤„ç†é¡µé¢å¯¼èˆªï¼ˆé¡µé¢å¯¼èˆªç”±ä¸»DOMContentLoadedå¤„ç†ï¼‰
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                updateUserDisplay();
                updateNavButtons();

                // ä¼˜åŒ–å¯åŠ¨åŠ è½½ - ä¸é¢„åŠ è½½ç”³è¯·æ•°æ®å’Œç­¾åæ•°æ®
                hideCenterLoadingIndicator();

                // æ¸…ç†æ‰€æœ‰ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
                clearAllApprovalCaches();

                // åˆå§‹åŒ–ç­¾åç¼“å­˜ç³»ç»Ÿ
                initSignatureCache();

                // ç­¾åæ•°æ®å°†æŒ‰éœ€åŠ è½½ï¼Œä¸åœ¨å¯åŠ¨æ—¶åŠ è½½

                // å¼‚æ­¥åŠ è½½å®¡æ‰¹äººæ•°æ®
                loadApprovers().catch(error => {
                    console.warn('å®¡æ‰¹äººæ•°æ®åŠ è½½å¤±è´¥:', error);
                });

                // ç®¡ç†å‘˜ç”¨æˆ·å¼‚æ­¥åŠ è½½å®Œæ•´çš„ç”¨æˆ·æ•°æ®
                if (currentRole === 'admin') {
                    loadUsers().catch(error => {
                        console.warn('ç®¡ç†å‘˜ç”¨æˆ·æ•°æ®åŠ è½½å¤±è´¥:', error);
                    });
                }



                // æ³¨æ„ï¼šé¡µé¢å¯¼èˆªé€»è¾‘å·²ç§»è‡³ä¸»DOMContentLoadedäº‹ä»¶å¤„ç†å™¨ä¸­
                // è¿™é‡Œä¸å†å¤„ç†é¡µé¢å¯¼èˆªï¼Œé¿å…ä¸ä¸»é€»è¾‘å†²çª
            } else {
                showLoginForm();
            }

            // ç¡®ä¿PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ­£ç¡®æ˜¾ç¤º
            if (window.innerWidth >= 768) {
                fixPCNavigation();
            }
        });

        // åŠ è½½æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆç”¨äºè·å–ç”µå­ç­¾åï¼‰- å¢å¼ºç‰ˆï¼Œæ”¯æŒä»£ç†å’ŒVPNç½‘ç»œ
        async function loadAllUsers() {
            try {
                // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œç›´æ¥è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
                if (currentRole === 'admin') {
                    try {
                        const users = await apiRequest(`/users?username=${currentUser}`, {
                            method: 'GET',
                            timeout: 6000, // å‡å°‘è¶…æ—¶æ—¶é—´
                            retry: {
                                maxRetries: 2, // å‡å°‘é‡è¯•æ¬¡æ•°
                                retryDelay: 500, // å‡å°‘é‡è¯•å»¶è¿Ÿ
                                retryStatusCodes: [0, 408, 429, 500, 502, 503, 504]
                            }
                        });

                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!Array.isArray(users)) {
                            throw new Error('æœåŠ¡å™¨è¿”å›çš„ç”¨æˆ·æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        }

                        // å¦‚æœallUserså·²æœ‰æ•°æ®ï¼Œåˆå¹¶æ–°æ•°æ®ï¼Œä¿ç•™å·²æœ‰çš„ç­¾åä¿¡æ¯
                        if (allUsers && allUsers.length > 0) {
                            // éå†æ–°è·å–çš„ç”¨æˆ·æ•°æ®
                            users.forEach(newUser => {
                                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·
                                const existingUser = allUsers.find(u => u.username === newUser.username);
                                if (existingUser) {
                                    // å¦‚æœæ–°ç”¨æˆ·æœ‰ç­¾åè€Œç°æœ‰ç”¨æˆ·æ²¡æœ‰ï¼Œæ›´æ–°ç­¾å
                                    if (newUser.signature && !existingUser.signature) {
                                        existingUser.signature = newUser.signature;
                                    }
                                } else {
                                    // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œæ·»åŠ åˆ°allUsers
                                    allUsers.push(newUser);
                                }
                            });
                        } else {
                            // å¦‚æœallUsersä¸ºç©ºï¼Œç›´æ¥èµ‹å€¼
                            allUsers = users;
                        }
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                        // å°è¯•ä»ç”³è¯·ä¸­æå–ç­¾åä¿¡æ¯
                        extractSignaturesFromApplications();
                    }
                } else {
                    // éç®¡ç†å‘˜ç”¨æˆ·ï¼Œä½¿ç”¨æ–°çš„signaturesæ¥å£è·å–æ‰€æœ‰ç”¨æˆ·çš„ç­¾åæ•°æ®
                    try {
                        const signatures = await apiRequest(`/signatures?username=${currentUser}`, {
                            method: 'GET',
                            timeout: 15000,
                            retry: {
                                maxRetries: 3,
                                retryDelay: 1500,
                                retryStatusCodes: [0, 408, 429, 500, 502, 503, 504]
                            }
                        });

                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!Array.isArray(signatures)) {
                            throw new Error('æœåŠ¡å™¨è¿”å›çš„ç­¾åæ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        }

                        // å¦‚æœallUserså·²æœ‰æ•°æ®ï¼Œåˆå¹¶æ–°æ•°æ®ï¼Œä¿ç•™å·²æœ‰çš„ç­¾åä¿¡æ¯
                        if (allUsers && allUsers.length > 0) {
                            // éå†æ–°è·å–çš„ç”¨æˆ·æ•°æ®
                            signatures.forEach(newUser => {
                                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·
                                const existingUser = allUsers.find(u => u.username === newUser.username);
                                if (existingUser) {
                                    // å¦‚æœæ–°ç”¨æˆ·æœ‰ç­¾åè€Œç°æœ‰ç”¨æˆ·æ²¡æœ‰ï¼Œæ›´æ–°ç­¾å
                                    if (newUser.signature && !existingUser.signature) {
                                        existingUser.signature = newUser.signature;
                                    }
                                } else {
                                    // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œæ·»åŠ åˆ°allUsers
                                    allUsers.push(newUser);
                                }
                            });
                        } else {
                            // å¦‚æœallUsersä¸ºç©ºï¼Œç›´æ¥èµ‹å€¼
                            allUsers = signatures;
                        }

                    } catch (error) {
                        console.error('è·å–ç­¾åæ•°æ®å‡ºé”™:', error);
                        // å°è¯•ä»ç”³è¯·ä¸­æå–ç­¾åä¿¡æ¯
                        extractSignaturesFromApplications();
                    }
                }

                return allUsers;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å‡ºé”™:', error);
                // å°è¯•ä»ç”³è¯·ä¸­æå–ç­¾åä¿¡æ¯
                extractSignaturesFromApplications();
                return allUsers;
            }
        }

        // ä»åº”ç”¨ç¨‹åºæ•°æ®ä¸­æå–ç­¾åä¿¡æ¯
        function extractSignaturesFromApplications() {
            if (!applications || applications.length === 0) return;

            // åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ•°æ®å­˜å‚¨
            allUsers = allUsers || [];

            // éå†æ‰€æœ‰åº”ç”¨ç¨‹åºï¼Œæå–ç­¾åä¿¡æ¯
            applications.forEach(app => {
                if (app.approvals) {
                    // æå–å‚é•¿ç­¾å
                    if (app.approvals.directors) {
                        Object.entries(app.approvals.directors).forEach(([username, approval]) => {
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·
                            const existingUser = allUsers.find(u => u.username === username);

                            // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨æˆ–è€…ç”¨æˆ·å­˜åœ¨ä½†æ²¡æœ‰ç­¾åè€Œå½“å‰å®¡æ‰¹æœ‰ç­¾å
                            if (approval.signature && (!existingUser || !existingUser.signature)) {
                                if (existingUser) {
                                    // æ›´æ–°ç°æœ‰ç”¨æˆ·çš„ç­¾å
                                    existingUser.signature = approval.signature;
                } else {
                                    // æ·»åŠ æ–°ç”¨æˆ·
                                    allUsers.push({
                                        username: username,
                                        role: 'director',
                                        signature: approval.signature
                                    });
                                }
                            }
                        });
                    }

                    // æå–æ€»ç›‘ç­¾å
                    if (app.approvals.chief && app.approvals.chief.signature) {
                        const chiefUsername = app.approvals.chief.username || 'chief';
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ€»ç›‘ç”¨æˆ·
                        const existingChief = allUsers.find(u => u.username === chiefUsername || u.role === 'chief');

                        if (existingChief) {
                            // æ›´æ–°ç°æœ‰æ€»ç›‘çš„ç­¾å
                            if (!existingChief.signature) {
                                existingChief.signature = app.approvals.chief.signature;
                            }
                        } else {
                            // æ·»åŠ æ–°æ€»ç›‘ç”¨æˆ·
                            allUsers.push({
                                username: chiefUsername,
                                role: 'chief',
                                signature: app.approvals.chief.signature
                            });
                        }
                    }

                    // æå–ç»ç†ç­¾å
                    if (app.approvals.managers) {
                        Object.entries(app.approvals.managers).forEach(([username, approval]) => {
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·
                            const existingUser = allUsers.find(u => u.username === username);

                            // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨æˆ–è€…ç”¨æˆ·å­˜åœ¨ä½†æ²¡æœ‰ç­¾åè€Œå½“å‰å®¡æ‰¹æœ‰ç­¾å
                            if (approval.signature && (!existingUser || !existingUser.signature)) {
                                if (existingUser) {
                                    // æ›´æ–°ç°æœ‰ç”¨æˆ·çš„ç­¾å
                                    existingUser.signature = approval.signature;
                                } else {
                                    // æ·»åŠ æ–°ç”¨æˆ·
                                    allUsers.push({
                                        username: username,
                                        role: 'manager',
                                        signature: approval.signature
                                    });
                                }
                            }
                        });
                    }

                    // æå–CEOç­¾å - å¢å¼ºç‰ˆï¼Œç¡®ä¿å†å²æ•°æ®ä¹Ÿèƒ½æ­£ç¡®å¤„ç†
                    if (app.approvals.ceo && app.approvals.ceo.signature) {
                        // å°è¯•å¤šç§æ–¹å¼è·å–CEOç”¨æˆ·åï¼Œç¡®ä¿å…¼å®¹å†å²æ•°æ®
                        const ceoUsername = app.approvals.ceo.approverUsername ||
                                           app.approvals.ceo.username ||
                                           'ceo';

                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨CEOç”¨æˆ·ï¼ˆå¤šç§åŒ¹é…æ–¹å¼ï¼‰
                        let existingCeo = allUsers.find(u =>
                            u.username === ceoUsername ||
                            u.role === 'ceo' ||
                            (u.username && u.username.toLowerCase().includes('ceo')) ||
                            (ceoUsername !== 'ceo' && u.username === ceoUsername)
                        );

                        if (existingCeo) {
                            // æ›´æ–°ç°æœ‰CEOçš„ç­¾åï¼ˆå¦‚æœå½“å‰æ²¡æœ‰ç­¾åæˆ–è€…æ–°ç­¾åæ›´æ–°ï¼‰
                            if (!existingCeo.signature ||
                                (app.approvals.ceo.signature && app.approvals.ceo.signature !== existingCeo.signature)) {
                                existingCeo.signature = app.approvals.ceo.signature;
                            }
                        } else {
                            // æ·»åŠ æ–°CEOç”¨æˆ·
                            allUsers.push({
                                username: ceoUsername,
                                role: 'ceo',
                                signature: app.approvals.ceo.signature
                            });
                        }
                    }

                    // æå–ç”³è¯·äººç­¾åï¼ˆå¦‚æœæœ‰ï¼‰
                    if (app.signature) {
                        const existingUser = allUsers.find(u => u.username === app.applicant);
                        if (existingUser) {
                            if (!existingUser.signature) {
                                existingUser.signature = app.signature;
                            }
                        } else {
                            allUsers.push({
                                username: app.applicant,
                                role: 'user',
                                signature: app.signature
                            });
                        }
                    }
                }
            });
        }

        function showLoginForm() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
        }

        // ç¡®ä¿PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ­£ç¡®æ˜¾ç¤º
        function fixPCNavigation() {
            if (window.innerWidth >= 768) {
                const topNavMenu = document.querySelector('.hidden.md\\:block');
                if (topNavMenu) {
                    // å¼ºåˆ¶æ˜¾ç¤ºé¡¶éƒ¨å¯¼èˆªèœå•
                    topNavMenu.classList.remove('hidden');
                    topNavMenu.style.display = 'flex';
                }
            }
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            // åœ¨ç§»åŠ¨ç«¯é»˜è®¤éšè—ä¾§è¾¹æ ï¼ŒPCç«¯ä¸éœ€è¦æ˜¾ç¤ºä¾§è¾¹æ 
            const sideMenu = document.getElementById('sideMenu');
            if (window.innerWidth < 768) {
                sideMenu.classList.add('-translate-x-full');
                document.getElementById('menuOverlay').classList.add('hidden');
            }

            // ç¡®ä¿PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ­£ç¡®æ˜¾ç¤º
            fixPCNavigation();

            let targetSection;

            // ç™»å½•æ—¶å§‹ç»ˆè·³è½¬åˆ°é»˜è®¤é¦–é¡µ
            if (currentRole === 'admin') {
                // ç®¡ç†å‘˜é»˜è®¤æ˜¾ç¤ºç”¨æˆ·ç®¡ç†é¡µé¢
                targetSection = 'manageUsers';
            } else if (['director', 'chief', 'manager', 'ceo'].includes(currentRole)) {
                // æ‰€æœ‰å®¡æ‰¹äººé»˜è®¤æ˜¾ç¤ºå¾…å®¡æ ¸é¡µé¢
                targetSection = 'pendingApproval';
            } else {
                // æ™®é€šç”¨æˆ·é»˜è®¤æ˜¾ç¤ºç”³è¯·è®°å½•é¡µé¢
                targetSection = 'history';
            }

            // åªä¿å­˜åˆ°sessionStorageï¼Œç¡®ä¿æµè§ˆå™¨å…³é—­åé¡µé¢çŠ¶æ€è¢«æ¸…é™¤
            sessionStorage.setItem('currentSection', targetSection);

            // æ˜¾ç¤ºé¡µé¢
            showSection(targetSection);
            initFileUpload();

            // è®¾ç½®ç”³è¯·æ—¥æœŸé»˜è®¤ä¸ºå½“å‰æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('applyDate').value = today;

            // è®¾ç½®ç”³è¯·äººå§“åä¸ºå½“å‰ç”¨æˆ·
            document.getElementById('applicant').value = currentUser;

            // è®¾ç½®ç”³è¯·éƒ¨é—¨ä¸ºå½“å‰ç”¨æˆ·çš„éƒ¨é—¨
            if (currentDepartment) {
                const departmentInput = document.getElementById('department');
                if (departmentInput) {
                    departmentInput.value = currentDepartment;
                }
            }
        }

        function updateUserDisplay() {
            // ä½¿ç”¨æ–°çš„updateUserInfoå‡½æ•°æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            updateUserInfo();
        }

        function initFileUpload() {
            const fileInput = document.getElementById('attachments');
            const dropZone = document.getElementById('fileInputArea');
            const editFileInput = document.getElementById('editAttachments');
            const editDropZone = document.getElementById('editFileInputArea');

            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768;

            fileInput.addEventListener('change', handleFileSelect);

            // ä¼˜åŒ–çš„æ‹–æ‹½åŠŸèƒ½
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500');
                if (isMobile) {
                    dropZone.parentElement.classList.add('drag-over');
                }
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500');
                if (isMobile) {
                    dropZone.parentElement.classList.remove('drag-over');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500');
                if (isMobile) {
                    dropZone.parentElement.classList.remove('drag-over');
                }
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            });

            // ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
            if (isMobile) {
                dropZone.addEventListener('touchstart', (e) => {
                    dropZone.style.transform = 'scale(0.98)';
                    dropZone.style.transition = 'transform 0.1s ease';
                });

                dropZone.addEventListener('touchend', (e) => {
                    dropZone.style.transform = 'scale(1)';
                    setTimeout(() => {
                        dropZone.style.transition = '';
                    }, 100);
                });
            }

            // ç¼–è¾‘æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ä¿æŒä¸å˜
            if (editFileInput && editDropZone) {
                editFileInput.addEventListener('change', handleEditFileSelect);
                editDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    editDropZone.classList.add('border-blue-500');
                });
                editDropZone.addEventListener('dragleave', () => {
                    editDropZone.classList.remove('border-blue-500');
                });
                editDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    editDropZone.classList.remove('border-blue-500');
                    editFileInput.files = e.dataTransfer.files;
                    handleEditFileSelect();
                });
            }
        }

        function showSection(section) {
            // æƒé™æ£€æŸ¥ï¼šæ²¡æœ‰ç”³è¯·æƒé™çš„ç”¨æˆ·ä¸èƒ½è®¿é—®ç”³è¯·ç›¸å…³åŠŸèƒ½
            if ((section === 'new' || section === 'history') && !currentUserCanSubmitApplication) {
                showNoPermissionMessage();
                return;
            }

            // æ›´æ–°ç§»åŠ¨ç«¯ä¾§è¾¹æ èœå•çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.side-nav-btn').forEach(btn => {
                if (btn.dataset.section === section) {
                    btn.classList.add('active-indicator');
                } else {
                    btn.classList.remove('active-indicator');
                }
            });

            // æ›´æ–°PCç«¯ä¾§è¾¹æ èœå•çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.pc-nav-btn').forEach(btn => {
                if (btn.dataset.section === section) {
                    btn.classList.add('active-indicator');
                } else {
                    btn.classList.remove('active-indicator');
                }
            });

            // æ›´æ–°é¡¶éƒ¨å¯¼èˆªèœå•çš„æ´»åŠ¨çŠ¶æ€ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
            document.querySelectorAll('.nav-btn[data-section]').forEach(btn => {
                if (btn.dataset.section === section) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });



            document.getElementById('newSection').classList.toggle('hidden', section !== 'new');
            document.getElementById('historySection').classList.toggle('hidden', section !== 'history');
            document.getElementById('pendingApprovalSection').classList.toggle('hidden', section !== 'pendingApproval');
            document.getElementById('approvedSection').classList.toggle('hidden', section !== 'approved');

            document.getElementById('systemSettingsSection').classList.toggle('hidden', section !== 'systemSettings' || currentRole !== 'admin');
            document.getElementById('manageUsersSection').classList.toggle('hidden', section !== 'manageUsers' || currentRole !== 'admin');

            // éšè—æ— æƒé™æç¤ºé¡µé¢
            const noPermissionSection = document.getElementById('noPermissionSection');
            if (noPermissionSection) {
                noPermissionSection.classList.add('hidden');
            }

            if (section === 'history') {
                updateHistoryList(); // ä½¿ç”¨åˆ†é¡µåŠ è½½
            }
            if (section === 'pendingApproval') {
                updatePendingApprovalList(); // ä½¿ç”¨åˆ†é¡µåŠ è½½
            }
            if (section === 'approved') {
                updateApprovedList(); // ä½¿ç”¨åˆ†é¡µåŠ è½½
            }

            if (section === 'systemSettings' && currentRole === 'admin') {
                loadSystemSettings();
                loadArchiveStats(); // åŠ è½½å½’æ¡£ç»Ÿè®¡
            }
            if (section === 'manageUsers' && currentRole === 'admin') loadUsers();

            // å¦‚æœåˆ‡æ¢åˆ°æ–°å»ºç”³è¯·é¡µé¢ï¼Œç¡®ä¿ç”³è¯·äººå’Œç”³è¯·éƒ¨é—¨å§‹ç»ˆä¸ºå½“å‰ç”¨æˆ·
            if (section === 'new') {
                // è®¾ç½®ç”³è¯·æ—¥æœŸé»˜è®¤ä¸ºå½“å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('applyDate').value = today;

                // è®¾ç½®ç”³è¯·äººå§“åä¸ºå½“å‰ç”¨æˆ·
                document.getElementById('applicant').value = currentUser;

                // è®¾ç½®ç”³è¯·éƒ¨é—¨ä¸ºå½“å‰ç”¨æˆ·çš„éƒ¨é—¨
                if (currentDepartment) {
                    const departmentInput = document.getElementById('department');
                    if (departmentInput) {
                        departmentInput.value = currentDepartment;
                    }
                }
            }

            // åªä¿å­˜åˆ°sessionStorageï¼Œç¡®ä¿æµè§ˆå™¨å…³é—­åé¡µé¢çŠ¶æ€è¢«æ¸…é™¤
            sessionStorage.setItem('currentSection', section);
        }

        // æ ¹æ®ç”¨æˆ·è§’è‰²è·³è½¬åˆ°ç›¸åº”çš„ä¸»é¡µ
        function goToHomePage() {
            if (currentRole === 'admin') {
                // ç®¡ç†å‘˜è·³è½¬åˆ°ç”¨æˆ·ç®¡ç†é¡µé¢
                showSection('manageUsers');
            } else if (currentUserCanSubmitApplication) {
                // æœ‰ç”³è¯·æƒé™çš„ç”¨æˆ·è·³è½¬åˆ°ç”³è¯·è®°å½•é¡µé¢ï¼ˆåŒ…æ‹¬æœ‰ç”³è¯·æƒé™çš„å®¡æ‰¹äººï¼‰
                showSection('history');
            } else if (['director', 'chief', 'manager', 'ceo'].includes(currentRole)) {
                // æ²¡æœ‰ç”³è¯·æƒé™ä½†æœ‰å®¡æ‰¹æƒé™çš„ç”¨æˆ·è·³è½¬åˆ°å¾…å®¡æ ¸é¡µé¢
                showSection('pendingApproval');
            } else {
                // æ—¢æ²¡æœ‰ç”³è¯·æƒé™ä¹Ÿæ²¡æœ‰å®¡æ‰¹æƒé™çš„ç”¨æˆ·æ˜¾ç¤ºæ— æƒé™æç¤º
                showNoPermissionMessage();
            }
        }

        // æ˜¾ç¤ºæ— æƒé™æç¤ºä¿¡æ¯
        function showNoPermissionMessage() {
            // éšè—æ‰€æœ‰section
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });

            // åˆ›å»ºæˆ–æ˜¾ç¤ºæ— æƒé™æç¤º
            let noPermissionSection = document.getElementById('noPermissionSection');
            if (!noPermissionSection) {
                noPermissionSection = document.createElement('section');
                noPermissionSection.id = 'noPermissionSection';
                noPermissionSection.className = 'bg-white p-6 rounded-lg shadow-md text-center';
                noPermissionSection.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="mb-4">
                            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">è®¿é—®å—é™</h2>
                        <p class="text-gray-600 mb-6">æ‚¨å½“å‰æ²¡æœ‰ç”³è¯·æäº¤æƒé™ï¼Œæ— æ³•è®¿é—®ç”³è¯·ç›¸å…³åŠŸèƒ½ã€‚</p>
                        <p class="text-sm text-gray-500">å¦‚éœ€ç”³è¯·æƒé™ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚</p>
                    </div>
                `;
                document.querySelector('main').appendChild(noPermissionSection);
            }
            noPermissionSection.classList.remove('hidden');
        }

        // éªŒè¯æ–‡ä»¶åæ ¼å¼ï¼ˆå¿…é¡»åŒ…å«æ—¥æœŸä¸”è‡³å°‘5ä¸ªä¸­æ–‡å­—ç¬¦ï¼‰
        function validateFileName(fileName) {
            const nameWithoutExt = fileName.replace(/\.pdf$/i, ''); // ç§»é™¤æ‰©å±•å
            
            const datePatterns = [ // æ”¯æŒä¸‰ç§æ—¥æœŸæ ¼å¼
                { regex: /\d{8}/, format: '20250101' },
                { regex: /\d{4}-\d{2}-\d{2}/, format: '2025-01-01' },
                { regex: /\d{4}\/\d{2}\/\d{2}/, format: '2025/01/01' }
            ];
            
            let hasDate = false;
            let nameWithoutDate = nameWithoutExt;
            
            for (const pattern of datePatterns) { // æ£€æŸ¥æ˜¯å¦åŒ…å«æ—¥æœŸ
                if (pattern.regex.test(nameWithoutExt)) {
                    hasDate = true;
                    nameWithoutDate = nameWithoutExt.replace(pattern.regex, '');
                    break;
                }
            }
            
            const chineseChars = nameWithoutDate.match(/[\u4e00-\u9fa5]/g); // åŒ¹é…ä¸­æ–‡å­—ç¬¦
            const chineseCount = chineseChars ? chineseChars.length : 0;
            
            return {
                valid: hasDate && chineseCount >= 5,
                hasDate: hasDate,
                chineseCount: chineseCount
            };
        }

        function handleFileSelect() {
            const files = Array.from(document.getElementById('attachments').files);

            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œç›´æ¥è¿”å›
            if (files.length === 0) {
                updateFileList([]);
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç¡®è®¤å¯¹è¯æ¡†
            if (!showFileUploadConfirmation()) {
                // ç”¨æˆ·å–æ¶ˆï¼Œæ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                document.getElementById('attachments').value = '';
                updateFileList([]);
                return;
            }

            // éªŒè¯å•ä¸ªæ–‡ä»¶å¤§å°å’Œæ ¼å¼
            const validFiles = files.filter(file =>
                file.size <= 10 * 1024 * 1024 && /\.pdf$/i.test(file.name)
            );
            const invalidFiles = files.filter(file => !validFiles.includes(file));

            // éªŒè¯æ–‡ä»¶åæ ¼å¼
            const fileNameValidFiles = [];
            const invalidFileNames = [];
            
            for (const file of validFiles) {
                const validation = validateFileName(file.name);
                if (validation.valid) {
                    fileNameValidFiles.push(file);
                } else {
                    invalidFileNames.push({
                        file: file,
                        hasDate: validation.hasDate,
                        chineseCount: validation.chineseCount
                    });
                }
            }

            // éªŒè¯æ€»æ–‡ä»¶å¤§å°
            const totalSize = fileNameValidFiles.reduce((sum, file) => sum + file.size, 0);
            const maxTotalSize = 15 * 1024 * 1024; // 15MB

            let errorMessage = '';
            if (invalidFiles.length > 0) {
                const oversizedFiles = invalidFiles.filter(f => f.size > 10 * 1024 * 1024);
                const wrongFormatFiles = invalidFiles.filter(f => !/\.pdf$/i.test(f.name));

                if (oversizedFiles.length > 0) {
                    errorMessage += `ä»¥ä¸‹æ–‡ä»¶è¶…è¿‡10MBé™åˆ¶ï¼š\n${oversizedFiles.map(f => `${f.name} (${(f.size / 1024 / 1024).toFixed(1)}MB)`).join('\n')}\n\n`;
                }
                if (wrongFormatFiles.length > 0) {
                    errorMessage += `ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼ˆä»…æ”¯æŒPDFï¼‰ï¼š\n${wrongFormatFiles.map(f => f.name).join('\n')}\n\n`;
                }
            }

            // éªŒè¯æ–‡ä»¶åæ ¼å¼
            if (invalidFileNames.length > 0) {
                errorMessage += 'âš ï¸ ä»¥ä¸‹æ–‡ä»¶åä¸ç¬¦åˆè§„èŒƒï¼š\n';
                invalidFileNames.forEach(item => {
                    errorMessage += `âŒ ${item.file.name}\n`;
                    if (!item.hasDate) {
                        errorMessage += '   - ç¼ºå°‘æ—¥æœŸï¼ˆéœ€è¦ï¼š20250101 æˆ– 2025-01-01 æˆ– 2025/01/01ï¼‰\n';
                    }
                    if (item.chineseCount < 5) {
                        errorMessage += `   - ä¸­æ–‡å­—ç¬¦ä¸è¶³ï¼ˆå½“å‰${item.chineseCount}ä¸ªï¼Œéœ€è¦è‡³å°‘5ä¸ªï¼‰\n`;
                    }
                });
                errorMessage += '\nğŸ”´ è¯·ä¿®æ”¹åé‡æ–°ä¸Šä¼ é™„ä»¶ï¼\n\n';
                errorMessage += 'æ­£ç¡®ç¤ºä¾‹ï¼š\n';
                errorMessage += 'âœ… xxå…¬å¸/å‚å•†æ¨¡å…·æŠ¥ä»·å•20250101.pdf\n';
                errorMessage += 'âœ… xxå‚å•†xxæŠ¥ä»·æ˜ç»†2025-01-01.pdf\n';
                errorMessage += 'âœ… xxé‡‡è´­åˆåŒé™„ä»¶2025/01/01.pdf\n\n';
            }

            if (totalSize > maxTotalSize) {
                errorMessage += `æ‰€æœ‰æ–‡ä»¶æ€»å¤§å°è¶…è¿‡15MBé™åˆ¶ï¼šå½“å‰${(totalSize / 1024 / 1024).toFixed(1)}MB`;
            }

            if (errorMessage) {
                // ç§»åŠ¨ç«¯ä¼˜åŒ–çš„é”™è¯¯æç¤º
                if (window.innerWidth <= 768) {
                    showMobileAlert(errorMessage.trim());
                } else {
                    alert(errorMessage.trim());
                }

                // å¦‚æœæ€»å¤§å°è¶…é™ï¼Œéœ€è¦ç§»é™¤ä¸€äº›æ–‡ä»¶
                if (totalSize > maxTotalSize) {
                    // æŒ‰æ–‡ä»¶å¤§å°æ’åºï¼Œä¼˜å…ˆä¿ç•™å°æ–‡ä»¶
                    const sortedFiles = fileNameValidFiles.sort((a, b) => a.size - b.size);
                    const finalFiles = [];
                    let currentSize = 0;

                    for (const file of sortedFiles) {
                        if (currentSize + file.size <= maxTotalSize) {
                            finalFiles.push(file);
                            currentSize += file.size;
                        }
                    }

                    const dt = new DataTransfer();
                    finalFiles.forEach(f => dt.items.add(f));
                    document.getElementById('attachments').files = dt.files;
                } else {
                    // åªæ˜¯æ ¼å¼æˆ–å•ä¸ªæ–‡ä»¶å¤§å°é—®é¢˜ï¼Œä¿ç•™æœ‰æ•ˆæ–‡ä»¶
                    const dt = new DataTransfer();
                    fileNameValidFiles.forEach(f => dt.items.add(f));
                    document.getElementById('attachments').files = dt.files;
                }
            }

            updateFileList(fileNameValidFiles);
        }

        // ç§»åŠ¨ç«¯ä¼˜åŒ–çš„æç¤ºæ¡†
        function showMobileAlert(message) {
            // ç§»é™¤å·²å­˜åœ¨çš„æç¤ºæ¡†
            const existingAlert = document.querySelector('.mobile-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = 'mobile-alert fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50 shadow-lg';
            alertDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="text-sm whitespace-pre-line">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-700 font-bold ml-2 text-lg leading-none">Ã—</button>
                </div>
            `;
            document.body.appendChild(alertDiv);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transform = 'translateY(-10px)';
                    alertDiv.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 300);
                }
            }, 3000);
        }

        function handleEditFileSelect() {
            const files = Array.from(document.getElementById('editAttachments').files);

            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œç›´æ¥è¿”å›
            if (files.length === 0) {
                document.getElementById('editFileList').innerHTML = '';
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç¡®è®¤å¯¹è¯æ¡†
            if (!showFileUploadConfirmation()) {
                // ç”¨æˆ·å–æ¶ˆï¼Œæ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                document.getElementById('editAttachments').value = '';
                document.getElementById('editFileList').innerHTML = '';
                return;
            }

            // éªŒè¯å•ä¸ªæ–‡ä»¶å¤§å°å’Œæ ¼å¼
            const validFiles = files.filter(file =>
                file.size <= 10 * 1024 * 1024 && /\.pdf$/i.test(file.name)
            );
            const invalidFiles = files.filter(file => !validFiles.includes(file));

            // éªŒè¯æ–‡ä»¶åæ ¼å¼
            const fileNameValidFiles = [];
            const invalidFileNames = [];
            
            for (const file of validFiles) {
                const validation = validateFileName(file.name);
                if (validation.valid) {
                    fileNameValidFiles.push(file);
                } else {
                    invalidFileNames.push({
                        file: file,
                        hasDate: validation.hasDate,
                        chineseCount: validation.chineseCount
                    });
                }
            }

            // éªŒè¯æ€»æ–‡ä»¶å¤§å°
            const totalSize = fileNameValidFiles.reduce((sum, file) => sum + file.size, 0);
            const maxTotalSize = 15 * 1024 * 1024; // 15MB

            let errorMessage = '';
            if (invalidFiles.length > 0) {
                const oversizedFiles = invalidFiles.filter(f => f.size > 10 * 1024 * 1024);
                const wrongFormatFiles = invalidFiles.filter(f => !/\.pdf$/i.test(f.name));

                if (oversizedFiles.length > 0) {
                    errorMessage += `ä»¥ä¸‹æ–‡ä»¶è¶…è¿‡10MBé™åˆ¶ï¼š\n${oversizedFiles.map(f => `${f.name} (${(f.size / 1024 / 1024).toFixed(1)}MB)`).join('\n')}\n\n`;
                }
                if (wrongFormatFiles.length > 0) {
                    errorMessage += `ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼ˆä»…æ”¯æŒPDFï¼‰ï¼š\n${wrongFormatFiles.map(f => f.name).join('\n')}\n\n`;
                }
            }

            // éªŒè¯æ–‡ä»¶åæ ¼å¼
            if (invalidFileNames.length > 0) {
                errorMessage += 'âš ï¸ ä»¥ä¸‹æ–‡ä»¶åä¸ç¬¦åˆè§„èŒƒï¼š\n';
                invalidFileNames.forEach(item => {
                    errorMessage += `âŒ ${item.file.name}\n`;
                    if (!item.hasDate) {
                        errorMessage += '   - ç¼ºå°‘æ—¥æœŸï¼ˆéœ€è¦ï¼š20250101 æˆ– 2025-01-01 æˆ– 2025/01/01ï¼‰\n';
                    }
                    if (item.chineseCount < 5) {
                        errorMessage += `   - ä¸­æ–‡å­—ç¬¦ä¸è¶³ï¼ˆå½“å‰${item.chineseCount}ä¸ªï¼Œéœ€è¦è‡³å°‘5ä¸ªï¼‰\n`;
                    }
                });
                errorMessage += '\nğŸ”´ è¯·ä¿®æ”¹åé‡æ–°ä¸Šä¼ é™„ä»¶ï¼\n\n';
                errorMessage += 'æ­£ç¡®ç¤ºä¾‹ï¼š\n';
                errorMessage += 'âœ… xxå…¬å¸/å‚å•†æ¨¡å…·æŠ¥ä»·å•20250101.pdf\n';
                errorMessage += 'âœ… xxå‚å•†xxæŠ¥ä»·æ˜ç»†2025-01-01.pdf\n';
                errorMessage += 'âœ… xxé‡‡è´­åˆåŒé™„ä»¶2025/01/01.pdf\n\n';
            }

            if (totalSize > maxTotalSize) {
                errorMessage += `æ‰€æœ‰æ–‡ä»¶æ€»å¤§å°è¶…è¿‡15MBé™åˆ¶ï¼šå½“å‰${(totalSize / 1024 / 1024).toFixed(1)}MB`;
            }

            if (errorMessage) {
                alert(errorMessage.trim());

                // å¦‚æœæ€»å¤§å°è¶…é™ï¼Œéœ€è¦ç§»é™¤ä¸€äº›æ–‡ä»¶
                if (totalSize > maxTotalSize) {
                    // æŒ‰æ–‡ä»¶å¤§å°æ’åºï¼Œä¼˜å…ˆä¿ç•™å°æ–‡ä»¶
                    const sortedFiles = fileNameValidFiles.sort((a, b) => a.size - b.size);
                    const finalFiles = [];
                    let currentSize = 0;

                    for (const file of sortedFiles) {
                        if (currentSize + file.size <= maxTotalSize) {
                            finalFiles.push(file);
                            currentSize += file.size;
                        }
                    }

                    const dt = new DataTransfer();
                    finalFiles.forEach(f => dt.items.add(f));
                    document.getElementById('editAttachments').files = dt.files;
                } else {
                    // åªæ˜¯æ ¼å¼æˆ–å•ä¸ªæ–‡ä»¶å¤§å°é—®é¢˜ï¼Œä¿ç•™æœ‰æ•ˆæ–‡ä»¶
                    const dt = new DataTransfer();
                    fileNameValidFiles.forEach(f => dt.items.add(f));
                    document.getElementById('editAttachments').files = dt.files;
                }
            }

            // ç›´æ¥æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
            const editFileList = document.getElementById('editFileList');
            editFileList.innerHTML = fileNameValidFiles.map((file, index) => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">${sanitizeInput(file.name)}</span>
                        <span class="text-xs text-gray-400">${(file.size/1024/1024).toFixed(2)}MB</span>
                    </div>
                    <button onclick="removeEditFile(${index})" class="text-red-500 hover:text-red-700 text-sm">ç§»é™¤</button>
                </div>
            `).join('');
        }

        function updateFileList(files) {
            document.getElementById('fileList').innerHTML = files.map((file, index) => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">${sanitizeInput(file.name)}</span>
                        <span class="text-xs text-gray-400">${(file.size/1024/1024).toFixed(2)}MB</span>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 text-sm">ç§»é™¤</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            const dt = new DataTransfer();
            const files = Array.from(document.getElementById('attachments').files);
            files.splice(index, 1);
            files.forEach(f => dt.items.add(f));
            document.getElementById('attachments').files = dt.files;
            handleFileSelect();
        }

        function removeEditFile(index) {
            const dt = new DataTransfer();
            const files = Array.from(document.getElementById('editAttachments').files);
            files.splice(index, 1);
            files.forEach(f => dt.items.add(f));
            document.getElementById('editAttachments').files = dt.files;
            handleEditFileSelect();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // æ˜¾ç¤ºç™»å½•çŠ¶æ€
                showNetworkStatus('æ­£åœ¨ç™»å½•...', 'loading');

                // ä½¿ç”¨å¢å¼ºçš„APIè¯·æ±‚å·¥å…·
                const result = await apiRequest('/login', {
                    method: 'POST',
                    data: { username, password },
                    timeout: 10000,
                    retry: {
                        maxRetries: 2,
                        retryDelay: 1000,
                        retryStatusCodes: [0, 408, 500, 502, 503, 504]
                    }
                });

                // éšè—ç™»å½•çŠ¶æ€
                hideNetworkStatus();

                if (result.success) {
                    currentUser = result.username; // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„ç”¨æˆ·å
                    currentRole = result.role;
                    currentDepartment = result.department; // ä¿å­˜ç”¨æˆ·éƒ¨é—¨ä¿¡æ¯
                    currentUserCanSubmitApplication = result.canSubmitApplication || false; // ä¿å­˜ç”³è¯·æƒé™

                    // ä½¿ç”¨sessionStorageç¡®ä¿æµè§ˆå™¨å…³é—­åéœ€è¦é‡æ–°ç™»å½•
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', result.username);
                    sessionStorage.setItem('role', result.role);
                    sessionStorage.setItem('department', result.department || '');
                    sessionStorage.setItem('canSubmitApplication', result.canSubmitApplication || false);

                    // è®°å½•ç™»å½•æ—¶é—´æˆ³å’Œæœ€åæ´»åŠ¨æ—¶é—´
                    const currentTime = Date.now();
                    sessionStorage.setItem('loginTimestamp', currentTime.toString());
                    sessionStorage.setItem('lastActivity', currentTime.toString());

                    // å¯åŠ¨ä¼šè¯ç›‘æ§
                    startSessionMonitoring();

                    showMainApp();
                    updateUserDisplay();
                    updateNavButtons();
                    loadApplications();
                    loadApprovers();


                } else {
                    document.getElementById('loginError').textContent = result.message;
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                hideNetworkStatus();

                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
                let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
                if (error.status === 'TIMEOUT') {
                    errorMessage = 'ç™»å½•è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                }

                document.getElementById('loginError').textContent = errorMessage;
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            const email = document.getElementById('newUserEmail').value;
            const userCode = document.getElementById('newUserCode').value;

            // éªŒè¯æ·»åŠ ç”¨æˆ·è¡¨å•
            const addUserValidationResult = validateAddUserForm(username, password, role, email, userCode);
            if (!addUserValidationResult.isValid) {
                showValidationError(addUserValidationResult.errors);
                return;
            }

            // æ ¹æ®è§’è‰²è®¾ç½®éƒ¨é—¨ï¼Œåªæœ‰adminè§’è‰²ä¸éœ€è¦éƒ¨é—¨
            let department = '';
            if (role === 'admin') {
                department = '';
            } else {
                department = document.getElementById('newUserDepartment').value;
                // éªŒè¯éƒ¨é—¨å­—æ®µï¼ˆå¯¹äºéœ€è¦éƒ¨é—¨çš„è§’è‰²ï¼‰
                if (!department || department.trim() === '') {
                    showValidationError(['è¯·é€‰æ‹©ç”¨æˆ·éƒ¨é—¨']);
                    return;
                }
            }
            const signatureFile = document.getElementById('newUserSignature').files[0];
            const canSubmitApplication = document.getElementById('newUserCanSubmitApplication').checked;

            try {
                // å¦‚æœæœ‰ç­¾åæ–‡ä»¶ï¼Œå…ˆè½¬æ¢ä¸ºbase64
                let signatureData = null;
                if (signatureFile) {
                    signatureData = await readFileAsDataURL(signatureFile);
                }

                const response = await fetch('/addUser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        adminUsername: currentUser,
                        username,
                        password,
                        role,
                        email,
                        department,
                        userCode,
                        signature: signatureData,
                        canSubmitApplication
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('ç”¨æˆ·æ·»åŠ æˆåŠŸ');
                    closeAddUserModal(); // å…³é—­æ¨¡æ€æ¡†
                    await loadUsers();
                    } else {
                    alert('ç”¨æˆ·æ·»åŠ å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                alert('æ·»åŠ ç”¨æˆ·å¤±è´¥');
            }
        });

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
        function showCustomConfirm(message, inputField) {
            return new Promise((resolve) => {
                // è®¾ç½®æ¶ˆæ¯ï¼ˆæ”¯æŒHTMLå†…å®¹ï¼‰
                document.getElementById('customConfirmMessage').innerHTML = message;

                // æ˜¾ç¤ºå¯¹è¯æ¡†
                const modal = document.getElementById('customConfirmModal');
                modal.classList.remove('hidden');

                // ç¡®è®¤æŒ‰é’®äº‹ä»¶
                const yesButton = document.getElementById('customConfirmYes');
                const noButton = document.getElementById('customConfirmNo');

                // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
                const newYesButton = yesButton.cloneNode(true);
                const newNoButton = noButton.cloneNode(true);
                yesButton.parentNode.replaceChild(newYesButton, yesButton);
                noButton.parentNode.replaceChild(newNoButton, noButton);

                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newYesButton.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    resolve(true);
                });

                newNoButton.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    if (inputField) {
                        inputField.focus();
                    }
                    resolve(false);
                });
            });
        }

        // è¯»å–æ–‡ä»¶ä¸ºDataURL (base64)
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                const maxSizeMB = 5; // æœ€å¤§5MB
                const maxSizeBytes = maxSizeMB * 1024 * 1024;

                if (file.size > maxSizeBytes) {
                    reject(new Error(`ç­¾åå›¾ç‰‡è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº${maxSizeMB}MBçš„å›¾ç‰‡`));
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    reject(new Error('è¯·ä¸Šä¼ å›¾ç‰‡æ ¼å¼çš„ç­¾åæ–‡ä»¶'));
                    return;
                }

                const reader = new FileReader();

                // è®¾ç½®è¶…æ—¶
                const timeoutId = setTimeout(() => {
                    reader.abort();
                    reject(new Error('è¯»å–æ–‡ä»¶è¶…æ—¶ï¼Œè¯·å°è¯•ä½¿ç”¨æ›´å°çš„å›¾ç‰‡'));
                }, 10000); // 10ç§’è¶…æ—¶

                reader.onload = () => {
                    clearTimeout(timeoutId);

                    // æ£€æŸ¥ç»“æœæ˜¯å¦æœ‰æ•ˆ
                    if (typeof reader.result !== 'string' || !reader.result.startsWith('data:image/')) {
                        reject(new Error('æ–‡ä»¶æ ¼å¼æ— æ•ˆ'));
                        return;
                    }

                    // æ£€æŸ¥æ•°æ®å¤§å°
                    if (reader.result.length > 5000000) { // å¦‚æœå¤§äº5MB
                        console.warn('ç­¾åæ•°æ®è¿‡å¤§:', reader.result.length, 'å­—èŠ‚');
                        // è¿™é‡Œå¯ä»¥æ·»åŠ å‹ç¼©é€»è¾‘
                    }

                    resolve(reader.result);
                };

                reader.onerror = (error) => {
                    clearTimeout(timeoutId);
                    console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
                    reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                };

                reader.onabort = () => {
                    clearTimeout(timeoutId);
                    reject(new Error('è¯»å–æ–‡ä»¶è¢«ä¸­æ­¢'));
                };

                // å¼€å§‹è¯»å–æ–‡ä»¶
                try {
                    reader.readAsDataURL(file);
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('å¯åŠ¨æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                    reject(new Error('æ— æ³•è¯»å–æ–‡ä»¶: ' + error.message));
                }
            });
        }

        // ç”µå­ç­¾åé¢„è§ˆ
        document.getElementById('newUserSignature').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('signaturePreview');
            const image = document.getElementById('signatureImage');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    image.src = event.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        });

        // æ¸…é™¤ç”µå­ç­¾å
        document.getElementById('clearSignature').addEventListener('click', function() {
            document.getElementById('newUserSignature').value = '';
            document.getElementById('signaturePreview').classList.add('hidden');
        });

        document.getElementById('applicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // ä¸¥æ ¼éªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µ
            const validationResult = validateApplicationForm();
            if (!validationResult.isValid) {
                // æ˜¾ç¤ºéªŒè¯é”™è¯¯ä¿¡æ¯
                showValidationError(validationResult.errors);
                return;
            }

            // æ˜¾ç¤º"æ­£åœ¨æäº¤"çŠ¶æ€
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnSpinner = document.getElementById('submitBtnSpinner');

            // ä¿å­˜åŸå§‹çŠ¶æ€
            const originalText = submitBtnText.textContent;
            const originalDisabled = submitBtn.disabled;

            // è®¾ç½®æäº¤ä¸­çŠ¶æ€
            submitBtn.disabled = true;
            submitBtnText.textContent = 'æ­£åœ¨æäº¤...';
            submitBtnSpinner.classList.remove('hidden');

            // å®šä¹‰æ¢å¤æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
            const restoreButtonState = () => {
                submitBtn.disabled = originalDisabled;
                submitBtnText.textContent = originalText;
                submitBtnSpinner.classList.add('hidden');
            };

            // æ£€æŸ¥é‡‘é¢å­—æ®µæ˜¯å¦ä¸ºç©º
            const amountField = document.getElementById('amount');
            const amountValue = amountField.value;
            if (!amountValue || amountValue.trim() === '') {
                // å¦‚æœé‡‘é¢ä¸ºç©ºï¼Œå¼¹å‡ºè‡ªå®šä¹‰ç¡®è®¤æ¡†
                const confirmed = await showCustomConfirm('æ‚¨æœªå¡«å†™ç”³è¯·/é‡‡è´­é‡‘é¢ï¼Œç‚¹å‡»<span class="text-blue-600 font-bold">ç¡®è®¤</span>åˆ™ç›´æ¥æäº¤ç”³è¯·ï¼Œç‚¹å‡»<span class="text-gray-800 font-bold">è¿”å›å¡«å†™</span>å®Œæˆé‡‘é¢å¡«å†™', amountField);
                if (!confirmed) {
                    // ç”¨æˆ·ç‚¹å‡»"è¿”å›å¡«å†™"ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€å¹¶ä¸ç»§ç»­æäº¤
                    restoreButtonState();
                    return;
                }
                // ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤"ï¼Œç»§ç»­æäº¤
            }

            const formData = new FormData();
            const files = document.getElementById('attachments').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('attachments', files[i]);
            }

            try {
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const uploadResult = await uploadResponse.json();
                if (uploadResult.success) {
                    // è·å–é€‰ä¸­çš„å‚é•¿
                    const selectedDirectors = getSelectedDirectors(document.getElementById('directorsList'));

                    const application = {
                        applicant: currentUser, // ä½¿ç”¨å½“å‰ç”¨æˆ·ä½œä¸ºç”³è¯·äºº
                        department: document.getElementById('department').value,
                        date: document.getElementById('applyDate').value,
                        content: document.getElementById('content').value,
                        amount: document.getElementById('amount').value || null,
                        currency: document.getElementById('currency').value,
                        priority: document.getElementById('priority').value,
                        attachments: uploadResult.files,
                        username: currentUser,
                        selectedDirectors: selectedDirectors
                    };

                    const submitResponse = await fetch('/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(application)
                    });
                    const submitResult = await submitResponse.json();
                    if (submitResult.success) {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        restoreButtonState();

                        resetForm();
                        alert('ç”³è¯·æäº¤æˆåŠŸï¼');

                        // æ¸…ç†ç›¸å…³ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æ›´æ–°
                        clearAllCaches();

                        // æ›´æ–°æœ¬åœ°åº”ç”¨æ•°æ®
                        if (submitResult.application) {
                            // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„åº”ç”¨æ•°æ®ç”Ÿæˆç”³è¯·ä¹¦æ¨¡æ¿
                            generateApplicationTemplate(submitResult.application);
                        }

                        // åˆ·æ–°å½“å‰é¡µé¢çš„æ•°æ®æ˜¾ç¤º
                        const currentSection = getCurrentSection();
                        if (currentSection === 'history') {
                            updateHistoryList();
                        }
                    } else {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        restoreButtonState();
                        alert('æäº¤å¤±è´¥ï¼š' + submitResult.message);
                    }
                } else {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    restoreButtonState();
                    alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š' + uploadResult.message);
                }
            } catch (error) {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                restoreButtonState();
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼š' + error.message);
            }
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // éªŒè¯ç¼–è¾‘è¡¨å•çš„æ•°æ®
            const editValidationResult = validateEditForm();
            if (!editValidationResult.isValid) {
                // æ˜¾ç¤ºéªŒè¯é”™è¯¯ä¿¡æ¯
                showValidationError(editValidationResult.errors);
                return;
            }

            const formData = new FormData();
            const files = document.getElementById('editAttachments').files;

            // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
            const editFileList = document.getElementById('editFileList');
            if (files.length > 0) {
                editFileList.innerHTML += '<div class="mt-2 text-blue-600">é™„ä»¶ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™...</div>';
            }

            for (let i = 0; i < files.length; i++) {
                formData.append('attachments', files[i]);
            }
            formData.append('id', document.getElementById('editId').value);
            formData.append('username', currentUser);
            formData.append('role', currentRole);
            formData.append('applicant', document.getElementById('editApplicant').value);
            formData.append('department', document.getElementById('editApplicationDepartment').value);
            formData.append('date', document.getElementById('editDate').value);
            formData.append('content', document.getElementById('editContent').value);
            formData.append('amount', document.getElementById('editAmount').value || '');
            formData.append('currency', document.getElementById('editCurrency').value);
            formData.append('priority', document.getElementById('editPriority').value);

            // è·å–é€‰ä¸­çš„å‚é•¿
            const selectedDirectors = getSelectedDirectors(document.getElementById('editDirectorsList'));
            formData.append('selectedDirectors', JSON.stringify(selectedDirectors));

            try {
                const response = await fetch('/modify', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    closeEditModal();
                    alert('ç”³è¯·ä¿®æ”¹æˆåŠŸ');

                    // æ›´æ–°æœ¬åœ°åº”ç”¨æ•°æ®
                    const appId = parseInt(document.getElementById('editId').value);
                    const appIndex = applications.findIndex(a => a.id === appId);
                    if (appIndex !== -1 && result.application) {
                        // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„æ›´æ–°åçš„åº”ç”¨æ•°æ®
                        applications[appIndex] = result.application;

                        // æ›´æ–°å½“å‰è§†å›¾
                        updateCurrentView();
                    } else {
                        // å¦‚æœæœåŠ¡å™¨æ²¡æœ‰è¿”å›æ›´æ–°åçš„åº”ç”¨æ•°æ®ï¼Œåˆ™é‡æ–°åŠ è½½æ‰€æœ‰åº”ç”¨
                        await loadApplications();

                        // æ›´æ–°å½“å‰è§†å›¾
                        updateCurrentView();
                    }
                } else {
                    alert('ä¿®æ”¹å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                alert('ä¿®æ”¹å¤±è´¥');
            }
        });

        // ä¸¥æ ¼éªŒè¯ç”³è¯·è¡¨å•çš„æ‰€æœ‰å¿…å¡«å­—æ®µ
        function validateApplicationForm() {
            const errors = [];

            // éªŒè¯ç”³è¯·äººå§“å
            const applicant = document.getElementById('applicant').value;
            if (!applicant || applicant.trim() === '') {
                errors.push('ç”³è¯·äººå§“åä¸èƒ½ä¸ºç©º');
            } else if (applicant.trim().length < 2) {
                errors.push('ç”³è¯·äººå§“åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
            }

            // éªŒè¯ç”³è¯·éƒ¨é—¨
            const department = document.getElementById('department').value;
            if (!department || department.trim() === '') {
                errors.push('ç”³è¯·éƒ¨é—¨ä¸èƒ½ä¸ºç©º');
            }

            // éªŒè¯ç”³è¯·æ—¥æœŸ
            const date = document.getElementById('applyDate').value;
            if (!date || date.trim() === '') {
                errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½ä¸ºç©º');
            } else {
                // éªŒè¯æ—¥æœŸæ ¼å¼å’Œåˆç†æ€§
                const selectedDate = new Date(date);
                const today = new Date();
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(today.getFullYear() - 1);
                const oneYearLater = new Date();
                oneYearLater.setFullYear(today.getFullYear() + 1);

                if (isNaN(selectedDate.getTime())) {
                    errors.push('ç”³è¯·æ—¥æœŸæ ¼å¼æ— æ•ˆ');
                } else if (selectedDate < oneYearAgo) {
                    errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½æ—©äºä¸€å¹´å‰');
                } else if (selectedDate > oneYearLater) {
                    errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½æ™šäºä¸€å¹´å');
                }
            }

            // éªŒè¯ç”³è¯·å†…å®¹
            const content = document.getElementById('content').value;
            if (!content || content.trim() === '') {
                errors.push('ç”³è¯·å†…å®¹ä¸èƒ½ä¸ºç©º');
            } else if (content.trim().length < 10) {
                errors.push('ç”³è¯·å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
            } else if (content.trim().length > 2000) {
                errors.push('ç”³è¯·å†…å®¹ä¸èƒ½è¶…è¿‡2000ä¸ªå­—ç¬¦');
            }

            // éªŒè¯é‡‘é¢ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            const amount = document.getElementById('amount').value;
            if (amount && amount.trim() !== '') {
                const amountNum = parseFloat(amount);
                if (isNaN(amountNum)) {
                    errors.push('ç”³è¯·é‡‘é¢å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—');
                } else if (amountNum < 0) {
                    errors.push('ç”³è¯·é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°');
                } else if (amountNum > 99999999) {
                    errors.push('ç”³è¯·é‡‘é¢ä¸èƒ½è¶…è¿‡99,999,999');
                }
            }

            // éªŒè¯ä¼˜å…ˆçº§
            const priority = document.getElementById('priority').value;
            if (!priority || priority.trim() === '') {
                errors.push('è¯·é€‰æ‹©ç”³è¯·ä¼˜å…ˆçº§');
            }

            // éªŒè¯å‚é•¿é€‰æ‹©
            const selectedDirectors = getSelectedDirectors(document.getElementById('directorsList'));
            if (!selectedDirectors || selectedDirectors.length === 0) {
                errors.push('è¯·è‡³å°‘é€‰æ‹©ä¸€ä½å‚é•¿è¿›è¡Œå®¡æ‰¹');
            }

            // å¸ç§å­—æ®µæœ‰é»˜è®¤å€¼ï¼Œä¸éœ€è¦éªŒè¯

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // éªŒè¯ç¼–è¾‘è¡¨å•çš„æ‰€æœ‰å¿…å¡«å­—æ®µ
        function validateEditForm() {
            const errors = [];

            // éªŒè¯ç”³è¯·äººå§“å
            const applicant = document.getElementById('editApplicant').value;
            if (!applicant || applicant.trim() === '') {
                errors.push('ç”³è¯·äººå§“åä¸èƒ½ä¸ºç©º');
            } else if (applicant.trim().length < 2) {
                errors.push('ç”³è¯·äººå§“åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
            }

            // éªŒè¯ç”³è¯·éƒ¨é—¨
            const department = document.getElementById('editApplicationDepartment').value;
            if (!department || department.trim() === '') {
                errors.push('ç”³è¯·éƒ¨é—¨ä¸èƒ½ä¸ºç©º');
            }

            // éªŒè¯ç”³è¯·æ—¥æœŸ
            const date = document.getElementById('editDate').value;
            if (!date || date.trim() === '') {
                errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½ä¸ºç©º');
            } else {
                // éªŒè¯æ—¥æœŸæ ¼å¼å’Œåˆç†æ€§
                const selectedDate = new Date(date);
                const today = new Date();
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(today.getFullYear() - 1);
                const oneYearLater = new Date();
                oneYearLater.setFullYear(today.getFullYear() + 1);

                if (isNaN(selectedDate.getTime())) {
                    errors.push('ç”³è¯·æ—¥æœŸæ ¼å¼æ— æ•ˆ');
                } else if (selectedDate < oneYearAgo) {
                    errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½æ—©äºä¸€å¹´å‰');
                } else if (selectedDate > oneYearLater) {
                    errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½æ™šäºä¸€å¹´å');
                }
            }

            // éªŒè¯ç”³è¯·å†…å®¹
            const content = document.getElementById('editContent').value;
            if (!content || content.trim() === '') {
                errors.push('ç”³è¯·å†…å®¹ä¸èƒ½ä¸ºç©º');
            } else if (content.trim().length < 10) {
                errors.push('ç”³è¯·å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
            } else if (content.trim().length > 2000) {
                errors.push('ç”³è¯·å†…å®¹ä¸èƒ½è¶…è¿‡2000ä¸ªå­—ç¬¦');
            }

            // éªŒè¯é‡‘é¢ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            const amount = document.getElementById('editAmount').value;
            if (amount && amount.trim() !== '') {
                const amountNum = parseFloat(amount);
                if (isNaN(amountNum)) {
                    errors.push('ç”³è¯·é‡‘é¢å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—');
                } else if (amountNum < 0) {
                    errors.push('ç”³è¯·é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°');
                } else if (amountNum > 99999999) {
                    errors.push('ç”³è¯·é‡‘é¢ä¸èƒ½è¶…è¿‡99,999,999');
                }
            }

            // éªŒè¯ä¼˜å…ˆçº§
            const priority = document.getElementById('editPriority').value;
            if (!priority || priority.trim() === '') {
                errors.push('è¯·é€‰æ‹©ç”³è¯·ä¼˜å…ˆçº§');
            }

            // å¸ç§å­—æ®µæœ‰é»˜è®¤å€¼ï¼Œä¸éœ€è¦éªŒè¯

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // éªŒè¯æ·»åŠ ç”¨æˆ·è¡¨å•çš„æ‰€æœ‰å¿…å¡«å­—æ®µ
        function validateAddUserForm(username, password, role, email, userCode) {
            const errors = [];

            // éªŒè¯ç”¨æˆ·å
            if (!username || username.trim() === '') {
                errors.push('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
            } else if (username.trim().length < 3) {
                errors.push('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
            } else if (username.trim().length > 20) {
                errors.push('ç”¨æˆ·åä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
            }

            // éªŒè¯å¯†ç  - åªéªŒè¯å¯†ç è‡³å°‘6ä½æ•°
            if (!password || password.trim() === '') {
                errors.push('å¯†ç ä¸èƒ½ä¸ºç©º');
            } else if (password.length < 6) {
                errors.push('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
            } else if (password.length > 50) {
                errors.push('å¯†ç ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦');
            }

            // éªŒè¯è§’è‰²
            if (!role || role.trim() === '') {
                errors.push('è¯·é€‰æ‹©ç”¨æˆ·è§’è‰²');
            } else {
                const validRoles = ['user', 'director', 'chief', 'manager', 'ceo', 'admin', 'readonly'];
                if (!validRoles.includes(role)) {
                    errors.push('ç”¨æˆ·è§’è‰²å€¼æ— æ•ˆ');
                }
            }

            // éªŒè¯é‚®ç®±ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            if (email && email.trim() !== '') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email.trim())) {
                    errors.push('é‚®ç®±åœ°å€æ ¼å¼æ— æ•ˆ');
                }
            }

            // éªŒè¯ç”¨æˆ·ç¼–å·ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            if (userCode && userCode.trim() !== '') {
                if (userCode.trim().length > 20) {
                    errors.push('ç”¨æˆ·ç¼–å·ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
                }
                if (!/^[A-Za-z0-9]{6}$/.test(userCode.trim())) {
                    errors.push('ç”¨æˆ·ä»£ç å¿…é¡»æ˜¯6ä½å­—æ¯æˆ–æ•°å­—ç»„åˆ');
                }
            }

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // éªŒè¯é¢„è§ˆç”³è¯·ä¹¦æ¨¡æ¿çš„æ•°æ®
        function validatePreviewData(applicant, department, date, content) {
            const errors = [];

            // éªŒè¯ç”³è¯·äººå§“å
            if (!applicant || applicant.trim() === '') {
                errors.push('ç”³è¯·äººå§“åä¸èƒ½ä¸ºç©º');
            } else if (applicant.trim().length < 2) {
                errors.push('ç”³è¯·äººå§“åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
            }

            // éªŒè¯ç”³è¯·éƒ¨é—¨
            if (!department || department.trim() === '') {
                errors.push('ç”³è¯·éƒ¨é—¨ä¸èƒ½ä¸ºç©º');
            }

            // éªŒè¯ç”³è¯·æ—¥æœŸ
            if (!date || date.trim() === '') {
                errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½ä¸ºç©º');
            } else {
                // éªŒè¯æ—¥æœŸæ ¼å¼å’Œåˆç†æ€§
                const selectedDate = new Date(date);
                const today = new Date();
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(today.getFullYear() - 1);
                const oneYearLater = new Date();
                oneYearLater.setFullYear(today.getFullYear() + 1);

                if (isNaN(selectedDate.getTime())) {
                    errors.push('ç”³è¯·æ—¥æœŸæ ¼å¼æ— æ•ˆ');
                } else if (selectedDate < oneYearAgo) {
                    errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½æ—©äºä¸€å¹´å‰');
                } else if (selectedDate > oneYearLater) {
                    errors.push('ç”³è¯·æ—¥æœŸä¸èƒ½æ™šäºä¸€å¹´å');
                }
            }

            // éªŒè¯ç”³è¯·å†…å®¹
            if (!content || content.trim() === '') {
                errors.push('ç”³è¯·å†…å®¹ä¸èƒ½ä¸ºç©º');
            } else if (content.trim().length < 10) {
                errors.push('ç”³è¯·å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
            } else if (content.trim().length > 2000) {
                errors.push('ç”³è¯·å†…å®¹ä¸èƒ½è¶…è¿‡2000ä¸ªå­—ç¬¦');
            }

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // æ˜¾ç¤ºéªŒè¯é”™è¯¯ä¿¡æ¯
        function showValidationError(errors) {
            const errorMessage = 'è¯·ä¿®æ­£ä»¥ä¸‹é—®é¢˜åå†æäº¤ï¼š\n\n' + errors.map((error, index) => `${index + 1}. ${error}`).join('\n');

            // ç§»åŠ¨ç«¯ä¼˜åŒ–çš„é”™è¯¯æç¤º
            if (window.innerWidth <= 768) {
                showMobileAlert(errorMessage);
            } else {
                alert(errorMessage);
            }
        }

        function resetForm() {
            document.getElementById('applicationForm').reset();
            document.getElementById('attachments').value = '';
            updateFileList([]);

            // é‡ç½®å‚é•¿é€‰æ‹©åˆ—è¡¨
            renderDirectorsList(document.getElementById('directorsList'), []);

            // é‡æ–°è®¾ç½®ç”³è¯·äººå§“åä¸ºå½“å‰ç”¨æˆ·
            document.getElementById('applicant').value = currentUser;

            // é‡æ–°è®¾ç½®ç”³è¯·éƒ¨é—¨ä¸ºå½“å‰ç”¨æˆ·çš„éƒ¨é—¨
            if (currentDepartment) {
                const departmentInput = document.getElementById('department');
                if (departmentInput) {
                    departmentInput.value = currentDepartment;
                }
            }
        }

        // åº”ç”¨æ•°æ®ç¼“å­˜ - å¢å¼ºç‰ˆ
        let applicationsCache = {
            data: [],
            pagination: null,
            lastPage: 0,
            sortBy: 'date',
            sortOrder: 'desc',
            preloadedPages: new Map(), // é¢„åŠ è½½çš„é¡µé¢æ•°æ®ç¼“å­˜
            pageCache: new Map() // é¡µé¢æ•°æ®ç¼“å­˜ï¼škeyä¸º"page-sortBy-sortOrder"ï¼Œvalueä¸º{data, pagination, timestamp}
        };

        // å¾…å®¡æ ¸æ•°æ®ç¼“å­˜
        let pendingCache = {
            pageCache: new Map(), // é¡µé¢æ•°æ®ç¼“å­˜
            lastUpdate: 0
        };

        // å·²å®¡æ ¸æ•°æ®ç¼“å­˜
        let approvedCache = {
            pageCache: new Map(), // é¡µé¢æ•°æ®ç¼“å­˜
            lastUpdate: 0,
            lastTimeRange: 'all',
            lastStatusFilter: 'all'
        };

        // æ¸…ç†æ‰€æœ‰å®¡æ ¸ç›¸å…³ç¼“å­˜
        function clearAllApprovalCaches() {
            pendingCache.pageCache.clear();
            approvedCache.pageCache.clear();
            pendingCache.lastUpdate = 0;
            approvedCache.lastUpdate = 0;
            console.debug('æ‰€æœ‰å®¡æ ¸ç¼“å­˜å·²æ¸…ç†');
        }

        // è‡ªåŠ¨åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨çš„å®šæ—¶å™¨
        let autoRefreshTimer = null;
        const AUTO_REFRESH_INTERVAL = 1 * 60 * 1000; // 1åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡(ä»2åˆ†é’Ÿä¼˜åŒ–ä¸º1åˆ†é’Ÿ)

        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
        function startPendingApprovalAutoRefresh() {
            // æ¸…é™¤å·²å­˜åœ¨çš„å®šæ—¶å™¨
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }

            // è®¾ç½®å®šæ—¶å™¨,æ¯1åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡å¾…å®¡æ ¸åˆ—è¡¨
            autoRefreshTimer = setInterval(() => {
                // åªåœ¨å¾…å®¡æ ¸é¡µé¢æ—¶åˆ·æ–°
                const currentSection = getCurrentSection();
                if (currentSection === 'pendingApproval') {
                    console.log('è‡ªåŠ¨åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨...');
                    // æ¸…ç†å¾…å®¡æ ¸ç¼“å­˜
                    clearPendingCache();
                    // åˆ·æ–°åˆ—è¡¨
                    updatePendingApprovalList();
                    // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                    updatePendingCount();
                }
            }, AUTO_REFRESH_INTERVAL);

            console.log('å·²å¯åŠ¨å¾…å®¡æ ¸åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°,é—´éš”:', AUTO_REFRESH_INTERVAL / 1000, 'ç§’');
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopPendingApprovalAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                console.log('å·²åœæ­¢å¾…å®¡æ ¸åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°');
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
        async function manualRefreshPendingList() {
            const btn = document.getElementById('manualRefreshBtn');
            if (!btn) return;

            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (btn.disabled) return;

            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                btn.disabled = true;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `
                    <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    åˆ·æ–°ä¸­...
                `;

                // æ¸…ç†å¾…å®¡æ ¸ç¼“å­˜
                clearPendingCache();

                // åˆ·æ–°åˆ—è¡¨
                await updatePendingApprovalList();

                // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                await updatePendingCount();

                // æ¢å¤æŒ‰é’®
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            } catch (error) {
                console.error('æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
                // æ¢å¤æŒ‰é’®
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    åˆ·æ–°
                `;
                btn.disabled = false;
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ç­¾åæ•°æ®ç¼“å­˜ç®¡ç†ç³»ç»Ÿ
        let signatureCache = {
            data: new Map(), // ç­¾åæ•°æ®ç¼“å­˜ï¼škeyä¸ºusernameï¼Œvalueä¸º{signature, timestamp, version}
            version: 0, // å…¨å±€ç‰ˆæœ¬å·
            lastUpdate: 0,
            cacheValidTime: 24 * 60 * 60 * 1000, // 24å°æ—¶ç¼“å­˜æœ‰æ•ˆæœŸ
            storageKey: 'signatureCache_v2' // localStorageå­˜å‚¨é”®
        };

        // ç­¾åç¼“å­˜ç®¡ç†å‡½æ•°
        function initSignatureCache() {
            try {
                const cached = localStorage.getItem(signatureCache.storageKey);
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                    if (Date.now() - parsedCache.lastUpdate < signatureCache.cacheValidTime) {
                        signatureCache.data = new Map(parsedCache.data);
                        signatureCache.version = parsedCache.version || 0;
                        signatureCache.lastUpdate = parsedCache.lastUpdate;
                        console.debug(`ç­¾åç¼“å­˜å·²åŠ è½½ï¼ŒåŒ…å« ${signatureCache.data.size} ä¸ªç­¾å`);
                        return true;
                    }
                }
            } catch (error) {
                console.warn('åŠ è½½ç­¾åç¼“å­˜å¤±è´¥:', error);
            }
            return false;
        }

        function saveSignatureCache() {
            try {
                const cacheData = {
                    data: Array.from(signatureCache.data.entries()),
                    version: signatureCache.version,
                    lastUpdate: Date.now()
                };
                localStorage.setItem(signatureCache.storageKey, JSON.stringify(cacheData));
                signatureCache.lastUpdate = Date.now();
            } catch (error) {
                console.warn('ä¿å­˜ç­¾åç¼“å­˜å¤±è´¥:', error);
            }
        }

        function getSignatureFromCache(username) {
            const cached = signatureCache.data.get(username);
            if (cached && (Date.now() - cached.timestamp < signatureCache.cacheValidTime)) {
                return cached.signature;
            }
            return null;
        }

        function setSignatureToCache(username, signature) {
            signatureCache.data.set(username, {
                signature: signature,
                timestamp: Date.now(),
                version: ++signatureCache.version
            });
            saveSignatureCache();
        }

        function clearSignatureCache() {
            signatureCache.data.clear();
            signatureCache.version = 0;
            localStorage.removeItem(signatureCache.storageKey);
            console.debug('ç­¾åç¼“å­˜å·²æ¸…ç†');
        }

        // ç¼“å­˜ç®¡ç†å‡½æ•°
        function clearAllCaches() {
            applicationsCache.pageCache.clear();
            pendingCache.pageCache.clear();
            approvedCache.pageCache.clear();
            clearSignatureCache();
            console.debug('æ‰€æœ‰ç¼“å­˜å·²æ¸…ç†');
        }

        function clearApplicationsCache() {
            applicationsCache.pageCache.clear();
            console.debug('ç”³è¯·è®°å½•ç¼“å­˜å·²æ¸…ç†');
        }

        function clearPendingCache() {
            pendingCache.pageCache.clear();
            console.debug('å¾…å®¡æ ¸ç¼“å­˜å·²æ¸…ç†');
        }

        function clearApprovedCache() {
            approvedCache.pageCache.clear();
            console.debug('å·²å®¡æ ¸ç¼“å­˜å·²æ¸…ç†');
        }

        // éé˜»å¡ä¿å­˜æŒ‡ç¤ºå™¨
        function showSavingIndicator(message = 'æ­£åœ¨ä¿å­˜...') {
            // ç§»é™¤ç°æœ‰çš„ä¿å­˜æŒ‡ç¤ºå™¨
            hideSavingIndicator();

            const indicator = document.createElement('div');
            indicator.id = 'savingIndicator';
            indicator.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2';
            indicator.innerHTML = `
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                <span>${message}</span>
            `;
            document.body.appendChild(indicator);
        }

        function hideSavingIndicator() {
            const indicator = document.getElementById('savingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // ä¸´æ—¶æ¶ˆæ¯ç³»ç»Ÿ
        function showTemporaryMessage(message, type = 'info', duration = 3000) {
            const messageId = 'tempMessage_' + Date.now();
            const typeClasses = {
                'success': 'bg-green-600 text-white',
                'error': 'bg-red-600 text-white',
                'warning': 'bg-yellow-600 text-white',
                'info': 'bg-blue-600 text-white'
            };

            const messageEl = document.createElement('div');
            messageEl.id = messageId;
            messageEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${typeClasses[type] || typeClasses.info} transform transition-all duration-300 translate-x-full`;
            messageEl.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">âœ•</button>
                </div>
            `;

            document.body.appendChild(messageEl);

            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                messageEl.classList.remove('translate-x-full');
            }, 10);

            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                if (document.getElementById(messageId)) {
                    messageEl.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (document.getElementById(messageId)) {
                            messageEl.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // å®æ—¶éªŒè¯å‡½æ•°
        function validateUserCodeRealtime(input) {
            const value = input.value.trim();
            const errorEl = document.getElementById('editUserCodeError');

            if (value === '') {
                errorEl.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }

            if (!/^[A-Za-z0-9]{6}$/.test(value)) {
                errorEl.textContent = 'ç”¨æˆ·ä»£ç å¿…é¡»æ˜¯6ä½å­—æ¯æˆ–æ•°å­—ç»„åˆ';
                errorEl.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–ç”¨æˆ·é‡å¤
            const targetUsername = document.getElementById('editTargetUsername').value;
            const isDuplicate = allUsers.some(u => u.userCode === value && u.username !== targetUsername);

            if (isDuplicate) {
                errorEl.textContent = 'ç”¨æˆ·ä»£ç å·²å­˜åœ¨';
                errorEl.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            }

            errorEl.classList.add('hidden');
            input.classList.remove('border-red-500');
            return true;
        }

        function validateEmailRealtime(input) {
            const value = input.value.trim();
            const errorEl = document.getElementById('editEmailError');

            if (value === '') {
                errorEl.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                errorEl.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
                errorEl.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            }

            errorEl.classList.add('hidden');
            input.classList.remove('border-red-500');
            return true;
        }

        function validatePasswordRealtime(input) {
            const value = input.value;
            const errorEl = document.getElementById('editPasswordError');

            if (value === '') {
                errorEl.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }

            if (value.length < 6) {
                errorEl.textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦';
                errorEl.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            }

            errorEl.classList.add('hidden');
            input.classList.remove('border-red-500');
            return true;
        }

        // éªŒè¯æ•´ä¸ªè¡¨å•
        function validateEditUserForm() {
            const userCodeInput = document.getElementById('editUserCode');
            const emailInput = document.getElementById('editEmail');
            const passwordInput = document.getElementById('editPassword');

            const isUserCodeValid = validateUserCodeRealtime(userCodeInput);
            const isEmailValid = validateEmailRealtime(emailInput);
            const isPasswordValid = validatePasswordRealtime(passwordInput);

            return isUserCodeValid && isEmailValid && isPasswordValid;
        }

        // æŒ‰éœ€åŠ è½½å•ä¸ªç”¨æˆ·ç­¾å
        async function loadUserSignature(username) {
            // é¦–å…ˆæ£€æŸ¥ç¼“å­˜
            const cachedSignature = getSignatureFromCache(username);
            if (cachedSignature) {
                console.debug(`ä½¿ç”¨ç¼“å­˜ç­¾å: ${username}`);
                return cachedSignature;
            }

            try {
                // ä»æœåŠ¡å™¨è·å–å•ä¸ªç”¨æˆ·ç­¾å
                const response = await apiRequest(`/user-signature?username=${username}&requestUser=${currentUser}`, {
                    method: 'GET',
                    timeout: 5000
                });

                if (response && response.signature) {
                    // å­˜å‚¨åˆ°ç¼“å­˜
                    setSignatureToCache(username, response.signature);
                    console.debug(`å·²åŠ è½½å¹¶ç¼“å­˜ç­¾å: ${username}`);
                    return response.signature;
                }
            } catch (error) {
                console.warn(`åŠ è½½ç”¨æˆ·ç­¾åå¤±è´¥: ${username}`, error);
            }

            return null;
        }

        // æ‰¹é‡æŒ‰éœ€åŠ è½½å¤šä¸ªç”¨æˆ·ç­¾å
        async function loadMultipleSignatures(usernames) {
            const signatures = {};
            const needToLoad = [];

            // æ£€æŸ¥å“ªäº›ç­¾åéœ€è¦ä»æœåŠ¡å™¨åŠ è½½
            for (const username of usernames) {
                const cachedSignature = getSignatureFromCache(username);
                if (cachedSignature) {
                    signatures[username] = cachedSignature;
                } else {
                    needToLoad.push(username);
                }
            }

            // å¦‚æœæœ‰éœ€è¦åŠ è½½çš„ç­¾åï¼Œæ‰¹é‡åŠ è½½
            if (needToLoad.length > 0) {
                try {
                    const response = await apiRequest(`/batch-signatures?usernames=${needToLoad.join(',')}&requestUser=${currentUser}`, {
                        method: 'GET',
                        timeout: 10000
                    });

                    if (response && response.signatures) {
                        // å­˜å‚¨åˆ°ç¼“å­˜å¹¶è¿”å›
                        for (const [username, signature] of Object.entries(response.signatures)) {
                            if (signature) {
                                setSignatureToCache(username, signature);
                                signatures[username] = signature;
                            }
                        }
                        console.debug(`æ‰¹é‡åŠ è½½ç­¾åå®Œæˆ: ${needToLoad.length}ä¸ªç”¨æˆ·`);
                    }
                } catch (error) {
                    console.warn('æ‰¹é‡åŠ è½½ç­¾åå¤±è´¥:', error);
                }
            }

            return signatures;
        }

        // è·å–å½“å‰æ´»åŠ¨çš„é¡µé¢
        function getCurrentSection() {
            const sections = ['history', 'pendingApproval', 'approved', 'manageUsers', 'systemSettings'];
            for (const section of sections) {
                const element = document.getElementById(section);
                if (element && !element.classList.contains('hidden')) {
                    return section;
                }
            }
            return 'history'; // é»˜è®¤è¿”å›ç”³è¯·è®°å½•é¡µé¢
        }

        // åŠ è½½åº”ç”¨æ•°æ® - æ™ºèƒ½ç¼“å­˜ç‰ˆ
        async function loadApplications(page = 1, pageSize = 10, sortBy = 'date', sortOrder = 'desc', updateView = true, showError = true) {
            const startTime = performance.now(); // æ€§èƒ½ç›‘æ§

            try {
                // æ£€æŸ¥ç¼“å­˜
                const cacheKey = `${page}-${sortBy}-${sortOrder}`;
                const cachedData = applicationsCache.pageCache.get(cacheKey);
                const cacheValidTime = 30000; // ç¼“å­˜æœ‰æ•ˆæœŸ30ç§’

                if (cachedData && (Date.now() - cachedData.timestamp < cacheValidTime)) {
                    // ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œç«‹å³æ˜¾ç¤º
                    applicationsCache.data = cachedData.data;
                    applicationsCache.pagination = cachedData.pagination;
                    applicationsCache.lastPage = page;
                    applicationsCache.sortBy = sortBy;
                    applicationsCache.sortOrder = sortOrder;
                    applications = cachedData.data;

                    // ç«‹å³æ›´æ–°è§†å›¾
                    if (updateView) {
                        const currentSection = getCurrentSection();
                        if (currentSection === 'history') {
                            const tbody = document.getElementById('applicationsList');
                            renderApplicationsList(cachedData.data, tbody);
                            calculateTotalAmount(cachedData.data);
                            updateHistoryPagination(cachedData.pagination.currentPage, cachedData.pagination.totalPages, cachedData.pagination.totalItems);
                        }
                    }

                    console.debug(`ä½¿ç”¨ç¼“å­˜æ•°æ® - é¡µé¢: ${page}, æ•°æ®é‡: ${cachedData.data.length}æ¡`);
                    return applications;
                }

                // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆä½†åªåœ¨å¿…è¦æ—¶æ˜¾ç¤ºï¼‰
                if (updateView && showError) {
                    const tbody = document.getElementById('applicationsList');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="ml-2">åŠ è½½ä¸­...</span></div></td></tr>';
                    }
                }

                // æ„å»ºè¯·æ±‚URL
                const params = new URLSearchParams({
                    username: currentUser,
                    page: page.toString(),
                    pageSize: pageSize.toString(),
                    sortBy: sortBy,
                    sortOrder: sortOrder
                });

                // ä½¿ç”¨ä¼˜åŒ–çš„APIè¯·æ±‚å·¥å…·
                const response = await apiRequest(`/applications?${params.toString()}`, {
                    method: 'GET',
                    timeout: 8000,
                    retry: {
                        maxRetries: 2,
                        retryDelay: 500,
                        retryStatusCodes: [0, 408, 429, 500, 502, 503, 504]
                    }
                });

                // éªŒè¯å“åº”æ ¼å¼
                if (!response || !response.data || !Array.isArray(response.data)) {
                    throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                // æ›´æ–°ç¼“å­˜ - å­˜å‚¨åˆ°é¡µé¢ç¼“å­˜ä¸­
                applicationsCache.pageCache.set(cacheKey, {
                    data: response.data,
                    pagination: response.pagination,
                    timestamp: Date.now()
                });

                // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œåªä¿ç•™æœ€è¿‘çš„10é¡µæ•°æ®
                if (applicationsCache.pageCache.size > 10) {
                    const firstKey = applicationsCache.pageCache.keys().next().value;
                    applicationsCache.pageCache.delete(firstKey);
                }

                applicationsCache.data = response.data;
                applicationsCache.pagination = response.pagination;
                applicationsCache.lastPage = page;
                applicationsCache.sortBy = sortBy;
                applicationsCache.sortOrder = sortOrder;

                // ä¸ºäº†å…¼å®¹ç°æœ‰ä»£ç ï¼Œè®¾ç½®å…¨å±€applicationså˜é‡
                applications = response.data;

                // ç­¾åæ•°æ®ç°åœ¨æŒ‰éœ€åŠ è½½ï¼Œä¸åœ¨æ­¤å¤„æå–

                // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                updatePendingCount();

                // æ›´æ–°è§†å›¾
                if (updateView) {
                    // è·å–å½“å‰æ´»åŠ¨çš„é¡µé¢
                    const currentSection = getCurrentSection();
                    if (currentSection === 'history') {
                        // å¦‚æœæ˜¯ç”³è¯·è®°å½•é¡µé¢ï¼Œä½¿ç”¨æ–°çš„åˆ†é¡µæ¸²æŸ“
                        const tbody = document.getElementById('applicationsList');
                        renderApplicationsList(response.data, tbody);
                        calculateTotalAmount(response.data);
                        updateHistoryPagination(response.pagination.currentPage, response.pagination.totalPages, response.pagination.totalItems);
                    } else {
                        // å…¶ä»–é¡µé¢ä¿æŒåŸæœ‰é€»è¾‘
                        const activeSection = document.querySelector('.side-nav-btn.active-indicator');
                        if (activeSection) {
                            const section = activeSection.dataset.section;
                            if (section === 'history') {
                                updateHistoryList();
                            } else if (section === 'pendingApproval') {
                                updatePendingApprovalList();
                            } else if (section === 'approved') {
                                updateApprovedList();
                            } else if (section === 'new') {
                                // ç¡®ä¿æ–°å»ºç”³è¯·è¡¨å•ä¸­çš„ç”³è¯·äººå§“åå’Œéƒ¨é—¨å§‹ç»ˆä¸ºå½“å‰ç”¨æˆ·
                                document.getElementById('applicant').value = currentUser;
                                if (currentDepartment) {
                                    const departmentInput = document.getElementById('department');
                                    if (departmentInput) {
                                        departmentInput.value = currentDepartment;
                                    }
                                }
                            }
                        }
                    }
                }

                // éšè—åŠ è½½çŠ¶æ€
                if (updateView && showError) {
                    hideCenterLoadingIndicator();
                }

                // æ€§èƒ½ç›‘æ§æ—¥å¿—
                const loadTime = performance.now() - startTime;
                console.debug(`æ•°æ®åŠ è½½å®Œæˆ - é¡µé¢: ${page}, è€—æ—¶: ${loadTime.toFixed(2)}ms, æ•°æ®é‡: ${response.data.length}æ¡`);

                return applications;
            } catch (error) {
                console.error('åŠ è½½åº”ç”¨æ•°æ®å¤±è´¥:', error);

                // éšè—åŠ è½½çŠ¶æ€
                if (updateView && showError) {
                    hideCenterLoadingIndicator();
                }

                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„å¤„ç†
                if (error.status === 'TIMEOUT') {
                    if (showError) {
                        showNetworkStatus('ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•...', 'error');
                        // è‡ªåŠ¨é‡è¯•ä¸€æ¬¡
                        setTimeout(() => {
                            loadApplications(1, 10, 'date', 'desc', updateView, false);
                        }, 3000);
                    }
                } else if (error.message && error.message.includes('network')) {
                    if (showError) {
                        showNetworkStatus('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®', 'error');
                    }
                } else {
                    if (showError) {
                        showNetworkStatus('åŠ è½½åº”ç”¨æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    }
                }

                // è¿”å›ç©ºæ•°ç»„ä»¥é¿å…åç»­é”™è¯¯
                return [];
            }
        }

        // å­˜å‚¨åŸå§‹ç”¨æˆ·åˆ—è¡¨å’Œæœç´¢ç»“æœ
        let originalUsers = [];
        let filteredUsers = [];
        let isSearchActive = false;

        async function loadUsers() {
            if (currentRole !== 'admin') return;
            try {
                // ä½¿ç”¨å¢å¼ºçš„APIè¯·æ±‚å·¥å…·
                originalUsers = await apiRequest(`/users?username=${currentUser}`, {
                    method: 'GET',
                    timeout: 15000,
                    retry: {
                        maxRetries: 3,
                        retryDelay: 1500,
                        retryStatusCodes: [0, 408, 429, 500, 502, 503, 504]
                    }
                });

                // éªŒè¯æ•°æ®æ ¼å¼
                if (!Array.isArray(originalUsers)) {
                    throw new Error('æœåŠ¡å™¨è¿”å›çš„ç”¨æˆ·æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                // è·å–ç”¨æˆ·åˆ—è¡¨å¹¶æŒ‰ç”¨æˆ·åè‡ªç„¶æ’åº
                originalUsers.sort((a, b) => a.username.localeCompare(b.username, undefined, { sensitivity: 'base', numeric: true }));
                allUsers = [...originalUsers]; // å¤åˆ¶ä¸€ä»½ç»™allUsers
                currentUserPage = 1; // é‡ç½®ä¸ºç¬¬ä¸€é¡µ
                renderUsersList();
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                showNetworkStatus('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // å…¨å±€å˜é‡æ§åˆ¶è§†å›¾æ¨¡å¼
        let currentViewMode = 'table'; // 'card' æˆ– 'table' - é»˜è®¤è¡¨æ ¼è§†å›¾

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
        function renderUsersList() {
            const startIndex = (currentUserPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = allUsers.slice(startIndex, endIndex);

            if (currentViewMode === 'card') {
                renderUsersCardView(usersToShow);
            } else {
                renderUsersTableView(usersToShow);
            }

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updateUsersPagination();
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updateUsersPagination() {
            const totalPages = Math.ceil(allUsers.length / usersPerPage);
            document.getElementById('currentPage').textContent = currentUserPage;
            document.getElementById('totalPages').textContent = totalPages;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevPageBtn').disabled = currentUserPage === 1;
            document.getElementById('nextPageBtn').disabled = currentUserPage === totalPages;

            // æ›´æ–°æœç´¢çŠ¶æ€æç¤º
            const searchInput = document.getElementById('userSearchInput');
            if (isSearchActive && searchInput.value.trim() !== '') {
                // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæç¤º
                if (allUsers.length === 0) {
                    const container = currentViewMode === 'card' ?
                        document.getElementById('usersGrid') :
                        document.getElementById('usersTableBody');

                    if (currentViewMode === 'card') {
                        container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-8">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>`;
                    } else {
                        container.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</td></tr>`;
                    }
                }
            }
        }

        // æ¸²æŸ“å¡ç‰‡è§†å›¾
        function renderUsersCardView(usersToShow) {
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = usersToShow.map(user => `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 border border-gray-200">
                    <div class="p-6">
                        <!-- ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-blue-400 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    ${sanitizeInput(user.username).charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${sanitizeInput(user.username)}</h3>
                                    <p class="text-sm text-gray-500">${sanitizeInput(user.userCode || 'æ— ä»£ç ')}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end space-y-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRoleBadgeClass(user.role)}">
                                    ${roleMap[user.role] || user.role}
                                </span>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${user.canSubmitApplication ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${user.canSubmitApplication ? 'âœ… å¯ç”³è¯·' : 'âŒ ä»…å®¡æ ¸'}
                                </span>
                            </div>
                        </div>

                        <!-- éƒ¨é—¨ä¿¡æ¯ -->
                        <div class="mb-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                <span class="font-medium">éƒ¨é—¨ï¼š</span>
                                <span class="ml-1">${user.role === 'admin' ? 'ä¸é€‚ç”¨' : (user.department || 'æœªè®¾ç½®')}</span>
                            </div>
                        </div>

                        <!-- ç”µå­ç­¾å -->
                        <div class="mb-4">
                            <div class="flex items-center text-sm text-gray-600 mb-2">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                                <span class="font-medium">ç”µå­ç­¾åï¼š</span>
                            </div>
                            <div class="ml-6">
                                ${user.signature ?
                                    `<img src="${user.signature}" alt="ç”µå­ç­¾å" class="max-h-12 border border-gray-200 rounded">` :
                                    '<span class="text-gray-400 text-sm">æœªè®¾ç½®</span>'}
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-100">
                            ${deleteMode ?
                                // åˆ é™¤æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                                (user.username !== currentUser ?
                                    `<button onclick="deleteUser('${user.username}')" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition-colors">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        åˆ é™¤
                                    </button>` :
                                    '<span class="text-gray-400 text-sm">å½“å‰ç”¨æˆ·</span>'
                                ) :
                                // æ­£å¸¸æ¨¡å¼ä¸‹æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                                `<button onclick="showEditUserModal('${user.username}')" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    ç¼–è¾‘
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“è¡¨æ ¼è§†å›¾
        function renderUsersTableView(usersToShow) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = usersToShow.map(user => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-400 rounded-full flex items-center justify-center text-white font-bold">
                                ${sanitizeInput(user.username).charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${sanitizeInput(user.username)}</div>
                                <div class="text-sm text-gray-500">${sanitizeInput(user.userCode || 'æ— ä»£ç ')}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="space-y-1">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRoleBadgeClass(user.role)}">
                                ${roleMap[user.role] || user.role}
                            </span>
                            <div>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${user.canSubmitApplication ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${user.canSubmitApplication ? 'âœ… å¯ç”³è¯·' : 'âŒ ä»…å®¡æ ¸'}
                                </span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-gray-900">${user.role === 'admin' ? 'ä¸é€‚ç”¨' : (user.department || 'æœªè®¾ç½®')}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${user.signature ?
                            `<img src="${user.signature}" alt="ç”µå­ç­¾å" class="max-h-8 border border-gray-200 rounded">` :
                            '<span class="text-gray-400 text-sm">æœªè®¾ç½®</span>'}
                    </td>
                    <td class="px-6 py-4 text-center">
                        ${deleteMode ?
                            // åˆ é™¤æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                            (user.username !== currentUser ?
                                `<button onclick="deleteUser('${user.username}')" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">åˆ é™¤</button>` :
                                '<span class="text-gray-400 text-sm">å½“å‰ç”¨æˆ·</span>'
                            ) :
                            // æ­£å¸¸æ¨¡å¼ä¸‹æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                            `<button onclick="showEditUserModal('${user.username}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">ç¼–è¾‘</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // è·å–è§’è‰²å¾½ç« æ ·å¼
        function getRoleBadgeClass(role) {
            const roleClasses = {
                'admin': 'bg-purple-100 text-purple-800',
                'ceo': 'bg-red-100 text-red-800',
                'manager': 'bg-orange-100 text-orange-800',
                'chief': 'bg-yellow-100 text-yellow-800',
                'director': 'bg-blue-100 text-blue-800',
                'user': 'bg-green-100 text-green-800',
                'readonly': 'bg-gray-100 text-gray-800'
            };
            return roleClasses[role] || 'bg-gray-100 text-gray-800';
        }

        // åˆ‡æ¢åˆ°å¡ç‰‡è§†å›¾
        function switchToCardView() {
            currentViewMode = 'card';
            document.getElementById('usersGrid').classList.remove('hidden');
            document.getElementById('usersTable').classList.add('hidden');

            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('cardViewBtn').classList.remove('bg-gray-300', 'text-gray-700');
            document.getElementById('cardViewBtn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('tableViewBtn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('tableViewBtn').classList.add('bg-gray-300', 'text-gray-700');

            renderUsersList();
        }

        // åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾
        function switchToTableView() {
            currentViewMode = 'table';
            document.getElementById('usersGrid').classList.add('hidden');
            document.getElementById('usersTable').classList.remove('hidden');

            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('tableViewBtn').classList.remove('bg-gray-300', 'text-gray-700');
            document.getElementById('tableViewBtn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('cardViewBtn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('cardViewBtn').classList.add('bg-gray-300', 'text-gray-700');

            renderUsersList();
        }

        // æœç´¢ç”¨æˆ·å‡½æ•°
        function searchUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.trim().toLowerCase();
            if (searchTerm === '') {
                resetUserSearch();
                return;
            }

            isSearchActive = true;
            allUsers = originalUsers.filter(user => {
                const username = (user.username || '').toLowerCase();
                const userCode = (user.userCode || '').toLowerCase();
                const role = (roleMap[user.role] || user.role || '').toLowerCase();
                const department = (user.department || '').toLowerCase();

                return username.includes(searchTerm) ||
                       userCode.includes(searchTerm) ||
                       role.includes(searchTerm) ||
                       department.includes(searchTerm);
            });

            currentUserPage = 1; // é‡ç½®ä¸ºç¬¬ä¸€é¡µ
            renderUsersList();
        }

        // é‡ç½®æœç´¢å‡½æ•°
        function resetUserSearch() {
            document.getElementById('userSearchInput').value = '';
            isSearchActive = false;
            allUsers = [...originalUsers]; // æ¢å¤åŸå§‹ç”¨æˆ·åˆ—è¡¨
            currentUserPage = 1; // é‡ç½®ä¸ºç¬¬ä¸€é¡µ
            renderUsersList();
        }

        // æ ¹æ®è§’è‰²åˆ‡æ¢éƒ¨é—¨é€‰æ‹©æ¡†çš„æ˜¾ç¤º/éšè—
        function toggleDepartmentSelect(username) {
            const roleSelect = document.getElementById(`role-${username}`);
            const departmentSelect = document.getElementById(`department-${username}`);
            // åªæœ‰adminè§’è‰²ä¸éœ€è¦éƒ¨é—¨è®¾ç½®ï¼Œå…¶ä»–è§’è‰²éƒ½éœ€è¦éƒ¨é—¨ä¿¡æ¯
            if (['admin'].includes(roleSelect.value)) {
                departmentSelect.classList.add('hidden');
            } else {
                departmentSelect.classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function showAddUserModal() {
            // é‡ç½®è¡¨å•
            document.getElementById('addUserForm').reset();
            document.getElementById('signaturePreview').classList.add('hidden');

            // è®¾ç½®ç”³è¯·æƒé™é»˜è®¤å€¼ä¸ºtrueï¼ˆæ–°ç”¨æˆ·é»˜è®¤æœ‰ç”³è¯·æƒé™ï¼‰
            document.getElementById('newUserCanSubmitApplication').checked = true;

            // å¤„ç†éƒ¨é—¨å­—æ®µæ˜¾ç¤º/éšè—
            toggleNewUserDepartment();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('addUserModal').classList.remove('hidden');

            // åº”ç”¨æ¨¡æ€æ¡†é«˜åº¦æ§åˆ¶
            if (typeof adjustModalHeight === 'function') {
                setTimeout(() => adjustModalHeight('addUserModal'), 10);
            }
        }

        // å…³é—­æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            // é‡ç½®è¡¨å•
            document.getElementById('addUserForm').reset();
            document.getElementById('signaturePreview').classList.add('hidden');
        }

        // åˆ‡æ¢æ–°ç”¨æˆ·éƒ¨é—¨å­—æ®µæ˜¾ç¤º/éšè—
        function toggleNewUserDepartment() {
            const role = document.getElementById('newUserRole').value;
            const departmentField = document.getElementById('newUserDepartmentField');
            // åªæœ‰adminè§’è‰²ä¸éœ€è¦éƒ¨é—¨è®¾ç½®ï¼Œå…¶ä»–è§’è‰²éƒ½éœ€è¦éƒ¨é—¨ä¿¡æ¯
            if (['admin'].includes(role)) {
                departmentField.classList.add('hidden');
            } else {
                departmentField.classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        function showEditUserModal(username) {
            const user = allUsers.find(u => u.username === username);
            if (!user) return;

            // å¡«å……è¡¨å•
            document.getElementById('editTargetUsername').value = username;
            document.getElementById('editUserCode').value = user.userCode || '';
            document.getElementById('editRole').value = user.role || 'user';
            document.getElementById('editUserDepartment').value = user.department || 'ç”Ÿäº§éƒ¨';
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editPassword').value = '';
            document.getElementById('editUserCanSubmitApplication').checked = user.canSubmitApplication || false;

            // å¤„ç†éƒ¨é—¨å­—æ®µæ˜¾ç¤º/éšè—
            toggleEditDepartment();

            // æ˜¾ç¤ºç­¾åé¢„è§ˆ
            const signaturePreview = document.getElementById('editSignaturePreview');
            const signatureImage = document.getElementById('editSignatureImage');
            if (user.signature) {
                signatureImage.src = user.signature;
                signaturePreview.classList.remove('hidden');
            } else {
                signaturePreview.classList.add('hidden');
            }

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        // å…³é—­ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
        }

        // åˆ‡æ¢ç¼–è¾‘æ¨¡æ€æ¡†ä¸­çš„éƒ¨é—¨é€‰æ‹©æ¡†æ˜¾ç¤º/éšè—
        function toggleEditDepartment() {
            const role = document.getElementById('editRole').value;
            const departmentField = document.getElementById('editDepartmentField');

            // åªæœ‰adminè§’è‰²ä¸éœ€è¦éƒ¨é—¨è®¾ç½®ï¼Œå…¶ä»–è§’è‰²éƒ½éœ€è¦éƒ¨é—¨ä¿¡æ¯
            if (['admin'].includes(role)) {
                departmentField.classList.add('hidden');
            } else {
                departmentField.classList.remove('hidden');
            }
        }

        // å¤„ç†ç¼–è¾‘ç”¨æˆ·è¡¨å•æäº¤
        async function handleEditUserSubmit(e) {
            e.preventDefault();

            const targetUsername = document.getElementById('editTargetUsername').value;
            const newRole = document.getElementById('editRole').value;
            const email = document.getElementById('editEmail').value;
            const userCode = document.getElementById('editUserCode').value || '';
            const signatureFile = document.getElementById('editSignature').files[0];
            const newPassword = document.getElementById('editPassword').value;
            const canSubmitApplication = document.getElementById('editUserCanSubmitApplication').checked;

            // æ ¹æ®è§’è‰²ç¡®å®šéƒ¨é—¨ï¼Œåªæœ‰adminè§’è‰²ä¸éœ€è¦éƒ¨é—¨
            let department = '';
            if (newRole === 'admin') {
                department = '';
            } else {
                department = document.getElementById('editUserDepartment').value;
            }

            try {
                // 0. éªŒè¯è¡¨å•æ•°æ®
                if (!validateEditUserForm()) {
                    showTemporaryMessage('è¯·ä¿®æ­£è¡¨å•ä¸­çš„é”™è¯¯', 'error');
                    return;
                }

                // 1. ç«‹å³æ›´æ–°ç•Œé¢ï¼ˆä¹è§‚æ›´æ–°ï¼‰
                const originalUser = allUsers.find(u => u.username === targetUsername);
                if (originalUser) {
                    // å¤‡ä»½åŸå§‹æ•°æ®ï¼Œä»¥é˜²éœ€è¦å›æ»š
                    const backup = { ...originalUser };

                    // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®
                    originalUser.role = newRole;
                    originalUser.email = email;
                    originalUser.department = department;
                    originalUser.userCode = userCode;
                    originalUser.canSubmitApplication = canSubmitApplication;

                    // ç«‹å³æ›´æ–°ç•Œé¢
                    renderUsersList();

                    // ç«‹å³å…³é—­æ¨¡æ€æ¡†ï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
                    closeEditUserModal();

                    // æ˜¾ç¤ºä¿å­˜ä¸­æç¤ºï¼ˆéé˜»å¡ï¼‰
                    showSavingIndicator('æ­£åœ¨ä¿å­˜ç”¨æˆ·æ•°æ®...');

                    // 2. å¼‚æ­¥å¤„ç†ç­¾åæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
                    let signatureData = null;
                    if (signatureFile) {
                        try {
                            signatureData = await readFileAsDataURL(signatureFile);
                            // æ›´æ–°ç­¾ååˆ°æœ¬åœ°æ•°æ®
                            originalUser.signature = signatureData;
                            // æ›´æ–°ç­¾åç¼“å­˜
                            setSignatureToCache(targetUsername, signatureData);
                            // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæ–°ç­¾å
                            renderUsersList();
                        } catch (signatureError) {
                            console.warn('ç­¾åå¤„ç†å¤±è´¥:', signatureError);
                            showTemporaryMessage('ç­¾åä¸Šä¼ å¤±è´¥ï¼Œå…¶ä»–ä¿¡æ¯å·²ä¿å­˜', 'warning');
                        }
                    }

                    // 3. åå°ä¿å­˜åˆ°æœåŠ¡å™¨
                    const response = await fetch('/updateUser', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            adminUsername: currentUser,
                            targetUsername,
                            newRole,
                            email,
                            department,
                            userCode,
                            signature: signatureData,
                            newPassword,
                            canSubmitApplication
                        })
                    });

                    const result = await response.json();
                    hideSavingIndicator();

                    if (result.success) {
                        // ä¿å­˜æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
                        showTemporaryMessage('ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜', 'success');

                        // æ¸…ç†ç­¾åç¼“å­˜ä¸­çš„æ—§æ•°æ®ï¼Œç¡®ä¿ä¸€è‡´æ€§
                        if (signatureData) {
                            setSignatureToCache(targetUsername, signatureData);
                        }
                    } else {
                        // ä¿å­˜å¤±è´¥ï¼Œå›æ»šæœ¬åœ°æ•°æ®
                        Object.assign(originalUser, backup);
                        renderUsersList();
                        showTemporaryMessage('ä¿å­˜å¤±è´¥ï¼š' + result.message, 'error');
                    }
                } else {
                    throw new Error('æ‰¾ä¸åˆ°è¦æ›´æ–°çš„ç”¨æˆ·');
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error);
                hideSavingIndicator();

                // å¦‚æœæœ‰å¤‡ä»½æ•°æ®ï¼Œå›æ»š
                const user = allUsers.find(u => u.username === targetUsername);
                if (user && window.userBackup) {
                    Object.assign(user, window.userBackup);
                    renderUsersList();
                }

                showTemporaryMessage('æ›´æ–°å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
            }
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator(message) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŠ è½½æŒ‡ç¤ºå™¨
            if (document.getElementById('loadingIndicator')) {
                return;
            }

            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loadingIndicator';
            loadingIndicator.className = 'loading-overlay';
            loadingIndicator.innerHTML = `
                <div class="loading-container">
                    <div class="spinner mb-2"></div>
                    <p>${message || 'æ­£åœ¨åŠ è½½...'}</p>
                </div>
            `;
            document.body.appendChild(loadingIndicator);
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                document.body.removeChild(loadingIndicator);
            }
        }

        // æ˜¾ç¤ºå±…ä¸­åŠ è½½æŒ‡ç¤ºå™¨ - ä¸“é—¨ç”¨äºåº”ç”¨æ•°æ®åŠ è½½
        function showCenterLoadingIndicator(message) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å±…ä¸­åŠ è½½æŒ‡ç¤ºå™¨
            if (document.getElementById('centerLoadingIndicator')) {
                return;
            }

            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'centerLoadingIndicator';
            loadingIndicator.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50';
            loadingIndicator.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <div class="text-center">
                        <div class="relative mb-4">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-200 border-t-blue-600"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${message || 'æ­£åœ¨åŠ è½½...'}</h3>
                        <p class="text-gray-600 text-sm">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨åŠ è½½æ•°æ®</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingIndicator);
        }

        // éšè—å±…ä¸­åŠ è½½æŒ‡ç¤ºå™¨
        function hideCenterLoadingIndicator() {
            const loadingIndicator = document.getElementById('centerLoadingIndicator');
            if (loadingIndicator) {
                document.body.removeChild(loadingIndicator);
            }
        }

        // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€ - æ”¯æŒä»£ç†å’ŒVPNç½‘ç»œçš„çŠ¶æ€æç¤º
        function showNetworkStatus(message, type = 'info') {
            // ç§»é™¤ç°æœ‰çš„çŠ¶æ€æç¤º
            hideNetworkStatus();

            const statusElement = document.createElement('div');
            statusElement.id = 'networkStatus';
            statusElement.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
                type === 'loading' ? 'bg-blue-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'success' ? 'bg-green-500 text-white' :
                'bg-gray-500 text-white'
            }`;

            statusElement.innerHTML = `
                <div class="flex items-center">
                    ${type === 'loading' ?
                        '<div class="spinner mr-3"></div>' :
                        type === 'error' ?
                        '<span class="mr-3">âš ï¸</span>' :
                        type === 'success' ?
                        '<span class="mr-3">âœ…</span>' :
                        '<span class="mr-3">â„¹ï¸</span>'
                    }
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(statusElement);

            // è‡ªåŠ¨éšè—ï¼ˆé™¤äº†åŠ è½½çŠ¶æ€ï¼‰
            if (type !== 'loading') {
                setTimeout(() => {
                    hideNetworkStatus();
                }, 5000);
            }
        }

        // éšè—ç½‘ç»œçŠ¶æ€
        function hideNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            if (statusElement) {
                document.body.removeChild(statusElement);
            }
        }

        // ä¸“é—¨çš„ç½‘ç»œå·¥å…·å‡½æ•° - ä¸ºä»£ç†å’ŒVPNç½‘ç»œä¼˜åŒ–
        async function makeNetworkRequest(url, options = {}) {
            const defaultOptions = {
                method: 'GET',
                timeout: 15000,
                retry: {
                    maxRetries: 3,
                    retryDelay: 1500,
                    retryStatusCodes: [0, 408, 429, 500, 502, 503, 504, 520, 521, 522, 523, 524]
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                retry: {
                    ...defaultOptions.retry,
                    ...options.retry
                }
            };

            try {
                return await apiRequest(url, mergedOptions);
            } catch (error) {
                console.error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ ${url}:`, error);

                // å¦‚æœæ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œè§¦å‘ç½‘ç»œè¯Šæ–­
                if (error.status === 'TIMEOUT' ||
                    (error.message && (error.message.includes('network') ||
                                      error.message.includes('Failed to fetch')))) {

                    // è¿è¡Œç½‘ç»œè¯Šæ–­
                    if (window.networkDiagnostics) {
                        const diagnostics = await window.networkDiagnostics.runDiagnostics();

                        if (diagnostics.quality.status === 'failed') {
                            showNetworkStatus('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®æˆ–ä»£ç†é…ç½®', 'error');
                        }
                    }
                }

                throw error;
            }
        }

        // å°†æ–‡ä»¶è¯»å–ä¸ºDataURLï¼ˆbase64æ ¼å¼ï¼‰
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }

        async function updateUser(targetUsername) {
            const newRole = document.getElementById(`role-${targetUsername}`).value;
            const email = document.getElementById(`email-${targetUsername}`).value;
            const userCode = document.getElementById(`userCode-${targetUsername}`).value || '';
            // æ ¹æ®è§’è‰²ç¡®å®šéƒ¨é—¨ï¼Œåªæœ‰adminè§’è‰²ä¸éœ€è¦éƒ¨é—¨
            let department = '';
            if (newRole === 'admin') {
                department = '';
            } else {
                department = document.getElementById(`department-${targetUsername}`).value;
            }
            const signatureFile = document.getElementById(`signature-${targetUsername}`).files[0];
            const newPassword = document.getElementById(`password-${targetUsername}`).value;

            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'updateLoadingIndicator';
                loadingIndicator.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loadingIndicator.innerHTML = `
                    <div class="bg-white p-4 rounded-md shadow-lg">
                        <div class="spinner mb-2"></div>
                        <p>æ­£åœ¨æ›´æ–°ç”¨æˆ·æ•°æ®...</p>
                    </div>
                `;
                document.body.appendChild(loadingIndicator);

                // å¦‚æœæœ‰æ–°çš„ç­¾åæ–‡ä»¶ï¼Œå…ˆè½¬æ¢ä¸ºbase64
                let signatureData = null;
                if (signatureFile) {
                    try {
                        // æ£€æŸ¥æ–‡ä»¶å¤§å°
                        const maxSizeMB = 5; // æœ€å¤§5MB
                        const maxSizeBytes = maxSizeMB * 1024 * 1024;

                        if (signatureFile.size > maxSizeBytes) {
                            throw new Error(`ç­¾åå›¾ç‰‡è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº${maxSizeMB}MBçš„å›¾ç‰‡`);
                        }

                        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                        if (!signatureFile.type.startsWith('image/')) {
                            throw new Error('è¯·ä¸Šä¼ å›¾ç‰‡æ ¼å¼çš„ç­¾åæ–‡ä»¶');
                        }

                        signatureData = await readFileAsDataURL(signatureFile);

                        // éªŒè¯ç­¾åæ•°æ®æ ¼å¼
                        if (!signatureData.startsWith('data:image/')) {
                            throw new Error('ç­¾åæ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨å›¾ç‰‡æ–‡ä»¶');
                        }

                        // å¦‚æœç­¾åæ•°æ®è¿‡å¤§ï¼Œå°è¯•å‹ç¼©
                        if (signatureData.length > 5000000) { // å¦‚æœå¤§äº5MB
                            // è¿™é‡Œå¯ä»¥æ·»åŠ å›¾ç‰‡å‹ç¼©é€»è¾‘ï¼Œä½†ç›®å‰å…ˆé€šè¿‡é™åˆ¶æ–‡ä»¶å¤§å°å¤„ç†
                        }
                    } catch (fileError) {
                        document.body.removeChild(loadingIndicator);
                        alert('è¯»å–ç­¾åæ–‡ä»¶å¤±è´¥: ' + fileError.message);
                        return;
                    }
                }

                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const requestData = {
                    adminUsername: currentUser,
                    targetUsername,
                    newRole,
                    email,
                    department,
                    userCode,
                    signature: signatureData,
                    newPassword
                };

                // è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶

                try {
                    const response = await fetch('/updateUser', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶

                    if (!response.ok) {
                        throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();

                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    document.body.removeChild(loadingIndicator);

                    if (result.success) {
                        alert('ç”¨æˆ·æ›´æ–°æˆåŠŸ');
                        // ä¿å­˜å½“å‰é¡µç 
                        const currentPageBeforeReload = currentUserPage;
                        // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                        await loadUsers();
                        // ç”±äºloadUsersä¸­å·²ç»è¿›è¡Œäº†æ’åºï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡æ’åº
                        // æ¢å¤åˆ°ä¹‹å‰çš„é¡µç 
                        currentUserPage = currentPageBeforeReload;
                        // ç¡®ä¿é¡µç ä¸è¶…è¿‡æ€»é¡µæ•°
                        const totalPages = Math.ceil(allUsers.length / usersPerPage);
                        if (currentUserPage > totalPages) {
                            currentUserPage = totalPages;
                        }
                        renderUsersList();
                    } else {
                        alert('ç”¨æˆ·æ›´æ–°å¤±è´¥ï¼š' + result.message);
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId); // ç¡®ä¿æ¸…é™¤è¶…æ—¶
                    throw fetchError; // é‡æ–°æŠ›å‡ºä»¥ä¾¿å¤–å±‚æ•è·
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error);
                // ç¡®ä¿åŠ è½½æŒ‡ç¤ºå™¨è¢«ç§»é™¤
                const loadingIndicator = document.getElementById('updateLoadingIndicator');
                if (loadingIndicator) {
                    document.body.removeChild(loadingIndicator);
                }
                alert('æ›´æ–°ç”¨æˆ·å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // åˆ é™¤ç”¨æˆ·å‡½æ•°
        async function deleteUser(targetUsername) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${targetUsername} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('/deleteUser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminUsername: currentUser, targetUsername })
                });
                const result = await response.json();
                if (result.success) {
                    alert('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
                    // ä¿å­˜å½“å‰é¡µç 
                    let currentPageBeforeReload = currentUserPage;
                    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    await loadUsers();
                    // ç¡®ä¿é¡µç ä¸è¶…è¿‡æ€»é¡µæ•°
                    const totalPages = Math.ceil(allUsers.length / usersPerPage);
                    if (currentPageBeforeReload > totalPages) {
                        currentPageBeforeReload = totalPages;
                    }
                    currentUserPage = currentPageBeforeReload > 0 ? currentPageBeforeReload : 1;
                    renderUsersList();
                } else {
                    alert('ç”¨æˆ·åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ é™¤ç”¨æˆ·å¤±è´¥');
            }
        }

        // åˆ‡æ¢åˆ é™¤æ¨¡å¼
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            const toggleBtn = document.getElementById('toggleDeleteModeBtn');
            const deleteAlert = document.getElementById('deleteModeAlert');

            if (deleteMode) {
                toggleBtn.innerHTML = `
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    å–æ¶ˆåˆ é™¤
                `;
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                deleteAlert.classList.remove('hidden');
            } else {
                toggleBtn.innerHTML = `
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    åˆ é™¤ç”¨æˆ·
                `;
                toggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                deleteAlert.classList.add('hidden');
            }

            // é‡æ–°æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
            renderUsersList();
        }

        // åˆ¤æ–­æ—¥æœŸæ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
        function isInRange(date, range) {
            const applyDate = new Date(date);
            const now = new Date();
            if (range === 'week') {
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // æœ¬å‘¨å¼€å§‹ï¼ˆå‘¨æ—¥ï¼‰
                startOfWeek.setHours(0, 0, 0, 0);
                return applyDate >= startOfWeek && applyDate <= now;
            } else if (range === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                return applyDate >= startOfMonth && applyDate <= now;
            } else if (range === 'year') {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                return applyDate >= startOfYear && applyDate <= now;
            }
            return true; // 'all'
        }

        // æ ¼å¼åŒ–é‡‘é¢ä¸ºåƒåˆ†ä½
        function formatAmountWithCommas(amount) {
            return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // è·å–å¹¶æ›´æ–°ç”³è¯·ç»Ÿè®¡æ•°æ®
        async function updateApplicationStats() {
            try {
                const response = await apiRequest(`/getApplicationStats?username=${currentUser}`, {
                    method: 'GET',
                    timeout: 10000
                });

                if (response && response.success && response.stats) {
                    const stats = response.stats;

                    // æ›´æ–°æ€»ç”³è¯·é‡‘é¢
                    document.getElementById('totalCnyAmount').textContent = `Â¥${formatAmountWithCommas(stats.total.cny)}`;
                    document.getElementById('totalUsdAmount').textContent = `$${formatAmountWithCommas(stats.total.usd)}`;

                    // æ›´æ–°å¾…å®¡æ ¸é‡‘é¢
                    document.getElementById('pendingCnyAmount').textContent = `Â¥${formatAmountWithCommas(stats.pending.cny)}`;
                    document.getElementById('pendingUsdAmount').textContent = `$${formatAmountWithCommas(stats.pending.usd)}`;

                    // æ›´æ–°å·²é€šè¿‡é‡‘é¢
                    document.getElementById('approvedCnyAmount').textContent = `Â¥${formatAmountWithCommas(stats.approved.cny)}`;
                    document.getElementById('approvedUsdAmount').textContent = `$${formatAmountWithCommas(stats.approved.usd)}`;
                }
            } catch (error) {
                console.error('è·å–ç”³è¯·ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        async function updateHistoryList(page = 1) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const tbody = document.getElementById('applicationsList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="ml-2">åŠ è½½ä¸­...</span></div></td></tr>';

                // ä½¿ç”¨æ–°çš„åˆ†é¡µAPIåŠ è½½æ•°æ®
                await loadApplications(page, 10, 'date', 'desc', false, false);

                // è·å–å½“å‰é¡µæ•°æ®å’Œåˆ†é¡µä¿¡æ¯
                const pagination = applicationsCache.pagination;
                // ç›´æ¥ä½¿ç”¨ä»åç«¯è·å–çš„å½“å‰é¡µæ•°æ®
                const currentPageData = applicationsCache.data;

                // æ¸²æŸ“å½“å‰é¡µæ•°æ®
                renderApplicationsList(currentPageData, tbody);

                // è®¡ç®—å½“å‰é¡µé‡‘é¢åˆè®¡
                calculateTotalAmount(currentPageData);

                // æ›´æ–°åˆ†é¡µæ§ä»¶
                updateHistoryPagination(pagination.currentPage, pagination.totalPages, pagination.totalItems);

                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                await updateApplicationStats();

                // é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (pagination.hasNextPage) {
                    preloadNextPage(page + 1);
                }

            } catch (error) {
                console.error('åŠ è½½ç”³è¯·è®°å½•å¤±è´¥:', error);
                const tbody = document.getElementById('applicationsList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            }
        }

        // åŠ è½½æ‰€æœ‰åº”ç”¨æ•°æ®ï¼ˆç”¨äºå¾…å®¡æ ¸å’Œå·²å®¡æ ¸é¡µé¢ï¼‰
        async function loadAllApplications(showError = true) {
            try {
                if (showError) {
                    showCenterLoadingIndicator('æ­£åœ¨åŠ è½½æ‰€æœ‰æ•°æ®...');
                }

                // ä½¿ç”¨ä¸€ä¸ªå¾ˆå¤§çš„pageSizeæ¥è·å–æ‰€æœ‰æ•°æ®
                const params = new URLSearchParams({
                    username: currentUser,
                    page: '1',
                    pageSize: '10000', // è¶³å¤Ÿå¤§çš„æ•°å­—æ¥è·å–æ‰€æœ‰æ•°æ®
                    sortBy: 'date',
                    sortOrder: 'desc'
                });

                const response = await apiRequest(`/applications?${params.toString()}`, {
                    method: 'GET',
                    timeout: 30000
                });

                if (response && response.data) {
                    // æ›´æ–°å…¨å±€applicationså˜é‡ä¸ºæ‰€æœ‰æ•°æ®
                    applications = response.data;

                    if (showError) {
                        hideCenterLoadingIndicator();
                    }

                    console.debug(`åŠ è½½æ‰€æœ‰æ•°æ®å®Œæˆ - æ€»æ•°æ®é‡: ${response.data.length}æ¡`);
                    return applications;
                } else {
                    throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                }

            } catch (error) {
                console.error('åŠ è½½æ‰€æœ‰åº”ç”¨æ•°æ®å¤±è´¥:', error);

                if (showError) {
                    hideCenterLoadingIndicator();
                    showNetworkStatus('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                }

                // è¿”å›ç©ºæ•°ç»„ä½œä¸ºfallback
                applications = [];
                return applications;
            }
        }

        // é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
        async function preloadNextPage(nextPage) {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»é¢„åŠ è½½è¿‡
                const cacheKey = `${nextPage}-date-desc`;
                if (applicationsCache.preloadedPages.has(cacheKey)) {
                    return;
                }

                // é™é»˜åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
                const params = new URLSearchParams({
                    username: currentUser,
                    page: nextPage.toString(),
                    pageSize: '10',
                    sortBy: 'date',
                    sortOrder: 'desc'
                });

                const response = await fetch(`/applications?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    // ç¼“å­˜é¢„åŠ è½½çš„æ•°æ®
                    applicationsCache.preloadedPages.set(cacheKey, data);

                    // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œåªä¿ç•™æœ€è¿‘çš„3é¡µ
                    if (applicationsCache.preloadedPages.size > 3) {
                        const firstKey = applicationsCache.preloadedPages.keys().next().value;
                        applicationsCache.preloadedPages.delete(firstKey);
                    }
                }
            } catch (error) {
                // é¢„åŠ è½½å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼Œé™é»˜å¤„ç†
                console.debug('é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç”³è¯·è®°å½•åˆ†é¡µæ§ä»¶
        function updateHistoryPagination(currentPage, totalPages, totalItems) {
            const prevPageBtn = document.getElementById('historyPrevPage');
            const nextPageBtn = document.getElementById('historyNextPage');
            const pageNumbersContainer = document.getElementById('historyPageNumbers');
            const totalItemsSpan = document.getElementById('historyTotalItems');

            // æ›´æ–°æ€»è®°å½•æ•°
            totalItemsSpan.textContent = totalItems;

            // ç¦ç”¨/å¯ç”¨ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µæŒ‰é’®
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;

            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ ¹æ®æ˜¯å¦åœ¨æœç´¢çŠ¶æ€å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
            if (currentSearchState.isSearching) {
                prevPageBtn.onclick = () => searchApplications(currentPage - 1);
                nextPageBtn.onclick = () => searchApplications(currentPage + 1);
            } else {
                prevPageBtn.onclick = () => updateHistoryList(currentPage - 1);
                nextPageBtn.onclick = () => updateHistoryList(currentPage + 1);
            }

            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbersContainer.innerHTML = '';

            // ç¡®å®šè¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            // è°ƒæ•´èµ·å§‹é¡µï¼Œç¡®ä¿å§‹ç»ˆæ˜¾ç¤º5ä¸ªé¡µç ï¼ˆå¦‚æœæœ‰è¶³å¤Ÿçš„é¡µæ•°ï¼‰
            if (endPage - startPage < 4 && totalPages > 5) {
                startPage = Math.max(1, endPage - 4);
            }

            // æ·»åŠ ç¬¬ä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…ï¼‰
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'px-3 py-1 border rounded-md hover:bg-gray-200';
                firstPageBtn.textContent = '1';
                firstPageBtn.onclick = () => currentSearchState.isSearching ? searchApplications(1) : updateHistoryList(1);
                pageNumbersContainer.appendChild(firstPageBtn);

                // æ·»åŠ çœç•¥å·ï¼ˆå¦‚æœç¬¬ä¸€é¡µå’Œèµ·å§‹é¡µä¹‹é—´æœ‰é—´éš”ï¼‰
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }

            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-200'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => currentSearchState.isSearching ? searchApplications(i) : updateHistoryList(i);
                pageNumbersContainer.appendChild(pageBtn);
            }

            // æ·»åŠ æœ€åä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…ï¼‰
            if (endPage < totalPages) {
                // æ·»åŠ çœç•¥å·ï¼ˆå¦‚æœç»“æŸé¡µå’Œæœ€åä¸€é¡µä¹‹é—´æœ‰é—´éš”ï¼‰
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }

                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'px-3 py-1 border rounded-md hover:bg-gray-200';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.onclick = () => currentSearchState.isSearching ? searchApplications(totalPages) : updateHistoryList(totalPages);
                pageNumbersContainer.appendChild(lastPageBtn);
            }
        }

        // å…¨å±€å˜é‡ï¼šä¿å­˜å½“å‰æœç´¢çŠ¶æ€
        let currentSearchState = {
            isSearching: false, // æ˜¯å¦å¤„äºæœç´¢çŠ¶æ€
            searchField: '', // æœç´¢å­—æ®µ
            searchInput: '' // æœç´¢å†…å®¹
        };

        // æœç´¢ç”³è¯· - ä½¿ç”¨åç«¯API
        async function searchApplications(page = 1) {
            const searchField = document.getElementById('searchField').value;
            const searchInput = document.getElementById('searchInput').value.trim();

            if (!searchInput) {
                // æ¸…ç©ºæœç´¢çŠ¶æ€
                currentSearchState.isSearching = false;
                currentSearchState.searchField = '';
                currentSearchState.searchInput = '';
                updateHistoryList(1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                return;
            }

            // ä¿å­˜æœç´¢çŠ¶æ€
            currentSearchState.isSearching = true;
            currentSearchState.searchField = searchField;
            currentSearchState.searchInput = searchInput;

            try {
                const tbody = document.getElementById('applicationsList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="ml-2">æœç´¢ä¸­...</span></div></td></tr>';

                // æ„å»ºè¯·æ±‚URLï¼ŒåŒ…å«æœç´¢å‚æ•°
                const params = new URLSearchParams({
                    username: currentUser,
                    page: page.toString(),
                    pageSize: '10',
                    sortBy: 'date',
                    sortOrder: 'desc',
                    searchField: searchField,
                    searchInput: searchInput
                });

                const response = await apiRequest(`/applications?${params.toString()}`, {
                    method: 'GET',
                    timeout: 10000
                });

                if (response && response.data) {
                    // æ¸²æŸ“æœç´¢ç»“æœ
                    renderApplicationsList(response.data, tbody);

                    // è®¡ç®—å½“å‰é¡µé‡‘é¢åˆè®¡
                    calculateTotalAmount(response.data);

                    // æ›´æ–°åˆ†é¡µæ§ä»¶
                    updateHistoryPagination(
                        response.pagination.currentPage,
                        response.pagination.totalPages,
                        response.pagination.totalItems
                    );

                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                    await updateApplicationStats();

                    // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæç¤º
                    if (response.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•</td></tr>';
                    }
                } else {
                    throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                const tbody = document.getElementById('applicationsList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            }
        }

        // æ¸²æŸ“ç”³è¯·åˆ—è¡¨
        function renderApplicationsList(apps, tbodyId) {
            // è·å–tbodyå…ƒç´ 
            const tbody = typeof tbodyId === 'string' ? document.getElementById(tbodyId) : tbodyId;

            if (!tbody) {
                console.error('æ‰¾ä¸åˆ°ç›®æ ‡å…ƒç´ :', tbodyId);
                return;
            }

            if (apps.length === 0) {
                // æ ¹æ®ä¸åŒé¡µé¢è®¾ç½®ä¸åŒçš„colspan
                let colSpan = 9; // é»˜è®¤å€¼
                if (tbody.id === 'pendingApprovalList' || tbody.id === 'approvedList') {
                    colSpan = 8; // å¾…å®¡æ ¸å’Œå·²å®¡æ ¸é¡µé¢æ²¡æœ‰é‡‘é¢åˆ—
                }

                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="px-6 py-4 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>`;

                // å¦‚æœæ˜¯ç”³è¯·è®°å½•é¡µé¢ï¼Œé‡ç½®åˆè®¡é‡‘é¢
                if (tbody.id === 'applicationsList') {
                    document.getElementById('currentPageTotalAmount').textContent = '0.00';
                }
                return;
            }

            // åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨å¾…å®¡æ ¸é¡µé¢
            const isPendingApprovalPage = tbody.id === 'pendingApprovalList';
            // åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨ç”³è¯·è®°å½•é¡µé¢
            const isHistoryPage = tbody.id === 'applicationsList';
            // åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨å·²å®¡æ ¸é¡µé¢
            const isApprovedPage = tbody.id === 'approvedList';

            tbody.innerHTML = apps.map(app => {
                const isApplicant = app.username === currentUser;
                const isAdmin = currentRole === 'admin';
                const isReadOnly = currentRole === 'readonly';

                // æ£€æŸ¥ç”³è¯·æ˜¯å¦å·²ç»æœ€ç»ˆå®¡æ ¸å®Œæˆ
                const isFinalStatus = app.status === 'å·²é€šè¿‡' || app.status === 'å·²æ‹’ç»';

                // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰åˆå§‹é™„ä»¶
                const hasNoInitialAttachments = !app.attachments || app.attachments.length === 0;

                // ç”³è¯·äººå¯ä»¥ä¿®æ”¹çš„æ¡ä»¶ï¼š
                // 1. ç”³è¯·å¤„äºå¾…å‚é•¿å®¡æ ¸çŠ¶æ€ï¼Œæˆ–
                // 2. ç”³è¯·æµç¨‹è¿›è¡Œä¸­ï¼ˆæœªæœ€ç»ˆå®¡æ ¸å®Œæˆï¼‰ä¸”ä¸€å¼€å§‹æ²¡æœ‰æ·»åŠ åˆå§‹é™„ä»¶
                const canApplicantModify = isApplicant &&
                    (app.status === 'å¾…å‚é•¿å®¡æ ¸' || (hasNoInitialAttachments && !isFinalStatus));

                // ç”³è¯·äººå¯ä»¥åœ¨ç‰¹å®šæ¡ä»¶ä¸‹ä¿®æ”¹ç”³è¯·ï¼Œç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æ“ä½œæƒé™ï¼Œåªè¯»è§’è‰²ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤
                const canEdit = (canApplicantModify || isAdmin) && !isReadOnly;
                // åˆ é™¤æƒé™ä»ç„¶åªé™äºå¾…å‚é•¿å®¡æ ¸çŠ¶æ€
                const canDelete = ((isApplicant && app.status === 'å¾…å‚é•¿å®¡æ ¸') || isAdmin) && !isReadOnly;

                let actions = [];

                // åœ¨ç”³è¯·è®°å½•é¡µé¢ï¼Œç”³è¯·äººè‡ªå·±ã€ç®¡ç†å‘˜å’Œåªè¯»è§’è‰²å¯ä»¥æŸ¥çœ‹è¯¦æƒ…
                if (isHistoryPage) {
                    if (isApplicant || isAdmin || isReadOnly) {
                        actions.push(`<button onclick="viewDetail(${app.id})" class="text-blue-600 hover:text-blue-800" data-id="${app.id}">æŸ¥çœ‹</button>`);
                    }
                }
                // åœ¨å¾…å®¡æ ¸é¡µé¢ï¼Œæ‰€æœ‰å®¡æ ¸äººéƒ½å¯ä»¥æŸ¥çœ‹è¯¦æƒ…
                else if (isPendingApprovalPage) {
                    actions.push(`<button onclick="viewDetail(${app.id})" class="text-blue-600 hover:text-blue-800" data-id="${app.id}">å®¡æ ¸ç”³è¯·</button>`);
                }
                // åœ¨å·²å®¡æ ¸é¡µé¢ï¼Œæ‰€æœ‰å®¡æ ¸äººéƒ½å¯ä»¥æŸ¥çœ‹è¯¦æƒ…
                else if (isApprovedPage) {
                    actions.push(`<button onclick="viewDetail(${app.id})" class="text-blue-600 hover:text-blue-800" data-id="${app.id}">æŸ¥çœ‹</button>`);
                }
                // å…¶ä»–é¡µé¢ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹è¯¦æƒ…
                else {
                    actions.push(`<button onclick="viewDetail(${app.id})" class="text-blue-600 hover:text-blue-800" data-id="${app.id}">æŸ¥çœ‹</button>`);
                }

                if (canEdit) {
                    actions.push(`<button onclick="editApplication(${app.id})" class="text-green-600 hover:text-green-800">ä¿®æ”¹</button>`);
                }

                if (canDelete) {
                    actions.push(`<button onclick="deleteApplication(${app.id})" class="text-red-600 hover:text-red-800">åˆ é™¤</button>`);
                }

                // åªåœ¨å¾…å®¡æ ¸é¡µé¢æ˜¾ç¤ºå®¡æ‰¹æ“ä½œ
                if (isPendingApprovalPage && canApprove(app)) {
                    // ç§»é™¤å®¡æ‰¹ä¸‹æ‹‰èœå•ï¼Œå®¡æ‰¹æ“ä½œå°†åœ¨è¯¦æƒ…é¡µé¢ä¸­è¿›è¡Œ
                    // actions.push(`
                    //     <select onchange="approveApplication(${app.id}, this.value)" class="border rounded p-1">
                    //         <option value="pending" selected>å¾…å®¡æ‰¹</option>
                    //         <option value="approved">é€šè¿‡</option>
                    //         <option value="rejected">æ‹’ç»</option>
                    //     </select>
                    // `);
                }

                return `
                    <tr data-app-id="${app.id}">
                        <td class="px-6 py-4">${app.applicationCode || 'æ— ç¼–å·'}</td>
                        <td class="px-6 py-4">${sanitizeInput(app.applicant)}</td>
                        <td class="px-6 py-4">${sanitizeInput(app.department)}</td>
                        <td class="px-6 py-4">
                            ${app.date}
                            <span class="block text-xs text-gray-500">${formatSubmitTime(app.id)}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded ${getPriorityClass(app.priority)}">${priorityMap[app.priority] || app.priority}</span>
                        </td>
                        <td class="px-6 py-4" style="max-width: 200px; width: 200px; white-space: normal; overflow: visible; word-break: break-word; vertical-align: top;">
                            ${createClickableContent(app.content)}
                        </td>
                        ${isHistoryPage ? `
                        <td class="px-6 py-4 text-right">
                            ${app.amount ? formatCurrency(parseFloat(app.amount), app.currency || 'CNY') : 'æ— '}
                        </td>` : ''}
                        <td class="px-6 py-4">
                            ${app.status}
                            <span class="block text-xs text-gray-500">${getApplicationStatusDesc(app.status, app)}</span>
                            ${app.status === 'å¾…å‚é•¿å®¡æ ¸' && app.approvals && app.approvals.directors ?
                                `<span class="block text-xs text-blue-600">å¾…å®¡æ ¸å‚é•¿ï¼š${Object.entries(app.approvals.directors)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([director, _]) => sanitizeInput(director))
                                    .join('ã€') || 'æ— '}</span>`
                                : ''}
                            ${app.status === 'å¾…ç»ç†å®¡æ‰¹' && app.approvals && app.approvals.managers ?
                                `<span class="block text-xs text-blue-600">å¾…å®¡æ ¸ç»ç†ï¼š${Object.entries(app.approvals.managers)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([manager, _]) => sanitizeInput(manager))
                                    .join('ã€') || 'æ— '}</span>`
                                : ''}
                        </td>
                        <td class="px-6 py-4 space-x-2">${actions.join(' ')}</td>
                    </tr>
                `;
            }).join('');
        }

        function canApprove(app) {
            // åªè¯»è§’è‰²ä¸èƒ½è¿›è¡Œå®¡æ‰¹æ“ä½œ
            if (currentRole === 'readonly') {
                return false;
            }

            // ç®¡ç†å‘˜å¯ä»¥å®¡æ‰¹ä»»ä½•çŠ¶æ€çš„ç”³è¯·
            if (currentRole === 'admin') {
                return true;
            }

            // å‚é•¿å®¡æ‰¹
            if (currentRole === 'director' && app.status === 'å¾…å‚é•¿å®¡æ ¸') {
                // æ£€æŸ¥å½“å‰å‚é•¿æ˜¯å¦æ˜¯è¯¥ç”³è¯·çš„å®¡æ‰¹äºº
                return app.approvals.directors && app.approvals.directors[currentUser] &&
                       app.approvals.directors[currentUser].status === 'pending';
            }

            // æ€»ç›‘å®¡æ‰¹
            if (currentRole === 'chief' && app.status === 'å¾…æ€»ç›‘å®¡æ‰¹') {
                return true;
            }

            // ç»ç†å®¡æ‰¹
            if (currentRole === 'manager' && app.status === 'å¾…ç»ç†å®¡æ‰¹') {
                // æ£€æŸ¥å½“å‰ç»ç†æ˜¯å¦æ˜¯è¯¥ç”³è¯·çš„å®¡æ‰¹äºº
                return app.approvals.managers && app.approvals.managers[currentUser] &&
                       app.approvals.managers[currentUser].status === 'pending';
            }

            // CEOå®¡æ‰¹
            if (currentRole === 'ceo' && app.status === 'å¾…CEOå®¡æ‰¹') {
                return true;
            }

            return false;
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'high': return 'bg-red-100 text-red-800';
                case 'medium': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-green-100 text-green-800';
            }
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–æäº¤æ—¶é—´ï¼Œå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºè¯¦ç»†çš„æ—¶é—´æ ¼å¼
        function formatSubmitTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(parseInt(timestamp));
            if (isNaN(date.getTime())) return '';

            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${hours}:${minutes}:${seconds}`;
        }

        async function deleteApplication(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”³è¯·å—ï¼Ÿ')) return;
            try {
                const response = await fetch('/deleteApplication', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, username: currentUser, role: currentRole })
                });
                const result = await response.json();
                if (result.success) {
                    alert('ç”³è¯·åˆ é™¤æˆåŠŸ');
                    loadApplications();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        function editApplication(id) {
            const app = applications.find(a => a.id === id);
            if (!app) return;

            document.getElementById('editId').value = app.id;
            document.getElementById('editApplicant').value = app.applicant;
            document.getElementById('editApplicationDepartment').value = app.department;
            document.getElementById('editDate').value = app.date;
            document.getElementById('editContent').value = app.content;
            document.getElementById('editAmount').value = app.amount || '';
            document.getElementById('editCurrency').value = app.currency || 'CNY';
            document.getElementById('editPriority').value = app.priority;
            document.getElementById('editAttachments').value = '';

            // æ˜¾ç¤ºå·²æœ‰é™„ä»¶ä¿¡æ¯ï¼ˆåªè¯»å±•ç¤ºï¼Œä¸å¯ç¼–è¾‘ï¼‰
            const editFileList = document.getElementById('editFileList');
            if (app.attachments && app.attachments.length > 0) {
                editFileList.innerHTML = `
                    <div class="p-2 bg-gray-100 rounded-md mb-2">
                        <p class="font-medium text-gray-700">å·²æœ‰é™„ä»¶ï¼ˆå°†è¢«æ›¿æ¢ï¼‰ï¼š</p>
                        ${app.attachments.map(file => `
                            <div class="flex items-center justify-between p-1">
                                <span class="text-sm">${sanitizeInput(decodeURIComponent(file.name))}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                editFileList.innerHTML = '';
            }

            // åŠ è½½å·²é€‰æ‹©çš„å‚é•¿
            if (app.approvals && app.approvals.directors) {
                const selectedDirectors = Object.keys(app.approvals.directors);
                renderDirectorsList(document.getElementById('editDirectorsList'), selectedDirectors);
            } else {
                renderDirectorsList(document.getElementById('editDirectorsList'), []);
            }

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            // é‡ç½®æ»šåŠ¨ä½ç½®
            document.getElementById('editModal').scrollTop = 0;
        }

        async function approveApplication(id, status) {
            // ç§»é™¤å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†çš„éƒ¨åˆ†ï¼Œå› ä¸ºç°åœ¨æ˜¯åœ¨è¯¦æƒ…é¡µé¢ä¸­è¿›è¡Œå®¡æ‰¹æ“ä½œ
            // ä¿å­˜å½“å‰å¡ç‰‡ç´¢å¼•ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªåŠ¨æ˜¾ç¤ºä¸‹ä¸€ä¸ª
            const wasCurrentCard = pendingCards.findIndex(app => app.id === id) === currentCardIndex;

            // åŸæœ‰çš„å®¡æ‰¹é€»è¾‘
            const approvalSelect = document.querySelector(`select[onchange="approveApplication(${id}, this.value)"]`);
            if (approvalSelect) {
                approvalSelect.disabled = true;
            }

            // æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
            const msgElement = document.createElement('div');
            msgElement.id = 'processingMessage';
            msgElement.className = 'fixed top-0 left-0 w-full bg-blue-500 text-white text-center py-2 z-50';
            msgElement.textContent = 'å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...';
            document.body.appendChild(msgElement);

            try {
                // è·å–å½“å‰ç”³è¯· - ä¼˜åŒ–:å¦‚æœæœ¬åœ°æ‰¾ä¸åˆ°,å°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
                let app = applications.find(a => a.id === id);
                if (!app) {
                    console.warn(`æœ¬åœ°æœªæ‰¾åˆ°ç”³è¯·ID=${id},å°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®`);
                    // å°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°çš„ç”³è¯·æ•°æ®
                    try {
                        const response = await fetch(`/application/${id}?username=${currentUser}`);
                        const result = await response.json();
                        if (result.success && result.application) {
                            app = result.application;
                            // æ›´æ–°æœ¬åœ°applicationsæ•°ç»„
                            const existingIndex = applications.findIndex(a => a.id === id);
                            if (existingIndex !== -1) {
                                applications[existingIndex] = app;
                            } else {
                                applications.push(app);
                            }
                            console.log(`æˆåŠŸä»æœåŠ¡å™¨è·å–ç”³è¯·ID=${id}`);
                        } else {
                            throw new Error('ç”³è¯·ä¸å­˜åœ¨æˆ–å·²è¢«å¤„ç†');
                        }
                    } catch (fetchError) {
                        console.error('ä»æœåŠ¡å™¨è·å–ç”³è¯·å¤±è´¥:', fetchError);
                        throw new Error('ç”³è¯·ä¸å­˜åœ¨æˆ–å·²è¢«å…¶ä»–å®¡æ ¸äººå¤„ç†');
                    }
                }

                // è·å–å®¡æ‰¹å¤‡æ³¨å’Œé™„ä»¶
                let comment = '';
                let attachments = [];

                // å¦‚æœæ˜¯ä»è¯¦æƒ…é¡µé¢å®¡æ‰¹çš„ï¼Œè·å–å¤‡æ³¨å’Œé™„ä»¶
                const commentElement = document.getElementById('detail-approval-comment');
                if (commentElement) {
                    comment = commentElement.value.trim();
                }

                // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è¾“å…¥å…ƒç´ IDè·å–å®¡æ‰¹é™„ä»¶
                const fileInput = document.getElementById('detail-new-attachments');
                if (fileInput && fileInput.files.length > 0) {
                    attachments = Array.from(fileInput.files);
                }

                // å¦‚æœæ˜¯æ€»ç›‘å®¡æ‰¹ï¼Œè¿˜éœ€è¦è·å–é€‰æ‹©çš„ç»ç†
                let selectedManagers = [];
                if (currentRole === 'chief' && app.status === 'å¾…æ€»ç›‘å®¡æ‰¹') {
                    const managerCheckboxes = document.querySelectorAll(`.manager-checkbox:checked`);
                    selectedManagers = Array.from(managerCheckboxes).map(cb => cb.value);

                    // å¦‚æœæ€»ç›‘é€šè¿‡å®¡æ‰¹ä½†æ²¡æœ‰é€‰æ‹©ç»ç†ï¼Œç»™å‡ºæé†’
                    if (status === 'approved' && selectedManagers.length === 0) {
                        if (!confirm('æ‚¨æ²¡æœ‰é€‰æ‹©ä»»ä½•ç»ç†ï¼Œç”³è¯·å°†åœ¨æ‚¨å®¡æ‰¹é€šè¿‡åç›´æ¥æµè½¬ç»™CEOè¿›è¡Œæœ€ç»ˆå®¡æ‰¹ã€‚\n\næ˜¯å¦ç¡®è®¤é€šè¿‡æ­¤ç”³è¯·ï¼Ÿ')) {
                            // ç”¨æˆ·å–æ¶ˆï¼Œç§»é™¤å¤„ç†ä¸­æç¤ºå¹¶åœæ­¢å®¡æ‰¹æµç¨‹
                            document.body.removeChild(msgElement);
                            return;
                        }
                    }
                }

                // è·å–å½“å‰ç”¨æˆ·çš„ç”µå­ç­¾å - ä¿®å¤æ€»ç›‘ç­¾åè·å–é—®é¢˜
                let currentUserData = allUsers ? allUsers.find(u => u.username === currentUser) : null;

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œå°è¯•é€šè¿‡è§’è‰²æŸ¥æ‰¾ï¼ˆç‰¹åˆ«æ˜¯æ€»ç›‘ç”¨æˆ·ï¼‰
                if (!currentUserData && currentRole === 'chief') {
                    currentUserData = allUsers ? allUsers.find(u => u.role === 'chief') : null;
                }

                // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å®æ—¶åŠ è½½ç”¨æˆ·ç­¾å
                let userSignature = currentUserData ? currentUserData.signature : null;

                if (!userSignature) {
                    try {
                        // å°è¯•ä»æœåŠ¡å™¨å®æ—¶è·å–å½“å‰ç”¨æˆ·çš„ç­¾å
                        const signatureResponse = await apiRequest(`/signatures?username=${currentUser}`, {
                            method: 'GET',
                            timeout: 5000
                        });

                        if (signatureResponse && Array.isArray(signatureResponse)) {
                            const userWithSignature = signatureResponse.find(u =>
                                u.username === currentUser ||
                                (currentRole === 'chief' && u.role === 'chief')
                            );
                            if (userWithSignature && userWithSignature.signature) {
                                userSignature = userWithSignature.signature;
                                console.log('æˆåŠŸè·å–ç”¨æˆ·ç­¾å:', currentUser, 'ç­¾åé•¿åº¦:', userSignature.length);
                            }
                        }
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·ç­¾åå¤±è´¥:', error);
                    }
                }

                // CEOç­¾åè·å–å¤„ç†

                // æ„å»ºè¡¨å•æ•°æ®
                const formData = new FormData();
            formData.append('id', id);
            formData.append('status', status);
                formData.append('username', currentUser);
                formData.append('role', currentRole);
                formData.append('comment', comment);
                formData.append('signature', userSignature || '');

                // æ·»åŠ é™„ä»¶
                for (let i = 0; i < attachments.length; i++) {
                    formData.append('newAttachments', attachments[i]);
                }

                // å¦‚æœæ˜¯æ€»ç›‘å®¡æ‰¹ï¼Œæ·»åŠ é€‰æ‹©çš„ç»ç†
                if (currentRole === 'chief' && app.status === 'å¾…æ€»ç›‘å®¡æ‰¹' && selectedManagers.length > 0) {
                    formData.append('selectedManagers', JSON.stringify(selectedManagers));
                }

                // å‘é€å®¡æ‰¹è¯·æ±‚
                const response = await fetch('/approve', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // ç§»é™¤å¤„ç†ä¸­æç¤º
                document.body.removeChild(msgElement);

                if (result.success) {
                    // æ›´æ–°æœ¬åœ°åº”ç”¨æ•°æ®
                    const appIndex = applications.findIndex(a => a.id === id);
                    if (appIndex !== -1) {
                        // å¦‚æœåç«¯æ²¡æœ‰å¤„ç†ç”µå­ç­¾åï¼Œåœ¨å‰ç«¯æ·»åŠ 
                        if (!result.application.approvals) {
                            result.application.approvals = app.approvals || {};
                        }

                        // æ ¹æ®è§’è‰²æ›´æ–°å®¡æ‰¹ä¿¡æ¯
                        if (currentRole === 'director') {
                            if (!result.application.approvals.directors) {
                                result.application.approvals.directors = {};
                            }
                            if (!result.application.approvals.directors[currentUser]) {
                                result.application.approvals.directors[currentUser] = {};
                            }
                            result.application.approvals.directors[currentUser].status = status;
                            result.application.approvals.directors[currentUser].comment = comment;
                            result.application.approvals.directors[currentUser].date = new Date().toISOString();
                            result.application.approvals.directors[currentUser].signature = userSignature;
                        } else if (currentRole === 'chief') {
                            if (!result.application.approvals.chief) {
                                result.application.approvals.chief = {};
                            }
                            result.application.approvals.chief.status = status;
                            result.application.approvals.chief.comment = comment;
                            result.application.approvals.chief.date = new Date().toISOString();
                            result.application.approvals.chief.signature = userSignature;
                        } else if (currentRole === 'manager') {
                            if (!result.application.approvals.managers) {
                                result.application.approvals.managers = {};
                            }
                            if (!result.application.approvals.managers[currentUser]) {
                                result.application.approvals.managers[currentUser] = {};
                            }
                            result.application.approvals.managers[currentUser].status = status;
                            result.application.approvals.managers[currentUser].comment = comment;
                            result.application.approvals.managers[currentUser].date = new Date().toISOString();
                            result.application.approvals.managers[currentUser].signature = userSignature;
                        } else if (currentRole === 'ceo') {
                            if (!result.application.approvals.ceo) {
                                result.application.approvals.ceo = {};
                            }
                            result.application.approvals.ceo.status = status;
                            result.application.approvals.ceo.comment = comment;
                            result.application.approvals.ceo.date = new Date().toISOString();
                            result.application.approvals.ceo.signature = userSignature;
                            result.application.approvals.ceo.approverUsername = currentUser; // è®°å½•å®¡æ‰¹äººç”¨æˆ·åï¼Œä¾¿äºå†å²æ•°æ®å¤„ç†
                        }

                        applications[appIndex] = result.application;
                    }

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert('å®¡æ‰¹æˆåŠŸ');

                    // æ¸…ç†æ‰€æœ‰ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æ›´æ–°
                    clearAllCaches();

                    // å¼ºåˆ¶å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
                    const detailModal = document.getElementById('detailModal');
                    if (detailModal) {
                        detailModal.classList.add('hidden');
                        // é‡ç½®æ»šåŠ¨ä½ç½®
                        detailModal.scrollTop = 0;
                    }

                    // å®¡æ‰¹æˆåŠŸåï¼Œæ— è®ºå½“å‰åœ¨å“ªä¸ªé¡µé¢ï¼Œéƒ½è¦æ›´æ–°ç›¸å…³åˆ—è¡¨
                    const activeSection = document.querySelector('.side-nav-btn.active')?.textContent;

                    // æ€»æ˜¯æ›´æ–°å¾…å®¡æ ¸åˆ—è¡¨ï¼ˆç§»é™¤å·²å®¡æ ¸çš„ç”³è¯·ï¼‰
                    updatePendingApprovalList();

                    // æ€»æ˜¯æ›´æ–°å·²å®¡æ ¸åˆ—è¡¨ï¼ˆæ·»åŠ åˆšå®¡æ ¸çš„ç”³è¯·ï¼‰
                    updateApprovedList();

                    if (activeSection && activeSection.includes('å¾…å®¡æ ¸')) {
                        // å¦‚æœæ˜¯ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾ï¼Œç«‹å³å¤„ç†ä¸‹ä¸€ä¸ªå¡ç‰‡
                        if (window.innerWidth <= 768) {
                            // ä»pendingCardsæ•°ç»„ä¸­ç§»é™¤å·²å®¡æ ¸çš„ç”³è¯·
                            const cardIndex = pendingCards.findIndex(card => card.id === id);
                            if (cardIndex !== -1) {
                                // ç§»é™¤å·²å®¡æ ¸çš„å¡ç‰‡
                                pendingCards.splice(cardIndex, 1);

                                // æ›´æ–°å¡ç‰‡è®¡æ•°
                                document.getElementById('totalCards').textContent = pendingCards.length;

                                // å¦‚æœæ²¡æœ‰æ›´å¤šå¾…å®¡æ ¸çš„ç”³è¯·ï¼Œæ˜¾ç¤ºå®Œæˆæç¤º
                                if (pendingCards.length === 0) {
                                    const cardContainer = document.getElementById('pendingCardContainer');
                                    cardContainer.innerHTML = `
                                        <div class="text-center py-8">
                                            <p class="text-green-600 font-semibold text-lg">æ‚¨å·²å®Œæˆæ‰€æœ‰å®¡æ ¸ï¼Œè¯·ä¼‘æ¯ä¸€ä¸‹å§</p>
                                            <div class="mt-4">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </div>
                                        </div>
                                    `;

                                    // æ›´æ–°å½“å‰å¡ç‰‡ç´¢å¼•æ˜¾ç¤º
                                    document.getElementById('currentCardIndex').textContent = "0";

                                    // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                                    updatePendingCount(0);
                                } else {
                                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ˜¾ç¤ºçš„å¡ç‰‡ï¼Œä¸”ä¸æ˜¯æœ€åä¸€ä¸ªå¡ç‰‡
                                    // ä¿æŒå½“å‰ç´¢å¼•ä¸å˜ï¼ˆè¿™æ ·ä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸‹ä¸€ä¸ªå¡ç‰‡ï¼‰
                                    if (cardIndex === currentCardIndex && currentCardIndex >= pendingCards.length) {
                                        currentCardIndex = pendingCards.length - 1;
                                    } else if (cardIndex < currentCardIndex) {
                                        // å¦‚æœåˆ é™¤çš„å¡ç‰‡åœ¨å½“å‰å¡ç‰‡ä¹‹å‰ï¼Œå½“å‰ç´¢å¼•éœ€è¦å‡1
                                        currentCardIndex--;
                                    }
                                    // å¦åˆ™å½“å‰ç´¢å¼•ä¿æŒä¸å˜

                                    // æ›´æ–°å½“å‰å¡ç‰‡ç´¢å¼•æ˜¾ç¤º
                                    document.getElementById('currentCardIndex').textContent = currentCardIndex + 1;

                                    // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                                    updatePendingCount(pendingCards.length);
                                }

                                // é‡æ–°æ¸²æŸ“å½“å‰å¡ç‰‡
                                renderCurrentCard();

                                // æ›´æ–°å¡ç‰‡å¯¼èˆªæŒ‰é’®çŠ¶æ€
                                updateCardNavButtons();
                            }
                        } else {
                            // éç§»åŠ¨ç«¯è§†å›¾ï¼Œæ›´æ–°å¾…å®¡æ ¸æ•°é‡
                            updatePendingCount();
                        }
                    }
                } else {
                    alert('å®¡æ‰¹å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));

                    // é‡æ–°å¯ç”¨å®¡æ‰¹ä¸‹æ‹‰èœå•
                    if (approvalSelect) {
                        approvalSelect.disabled = false;
                        approvalSelect.value = 'pending'; // é‡ç½®ä¸ºå¾…å®¡æ‰¹çŠ¶æ€
                    }
                }
            } catch (error) {
                console.error('å®¡æ‰¹å¤±è´¥:', error);

                // ç§»é™¤å¤„ç†ä¸­æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const msgElement = document.getElementById('processingMessage');
                if (msgElement) {
                    document.body.removeChild(msgElement);
                }

                // ä¼˜åŒ–é”™è¯¯æç¤ºä¿¡æ¯
                let errorMessage = 'å®¡æ‰¹å¤±è´¥: ';
                if (error.message.includes('ç”³è¯·ä¸å­˜åœ¨') || error.message.includes('å·²è¢«å¤„ç†') || error.message.includes('å·²è¢«å…¶ä»–å®¡æ ¸äººå¤„ç†')) {
                    errorMessage = 'è¯¥ç”³è¯·å¯èƒ½å·²è¢«å…¶ä»–å®¡æ ¸äººå¤„ç†æˆ–å·²åˆ é™¤ã€‚é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚';
                    alert(errorMessage);

                    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
                    const detailModal = document.getElementById('detailModal');
                    if (detailModal) {
                        detailModal.classList.add('hidden');
                        detailModal.scrollTop = 0;
                    }

                    // æ¸…ç†æ‰€æœ‰ç¼“å­˜
                    clearAllCaches();

                    // è‡ªåŠ¨åˆ·æ–°å½“å‰é¡µé¢æ•°æ®
                    const currentSection = getCurrentSection();
                    if (currentSection === 'pendingApproval') {
                        updatePendingApprovalList();
                    } else if (currentSection === 'approved') {
                        updateApprovedList();
                    } else if (currentSection === 'history') {
                        updateHistoryList();
                    }

                    // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                    updatePendingCount();

                    return; // ç›´æ¥è¿”å›,ä¸å†æ‰§è¡Œåç»­çš„é”™è¯¯å¤„ç†
                } else {
                    errorMessage += (error.message || 'ç½‘ç»œé”™è¯¯');
                    alert(errorMessage);
                }

                // é‡æ–°å¯ç”¨å®¡æ‰¹ä¸‹æ‹‰èœå•
                const approvalSelect = document.querySelector(`select[onchange="approveApplication(${id}, this.value)"]`);
                if (approvalSelect) {
                    approvalSelect.disabled = false;
                    approvalSelect.value = 'pending'; // é‡ç½®ä¸ºå¾…å®¡æ‰¹çŠ¶æ€
                }

                // é‡ç½®è¯¦æƒ…é¡µé¢ä¸­çš„å®¡æ ¸äººé€‰æ‹©æ¡†
                if (currentRole === 'chief' && error.message.includes('è¯·è‡³å°‘é€‰æ‹©ä¸€ä½ç»ç†')) {
                    // å–æ¶ˆæ‰€æœ‰ç»ç†é€‰æ‹©æ¡†çš„é€‰ä¸­çŠ¶æ€
                    const managerCheckboxes = document.querySelectorAll(`.manager-checkbox`);
                    managerCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
            }
        }

        async function viewDetail(id) {
            let app = applications.find(a => a.id === id);
            if (!app) {
                // å¦‚æœåœ¨å½“å‰é¡µé¢æ•°æ®ä¸­æ‰¾ä¸åˆ°ï¼Œå°è¯•ä»æœåŠ¡å™¨è·å–
                try {
                    const response = await fetch(`/application/${id}?username=${currentUser}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„ç”³è¯·æ•°æ®ï¼Œç›´æ¥è°ƒç”¨è¯¦æƒ…æ˜¾ç¤ºé€»è¾‘
                            const serverApp = data.application;

                            // åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨å¾…å®¡æ ¸é¡µé¢
                            const isPendingApprovalPage = document.getElementById('pendingApprovalSection').classList.contains('hidden') === false;

                            // ç”Ÿæˆè¯¦æƒ…å†…å®¹
                            generateDetailContent(serverApp, isPendingApprovalPage);

                            // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
                            document.getElementById('detailModal').classList.remove('hidden');
                            document.body.classList.add('modal-open');

                            // åº”ç”¨æ¨¡æ€æ¡†é«˜åº¦æ§åˆ¶
                            if (typeof adjustModalHeight === 'function') {
                                setTimeout(() => {
                                    adjustModalHeight('detailModal');
                                    if (typeof adjustDetailTabsHeight === 'function') {
                                        adjustDetailTabsHeight();
                                    }
                                }, 10);
                            }
                            return;
                        }
                    }
                } catch (error) {
                    console.error('è·å–ç”³è¯·è¯¦æƒ…å¤±è´¥:', error);
                }
                // ä¼˜åŒ–é”™è¯¯æç¤º
                alert('è¯¥ç”³è¯·å¯èƒ½å·²è¢«åˆ é™¤æˆ–æ‚¨æ— æƒæŸ¥çœ‹ã€‚é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚');

                // æ¸…ç†ç¼“å­˜å¹¶åˆ·æ–°å½“å‰é¡µé¢
                clearAllCaches();
                const currentSection = getCurrentSection();
                if (currentSection === 'pendingApproval') {
                    updatePendingApprovalList();
                } else if (currentSection === 'approved') {
                    updateApprovedList();
                } else if (currentSection === 'history') {
                    updateHistoryList();
                }
                return;
            }

            // ç®€åŒ–æƒé™æ£€æŸ¥ï¼šå¦‚æœç”¨æˆ·èƒ½åœ¨å½“å‰é¡µé¢çœ‹åˆ°è¿™ä¸ªç”³è¯·ï¼Œå°±æœ‰æƒé™æŸ¥çœ‹è¯¦æƒ…
            // ç®¡ç†å‘˜ã€åªè¯»ç”¨æˆ·ã€å®¡æ ¸äººå‘˜ã€ç”³è¯·äººéƒ½å¯ä»¥æŸ¥çœ‹
            const hasPermission = currentRole === 'admin' ||
                                currentRole === 'readonly' ||
                                ['director', 'chief', 'manager', 'ceo'].includes(currentRole) ||
                                app.username === currentUser;

            if (!hasPermission) {
                alert('æ‚¨æ— æƒæŸ¥çœ‹æ­¤ç”³è¯·çš„è¯¦ç»†ä¿¡æ¯');
                return;
            }

            // ç¡®ä¿å·²åŠ è½½æ‰€æœ‰ç”¨æˆ·çš„ç­¾åæ•°æ®
            if (!allUsers || allUsers.length === 0) {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'detailLoadingIndicator';
                loadingIndicator.className = 'fixed top-0 left-0 w-full bg-blue-500 text-white text-center py-2 z-50';
                loadingIndicator.textContent = 'æ­£åœ¨åŠ è½½ç­¾åæ•°æ®ï¼Œè¯·ç¨å€™...';
                document.body.appendChild(loadingIndicator);

                try {
                    // æ”¶é›†éœ€è¦ç­¾åçš„ç”¨æˆ·
                    const usersNeedingSignatures = new Set();

                    // æ·»åŠ ç”³è¯·äºº
                    if (app.applicant) {
                        usersNeedingSignatures.add(app.applicant);
                    }

                    // æ·»åŠ å®¡æ‰¹äºº
                    if (app.approvals) {
                        if (app.approvals.managers) {
                            Object.keys(app.approvals.managers).forEach(manager => {
                                usersNeedingSignatures.add(manager);
                            });
                        }
                        if (app.approvals.directors) {
                            Object.keys(app.approvals.directors).forEach(director => {
                                usersNeedingSignatures.add(director);
                            });
                        }
                        if (app.approvals.chief && app.approvals.chief.approverUsername) {
                            usersNeedingSignatures.add(app.approvals.chief.approverUsername);
                        }
                        if (app.approvals.ceo && app.approvals.ceo.approverUsername) {
                            usersNeedingSignatures.add(app.approvals.ceo.approverUsername);
                        }
                    }

                    // æŒ‰éœ€åŠ è½½æ‰€éœ€çš„ç­¾å
                    const signatures = await loadMultipleSignatures(Array.from(usersNeedingSignatures));

                    // æ›´æ–°allUsersæ•°æ®ç»“æ„ä»¥å…¼å®¹ç°æœ‰ä»£ç 
                    if (!allUsers) allUsers = [];

                    Array.from(usersNeedingSignatures).forEach(username => {
                        let existingUser = allUsers.find(u => u.username === username);
                        if (!existingUser) {
                            existingUser = {
                                username: username,
                                signature: signatures[username] || null
                            };
                            allUsers.push(existingUser);
                        } else if (signatures[username]) {
                            existingUser.signature = signatures[username];
                        }
                    });
                } catch (error) {
                    console.error('åŠ è½½ç”¨æˆ·ç­¾åæ•°æ®å‡ºé”™:', error);
                } finally {
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    const indicator = document.getElementById('detailLoadingIndicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            }

            // åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨å¾…å®¡æ ¸é¡µé¢
            const isPendingApprovalPage = document.getElementById('pendingApprovalSection').classList.contains('hidden') === false;

            // ç”Ÿæˆè¯¦æƒ…å†…å®¹
            generateDetailContent(app, isPendingApprovalPage);

            // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
            document.getElementById('detailModal').classList.remove('hidden');

            // æ·»åŠ bodyç±»é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.classList.add('modal-open');

            // åº”ç”¨æ¨¡æ€æ¡†é«˜åº¦æ§åˆ¶ï¼ˆå¦‚æœå·²åŠ è½½modal-height-control.jsï¼‰
            if (typeof adjustModalHeight === 'function') {
                setTimeout(() => {
                    adjustModalHeight('detailModal');
                    if (typeof adjustDetailTabsHeight === 'function') {
                        adjustDetailTabsHeight();
                    }
                }, 10);
            }

            // å½“æ€»ç›‘æŸ¥çœ‹å¾…å®¡æ‰¹çš„ç”³è¯·æ—¶ï¼ŒåŠ è½½ç»ç†åˆ—è¡¨
            if (isPendingApprovalPage && currentRole === 'chief' && app.status === 'å¾…æ€»ç›‘å®¡æ‰¹') {
                const managersListContainer = document.getElementById(`managersList_${app.id}`);
                if (managersListContainer) {
                    renderManagersList(managersListContainer, []);

                    // æ·»åŠ ç»ç†é€‰æ‹©å˜åŒ–ç›‘å¬
                    setTimeout(() => {
                        const checkboxes = managersListContainer.querySelectorAll('.manager-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                updateSelectedManagersCount(app.id);
                            });
                        });

                        // åˆå§‹åŒ–é€‰æ‹©è®¡æ•°
                        updateSelectedManagersCount(app.id);
                    }, 100);
                }
            }

            // æ³¨é‡Šï¼šé™„ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬åœ¨è¯¦æƒ…é¡µé¢ä¸Šä¼ åŒºåŸŸç»Ÿä¸€å¤„ç†ï¼ˆç¬¬5061è¡Œï¼‰ï¼Œé¿å…é‡å¤è®¾ç½®
        }

        // ç”Ÿæˆç”³è¯·è¯¦æƒ…å†…å®¹
        function generateDetailContent(app, isPendingApprovalPage) {
            // è®¾ç½®åŸºæœ¬ä¿¡æ¯
            document.getElementById('detail-code').textContent = app.applicationCode || 'æ— ';
            document.getElementById('detail-applicant').textContent = sanitizeInput(app.applicant);
            document.getElementById('detail-department').textContent = sanitizeInput(app.department);
            document.getElementById('detail-date').textContent = app.date;
            document.getElementById('detail-status').textContent = `${app.status} (${getApplicationStatusDesc(app.status, app)})`;
            document.getElementById('detail-content').textContent = sanitizeInput(app.content);

            // è®¾ç½®ç”³è¯·é‡‘é¢
            const amountEl = document.getElementById('detail-amount');
            if (app.amount) {
                const currency = app.currency || 'CNY';
                amountEl.textContent = `${formatCurrency(parseFloat(app.amount), currency)}`;

                // ä¸å†æ˜¾ç¤ºç¾å…ƒçº¦åˆäººæ°‘å¸çš„ç­‰å€¼

                amountEl.classList.remove('text-gray-500');
                amountEl.classList.add('text-blue-700');
            } else {
                amountEl.textContent = 'æ— ';
                amountEl.classList.remove('text-blue-700');
                amountEl.classList.add('text-gray-500');
            }

            // è®¾ç½®æ“ä½œæŒ‰é’®
            document.getElementById('detail-view-template').onclick = () => previewApplicationTemplate(app.id);

            // æ’¤å›å®¡æ‰¹æŒ‰é’®
            const withdrawBtn = document.getElementById('detail-withdraw');
            if (canWithdrawApproval(app)) {
                withdrawBtn.classList.remove('hidden');
                withdrawBtn.onclick = () => handleWithdrawApproval(app.id);
            } else {
                withdrawBtn.classList.add('hidden');
            }

            // è®¾ç½®å‚é•¿å®¡æ‰¹è®°å½•
            const directorsEl = document.getElementById('detail-directors-approvals');
            if (app.approvals.directors && Object.keys(app.approvals.directors).length > 0) {
                directorsEl.innerHTML = Object.entries(app.approvals.directors).map(([director, approval]) => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                    let roleChangeInfo = '';
                    if (approval.originalRole && approval.roleChangedTo) {
                        roleChangeInfo = `<p class="text-xs text-blue-600 mt-1">æ³¨ï¼šæ­¤ç”¨æˆ·å·²ä»${approval.originalRole === 'director' ? 'å‚é•¿' : approval.originalRole}å˜æ›´ä¸º${getRoleDisplayName(approval.roleChangedTo)}</p>`;
                    }

                    return `
                        <div class="bg-white p-3 rounded border">
                            <div class="flex justify-between">
                                <span class="font-medium">å‚é•¿ ${sanitizeInput(director)}</span>
                                <span class="${approval.status === 'approved' ? 'text-green-600' : approval.status === 'rejected' ? 'text-red-600' : 'text-blue-600'}">
                                    ${statusMap[approval.status] || approval.status}
                                </span>
                            </div>
                            ${approval.comment ? `<p class="text-gray-600 mt-2">${sanitizeInput(approval.comment)}</p>` : ''}
                            ${approval.date ? `<p class="text-xs text-gray-500 mt-1">å®¡æ‰¹æ—¶é—´: ${formatDate(approval.date)}</p>` : ''}
                            ${roleChangeInfo}
                        </div>
                    `;
                }).join('');
            } else {
                directorsEl.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— å‚é•¿å®¡æ‰¹ä¿¡æ¯</p>';
            }

            // è®¾ç½®æ€»ç›‘å®¡æ‰¹è®°å½•
            const chiefEl = document.getElementById('detail-chief-approval');
            if (app.approvals.chief && app.approvals.chief.status && app.approvals.chief.status !== 'pending') {
                // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                let roleChangeInfo = '';
                if (app.approvals.chief.originalRole && app.approvals.chief.roleChangedTo) {
                    const approverName = app.approvals.chief.approverUsername || 'æ€»ç›‘';
                    roleChangeInfo = `<p class="text-xs text-blue-600 mt-1">æ³¨ï¼šå®¡æ‰¹äºº ${approverName} å·²ä»${app.approvals.chief.originalRole === 'chief' ? 'æ€»ç›‘' : app.approvals.chief.originalRole}å˜æ›´ä¸º${getRoleDisplayName(app.approvals.chief.roleChangedTo)}</p>`;
                }

                chiefEl.innerHTML = `
                    <div class="bg-white p-3 rounded border">
                        <div class="flex justify-between">
                            <span class="font-medium">æ€»ç›‘å®¡æ‰¹</span>
                            <span class="${app.approvals.chief.status === 'approved' ? 'text-green-600' : 'text-red-600'}">
                                ${statusMap[app.approvals.chief.status] || app.approvals.chief.status}
                            </span>
                        </div>
                        ${app.approvals.chief.comment ? `<p class="text-gray-600 mt-2">${sanitizeInput(app.approvals.chief.comment)}</p>` : ''}
                        ${app.approvals.chief.date ? `<p class="text-xs text-gray-500 mt-1">å®¡æ‰¹æ—¶é—´: ${formatDate(app.approvals.chief.date)}</p>` : ''}
                        ${roleChangeInfo}
                    </div>
                `;
            } else {
                chiefEl.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— æ€»ç›‘å®¡æ‰¹ä¿¡æ¯</p>';
            }

            // è®¾ç½®ç»ç†å®¡æ‰¹è®°å½•
            const managersEl = document.getElementById('detail-managers-approvals');
            if (app.approvals.managers && Object.keys(app.approvals.managers).length > 0) {
                const approvedManagers = Object.entries(app.approvals.managers).filter(([_, approval]) =>
                    approval.status && approval.status !== 'pending'
                );

                if (approvedManagers.length > 0) {
                    managersEl.innerHTML = approvedManagers.map(([manager, approval]) => {
                        // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                        let roleChangeInfo = '';
                        if (approval.originalRole && approval.roleChangedTo) {
                            roleChangeInfo = `<p class="text-xs text-blue-600 mt-1">æ³¨ï¼šæ­¤ç”¨æˆ·å·²ä»${approval.originalRole === 'manager' ? 'ç»ç†' : approval.originalRole}å˜æ›´ä¸º${getRoleDisplayName(approval.roleChangedTo)}</p>`;
                        }

                        return `
                            <div class="bg-white p-3 rounded border">
                                <div class="flex justify-between">
                                    <span class="font-medium">ç»ç† ${sanitizeInput(manager)}</span>
                                    <span class="${approval.status === 'approved' ? 'text-green-600' : 'text-red-600'}">
                                        ${statusMap[approval.status] || approval.status}
                                    </span>
                                </div>
                                ${approval.comment ? `<p class="text-gray-600 mt-2">${sanitizeInput(approval.comment)}</p>` : ''}
                                ${approval.date ? `<p class="text-xs text-gray-500 mt-1">å®¡æ‰¹æ—¶é—´: ${formatDate(approval.date)}</p>` : ''}
                                ${roleChangeInfo}
                            </div>
                        `;
                    }).join('');
                } else {
                    managersEl.innerHTML = '<p class="text-gray-500 text-center">ç»ç†å®¡æ‰¹è¿›è¡Œä¸­ï¼Œæš‚æ— å®¡æ‰¹ç»“æœ</p>';
                }
            } else {
                managersEl.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— ç»ç†å®¡æ‰¹ä¿¡æ¯</p>';
            }

            // è®¾ç½®CEOå®¡æ‰¹ä¿¡æ¯
            const ceoEl = document.getElementById('detail-ceo');
            if (app.approvals.ceo && (app.approvals.ceo.status === 'approved' || app.approvals.ceo.status === 'rejected')) {
                const ceoApproval = app.approvals.ceo;

                // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                let roleChangeInfo = '';
                if (ceoApproval.originalRole && ceoApproval.roleChangedTo) {
                    const approverName = ceoApproval.approverUsername || 'CEO';
                    roleChangeInfo = `<p class="text-xs text-blue-600 mt-1">æ³¨ï¼šå®¡æ‰¹äºº ${approverName} å·²ä»${ceoApproval.originalRole === 'ceo' ? 'CEO' : getRoleDisplayName(ceoApproval.originalRole)}å˜æ›´ä¸º${getRoleDisplayName(ceoApproval.roleChangedTo)}</p>`;
                }

                ceoEl.innerHTML = `
                    <div class="bg-white p-3 rounded border">
                        <div class="flex justify-between">
                            <span class="font-medium">CEO</span>
                            <span class="${ceoApproval.status === 'approved' ? 'text-green-600' : 'text-red-600'}">
                                ${statusMap[ceoApproval.status] || ceoApproval.status}
                            </span>
                        </div>
                        ${ceoApproval.comment ? `<p class="text-gray-600 mt-2">${sanitizeInput(ceoApproval.comment)}</p>` : ''}
                        ${ceoApproval.date ? `<p class="text-xs text-gray-500 mt-1">å®¡æ‰¹æ—¶é—´: ${formatDate(ceoApproval.date)}</p>` : ''}
                        ${roleChangeInfo}
                    </div>
                `;
            } else {
                ceoEl.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— CEOå®¡æ‰¹ä¿¡æ¯</p>';
            }

            // è®¾ç½®åˆå§‹é™„ä»¶
            const attachmentsEl = document.getElementById('detail-attachments');
            if (app.attachments && app.attachments.length > 0) {
                attachmentsEl.innerHTML = app.attachments.map(f => `
                    <div class="flex items-center justify-between bg-white p-3 rounded border">
                        <span class="truncate max-w-xs">${sanitizeInput(decodeURIComponent(f.name))}</span>
                        <div class="flex space-x-2">
                            <button onclick="previewFile('${f.path}', '${encodeURIComponent(f.name)}')" class="text-green-600 hover:text-green-800 text-sm px-3 py-1 rounded border border-green-200 hover:bg-green-50">é¢„è§ˆ</button>
                            <a href="/download/${f.path}?name=${encodeURIComponent(f.name)}" class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 rounded border border-blue-200 hover:bg-blue-50" download="${decodeURIComponent(f.name)}">ä¸‹è½½</a>
                        </div>
                    </div>
                `).join('');
            } else {
                attachmentsEl.innerHTML = '<p class="text-gray-500 text-center">æ— é™„ä»¶</p>';
            }

            // è®¾ç½®å®¡æ‰¹é™„ä»¶
            const approvalAttachmentsEl = document.getElementById('detail-approval-attachments');
            let allApprovalAttachments = [];

            // æ”¶é›†æ‰€æœ‰å®¡æ‰¹é™„ä»¶
            if (app.approvals.directors) {
                Object.entries(app.approvals.directors).forEach(([director, approval]) => {
                    if (approval.attachments && approval.attachments.length > 0) {
                        approval.attachments.forEach(f => {
                            allApprovalAttachments.push({
                                ...f,
                                approver: director // ç›´æ¥æ˜¾ç¤ºå®¡æ‰¹äººå§“å
                            });
                        });
                    }
                });
            }

            if (app.approvals.chief && app.approvals.chief.attachments && app.approvals.chief.attachments.length > 0) {
                // è·å–æ€»ç›‘çš„çœŸå®å§“å
                const chiefUser = allUsers ? allUsers.find(u => u.role === 'chief') : null;
                const chiefName = chiefUser ? chiefUser.username : 'æ€»ç›‘';

                app.approvals.chief.attachments.forEach(f => {
                    allApprovalAttachments.push({
                        ...f,
                        approver: chiefName // æ˜¾ç¤ºæ€»ç›‘çš„çœŸå®å§“å
                    });
                });
            }

            if (app.approvals.managers) {
                Object.entries(app.approvals.managers).forEach(([manager, approval]) => {
                    if (approval.attachments && approval.attachments.length > 0) {
                        approval.attachments.forEach(f => {
                            allApprovalAttachments.push({
                                ...f,
                                approver: manager // ç›´æ¥æ˜¾ç¤ºå®¡æ‰¹äººå§“å
                            });
                        });
                    }
                });
            }

            if (app.approvals.ceo && app.approvals.ceo.attachments && app.approvals.ceo.attachments.length > 0) {
                // è·å–CEOçš„çœŸå®å§“å
                const ceoUser = allUsers ? allUsers.find(u => u.role === 'ceo') : null;
                const ceoName = ceoUser ? ceoUser.username : 'CEO';

                app.approvals.ceo.attachments.forEach(f => {
                    allApprovalAttachments.push({
                        ...f,
                        approver: ceoName // æ˜¾ç¤ºCEOçš„çœŸå®å§“å
                    });
                });
            }

            if (allApprovalAttachments.length > 0) {
                approvalAttachmentsEl.innerHTML = allApprovalAttachments.map(f => `
                    <div class="flex items-center justify-between bg-white p-3 rounded border">
                        <div>
                            <span class="truncate max-w-xs block">${sanitizeInput(decodeURIComponent(f.name))}</span>
                            <span class="text-xs text-gray-500">ä¸Šä¼ è€…: ${f.approver}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="previewFile('${f.path}', '${encodeURIComponent(f.name)}')" class="text-green-600 hover:text-green-800 text-sm px-3 py-1 rounded border border-green-200 hover:bg-green-50">é¢„è§ˆ</button>
                            <a href="/download/${f.path}?name=${encodeURIComponent(f.name)}" class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 rounded border border-blue-200 hover:bg-blue-50" download="${decodeURIComponent(f.name)}">ä¸‹è½½</a>
                        </div>
                    </div>
                `).join('');
            } else {
                approvalAttachmentsEl.innerHTML = '<p class="text-gray-500 text-center">æ— å®¡æ‰¹é™„ä»¶</p>';
            }

            // ä¸Šä¼ æ–°é™„ä»¶åŒºåŸŸ
            const uploadSectionEl = document.getElementById('detail-upload-section');
            if (isPendingApprovalPage && canApprove(app)) {
                uploadSectionEl.classList.remove('hidden');

                // è®¾ç½®é™„ä»¶ä¸Šä¼ äº‹ä»¶
                const fileInput = document.getElementById('detail-new-attachments');
                fileInput.onchange = function() {
                    // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç¡®è®¤å¯¹è¯æ¡†
                    if (!showFileUploadConfirmation()) {
                        this.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                        return;
                    }

                    const files = Array.from(this.files);
                    // éªŒè¯å•ä¸ªæ–‡ä»¶å¤§å°å’Œæ ¼å¼
                    const validFiles = files.filter(file =>
                        file.size <= 10 * 1024 * 1024 && /\.pdf$/i.test(file.name)
                    );
                    const invalidFiles = files.filter(file => !validFiles.includes(file));

                    // éªŒè¯æ–‡ä»¶åæ ¼å¼
                    const fileNameValidFiles = [];
                    const invalidFileNames = [];
                    
                    for (const file of validFiles) {
                        const validation = validateFileName(file.name);
                        if (validation.valid) {
                            fileNameValidFiles.push(file);
                        } else {
                            invalidFileNames.push({
                                file: file,
                                hasDate: validation.hasDate,
                                chineseCount: validation.chineseCount
                            });
                        }
                    }

                    // éªŒè¯æ€»æ–‡ä»¶å¤§å°
                    const totalSize = fileNameValidFiles.reduce((sum, file) => sum + file.size, 0);
                    const maxTotalSize = 15 * 1024 * 1024; // 15MB

                    let errorMessage = '';
                    if (invalidFiles.length > 0) {
                        const oversizedFiles = invalidFiles.filter(f => f.size > 10 * 1024 * 1024);
                        const wrongFormatFiles = invalidFiles.filter(f => !/\.pdf$/i.test(f.name));

                        if (oversizedFiles.length > 0) {
                            errorMessage += `ä»¥ä¸‹æ–‡ä»¶è¶…è¿‡10MBé™åˆ¶ï¼š\n${oversizedFiles.map(f => `${f.name} (${(f.size / 1024 / 1024).toFixed(1)}MB)`).join('\n')}\n\n`;
                        }
                        if (wrongFormatFiles.length > 0) {
                            errorMessage += `ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼ˆä»…æ”¯æŒPDFï¼‰ï¼š\n${wrongFormatFiles.map(f => f.name).join('\n')}\n\n`;
                        }
                    }

                    // éªŒè¯æ–‡ä»¶åæ ¼å¼
                    if (invalidFileNames.length > 0) {
                        errorMessage += 'âš ï¸ ä»¥ä¸‹æ–‡ä»¶åä¸ç¬¦åˆè§„èŒƒï¼š\n';
                        invalidFileNames.forEach(item => {
                            errorMessage += `âŒ ${item.file.name}\n`;
                            if (!item.hasDate) {
                                errorMessage += '   - ç¼ºå°‘æ—¥æœŸï¼ˆéœ€è¦ï¼š20250101 æˆ– 2025-01-01 æˆ– 2025/01/01ï¼‰\n';
                            }
                            if (item.chineseCount < 5) {
                                errorMessage += `   - ä¸­æ–‡å­—ç¬¦ä¸è¶³ï¼ˆå½“å‰${item.chineseCount}ä¸ªï¼Œéœ€è¦è‡³å°‘5ä¸ªï¼‰\n`;
                            }
                        });
                        errorMessage += '\nğŸ”´ è¯·ä¿®æ”¹åé‡æ–°ä¸Šä¼ é™„ä»¶ï¼\n\n';
                        errorMessage += 'æ­£ç¡®ç¤ºä¾‹ï¼š\n';
                        errorMessage += 'âœ… xxå…¬å¸/å‚å•†æ¨¡å…·æŠ¥ä»·å•20250101.pdf\n';
                        errorMessage += 'âœ… xxå‚å•†xxæŠ¥ä»·æ˜ç»†2025-01-01.pdf\n';
                        errorMessage += 'âœ… xxé‡‡è´­åˆåŒé™„ä»¶2025/01/01.pdf\n\n';
                    }

                    if (totalSize > maxTotalSize) {
                        errorMessage += `æ‰€æœ‰æ–‡ä»¶æ€»å¤§å°è¶…è¿‡15MBé™åˆ¶ï¼šå½“å‰${(totalSize / 1024 / 1024).toFixed(1)}MB`;
                    }

                    if (errorMessage) {
                        alert(errorMessage.trim());

                        // å¦‚æœæ€»å¤§å°è¶…é™ï¼Œéœ€è¦ç§»é™¤ä¸€äº›æ–‡ä»¶
                        if (totalSize > maxTotalSize) {
                            // æŒ‰æ–‡ä»¶å¤§å°æ’åºï¼Œä¼˜å…ˆä¿ç•™å°æ–‡ä»¶
                            const sortedFiles = fileNameValidFiles.sort((a, b) => a.size - b.size);
                            const finalFiles = [];
                            let currentSize = 0;

                            for (const file of sortedFiles) {
                                if (currentSize + file.size <= maxTotalSize) {
                                    finalFiles.push(file);
                                    currentSize += file.size;
                                }
                            }

                            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
                            const dt = new DataTransfer();
                            finalFiles.forEach(f => dt.items.add(f));
                            this.files = dt.files;
                        } else {
                            // åªæ˜¯æ ¼å¼æˆ–å•ä¸ªæ–‡ä»¶å¤§å°é—®é¢˜ï¼Œä¿ç•™æœ‰æ•ˆæ–‡ä»¶
                            const dt = new DataTransfer();
                            fileNameValidFiles.forEach(f => dt.items.add(f));
                            this.files = dt.files;
                        }
                    }

                    // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
                    const attachmentsList = document.getElementById('detail-new-attachments-list');
                    attachmentsList.innerHTML = fileNameValidFiles.map(file => `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm">${sanitizeInput(file.name)}</span>
                                <span class="text-xs text-gray-400">${(file.size/1024/1024).toFixed(2)}MB</span>
                            </div>
                        </div>
                    `).join('');
                };

                // è®¾ç½®ç¡®è®¤é™„ä»¶æŒ‰é’®
                document.getElementById('detail-confirm-attachments').onclick = () => confirmDetailAttachments(app.id);
            } else {
                uploadSectionEl.classList.add('hidden');
            }

            // å®¡æ‰¹æ“ä½œåŒºåŸŸ
            const approvalActionsEl = document.getElementById('detail-approval-actions');
            if (isPendingApprovalPage && canApprove(app)) {
                approvalActionsEl.classList.remove('hidden');

                // ç»ç†é€‰æ‹©åŒºåŸŸï¼ˆä»…æ€»ç›‘å¯è§ï¼‰
                const managersSelectionEl = document.getElementById('detail-managers-selection');
                if (currentRole === 'chief' && app.status === 'å¾…æ€»ç›‘å®¡æ‰¹') {
                    managersSelectionEl.classList.remove('hidden');

                    // é‡ç½®ç»ç†é€‰æ‹©åŒºåŸŸçŠ¶æ€ä¸ºé»˜è®¤æŠ˜å 
                    if (typeof resetManagersSelectionState === 'function') {
                        resetManagersSelectionState();
                    }

                    // æ¸²æŸ“ç»ç†åˆ—è¡¨
                    renderManagersList(document.getElementById('detail-managers-list'), []);

                    // æ·»åŠ ç»ç†é€‰æ‹©å˜åŒ–ç›‘å¬
                    setTimeout(() => {
                        const checkboxes = document.querySelectorAll('.manager-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                updateSelectedManagersCount(app.id);
                            });
                        });

                        // åˆå§‹åŒ–é€‰æ‹©è®¡æ•°
                        updateSelectedManagersCount(app.id);
                    }, 100);

                    // è®¾ç½®ç¡®è®¤é€‰æ‹©æŒ‰é’®
                    document.getElementById('detail-confirm-managers').onclick = () => confirmSelectedManagers(app.id);
                } else {
                    managersSelectionEl.classList.add('hidden');
                }

                // è®¾ç½®å®¡æ‰¹æŒ‰é’®
                document.getElementById('detail-approve').onclick = () => approveApplication(app.id, 'approved');
                document.getElementById('detail-reject').onclick = () => approveApplication(app.id, 'rejected');
            } else {
                approvalActionsEl.classList.add('hidden');
            }

            // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
            setupDetailTabs();
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
        function setupDetailTabs() {
            const tabs = ['basic', 'approvals', 'attachments'];

            tabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).addEventListener('click', () => {
                    // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
                    tabs.forEach(t => {
                        const tabEl = document.getElementById(`tab-${t}`);
                        const contentEl = document.getElementById(`content-${t}`);

                        if (t === tab) {
                            tabEl.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                            tabEl.classList.remove('text-gray-500');
                            contentEl.classList.remove('hidden');
                        } else {
                            tabEl.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                            tabEl.classList.add('text-gray-500');
                            contentEl.classList.add('hidden');
                        }
                    });
                });
            });
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.add('hidden');

            // ç§»é™¤bodyç±»ï¼Œæ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.classList.remove('modal-open');

            // é‡ç½®æ»šåŠ¨ä½ç½®
            const modalContent = document.querySelector('#detailModal .relative');
            if (modalContent) {
                modalContent.scrollTop = 0;
            }

            // é‡ç½®ç»ç†é€‰æ‹©åŒºåŸŸçŠ¶æ€
            if (typeof resetManagersSelectionState === 'function') {
                resetManagersSelectionState();
            }

            // é‡ç½®æ ‡ç­¾é¡µçŠ¶æ€ï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯æ ‡ç­¾é¡µ
            const tabs = ['basic', 'approvals', 'attachments'];
            tabs.forEach(t => {
                const tabEl = document.getElementById(`tab-${t}`);
                const contentEl = document.getElementById(`content-${t}`);

                if (t === 'basic') {
                    tabEl.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                    tabEl.classList.remove('text-gray-500');
                    contentEl.classList.remove('hidden');
                } else {
                    tabEl.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                    tabEl.classList.add('text-gray-500');
                    contentEl.classList.add('hidden');
                }
            });

            // æ¸…ç©ºæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            const fileInput = document.getElementById('detail-new-attachments');
            if (fileInput) {
                fileInput.value = '';
            }

            const attachmentsList = document.getElementById('detail-new-attachments-list');
            if (attachmentsList) {
                attachmentsList.innerHTML = '';
            }
        }

        // æ ¼å¼åŒ–é‡‘é¢ä¸ºåƒåˆ†ä½æ ¼å¼ï¼Œæ”¯æŒä¸åŒå¸ç§
        function formatCurrency(amount, currency = 'CNY') {
            const formattedAmount = amount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (currency === 'USD') {
                return '$' + formattedAmount;
            } else {
                return 'Â¥' + formattedAmount;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDate(dateString) {
            if (!dateString) return '';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString; // å¦‚æœæ—¥æœŸæ— æ•ˆï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²

                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error);
                return dateString;
            }
        }

        // è·å–è§’è‰²æ˜¾ç¤ºåç§°
        function getRoleDisplayName(role) {
            const roleNames = {
                'user': 'æ™®é€šç”¨æˆ·',
                'director': 'å‚é•¿',
                'chief': 'æ€»ç›‘',
                'manager': 'ç»ç†',
                'ceo': 'CEO',
                'admin': 'ç®¡ç†å‘˜',
                'readonly': 'åªè¯»ç”¨æˆ·'
            };
            return roleNames[role] || role;
        }

        // è®¡ç®—å½“å‰é¡µé‡‘é¢åˆè®¡ï¼Œåˆ†åˆ«è®¡ç®—äººæ°‘å¸å’Œç¾å…ƒ
        function calculateTotalAmount(apps) {
            let totalCNY = 0;
            let totalUSD = 0;

            // éå†åº”ç”¨åˆ—è¡¨ï¼ŒæŒ‰å¸ç§ç´¯åŠ é‡‘é¢
            apps.forEach(app => {
                if (app.amount) {
                    const amount = parseFloat(app.amount);
                    if (!isNaN(amount)) {
                        if (app.currency === 'USD') {
                            totalUSD += amount;
                        } else {
                            totalCNY += amount;
                        }
                    }
                }
            });

            // æ›´æ–°åˆè®¡é‡‘é¢æ˜¾ç¤ºï¼Œä½¿ç”¨åƒåˆ†ä½æ ¼å¼
            const totalAmountElement = document.getElementById('currentPageTotalAmount');

            // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
            let displayText = '';

            if (totalCNY > 0) {
                displayText += formatCurrency(totalCNY, 'CNY');
            }

            if (totalUSD > 0) {
                if (displayText) {
                    displayText += '<br>';
                }
                displayText += formatCurrency(totalUSD, 'USD');
            }

            if (!displayText) {
                displayText = 'Â¥0.00';
            }

            totalAmountElement.innerHTML = displayText;
        }

        // æ–‡ä»¶é¢„è§ˆå‡½æ•° - æ”¯æŒç§»åŠ¨ç«¯å’ŒPCç«¯åˆ†ç¦»
        function previewFile(filePath, fileName) {
            const previewFrame = document.getElementById('previewFrame');
            const mobilePdfPreview = document.getElementById('mobilePdfPreview');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const previewFileName = document.getElementById('previewFileName');
            const unsupportedPreview = document.getElementById('unsupportedPreview');
            const unsupportedDownloadLink = document.getElementById('unsupportedDownloadLink');

            // è®¾ç½®æ–‡ä»¶å
            previewFileName.textContent = decodeURIComponent(fileName);

            // è·å–æ–‡ä»¶æ‰©å±•å
            const fileExt = fileName.split('.').pop().toLowerCase();

            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // éšè—æ‰€æœ‰é¢„è§ˆå®¹å™¨
            previewFrame.classList.add('hidden');
            mobilePdfPreview.classList.add('hidden');
            imagePreview.classList.add('hidden');
            unsupportedPreview.classList.add('hidden');

            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©ä¸åŒçš„é¢„è§ˆæ–¹å¼
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt)) {
                // å›¾ç‰‡é¢„è§ˆ
                imagePreview.classList.remove('hidden');
                previewImage.src = `/preview/${filePath}`;

                // ç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåè°ƒæ•´å¤§å°
                previewImage.onload = function() {
                    if (previewImage.naturalHeight > window.innerHeight * 0.8) {
                        previewImage.style.maxHeight = '80vh';
                    }
                };
            } else if (fileExt === 'pdf') {
                // PDFé¢„è§ˆ - ç§»åŠ¨ç«¯å’ŒPCç«¯åˆ†ç¦»å¤„ç†
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ä½¿ç”¨PDF.jsæ¸²æŸ“
                    mobilePdfPreview.classList.remove('hidden');
                    loadMobilePdfPreview(filePath);
                } else {
                    // PCç«¯ä½¿ç”¨iframe
                    previewFrame.classList.remove('hidden');

                    // æ¸…é™¤ä¹‹å‰çš„srcï¼Œé¿å…ç¼“å­˜é—®é¢˜
                    previewFrame.src = '';

                    // è®¾ç½®æ–°çš„src
                    setTimeout(() => {
                        previewFrame.src = `/preview/${filePath}`;
                    }, 50);

                    // ç›‘å¬iframeåŠ è½½äº‹ä»¶
                    previewFrame.onload = function() {
                        try {
                            // å°è¯•è°ƒæ•´iframeé«˜åº¦ä»¥é€‚åº”å†…å®¹
                            const frameHeight = previewFrame.contentWindow.document.body.scrollHeight;
                            if (frameHeight > 0) {
                                previewFrame.style.height = Math.min(frameHeight, window.innerHeight * 0.8) + 'px';
                            }
                        } catch (e) {
                            // æ— æ³•è®¿é—®iframeå†…å®¹ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶
                        }
                    };
                }
            } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'].includes(fileExt)) {
                // å…¶ä»–æ–‡æ¡£é¢„è§ˆ - ç»Ÿä¸€ä½¿ç”¨iframe
                previewFrame.classList.remove('hidden');

                // æ¸…é™¤ä¹‹å‰çš„srcï¼Œé¿å…ç¼“å­˜é—®é¢˜
                previewFrame.src = '';

                // è®¾ç½®æ–°çš„src
                setTimeout(() => {
                    previewFrame.src = `/preview/${filePath}`;
                }, 50);

                // ç›‘å¬iframeåŠ è½½äº‹ä»¶
                previewFrame.onload = function() {
                    try {
                        // å°è¯•è°ƒæ•´iframeé«˜åº¦ä»¥é€‚åº”å†…å®¹
                        const frameHeight = previewFrame.contentWindow.document.body.scrollHeight;
                        if (frameHeight > 0) {
                            previewFrame.style.height = Math.min(frameHeight, window.innerHeight * 0.8) + 'px';
                        }
                    } catch (e) {
                        // æ— æ³•è®¿é—®iframeå†…å®¹ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶
                    }
                };
            } else {
                // ä¸æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ç±»å‹
                unsupportedPreview.classList.remove('hidden');
                unsupportedDownloadLink.href = `/download/${filePath}?name=${encodeURIComponent(fileName)}`;
                unsupportedDownloadLink.setAttribute('download', decodeURIComponent(fileName));
            }

            // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
            document.getElementById('previewModal').classList.remove('hidden');
        }

        // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewFrame').src = '';
            document.getElementById('previewImage').src = '';
            document.getElementById('unsupportedDownloadLink').href = '#';

            // æ¸…ç†ç§»åŠ¨ç«¯PDFé¢„è§ˆ
            const mobilePdfPreview = document.getElementById('mobilePdfPreview');
            if (mobilePdfPreview && !mobilePdfPreview.classList.contains('hidden')) {
                cleanupMobilePdfPreview();
            }

            // é‡ç½®æ»šåŠ¨ä½ç½®
            document.getElementById('previewModal').scrollTop = 0;
        }

        // ç§»åŠ¨ç«¯PDFé¢„è§ˆç›¸å…³å˜é‡
        let currentPdfDoc = null;
        let currentPageNum = 1;
        let totalPages = 0;
        let pdfScale = 1.5; // é€‚ä¸­çš„ç¼©æ”¾æ¯”ä¾‹
        let isRendering = false; // é˜²æ­¢é‡å¤æ¸²æŸ“

        // åŠ è½½ç§»åŠ¨ç«¯PDFé¢„è§ˆ
        async function loadMobilePdfPreview(filePath) {
            const loadingIndicator = document.getElementById('pdfLoadingIndicator');
            const pageInfo = document.getElementById('pageInfo');

            try {
                // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€
                cleanupMobilePdfPreview();

                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'flex';
                }

                // ç¡®ä¿PDF.jså·²åŠ è½½
                await window.loadPdfJsLibrary();
                console.log('âœ“ PDF.jsåº“å·²åŠ è½½');

                // åŠ è½½PDFæ–‡æ¡£
                console.log('æ­£åœ¨åŠ è½½PDFæ–‡æ¡£...');
                const loadingTask = pdfjsLib.getDocument({
                    url: `/preview/${filePath}`,
                    cMapUrl: 'js/libs/cmaps/',
                    cMapPacked: true
                });

                currentPdfDoc = await loadingTask.promise;
                totalPages = currentPdfDoc.numPages;
                currentPageNum = 1;

                console.log(`âœ“ PDFåŠ è½½æˆåŠŸï¼Œæ€»é¡µæ•°: ${totalPages}`);

                // æ›´æ–°é¡µé¢ä¿¡æ¯
                if (pageInfo) {
                    pageInfo.textContent = `ç¬¬ ${currentPageNum} é¡µï¼Œå…± ${totalPages} é¡µ`;
                }

                // åˆå§‹åŒ–è§¦æ‘¸æ‰‹åŠ¿
                initializePdfTouchGestures();

                // æ¸²æŸ“ç¬¬ä¸€é¡µ
                await renderPdfPage(currentPageNum);

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }

                console.log('âœ“ PDFé¢„è§ˆåŠ è½½å®Œæˆ');

                // æ˜¾ç¤ºæ»‘åŠ¨æç¤ºï¼ˆä»…åœ¨å¤šé¡µé¢æ—¶ï¼‰
                if (totalPages > 1) {
                    showPdfSwipeHint();
                }

            } catch (error) {
                console.error('âŒ PDFåŠ è½½å¤±è´¥:', error);
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `
                        <div class="text-center">
                            <div class="text-red-600 mb-2">PDFåŠ è½½å¤±è´¥</div>
                            <div class="text-sm text-gray-500">${error.message}</div>
                            <button onclick="closePreview()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">å…³é—­</button>
                        </div>
                    `;
                }
            }
        }

        // åˆå§‹åŒ–PDFè§¦æ‘¸æ‰‹åŠ¿
        function initializePdfTouchGestures() {
            const pdfContainer = document.getElementById('pdfContainer');

            if (!pdfContainer) {
                console.error('âŒ æ‰¾ä¸åˆ°PDFå®¹å™¨');
                return;
            }

            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;

            pdfContainer.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            pdfContainer.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handlePdfSwipe();
            }, { passive: true });

            function handlePdfSwipe() {
                if (isRendering) {
                    console.log('â³ æ­£åœ¨æ¸²æŸ“ä¸­ï¼Œè·³è¿‡æ»‘åŠ¨æ“ä½œ');
                    return;
                }

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const minSwipeDistance = 50;

                // åªæœ‰æ°´å¹³æ»‘åŠ¨è·ç¦»å¤§äºå‚ç›´æ»‘åŠ¨è·ç¦»æ—¶æ‰å¤„ç†ç¿»é¡µ
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // å‘å³æ»‘åŠ¨ - ä¸Šä¸€é¡µ
                        if (currentPageNum > 1) {
                            console.log('ğŸ‘‰ å‘å³æ»‘åŠ¨ - ä¸Šä¸€é¡µ');
                            currentPageNum--;
                            renderPdfPage(currentPageNum);
                            updatePageInfo();
                        }
                    } else {
                        // å‘å·¦æ»‘åŠ¨ - ä¸‹ä¸€é¡µ
                        if (currentPageNum < totalPages) {
                            console.log('ğŸ‘ˆ å‘å·¦æ»‘åŠ¨ - ä¸‹ä¸€é¡µ');
                            currentPageNum++;
                            renderPdfPage(currentPageNum);
                            updatePageInfo();
                        }
                    }
                }
            }

            console.log('âœ“ è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒå·²æ·»åŠ ');
        }

        // æ›´æ–°é¡µé¢ä¿¡æ¯
        function updatePageInfo() {
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) {
                pageInfo.textContent = `ç¬¬ ${currentPageNum} é¡µï¼Œå…± ${totalPages} é¡µ`;
            }
        }

        // æ¸²æŸ“PDFé¡µé¢ - é«˜åˆ†è¾¨ç‡ä¼˜åŒ–ç‰ˆæœ¬
        async function renderPdfPage(pageNum) {
            if (isRendering) {
                console.log('â³ æ­£åœ¨æ¸²æŸ“ä¸­ï¼Œè·³è¿‡é‡å¤æ¸²æŸ“');
                return;
            }

            if (!currentPdfDoc) {
                console.error('âŒ PDFæ–‡æ¡£æœªåŠ è½½');
                return;
            }

            isRendering = true;
            console.log(`=== å¼€å§‹æ¸²æŸ“ç¬¬ ${pageNum} é¡µ ===`);

            try {
                // è·å–é¡µé¢
                const page = await currentPdfDoc.getPage(pageNum);
                console.log('âœ“ è·å–PDFé¡µé¢æˆåŠŸ');

                const canvas = document.getElementById('pdfCanvas');
                const context = canvas.getContext('2d');

                if (!canvas || !context) {
                    throw new Error('æ— æ³•è·å–Canvaså…ƒç´ æˆ–ä¸Šä¸‹æ–‡');
                }

                // ç­‰å¾…DOMæ›´æ–°
                await new Promise(resolve => requestAnimationFrame(resolve));

                // è·å–å®¹å™¨å°ºå¯¸
                const container = document.getElementById('pdfContainer');
                const containerWidth = container.clientWidth - 20; // å‡å»padding

                console.log(`å®¹å™¨å®½åº¦: ${containerWidth}`);

                // è·å–è®¾å¤‡åƒç´ æ¯”ï¼Œç¡®ä¿é«˜åˆ†è¾¨ç‡æ˜¾ç¤º
                const devicePixelRatio = window.devicePixelRatio || 1;
                console.log(`è®¾å¤‡åƒç´ æ¯”: ${devicePixelRatio}`);

                // è·å–é¡µé¢åŸå§‹å°ºå¯¸
                const originalViewport = page.getViewport({ scale: 1.0 });
                console.log(`åŸå§‹é¡µé¢å°ºå¯¸: ${originalViewport.width} x ${originalViewport.height}`);

                // è®¡ç®—æ˜¾ç¤ºç¼©æ”¾æ¯”ä¾‹ï¼ˆé€‚åº”å®¹å™¨å®½åº¦ï¼‰
                const displayScale = Math.min(containerWidth / originalViewport.width, 2.5);

                // è®¡ç®—æ¸²æŸ“ç¼©æ”¾æ¯”ä¾‹ï¼ˆè€ƒè™‘è®¾å¤‡åƒç´ æ¯”ä»¥è·å¾—æ¸…æ™°æ˜¾ç¤ºï¼‰
                const renderScale = displayScale * devicePixelRatio;

                console.log(`æ˜¾ç¤ºç¼©æ”¾: ${displayScale}, æ¸²æŸ“ç¼©æ”¾: ${renderScale}`);

                // è·å–æ¸²æŸ“è§†å£ï¼ˆç”¨äºå®é™…æ¸²æŸ“ï¼‰
                const renderViewport = page.getViewport({ scale: renderScale });

                // è·å–æ˜¾ç¤ºè§†å£ï¼ˆç”¨äºCSSæ˜¾ç¤ºå°ºå¯¸ï¼‰
                const displayViewport = page.getViewport({ scale: displayScale });

                // è®¾ç½®canvasçš„å®é™…æ¸²æŸ“å°ºå¯¸ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
                canvas.width = renderViewport.width;
                canvas.height = renderViewport.height;

                // è®¾ç½®canvasçš„CSSæ˜¾ç¤ºå°ºå¯¸
                canvas.style.width = displayViewport.width + 'px';
                canvas.style.height = displayViewport.height + 'px';

                console.log(`Canvaså®é™…å°ºå¯¸: ${canvas.width} x ${canvas.height}`);
                console.log(`Canvasæ˜¾ç¤ºå°ºå¯¸: ${displayViewport.width} x ${displayViewport.height}`);

                // ç¼©æ”¾ç»˜å›¾ä¸Šä¸‹æ–‡ä»¥åŒ¹é…è®¾å¤‡åƒç´ æ¯”
                context.scale(devicePixelRatio, devicePixelRatio);

                // æ¸…é™¤ç”»å¸ƒ
                context.clearRect(0, 0, canvas.width / devicePixelRatio, canvas.height / devicePixelRatio);

                // è®¾ç½®ç™½è‰²èƒŒæ™¯
                context.fillStyle = '#ffffff';
                context.fillRect(0, 0, canvas.width / devicePixelRatio, canvas.height / devicePixelRatio);

                // é‡ç½®ç¼©æ”¾ä»¥è¿›è¡ŒPDFæ¸²æŸ“
                context.setTransform(1, 0, 0, 1, 0, 0);

                // æ¸²æŸ“é¡µé¢
                const renderContext = {
                    canvasContext: context,
                    viewport: renderViewport
                };

                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“PDFé¡µé¢...');
                await page.render(renderContext).promise;
                console.log('âœ“ PDFé¡µé¢æ¸²æŸ“å®Œæˆ');

                // æ›´æ–°é¡µé¢ä¿¡æ¯
                updatePageInfo();

            } catch (error) {
                console.error('âŒ PDFé¡µé¢æ¸²æŸ“å¤±è´¥:', error);

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const canvas = document.getElementById('pdfCanvas');
                if (canvas) {
                    const context = canvas.getContext('2d');
                    if (context) {
                        // è®¾ç½®canvasåŸºæœ¬å°ºå¯¸
                        canvas.width = 400;
                        canvas.height = 300;
                        canvas.style.width = '400px';
                        canvas.style.height = '300px';

                        // æ¸…é™¤å¹¶ç»˜åˆ¶é”™è¯¯ä¿¡æ¯
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        context.fillStyle = '#f3f4f6';
                        context.fillRect(0, 0, canvas.width, canvas.height);

                        context.fillStyle = '#ef4444';
                        context.font = '16px Arial';
                        context.textAlign = 'center';
                        context.fillText('é¡µé¢æ¸²æŸ“å¤±è´¥', canvas.width / 2, canvas.height / 2 - 10);

                        context.fillStyle = '#6b7280';
                        context.font = '12px Arial';
                        context.fillText(error.message, canvas.width / 2, canvas.height / 2 + 20);
                    }
                }
            } finally {
                isRendering = false;
                console.log('=== æ¸²æŸ“æµç¨‹ç»“æŸ ===');
            }
        }



        // æ¸…ç†ç§»åŠ¨ç«¯PDFé¢„è§ˆ
        function cleanupMobilePdfPreview() {
            console.log('=== æ¸…ç†PDFé¢„è§ˆçŠ¶æ€ ===');

            // é‡ç½®æ¸²æŸ“çŠ¶æ€
            isRendering = false;

            // é”€æ¯PDFæ–‡æ¡£
            if (currentPdfDoc) {
                try {
                    currentPdfDoc.destroy();
                    console.log('âœ“ PDFæ–‡æ¡£å·²é”€æ¯');
                } catch (e) {
                    console.warn('âš ï¸ PDFæ–‡æ¡£é”€æ¯æ—¶å‡ºé”™:', e);
                }
                currentPdfDoc = null;
            }

            // é‡ç½®å˜é‡
            currentPageNum = 1;
            totalPages = 0;

            // æ¸…ç©ºcanvas
            const canvas = document.getElementById('pdfCanvas');
            if (canvas) {
                try {
                    const context = canvas.getContext('2d');
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    // é‡ç½®canvaså°ºå¯¸
                    canvas.width = 100;
                    canvas.height = 100;
                    canvas.style.width = '100px';
                    canvas.style.height = '100px';
                    console.log('âœ“ Canvaså·²æ¸…ç†');
                } catch (e) {
                    console.warn('âš ï¸ æ¸…ç†canvasæ—¶å‡ºé”™:', e);
                }
            }

            // é‡ç½®UI
            const pageInfo = document.getElementById('pageInfo');
            const loadingIndicator = document.getElementById('pdfLoadingIndicator');

            if (pageInfo) {
                pageInfo.textContent = 'ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ';
            }

            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
                loadingIndicator.innerHTML = `
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                        <div class="text-gray-600">æ­£åœ¨åŠ è½½PDF...</div>
                    </div>
                `;
            }

            console.log('âœ“ PDFé¢„è§ˆçŠ¶æ€å·²æ¸…ç†');
        }

        // æ˜¾ç¤ºPDFæ»‘åŠ¨æç¤º
        function showPdfSwipeHint() {
            const swipeHint = document.getElementById('swipeHint');
            if (swipeHint) {
                swipeHint.style.opacity = '1';
                setTimeout(() => {
                    swipeHint.style.opacity = '0';
                }, 3000); // 3ç§’åéšè—æç¤º
            }
        }

        function logout() {
            // åœæ­¢è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
            stopPendingApprovalAutoRefresh();

            // æ¸…é™¤ä¼šè¯å­˜å‚¨
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('role');
            sessionStorage.removeItem('department');
            sessionStorage.removeItem('loginTimestamp');
            sessionStorage.removeItem('lastActivity');
            sessionStorage.removeItem('currentSection'); // æ¸…é™¤å½“å‰é¡µé¢çŠ¶æ€

            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆæœ¬localStorageæ•°æ®ï¼ˆç¡®ä¿å®Œå…¨æ¸…é™¤ï¼‰
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            localStorage.removeItem('department');
            localStorage.removeItem('currentSection');

            // æ¸…é™¤å½“å‰ç”¨æˆ·çŠ¶æ€
            currentUser = null;
            currentRole = null;
            currentDepartment = null;

            // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆé€šè¿‡é‡æ–°åŠ è½½é¡µé¢å¹¶è·³è¿‡ç¼“å­˜ï¼‰
            window.location.reload(true);

            // ä»¥ä¸‹ä»£ç åœ¨é¡µé¢é‡æ–°åŠ è½½åä¸ä¼šæ‰§è¡Œï¼Œä½†ä¿ç•™ä»¥é˜²é‡å®šå‘å¤±è´¥
            showLoginForm();
            updateUserDisplay();
        }

        // åŠ è½½å®¡æ‰¹äººåˆ—è¡¨
        async function loadApprovers() {
            try {
                const response = await fetch('/approvers');
                const result = await response.json();
                if (result.success) {
                    // ä¿å­˜å®¡æ‰¹äººåˆ—è¡¨
                    window.directorsData = result.directors;
                    window.managersData = result.managers;

                    // æ¸²æŸ“å‚é•¿åˆ—è¡¨åˆ°æ–°å»ºç”³è¯·è¡¨å•
                    renderDirectorsList(document.getElementById('directorsList'), []);

                    // æ¸²æŸ“å‚é•¿åˆ—è¡¨åˆ°ç¼–è¾‘è¡¨å•
                    renderDirectorsList(document.getElementById('editDirectorsList'), []);
                }
            } catch (error) {
                console.error('åŠ è½½å®¡æ‰¹äººå¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å‚é•¿åˆ—è¡¨
        function renderDirectorsList(container, selectedDirectors = []) {
            if (!window.directorsData || window.directorsData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— å‚é•¿ç”¨æˆ·</p>';
                return;
            }

            container.innerHTML = window.directorsData.map(director => `
                <div class="flex items-center p-1">
                    <input type="checkbox" id="director-${director.username}"
                        value="${director.username}"
                        ${selectedDirectors.includes(director.username) ? 'checked' : ''}
                        class="mr-2 director-checkbox">
                    <label for="director-${director.username}" class="text-sm">
                        ${sanitizeInput(director.username)} (${director.department || 'æœªè®¾ç½®éƒ¨é—¨'})
                    </label>
                </div>
            `).join('');
        }

        // æ¸²æŸ“ç»ç†åˆ—è¡¨
        function renderManagersList(container, selectedManagers = []) {
            if (!window.managersData || window.managersData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— ç»ç†ç”¨æˆ·</p>';
                return;
            }

            // ä»container.idä¸­æå–appId
            const appId = container.id.split('_')[1];

            container.innerHTML = window.managersData.map(manager => `
                <div class="flex items-center p-1">
                    <input type="checkbox" id="manager_${appId}_${manager.username}"
                        value="${manager.username}"
                        ${selectedManagers.includes(manager.username) ? 'checked' : ''}
                        class="mr-2 manager-checkbox">
                    <label for="manager_${appId}_${manager.username}" class="text-sm">
                        ${sanitizeInput(manager.username)}
                    </label>
                </div>
            `).join('');

            // é‡ç½®ç¡®è®¤çŠ¶æ€
            if (appId) {
                const confirmStatus = document.getElementById(`managersConfirmStatus_${appId}`);
                if (confirmStatus) {
                    confirmStatus.classList.add('hidden');
                }
            }
        }

        // è·å–é€‰ä¸­çš„å‚é•¿
        function getSelectedDirectors(container) {
            const checkboxes = container.querySelectorAll('.director-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // è·å–é€‰ä¸­çš„ç»ç†
        function getSelectedManagers(container) {
            const checkboxes = container.querySelectorAll('.manager-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // ç¡®è®¤ç”³è¯·è¯¦æƒ…ä¸­çš„é™„ä»¶
        function confirmDetailAttachments(appId) {
            const fileInput = document.getElementById('detail-new-attachments');
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„é™„ä»¶');
                return;
            }

            // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
            const attachmentsList = document.getElementById('detail-new-attachments-list');
            attachmentsList.innerHTML = files.map(file => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm attachment-filename">${sanitizeInput(file.name)}</span>
                        <span class="text-xs text-gray-400">${(file.size/1024/1024).toFixed(2)}MB</span>
                    </div>
                    <span class="text-green-600 text-sm">âœ“ å·²ç¡®è®¤</span>
                </div>
            `).join('');

            // ç®€å•ç¡®è®¤é™„ä»¶ï¼Œä¸è¿›è¡Œä¸Šä¼ 
            // ä¸Šä¼ å°†åœ¨å®¡æ‰¹æ—¶ä¸€èµ·è¿›è¡Œ
            alert('é™„ä»¶ç¡®è®¤æˆåŠŸï¼Œå…±é€‰æ‹©äº† ' + files.length + ' ä¸ªæ–‡ä»¶');
        }

        // æ›´æ–°å¾…å®¡æ ¸åˆ—è¡¨ - æ™ºèƒ½ç¼“å­˜ç‰ˆ
        async function updatePendingApprovalList(page = 1) {
            try {
                const tbody = document.getElementById('pendingApprovalList');

                // æ£€æŸ¥ç¼“å­˜
                const cacheKey = `${page}-${currentUser}-${currentRole}`;
                const cachedData = pendingCache.pageCache.get(cacheKey);
                const cacheValidTime = 15000; // ç¼“å­˜æœ‰æ•ˆæœŸ15ç§’ï¼ˆå¾…å®¡æ ¸æ•°æ®æ›´æ–°é¢‘ç¹ï¼‰

                if (cachedData && (Date.now() - cachedData.timestamp < cacheValidTime)) {
                    // ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œç«‹å³æ˜¾ç¤º
                    // é‡è¦ï¼šå°†ç¼“å­˜æ•°æ®å¡«å……åˆ°å…¨å±€applicationsæ•°ç»„ï¼Œä»¥ä¾¿viewDetailå‡½æ•°èƒ½æ‰¾åˆ°æ•°æ®
                    applications = cachedData.data;

                    if (cachedData.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center"><p class="text-green-600 font-semibold text-lg">æ‚¨å·²å®Œæˆæ‰€æœ‰å®¡æ ¸ï¼Œè¯·ä¼‘æ¯ä¸€ä¸‹å§</p><div class="mt-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div></td></tr>';
                        updatePendingCards([]);
                    } else {
                        renderApplicationsList(cachedData.data, tbody);
                        updatePendingCards(cachedData.data);
                    }

                    updatePendingPagination(cachedData.pagination.currentPage, cachedData.pagination.totalPages, cachedData.pagination.totalItems);
                    updatePendingCount(cachedData.pagination.totalItems);

                    console.debug(`ä½¿ç”¨å¾…å®¡æ ¸ç¼“å­˜æ•°æ® - é¡µé¢: ${page}, æ•°æ®é‡: ${cachedData.data.length}æ¡`);
                    return;
                }

                // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="ml-2">åŠ è½½ä¸­...</span></div></td></tr>';

                // ä½¿ç”¨æ–°çš„åˆ†é¡µAPIåŠ è½½å¾…å®¡æ ¸æ•°æ®
                const params = new URLSearchParams({
                    username: currentUser,
                    page: page.toString(),
                    pageSize: '10',
                    sortBy: 'date',
                    sortOrder: 'desc'
                });

                const response = await apiRequest(`/applications/pending?${params.toString()}`, {
                    method: 'GET',
                    timeout: 15000
                });

                if (response && response.data) {
                    // å­˜å‚¨åˆ°ç¼“å­˜
                    const cacheKey = `${page}-${currentUser}-${currentRole}`;
                    pendingCache.pageCache.set(cacheKey, {
                        data: response.data,
                        pagination: response.pagination,
                        timestamp: Date.now()
                    });

                    // é™åˆ¶ç¼“å­˜å¤§å°
                    if (pendingCache.pageCache.size > 8) {
                        const firstKey = pendingCache.pageCache.keys().next().value;
                        pendingCache.pageCache.delete(firstKey);
                    }

                    // é‡è¦ï¼šå°†å½“å‰é¡µæ•°æ®å¡«å……åˆ°å…¨å±€applicationsæ•°ç»„ï¼Œä»¥ä¾¿viewDetailå‡½æ•°èƒ½æ‰¾åˆ°æ•°æ®
                    applications = response.data;

                    if (response.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center"><p class="text-green-600 font-semibold text-lg">æ‚¨å·²å®Œæˆæ‰€æœ‰å®¡æ ¸ï¼Œè¯·ä¼‘æ¯ä¸€ä¸‹å§</p><div class="mt-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div></td></tr>';

                        // æ›´æ–°ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾ï¼Œæ˜¾ç¤ºå®Œæˆæç¤º
                        updatePendingCards([]);
                    } else {
                        // æ¸²æŸ“å½“å‰é¡µæ•°æ®
                        renderApplicationsList(response.data, tbody);

                        // æ›´æ–°ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
                        updatePendingCards(response.data);
                    }

                    // æ›´æ–°åˆ†é¡µæ§ä»¶
                    updatePendingPagination(response.pagination.currentPage, response.pagination.totalPages, response.pagination.totalItems);

                    // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
                    updatePendingCount(response.pagination.totalItems);

                    console.debug(`å¾…å®¡æ ¸æ•°æ®åŠ è½½å®Œæˆ - é¡µé¢: ${page}, æ•°æ®é‡: ${response.data.length}æ¡`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">æš‚æ— å¾…å®¡æ ¸ç”³è¯·</td></tr>';
                    updatePendingPagination(1, 1, 0);
                    updatePendingCount(0);
                    updatePendingCards([]);
                }

            } catch (error) {
                console.error('åŠ è½½å¾…å®¡æ ¸ç”³è¯·å¤±è´¥:', error);
                const tbody = document.getElementById('pendingApprovalList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
                updatePendingPagination(1, 1, 0);
                updatePendingCount(0);
                updatePendingCards([]);
            }
        }

        // æ›´æ–°å¾…å®¡æ ¸åˆ†é¡µæ§ä»¶
        function updatePendingPagination(currentPage, totalPages, totalItems) {
            const prevPageBtn = document.getElementById('pendingPrevPage');
            const nextPageBtn = document.getElementById('pendingNextPage');
            const pageNumbersContainer = document.getElementById('pendingPageNumbers');
            const totalItemsSpan = document.getElementById('pendingTotalItems');

            // æ›´æ–°æ€»è®°å½•æ•°
            totalItemsSpan.textContent = totalItems;

            // ç¦ç”¨/å¯ç”¨ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µæŒ‰é’®
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;

            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            prevPageBtn.onclick = () => updatePendingApprovalList(currentPage - 1);
            nextPageBtn.onclick = () => updatePendingApprovalList(currentPage + 1);

            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbersContainer.innerHTML = '';

            // ç¡®å®šè¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            // è°ƒæ•´èµ·å§‹é¡µï¼Œç¡®ä¿å§‹ç»ˆæ˜¾ç¤º5ä¸ªé¡µç ï¼ˆå¦‚æœæœ‰è¶³å¤Ÿçš„é¡µæ•°ï¼‰
            if (endPage - startPage < 4 && totalPages > 5) {
                startPage = Math.max(1, endPage - 4);
            }

            // æ·»åŠ ç¬¬ä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…ï¼‰
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'px-3 py-1 border rounded-md hover:bg-gray-200';
                firstPageBtn.textContent = '1';
                firstPageBtn.onclick = () => updatePendingApprovalList(1);
                pageNumbersContainer.appendChild(firstPageBtn);

                // æ·»åŠ çœç•¥å·ï¼ˆå¦‚æœç¬¬ä¸€é¡µå’Œèµ·å§‹é¡µä¹‹é—´æœ‰é—´éš”ï¼‰
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }

            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-200'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => updatePendingApprovalList(i);
                pageNumbersContainer.appendChild(pageBtn);
            }

            // æ·»åŠ æœ€åä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…ï¼‰
            if (endPage < totalPages) {
                // æ·»åŠ çœç•¥å·ï¼ˆå¦‚æœç»“æŸé¡µå’Œæœ€åä¸€é¡µä¹‹é—´æœ‰é—´éš”ï¼‰
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }

                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'px-3 py-1 border rounded-md hover:bg-gray-200';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.onclick = () => updatePendingApprovalList(totalPages);
                pageNumbersContainer.appendChild(lastPageBtn);
            }
        }

        // å…¨å±€å˜é‡ï¼Œç”¨äºè·Ÿè¸ªå½“å‰æ˜¾ç¤ºçš„å¡ç‰‡ç´¢å¼•
        let currentCardIndex = 0;
        let pendingCards = [];

        // æ›´æ–°ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
        function updatePendingCards(apps) {
            // æ›´æ–°å…¨å±€å˜é‡
            pendingCards = [...apps];

            // é‡ç½®å½“å‰å¡ç‰‡ç´¢å¼•
            if (pendingCards.length > 0) {
                // å¦‚æœå½“å‰ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®ä¸º0
                if (currentCardIndex >= pendingCards.length) {
                    currentCardIndex = 0;
                }
            } else {
                currentCardIndex = 0;
            }

            // æ›´æ–°å¡ç‰‡è®¡æ•°
            document.getElementById('totalCards').textContent = pendingCards.length;
            document.getElementById('currentCardIndex').textContent = pendingCards.length > 0 ? currentCardIndex + 1 : 0;

            // æ¸²æŸ“å½“å‰å¡ç‰‡
            renderCurrentCard();

            // æ›´æ–°å¡ç‰‡å¯¼èˆªæŒ‰é’®çŠ¶æ€
            updateCardNavButtons();
        }

        // æ¸²æŸ“å½“å‰å¡ç‰‡
        function renderCurrentCard() {
            const cardContainer = document.getElementById('pendingCardContainer');

            if (pendingCards.length === 0) {
                cardContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-green-600 font-semibold text-lg">æ‚¨å·²å®Œæˆæ‰€æœ‰å®¡æ ¸ï¼Œè¯·ä¼‘æ¯ä¸€ä¸‹å§</p>
                        <div class="mt-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                `;
                return;
            }

            if (currentCardIndex >= pendingCards.length) {
                currentCardIndex = pendingCards.length - 1;
            }

            const app = pendingCards[currentCardIndex];

            // æ›´æ–°å½“å‰å¡ç‰‡ç´¢å¼•æ˜¾ç¤º
            document.getElementById('currentCardIndex').textContent = currentCardIndex + 1;

            // ç”Ÿæˆå¡ç‰‡HTML
            cardContainer.innerHTML = `
                <div class="pending-card">
                    <div class="pending-card-header">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${sanitizeInput(app.applicant)}</span>
                            <span class="px-2 py-1 rounded text-xs ${getPriorityClass(app.priority)}">${priorityMap[app.priority] || app.priority}</span>
                        </div>
                    </div>
                    <div class="pending-card-body">
                        ${app.applicationCode ? `
                        <div class="pending-card-item">
                            <span class="pending-card-label">ç”³è¯·ç¼–å·</span>
                            <span class="pending-card-value">${app.applicationCode}</span>
                        </div>
                        ` : ''}
                        <div class="pending-card-item">
                            <span class="pending-card-label">ç”³è¯·éƒ¨é—¨</span>
                            <span class="pending-card-value">${sanitizeInput(app.department)}</span>
                        </div>
                        <div class="pending-card-item">
                            <span class="pending-card-label">ç”³è¯·æ—¥æœŸ</span>
                            <span class="pending-card-value">${app.date}</span>
                        </div>
                        <div class="pending-card-item">
                            <span class="pending-card-label">ç”³è¯·å†…å®¹</span>
                            <div class="pending-card-content cursor-pointer" onclick="showContentModal('${escapeJsString(app.content)}')">
                                <div style="display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${sanitizeInput(app.content.length > 100 ? app.content.substring(0, 100) + '...' : app.content).replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                        <div class="pending-card-item">
                            <span class="pending-card-label">å½“å‰çŠ¶æ€</span>
                            <span class="pending-card-value">${app.status}</span>
                            ${app.status === 'å¾…å‚é•¿å®¡æ ¸' && app.approvals && app.approvals.directors ?
                                `<div class="text-xs text-blue-600 mt-1">å¾…å®¡æ ¸å‚é•¿ï¼š${Object.entries(app.approvals.directors)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([director, _]) => sanitizeInput(director))
                                    .join('ã€') || 'æ— '}</div>`
                                : ''}
                            ${app.status === 'å¾…ç»ç†å®¡æ‰¹' && app.approvals && app.approvals.managers ?
                                `<div class="text-xs text-blue-600 mt-1">å¾…å®¡æ ¸ç»ç†ï¼š${Object.entries(app.approvals.managers)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([manager, _]) => sanitizeInput(manager))
                                    .join('ã€') || 'æ— '}</div>`
                                : ''}
                        </div>
                    </div>
                    <div class="pending-card-footer">
                        <div class="w-full flex justify-center">
                            <button onclick="viewDetail(${app.id})" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">å®¡æ ¸ç”³è¯·</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°å¡ç‰‡å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateCardNavButtons() {
            const prevBtn = document.getElementById('prevCardBtn');
            const nextBtn = document.getElementById('nextCardBtn');

            prevBtn.disabled = currentCardIndex <= 0 || pendingCards.length === 0;
            nextBtn.disabled = currentCardIndex >= pendingCards.length - 1 || pendingCards.length === 0;
        }

        // æ˜¾ç¤ºä¸Šä¸€ä¸ªå¡ç‰‡
        function showPrevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                renderCurrentCard();
                updateCardNavButtons();
            }
        }

        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªå¡ç‰‡
        function showNextCard() {
            if (currentCardIndex < pendingCards.length - 1) {
                currentCardIndex++;
                renderCurrentCard();
                updateCardNavButtons();
            }
        }

        // æ›´æ–°å¾…å®¡æ ¸æ•°é‡
        function updatePendingCount(count) {
            // æ›´æ–°å¾…å®¡æ ¸æŒ‰é’®ä¸Šçš„æ•°å­—
            const pendingCountElements = [
                document.getElementById('sidePendingCount'),
                document.getElementById('topPendingCount'),
                document.getElementById('pcPendingCount')
            ];

            pendingCountElements.forEach(element => {
                if (element) {
                    if (count === undefined) {
                        // å¦‚æœæ²¡æœ‰æä¾›countå‚æ•°ï¼Œé‡æ–°è®¡ç®—
                        const pendingApps = applications.filter(app => {
                            const needsApproval = needsApprovalByCurrentUser(app.status);

                            // å¯¹äºå‚é•¿å’Œç»ç†ï¼Œè¿˜éœ€è¦æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‡å®šçš„å®¡æ‰¹äºº
                            if (needsApproval) {
                                if (currentRole === 'director') {
                                    return app.approvals.directors &&
                                           app.approvals.directors[currentUser] &&
                                           app.approvals.directors[currentUser].status === 'pending';
                                } else if (currentRole === 'manager') {
                                    return app.approvals.managers &&
                                           app.approvals.managers[currentUser] &&
                                           app.approvals.managers[currentUser].status === 'pending';
                                }
                                return true; // æ€»ç›‘ã€CEOã€ç®¡ç†å‘˜å’Œåªè¯»ç”¨æˆ·ä¸éœ€è¦é¢å¤–æ£€æŸ¥
                            }
                            return false;
                        });
                        count = pendingApps.length;
                    }

                    element.textContent = count;
                    if (count > 0) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            });
        }

        // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦éœ€è¦å®¡æ ¸è¯¥çŠ¶æ€çš„ç”³è¯·
        function needsApprovalByCurrentUser(status) {
            // æ ¹æ®çŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ ¸
            if (status === 'å·²å®Œæˆ' || status.includes('æ‹’ç»')) {
                return false; // å·²å®Œæˆæˆ–è¢«æ‹’ç»çš„ç”³è¯·ä¸éœ€è¦å®¡æ ¸
            }

            // æ ¹æ®ç”¨æˆ·è§’è‰²åˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ ¸
            switch (currentRole) {
                case 'admin':
                case 'readonly':
                    // ç®¡ç†å‘˜å’Œåªè¯»ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰å¾…å®¡æ ¸çš„ç”³è¯·
                    return status.includes('å¾…') && !status.includes('å·²å®Œæˆ');
                case 'director':
                    return status === 'å¾…å‚é•¿å®¡æ ¸';
                case 'chief':
                    return status === 'å¾…æ€»ç›‘å®¡æ ¸' || status === 'å¾…æ€»ç›‘å®¡æ‰¹';
                case 'manager':
                    return status === 'å¾…ç»ç†å®¡æ ¸' || status === 'å¾…ç»ç†å®¡æ‰¹';
                case 'ceo':
                    return status === 'å¾…CEOå®¡æ ¸' || status === 'å¾…CEOå®¡æ‰¹';
                default:
                    return false;
            }
        }

        // å…¨å±€å˜é‡ï¼šä¿å­˜å·²å®¡æ ¸é¡µé¢çš„æœç´¢çŠ¶æ€
        let approvedSearchState = {
            isSearching: false, // æ˜¯å¦å¤„äºæœç´¢çŠ¶æ€
            searchField: '', // æœç´¢å­—æ®µ
            searchInput: '', // æœç´¢å†…å®¹
            timeRange: 'all', // æ—¶é—´èŒƒå›´
            statusFilter: 'all' // çŠ¶æ€ç­›é€‰
        };

        // æœç´¢å·²å®¡æ ¸ç”³è¯· - ä½¿ç”¨åç«¯API
        async function searchApprovedApplications(page = 1) {
            const searchField = document.getElementById('approvedSearchField').value;
            const searchInput = document.getElementById('approvedSearchInput').value.trim();
            const range = document.getElementById('approvedTimeRange').value;
            const statusFilter = document.getElementById('approvedStatusFilter').value;

            if (!searchInput) {
                // æ¸…ç©ºæœç´¢çŠ¶æ€
                approvedSearchState.isSearching = false;
                approvedSearchState.searchField = '';
                approvedSearchState.searchInput = '';
                approvedSearchState.timeRange = 'all';
                approvedSearchState.statusFilter = 'all';
                updateApprovedList(1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                return;
            }

            // ä¿å­˜æœç´¢çŠ¶æ€
            approvedSearchState.isSearching = true;
            approvedSearchState.searchField = searchField;
            approvedSearchState.searchInput = searchInput;
            approvedSearchState.timeRange = range;
            approvedSearchState.statusFilter = statusFilter;

            try {
                const tbody = document.getElementById('approvedList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="ml-2">æœç´¢ä¸­...</span></div></td></tr>';

                // æ„å»ºè¯·æ±‚URLï¼ŒåŒ…å«æœç´¢å‚æ•°
                const params = new URLSearchParams({
                    username: currentUser,
                    page: page.toString(),
                    pageSize: '10',
                    sortBy: 'date',
                    sortOrder: 'desc',
                    timeRange: range,
                    statusFilter: statusFilter,
                    searchField: searchField,
                    searchInput: searchInput
                });

                const response = await apiRequest(`/applications/approved?${params.toString()}`, {
                    method: 'GET',
                    timeout: 10000
                });

                if (response && response.data) {
                    // æ¸²æŸ“æœç´¢ç»“æœ
                    renderApprovedList(response.data, tbody);

                    // æ›´æ–°åˆ†é¡µæ§ä»¶
                    updateApprovedPagination(
                        response.pagination.currentPage,
                        response.pagination.totalPages,
                        response.pagination.totalItems
                    );

                    // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæç¤º
                    if (response.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•</td></tr>';
                    }
                } else {
                    throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                const tbody = document.getElementById('approvedList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            }
        }

        // æ›´æ–°å·²å®¡æ ¸åˆ—è¡¨ - æ™ºèƒ½ç¼“å­˜ç‰ˆ
        async function updateApprovedList(page = 1) {
            try {
                const range = document.getElementById('approvedTimeRange').value;
                const statusFilter = document.getElementById('approvedStatusFilter').value;
                const tbody = document.getElementById('approvedList');

                // æ£€æŸ¥ç¼“å­˜
                const cacheKey = `${page}-${currentUser}-${range}-${statusFilter}`;
                const cachedData = approvedCache.pageCache.get(cacheKey);
                const cacheValidTime = 60000; // ç¼“å­˜æœ‰æ•ˆæœŸ60ç§’ï¼ˆå·²å®¡æ ¸æ•°æ®ç›¸å¯¹ç¨³å®šï¼‰

                if (cachedData && (Date.now() - cachedData.timestamp < cacheValidTime)) {
                    // ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œç«‹å³æ˜¾ç¤º
                    // é‡è¦ï¼šå°†ç¼“å­˜æ•°æ®å¡«å……åˆ°å…¨å±€applicationsæ•°ç»„ï¼Œä»¥ä¾¿viewDetailå‡½æ•°èƒ½æ‰¾åˆ°æ•°æ®
                    applications = cachedData.data;

                    renderApprovedList(cachedData.data, tbody);
                    updateApprovedPagination(cachedData.pagination.currentPage, cachedData.pagination.totalPages, cachedData.pagination.totalItems);

                    console.debug(`ä½¿ç”¨å·²å®¡æ ¸ç¼“å­˜æ•°æ® - é¡µé¢: ${page}, æ•°æ®é‡: ${cachedData.data.length}æ¡`);
                    return;
                }

                // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="ml-2">åŠ è½½ä¸­...</span></div></td></tr>';

                // ä½¿ç”¨æ–°çš„åˆ†é¡µAPIåŠ è½½å·²å®¡æ ¸æ•°æ®
                const params = new URLSearchParams({
                    username: currentUser,
                    page: page.toString(),
                    pageSize: '10',
                    sortBy: 'date',
                    sortOrder: 'desc',
                    timeRange: range,
                    statusFilter: statusFilter
                });

                const response = await apiRequest(`/applications/approved?${params.toString()}`, {
                    method: 'GET',
                    timeout: 15000
                });

                if (response && response.data) {
                    // å­˜å‚¨åˆ°ç¼“å­˜
                    const cacheKey = `${page}-${currentUser}-${range}-${statusFilter}`;
                    approvedCache.pageCache.set(cacheKey, {
                        data: response.data,
                        pagination: response.pagination,
                        timestamp: Date.now()
                    });

                    // é™åˆ¶ç¼“å­˜å¤§å°
                    if (approvedCache.pageCache.size > 8) {
                        const firstKey = approvedCache.pageCache.keys().next().value;
                        approvedCache.pageCache.delete(firstKey);
                    }

                    // é‡è¦ï¼šå°†å½“å‰é¡µæ•°æ®å¡«å……åˆ°å…¨å±€applicationsæ•°ç»„ï¼Œä»¥ä¾¿viewDetailå‡½æ•°èƒ½æ‰¾åˆ°æ•°æ®
                    applications = response.data;

                    // æ¸²æŸ“å½“å‰é¡µæ•°æ®
                    renderApprovedList(response.data, tbody);

                    // æ›´æ–°åˆ†é¡µæ§ä»¶
                    updateApprovedPagination(response.pagination.currentPage, response.pagination.totalPages, response.pagination.totalItems);

                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                    if (response.stats) { updateApprovedStats(response.stats); }

                    console.debug(`å·²å®¡æ ¸æ•°æ®åŠ è½½å®Œæˆ - é¡µé¢: ${page}, æ•°æ®é‡: ${response.data.length}æ¡`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">æš‚æ— å·²å®¡æ ¸ç”³è¯·</td></tr>';
                    updateApprovedPagination(1, 1, 0);
                    updateApprovedStats({ total: { cny: 0, usd: 0 }, approved: { cny: 0, usd: 0 }, rejected: { cny: 0, usd: 0 } });
                }

            } catch (error) {
                console.error('åŠ è½½å·²å®¡æ ¸ç”³è¯·å¤±è´¥:', error);
                const tbody = document.getElementById('approvedList');
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
                updateApprovedPagination(1, 1, 0);
            }
        }

        // æ›´æ–°å·²å®¡æ ¸åˆ†é¡µæ§ä»¶
        function updateApprovedPagination(currentPage, totalPages, totalItems) {
            const prevPageBtn = document.getElementById('approvedPrevPage');
            const nextPageBtn = document.getElementById('approvedNextPage');
            const pageNumbersContainer = document.getElementById('approvedPageNumbers');
            const totalItemsSpan = document.getElementById('approvedTotalItems');

            // æ›´æ–°æ€»è®°å½•æ•°
            totalItemsSpan.textContent = totalItems;

            // ç¦ç”¨/å¯ç”¨ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µæŒ‰é’®
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;

            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ ¹æ®æ˜¯å¦åœ¨æœç´¢çŠ¶æ€å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
            if (approvedSearchState.isSearching) {
                prevPageBtn.onclick = () => searchApprovedApplications(currentPage - 1);
                nextPageBtn.onclick = () => searchApprovedApplications(currentPage + 1);
            } else {
                prevPageBtn.onclick = () => updateApprovedList(currentPage - 1);
                nextPageBtn.onclick = () => updateApprovedList(currentPage + 1);
            }

            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbersContainer.innerHTML = '';

            // ç¡®å®šè¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            // è°ƒæ•´èµ·å§‹é¡µï¼Œç¡®ä¿å§‹ç»ˆæ˜¾ç¤º5ä¸ªé¡µç ï¼ˆå¦‚æœæœ‰è¶³å¤Ÿçš„é¡µæ•°ï¼‰
            if (endPage - startPage < 4 && totalPages > 5) {
                startPage = Math.max(1, endPage - 4);
            }

            // æ·»åŠ ç¬¬ä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…ï¼‰
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'px-3 py-1 border rounded-md hover:bg-gray-200';
                firstPageBtn.textContent = '1';
                firstPageBtn.onclick = () => approvedSearchState.isSearching ? searchApprovedApplications(1) : updateApprovedList(1);
                pageNumbersContainer.appendChild(firstPageBtn);

                // æ·»åŠ çœç•¥å·ï¼ˆå¦‚æœç¬¬ä¸€é¡µå’Œèµ·å§‹é¡µä¹‹é—´æœ‰é—´éš”ï¼‰
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }

            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-200'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => approvedSearchState.isSearching ? searchApprovedApplications(i) : updateApprovedList(i);
                pageNumbersContainer.appendChild(pageBtn);
            }

            // æ·»åŠ æœ€åä¸€é¡µæŒ‰é’®ï¼ˆå¦‚æœä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…ï¼‰
            if (endPage < totalPages) {
                // æ·»åŠ çœç•¥å·ï¼ˆå¦‚æœç»“æŸé¡µå’Œæœ€åä¸€é¡µä¹‹é—´æœ‰é—´éš”ï¼‰
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }

                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'px-3 py-1 border rounded-md hover:bg-gray-200';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.onclick = () => approvedSearchState.isSearching ? searchApprovedApplications(totalPages) : updateApprovedList(totalPages);
                pageNumbersContainer.appendChild(lastPageBtn);
            }
        }

        // æ›´æ–°å·²å®¡æ ¸ç»Ÿè®¡å¡ç‰‡
        function updateApprovedStats(stats) {
            document.getElementById('approvedTotalCny').textContent = `Â¥${formatAmountWithCommas(stats.total.cny)}`;
            document.getElementById('approvedTotalUsd').textContent = `$${formatAmountWithCommas(stats.total.usd)}`;
            document.getElementById('approvedPassCny').textContent = `Â¥${formatAmountWithCommas(stats.approved.cny)}`;
            document.getElementById('approvedPassUsd').textContent = `$${formatAmountWithCommas(stats.approved.usd)}`;
            document.getElementById('approvedRejectCny').textContent = `Â¥${formatAmountWithCommas(stats.rejected.cny)}`;
            document.getElementById('approvedRejectUsd').textContent = `$${formatAmountWithCommas(stats.rejected.usd)}`;
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®æ˜¾ç¤º
        function updateNavButtons() {
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒçš„å¯¼èˆªæŒ‰é’®
            // ç§»åŠ¨ç«¯ä¾§è¾¹æ æŒ‰é’®
            const sidePendingApprovalBtn = document.getElementById('sidePendingApprovalBtn');
            const sideApprovedBtn = document.getElementById('sideApprovedBtn');
            const sideSystemSettingsBtn = document.getElementById('sideSystemSettingsBtn');
            const sideManageUsersBtn = document.getElementById('sideManageUsersBtn');

            // PCç«¯ä¾§è¾¹æ æŒ‰é’®
            const pcPendingApprovalBtn = document.getElementById('pcPendingApprovalBtn');
            const pcApprovedBtn = document.getElementById('pcApprovedBtn');
            const pcSystemSettingsBtn = document.getElementById('pcSystemSettingsBtn');
            const pcManageUsersBtn = document.getElementById('pcManageUsersBtn');

            // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
            const topPendingApprovalBtn = document.getElementById('topPendingApprovalBtn');
            const topApprovedBtn = document.getElementById('topApprovedBtn');
            const topSystemSettingsBtn = document.getElementById('topSystemSettingsBtn');
            const topManageUsersBtn = document.getElementById('topManageUsersBtn');

            // æ–°å»ºç”³è¯·å’Œç”³è¯·è®°å½•æŒ‰é’®
            const newAppBtn = document.querySelector('.nav-btn[data-section="new"]');
            const historyBtn = document.querySelector('.nav-btn[data-section="history"]');
            const sideNewAppBtn = document.querySelector('.side-nav-btn[data-section="new"]');
            const sideHistoryBtn = document.querySelector('.side-nav-btn[data-section="history"]');
            const pcNewAppBtn = document.querySelector('.pc-nav-btn[data-section="new"]');
            const pcHistoryBtn = document.querySelector('.pc-nav-btn[data-section="history"]');

            // æ ¹æ®ç”¨æˆ·çš„ç”³è¯·æƒé™æ˜¾ç¤º/éšè—æ–°å»ºç”³è¯·å’Œç”³è¯·è®°å½•æŒ‰é’®
            if (currentUserCanSubmitApplication) {
                if (newAppBtn) newAppBtn.classList.remove('hidden');
                if (sideNewAppBtn) sideNewAppBtn.classList.remove('hidden');
                if (pcNewAppBtn) pcNewAppBtn.classList.remove('hidden');
                if (historyBtn) historyBtn.classList.remove('hidden');
                if (sideHistoryBtn) sideHistoryBtn.classList.remove('hidden');
                if (pcHistoryBtn) pcHistoryBtn.classList.remove('hidden');
            } else {
                if (newAppBtn) newAppBtn.classList.add('hidden');
                if (sideNewAppBtn) sideNewAppBtn.classList.add('hidden');
                if (pcNewAppBtn) pcNewAppBtn.classList.add('hidden');
                if (historyBtn) historyBtn.classList.add('hidden');
                if (sideHistoryBtn) sideHistoryBtn.classList.add('hidden');
                if (pcHistoryBtn) pcHistoryBtn.classList.add('hidden');
            }

            if (['director', 'chief', 'manager', 'ceo', 'admin', 'readonly'].includes(currentRole)) {
                // ç§»åŠ¨ç«¯ä¾§è¾¹æ æŒ‰é’®
                if (sidePendingApprovalBtn) sidePendingApprovalBtn.classList.remove('hidden');
                if (sideApprovedBtn) sideApprovedBtn.classList.remove('hidden');

                // PCç«¯ä¾§è¾¹æ æŒ‰é’®
                if (pcPendingApprovalBtn) pcPendingApprovalBtn.classList.remove('hidden');
                if (pcApprovedBtn) pcApprovedBtn.classList.remove('hidden');

                // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
                if (topPendingApprovalBtn) topPendingApprovalBtn.classList.remove('hidden');
                if (topApprovedBtn) topApprovedBtn.classList.remove('hidden');
            } else {
                // ç§»åŠ¨ç«¯ä¾§è¾¹æ æŒ‰é’®
                if (sidePendingApprovalBtn) sidePendingApprovalBtn.classList.add('hidden');
                if (sideApprovedBtn) sideApprovedBtn.classList.add('hidden');

                // PCç«¯ä¾§è¾¹æ æŒ‰é’®
                if (pcPendingApprovalBtn) pcPendingApprovalBtn.classList.add('hidden');
                if (pcApprovedBtn) pcApprovedBtn.classList.add('hidden');

                // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
                if (topPendingApprovalBtn) topPendingApprovalBtn.classList.add('hidden');
                if (topApprovedBtn) topApprovedBtn.classList.add('hidden');
            }

            if (currentRole === 'admin') {
                // ç§»åŠ¨ç«¯ä¾§è¾¹æ æŒ‰é’®
                if (sideSystemSettingsBtn) sideSystemSettingsBtn.classList.remove('hidden');
                if (sideManageUsersBtn) sideManageUsersBtn.classList.remove('hidden');

                // PCç«¯ä¾§è¾¹æ æŒ‰é’®
                if (pcSystemSettingsBtn) pcSystemSettingsBtn.classList.remove('hidden');
                if (pcManageUsersBtn) pcManageUsersBtn.classList.remove('hidden');

                // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
                if (topSystemSettingsBtn) topSystemSettingsBtn.classList.remove('hidden');
                if (topManageUsersBtn) topManageUsersBtn.classList.remove('hidden');
            } else {
                // ç§»åŠ¨ç«¯ä¾§è¾¹æ æŒ‰é’®
                if (sideSystemSettingsBtn) sideSystemSettingsBtn.classList.add('hidden');
                if (sideManageUsersBtn) sideManageUsersBtn.classList.add('hidden');

                // PCç«¯ä¾§è¾¹æ æŒ‰é’®
                if (pcSystemSettingsBtn) pcSystemSettingsBtn.classList.add('hidden');
                if (pcManageUsersBtn) pcManageUsersBtn.classList.add('hidden');

                // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
                if (topSystemSettingsBtn) topSystemSettingsBtn.classList.add('hidden');
                if (topManageUsersBtn) topManageUsersBtn.classList.add('hidden');
            }
        }

        // æ›´æ–°å·²é€‰æ‹©çš„ç»ç†æ•°é‡æ˜¾ç¤º
        function updateSelectedManagersCount(appId) {
            const container = document.getElementById('detail-managers-list');
            const countElement = document.getElementById('detail-selected-managers-count');
            if (container && countElement) {
                const selectedCount = container.querySelectorAll('.manager-checkbox:checked').length;
                countElement.textContent = `å·²é€‰æ‹© ${selectedCount} ä½ç»ç†`;

                // ç§»é™¤å¯èƒ½çš„ç»¿è‰²æ–‡æœ¬æ ·å¼
                countElement.classList.remove('text-green-600');

                // é‡ç½®ç¡®è®¤çŠ¶æ€
                const confirmStatus = document.getElementById('detail-managers-confirm-status');
                if (confirmStatus) {
                    confirmStatus.classList.add('hidden');
                }

                // æ ‡è®°ä¸ºæœªç¡®è®¤
                container.dataset.confirmed = 'false';
            }
        }

        // ç¡®è®¤é€‰æ‹©çš„ç»ç†
        function confirmSelectedManagers(appId) {
            const container = document.getElementById('detail-managers-list');
            const confirmStatus = document.getElementById('detail-managers-confirm-status');
            const countElement = document.getElementById('detail-selected-managers-count');

            if (container && confirmStatus) {
                const selectedManagers = getSelectedManagers(container);

                if (selectedManagers.length === 0) {
                    if (!confirm('æ‚¨æ²¡æœ‰é€‰æ‹©ä»»ä½•ç»ç†ï¼Œç”³è¯·å°†åœ¨æ‚¨å®¡æ‰¹é€šè¿‡åæµè½¬ç»™CEOè¿›è¡Œæœ€ç»ˆå®¡æ‰¹ã€‚æ˜¯å¦ç¡®è®¤ï¼Ÿ')) {
                        return;
                    }

                    // æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
                    alert('å·²ç¡®è®¤ä¸é€‰æ‹©ä»»ä½•ç»ç†ï¼Œç”³è¯·å°†åœ¨æ‚¨å®¡æ‰¹é€šè¿‡åæµè½¬ç»™CEOè¿›è¡Œæœ€ç»ˆå®¡æ‰¹');

                    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                    if (countElement) {
                        countElement.textContent = 'å·²é€‰æ‹© 0 ä½ç»ç† (å·²ç¡®è®¤)';
                        countElement.classList.add('text-green-600');
                    }

                    // æ˜¾ç¤ºç¡®è®¤çŠ¶æ€
                    confirmStatus.classList.remove('hidden');
                    return;
                }

                // è·å–ç»ç†åç§°åˆ—è¡¨ç”¨äºæ˜¾ç¤º
                const managerNames = selectedManagers.map(managerId => {
                    const managerLabel = container.querySelector(`label[for="manager_${appId}_${managerId}"]`);
                    return managerLabel ? managerLabel.textContent.trim() : managerId;
                });

                // æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
                alert(`å·²ç¡®è®¤é€‰æ‹©ä»¥ä¸‹ç»ç†è¿›è¡Œå®¡æ‰¹ï¼š\n${managerNames.join('\n')}`);

                // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                if (countElement) {
                    countElement.textContent = `å·²é€‰æ‹© ${selectedManagers.length} ä½ç»ç† (å·²ç¡®è®¤)`;
                    countElement.classList.add('text-green-600');
                }

                // æ ‡è®°ä¸ºå·²ç¡®è®¤
                container.dataset.confirmed = 'true';
                confirmStatus.classList.remove('hidden');
            }
        }

        // åˆ‡æ¢èœå•æ˜¾ç¤º/éšè—
        function toggleMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const menuOverlay = document.getElementById('menuOverlay');

            if (sideMenu.classList.contains('-translate-x-full')) {
                // æ˜¾ç¤ºèœå•
                sideMenu.classList.remove('-translate-x-full');
                menuOverlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            } else {
                // éšè—èœå•
                sideMenu.classList.add('-translate-x-full');
                menuOverlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }

        // ä»…åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šåˆ‡æ¢èœå•
        function toggleMenuMobile() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            if (window.innerWidth < 768) {
                toggleMenu();
            }
        }

        // é¢„è§ˆç”³è¯·ä¹¦æ¨¡æ¿
        async function previewApplicationTemplate(appId) {
            // å¦‚æœæä¾›äº†appIdï¼Œè¡¨ç¤ºä»è¯¦æƒ…é¡µé¢è°ƒç”¨
            if (appId) {
                const app = applications.find(a => a.id === appId);
                if (!app) {
                    alert('æ‰¾ä¸åˆ°ç”³è¯·æ•°æ®');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'templateLoadingIndicator';
                loadingIndicator.className = 'fixed top-0 left-0 w-full bg-blue-500 text-white text-center py-2 z-50';
                loadingIndicator.textContent = 'æ­£åœ¨åŠ è½½ç­¾åæ•°æ®ï¼Œè¯·ç¨å€™...';
                document.body.appendChild(loadingIndicator);

                try {
                    // ç›´æ¥ä½¿ç”¨ä»åº”ç”¨ç¨‹åºä¸­æå–çš„ç­¾åä¿¡æ¯ç”Ÿæˆæ¨¡æ¿
                    await generateApplicationTemplateWithApp(app);
                } catch (error) {
                    console.error('ç”Ÿæˆç”³è¯·æ¨¡æ¿å‡ºé”™:', error);
                    alert('ç”Ÿæˆç”³è¯·æ¨¡æ¿æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
                } finally {
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    const indicator = document.getElementById('templateLoadingIndicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            } else {
                // ä»æ–°ç”³è¯·è¡¨å•è·å–æ•°æ®
                const applicant = document.getElementById('applicant').value;
                const department = document.getElementById('department').value;
                const date = document.getElementById('applyDate').value;
                const content = document.getElementById('content').value;
                const amount = document.getElementById('amount').value; // è·å–é‡‘é¢
                const currency = document.getElementById('currency').value; // è·å–å¸ç§

                // ä¸¥æ ¼éªŒè¯å¿…å¡«å­—æ®µ
                const previewValidationResult = validatePreviewData(applicant, department, date, content);
                if (!previewValidationResult.isValid) {
                    showValidationError(previewValidationResult.errors);
                    return;
                }

                // åˆ›å»ºç”³è¯·å¯¹è±¡
                const application = {
                    applicant: currentUser, // ä½¿ç”¨å½“å‰ç”¨æˆ·ä½œä¸ºç”³è¯·äºº
                    department: department,
                    date: date,
                    content: content,
                    amount: amount, // æ·»åŠ é‡‘é¢ä¿¡æ¯
                    currency: currency, // æ·»åŠ å¸ç§ä¿¡æ¯
                    approvals: {
                        directors: {},
                        chief: {},
                        managers: {}
                    }
                };

                // ç”Ÿæˆå¹¶æ˜¾ç¤ºç”³è¯·ä¹¦æ¨¡æ¿
                generateApplicationTemplate(application);
            }
        }

        // ä½¿ç”¨åº”ç”¨æ•°æ®ç”Ÿæˆç”³è¯·ä¹¦æ¨¡æ¿ - ä¼˜åŒ–ç‰ˆ
        async function generateApplicationTemplateWithApp(app) {
            // æ”¶é›†éœ€è¦ç­¾åçš„ç”¨æˆ·
            const usersNeedingSignatures = new Set();

            // æ·»åŠ ç”³è¯·äºº
            if (app.applicant) {
                usersNeedingSignatures.add(app.applicant);
            }

            // æ·»åŠ å®¡æ‰¹äºº
            if (app.approvals) {
                if (app.approvals.managers) {
                    Object.keys(app.approvals.managers).forEach(manager => {
                        usersNeedingSignatures.add(manager);
                    });
                }
                if (app.approvals.directors) {
                    Object.keys(app.approvals.directors).forEach(director => {
                        usersNeedingSignatures.add(director);
                    });
                }
                // ä¿®å¤æ€»ç›‘ç­¾åè·å–é—®é¢˜ï¼šæ·»åŠ æ€»ç›‘ç”¨æˆ·ååˆ°éœ€è¦ç­¾åçš„ç”¨æˆ·é›†åˆ
                if (app.approvals.chief) {
                    if (app.approvals.chief.approverUsername) {
                        usersNeedingSignatures.add(app.approvals.chief.approverUsername);
                    } else if (app.approvals.chief.username) {
                        usersNeedingSignatures.add(app.approvals.chief.username);
                    } else {
                        // å¦‚æœæ²¡æœ‰å…·ä½“çš„ç”¨æˆ·åï¼Œæ·»åŠ ä¸€ä¸ªé€šç”¨çš„æ€»ç›‘æ ‡è¯†
                        usersNeedingSignatures.add('chief');
                    }
                }
                if (app.approvals.ceo && app.approvals.ceo.approverUsername) {
                    usersNeedingSignatures.add(app.approvals.ceo.approverUsername);
                }
            }

            // æŒ‰éœ€åŠ è½½æ‰€éœ€çš„ç­¾å
            const signatures = await loadMultipleSignatures(Array.from(usersNeedingSignatures));

            // æ›´æ–°allUsersæ•°æ®ç»“æ„ä»¥å…¼å®¹ç°æœ‰ä»£ç 
            if (!allUsers) allUsers = [];

            // ç¡®ä¿allUsersåŒ…å«æ‰€éœ€çš„ç”¨æˆ·ä¿¡æ¯
            Array.from(usersNeedingSignatures).forEach(username => {
                let existingUser = allUsers.find(u => u.username === username);
                if (!existingUser) {
                    existingUser = {
                        username: username,
                        signature: signatures[username] || null
                    };
                    allUsers.push(existingUser);
                } else if (signatures[username]) {
                    existingUser.signature = signatures[username];
                }
            });

            // åˆ›å»ºåŒ…å«å®¡æ‰¹ä¿¡æ¯çš„ç”³è¯·å¯¹è±¡
            const application = {
                applicant: app.applicant,
                department: app.department,
                date: app.date,
                content: app.content,
                amount: app.amount, // æ·»åŠ é‡‘é¢ä¿¡æ¯
                currency: app.currency, // æ·»åŠ å¸ç§ä¿¡æ¯
                approvals: {
                    directors: {},
                    chief: {},
                    managers: {},
                    ceo: {}
                }
            };

            // å¤„ç†å‚é•¿å®¡æ‰¹ä¿¡æ¯
            if (app.approvals && app.approvals.directors) {
                Object.entries(app.approvals.directors).forEach(([username, approval]) => {
                    if (approval.status === 'approved' || approval.status === 'rejected') {
                        // è·å–ç”¨æˆ·ä¿¡æ¯ä»¥è·å–ç”µå­ç­¾å
                        const user = allUsers ? allUsers.find(u => u.username === username) : null;
                        const signature = user && user.signature ? user.signature :
                                         approval.signature ? approval.signature : null;

                        application.approvals.directors[username] = {
                            status: approval.status,
                            comment: approval.comment || (approval.status === 'approved' ? 'åŒæ„' : 'ä¸åŒæ„'),
                            date: approval.date || new Date().toISOString(),
                            approverName: user ? (user.displayName || username) : username,
                            signature: signature
                        };
                    }
                });
            }

            // å¤„ç†æ€»ç›‘å®¡æ‰¹ä¿¡æ¯
            if (app.approvals && app.approvals.chief && (app.approvals.chief.status === 'approved' || app.approvals.chief.status === 'rejected')) {
                // ä¿®å¤æ€»ç›‘ç­¾åæ˜¾ç¤ºé—®é¢˜ï¼šä¼˜å…ˆä½¿ç”¨å®¡æ‰¹è®°å½•ä¸­çš„ç­¾åï¼Œç„¶åæŸ¥æ‰¾ç”¨æˆ·ç­¾å
                let signature = null;
                let approverName = 'æ€»ç›‘';

                // é¦–å…ˆå°è¯•ä»å®¡æ‰¹è®°å½•ä¸­è·å–ç­¾å
                if (app.approvals.chief.signature) {
                    signature = app.approvals.chief.signature;
                }

                // ç„¶åå°è¯•ä»ç”¨æˆ·æ•°æ®ä¸­è·å–ç­¾åå’Œå§“å
                const chiefUser = allUsers ? allUsers.find(u =>
                    u.username === app.approvals.chief.username ||
                    u.username === app.approvals.chief.approverUsername ||
                    u.role === 'chief'
                ) : null;

                if (chiefUser) {
                    approverName = chiefUser.displayName || chiefUser.username;
                    // å¦‚æœå®¡æ‰¹è®°å½•ä¸­æ²¡æœ‰ç­¾åï¼Œä½¿ç”¨ç”¨æˆ·æ•°æ®ä¸­çš„ç­¾å
                    if (!signature && chiefUser.signature) {
                        signature = chiefUser.signature;
                    }
                }

                application.approvals.chief = {
                    status: app.approvals.chief.status,
                    comment: app.approvals.chief.comment || (app.approvals.chief.status === 'approved' ? 'åŒæ„' : 'ä¸åŒæ„'),
                    date: app.approvals.chief.date || new Date().toISOString(),
                    approverName: approverName,
                    signature: signature
                };
            }

            // å¤„ç†ç»ç†å®¡æ‰¹ä¿¡æ¯
            if (app.approvals && app.approvals.managers) {
                Object.entries(app.approvals.managers).forEach(([username, approval]) => {
                    if (approval.status === 'approved' || approval.status === 'rejected') {
                        // è·å–ç”¨æˆ·ä¿¡æ¯ä»¥è·å–ç”µå­ç­¾å
                        const user = allUsers ? allUsers.find(u => u.username === username) : null;
                        const signature = user && user.signature ? user.signature :
                                         approval.signature ? approval.signature : null;

                        application.approvals.managers[username] = {
                            status: approval.status,
                            comment: approval.comment || (approval.status === 'approved' ? 'åŒæ„' : 'ä¸åŒæ„'),
                            date: approval.date || new Date().toISOString(),
                            approverName: user ? (user.displayName || username) : username,
                            signature: signature
                        };
                    }
                });
            }

            // å¤„ç†CEOå®¡æ‰¹ä¿¡æ¯ - å¢å¼ºç‰ˆï¼Œç¡®ä¿å†å²æ•°æ®ä¹Ÿèƒ½æ­£ç¡®å¤„ç†
            if (app.approvals && app.approvals.ceo) {
                const ceoApproval = app.approvals.ceo;
                if (ceoApproval.status === 'approved' || ceoApproval.status === 'rejected') {
                    // è·å–CEOç”¨æˆ·åï¼Œå…¼å®¹å†å²æ•°æ®
                    const ceoUsername = ceoApproval.approverUsername ||
                                       ceoApproval.username ||
                                       'ceo';

                    // å¤šç§æ–¹å¼æŸ¥æ‰¾CEOç”¨æˆ·ä¿¡æ¯ä»¥è·å–ç”µå­ç­¾å
                    const user = allUsers ? allUsers.find(u =>
                        u.role === 'ceo' ||
                        u.username === ceoUsername ||
                        (u.username && u.username.toLowerCase().includes('ceo')) ||
                        (ceoUsername !== 'ceo' && u.username === ceoUsername)
                    ) : null;

                    // å½»åº•ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å®¡æ‰¹è®°å½•ä¸­çš„ç­¾åï¼Œä¸ä¾èµ–ç”¨æˆ·æ•°æ®
                    const signature = ceoApproval.signature || (user && user.signature) || null;

                    application.approvals.ceo = {
                        status: ceoApproval.status,
                        comment: ceoApproval.comment || (ceoApproval.status === 'approved' ? 'åŒæ„' : 'ä¸åŒæ„'),
                        date: ceoApproval.date || new Date().toISOString(),
                        approverName: user ? (user.displayName || user.username || 'CEO') : (ceoUsername !== 'ceo' ? ceoUsername : 'CEO'),
                        signature: signature,
                        // ä¿ç•™åŸå§‹å®¡æ‰¹è®°å½•ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
                        approverUsername: ceoApproval.approverUsername,
                        username: ceoApproval.username
                    };
                }
            }

            // ç”Ÿæˆå¹¶æ˜¾ç¤ºç”³è¯·ä¹¦æ¨¡æ¿
            generateApplicationTemplate(application);
        }

        // ç”Ÿæˆç”³è¯·ä¹¦æ¨¡æ¿
        function generateApplicationTemplate(application) {
            // æ ¼å¼åŒ–æ—¥æœŸ
            const formattedDate = formatDate(application.date);

            // å¤„ç†ç”³è¯·äº‹ç”±å†…å®¹ï¼Œå¦‚æœæœ‰é‡‘é¢åˆ™æ·»åŠ é‡‘é¢ä¿¡æ¯
            let contentWithAmount = sanitizeInput(application.content);
            if (application.amount && parseFloat(application.amount) > 0) {
                const currency = application.currency || 'CNY';
                const formattedAmount = formatCurrency(parseFloat(application.amount), currency);
                const currencyName = currency === 'USD' ? 'USD' : 'CNY';
                contentWithAmount += `<br>ç”³è¯·é‡‘é¢ï¼š${formattedAmount} ${currencyName}`;
            }

            // è·å–å®¡æ‰¹ä¿¡æ¯
            let factoryApproval = '';
            let directorApproval = '';
            let managerApproval = '';

            // å¤„ç†å‚é•¿å®¡æ‰¹ä¿¡æ¯
            if (application.approvals && application.approvals.directors) {
                const directorsEntries = Object.entries(application.approvals.directors);
                if (directorsEntries.length > 0) {
                    factoryApproval = `<div class="approval-container">`;
                    directorsEntries.forEach(([username, approval]) => {
                        if (approval.status === 'approved' || approval.status === 'rejected') {
                            factoryApproval += `
                                <div class="single-approval">
                                    ${approval.comment ? `<div class="approval-comment">${sanitizeInput(approval.comment)}</div>` : ''}
                                    <div class="signature-wrapper">
                                        ${approval.signature ?
                                            `<img src="${approval.signature}" alt="${approval.approverName || username}çš„ç­¾å" class="signature-image" style="image-rendering: -webkit-optimize-contrast; filter: contrast(1.05);">` :
                                            `<div class="no-signature">æ— ç­¾å</div>`
                                        }
                                        <div class="approval-date">${formatDate(approval.date)}</div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    factoryApproval += `</div>`;
                }
            }

            // å¤„ç†æ€»ç›‘å®¡æ‰¹ä¿¡æ¯
            if (application.approvals && application.approvals.chief) {
                const chiefApproval = application.approvals.chief;
                if (chiefApproval.status === 'approved' || chiefApproval.status === 'rejected') {
                    directorApproval = `
                        <div class="approval-container">
                            <div class="single-approval">
                                ${chiefApproval.comment ? `<div class="approval-comment">${sanitizeInput(chiefApproval.comment)}</div>` : ''}
                                <div class="signature-wrapper">
                                    ${chiefApproval.signature ?
                                        `<img src="${chiefApproval.signature}" alt="${chiefApproval.approverName || 'æ€»ç›‘'}çš„ç­¾å" class="signature-image" style="image-rendering: -webkit-optimize-contrast; filter: contrast(1.05);">` :
                                        `<div class="no-signature">æ— ç­¾å</div>`
                                    }
                                    <div class="approval-date">${formatDate(chiefApproval.date)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // å¤„ç†ç»ç†å®¡æ‰¹ä¿¡æ¯ï¼ˆåŒ…å«CEOç­¾åï¼‰
            if (application.approvals && application.approvals.managers) {
                const managersEntries = Object.entries(application.approvals.managers);
                if (managersEntries.length > 0) {
                    managerApproval = `<div class="approval-container">`;
                    managersEntries.forEach(([username, approval]) => {
                        if (approval.status === 'approved' || approval.status === 'rejected') {
                            // æ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                            let roleChangeNote = '';
                            if (approval.originalRole && approval.roleChangedTo) {
                                roleChangeNote = `<div class="role-change-note" style="font-size: 10px; color: #666; margin-top: 2px;">æ³¨ï¼š${username} å·²ä»${getRoleDisplayName(approval.originalRole)}å˜æ›´ä¸º${getRoleDisplayName(approval.roleChangedTo)}</div>`;
                            }

                            managerApproval += `
                                <div class="single-approval">
                                    ${approval.comment ? `<div class="approval-comment">${sanitizeInput(approval.comment)}</div>` : ''}
                                    <div class="signature-wrapper">
                                        ${approval.signature ?
                                            `<img src="${approval.signature}" alt="${approval.approverName || username}çš„ç­¾å" class="signature-image" style="image-rendering: -webkit-optimize-contrast; filter: contrast(1.05);">` :
                                            `<div class="no-signature">æ— ç­¾å</div>`
                                        }
                                        <div class="approval-date">${formatDate(approval.date)}</div>
                                        ${roleChangeNote}
                                    </div>
                                </div>
                            `;
                        }
                    });

                    // æ·»åŠ CEOå®¡æ‰¹ä¿¡æ¯åˆ°ç»ç†æ ¸å‡†åŒºåŸŸ - å¢å¼ºç‰ˆï¼Œç¡®ä¿å†å²æ•°æ®ä¹Ÿèƒ½æ­£ç¡®å¤„ç†
                    if (application.approvals.ceo && (application.approvals.ceo.status === 'approved' || application.approvals.ceo.status === 'rejected')) {
                        const ceoApproval = application.approvals.ceo;

                        // è·å–CEOç”¨æˆ·åï¼Œå…¼å®¹å†å²æ•°æ®
                        const ceoUsername = ceoApproval.approverUsername ||
                                           ceoApproval.username ||
                                           'ceo';

                        // å¤šç§æ–¹å¼æŸ¥æ‰¾CEOç”¨æˆ·ä¿¡æ¯
                        const ceoUser = allUsers ? allUsers.find(u =>
                            u.role === 'ceo' ||
                            u.username === ceoUsername ||
                            (u.username && u.username.toLowerCase().includes('ceo')) ||
                            (ceoUsername !== 'ceo' && u.username === ceoUsername)
                        ) : null;

                        // å½»åº•ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å®¡æ‰¹è®°å½•ä¸­çš„ç­¾åï¼Œä¸ä¾èµ–ç”¨æˆ·æ•°æ®
                        const ceoSignature = ceoApproval.signature || (ceoUser && ceoUser.signature) || null;

                        console.log('CEOçš„ç­¾åä¿¡æ¯:', ceoSignature ? 'æœ‰ç­¾å' : 'æ— ç­¾å');
                        console.log('CEOç”¨æˆ·æŸ¥æ‰¾ç»“æœ:', ceoUser ? `æ‰¾åˆ°ç”¨æˆ·: ${ceoUser.username}` : 'æœªæ‰¾åˆ°ç”¨æˆ·');
                        console.log('CEOç­¾åæ¥æº:', ceoUser && ceoUser.signature ? 'æ¥è‡ªç”¨æˆ·æ•°æ®' : (ceoApproval.signature ? 'æ¥è‡ªå®¡æ‰¹è®°å½•' : 'æ— ç­¾å'));
                        console.log('CEOå®¡æ‰¹è®°å½•è¯¦æƒ…:', {
                            status: ceoApproval.status,
                            approverUsername: ceoApproval.approverUsername,
                            username: ceoApproval.username,
                            hasSignature: !!ceoApproval.signature,
                            signatureLength: ceoApproval.signature ? ceoApproval.signature.length : 0
                        });
                        console.log('allUsersä¸­çš„CEOç”¨æˆ·:', allUsers ? allUsers.filter(u => u.role === 'ceo' || (u.username && u.username.toLowerCase().includes('ceo'))) : 'æ— allUsersæ•°æ®');
                        console.log('æŸ¥æ‰¾CEOç”¨æˆ·çš„æ¡ä»¶:', {
                            ceoUsername: ceoUsername,
                            allUsersCount: allUsers ? allUsers.length : 0,
                            ceoRoleUsers: allUsers ? allUsers.filter(u => u.role === 'ceo').map(u => u.username) : [],
                            usernameMatches: allUsers ? allUsers.filter(u => u.username === ceoUsername).map(u => u.username) : []
                        });

                        // æ£€æŸ¥CEOæ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                        let ceoRoleChangeNote = '';
                        if (ceoApproval.originalRole && ceoApproval.roleChangedTo) {
                            const approverName = ceoApproval.approverUsername || 'CEO';
                            ceoRoleChangeNote = `<div class="role-change-note" style="font-size: 10px; color: #666; margin-top: 2px;">æ³¨ï¼š${approverName} å·²ä»${getRoleDisplayName(ceoApproval.originalRole)}å˜æ›´ä¸º${getRoleDisplayName(ceoApproval.roleChangedTo)}</div>`;
                        }

                        managerApproval += `
                            <div class="single-approval">
                                ${ceoApproval.comment ? `<div class="approval-comment">${sanitizeInput(ceoApproval.comment)}</div>` : ''}
                                <div class="signature-wrapper">
                                    ${ceoSignature ?
                                        `<img src="${ceoSignature}" alt="${ceoUser ? (ceoUser.displayName || 'CEO') : 'CEO'}çš„ç­¾å" class="signature-image" style="image-rendering: -webkit-optimize-contrast; filter: contrast(1.05);">` :
                                        `<div class="no-signature">æ— ç­¾å</div>`
                                    }
                                    <div class="approval-date">${formatDate(ceoApproval.date)}</div>
                                    ${ceoRoleChangeNote}
                                </div>
                            </div>
                        `;
                    }

                    managerApproval += `</div>`;
                }
            }

            // å½»åº•ä¿®å¤ï¼šæ— è®ºæ˜¯å¦æœ‰ç»ç†å®¡æ‰¹ï¼Œåªè¦æœ‰CEOå®¡æ‰¹å°±è¦æ˜¾ç¤ºCEOç­¾å
            if (application.approvals && application.approvals.ceo && (application.approvals.ceo.status === 'approved' || application.approvals.ceo.status === 'rejected')) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç»ç†å®¡æ‰¹å†…å®¹
                const hasManagerApproval = application.approvals.managers && Object.keys(application.approvals.managers).length > 0;

                if (!hasManagerApproval) {
                    // å¦‚æœæ²¡æœ‰ç»ç†å®¡æ‰¹ï¼ŒCEOç­¾åæ˜¾ç¤ºåœ¨ç»ç†æ ¸å‡†åŒºåŸŸ
                    const ceoApproval = application.approvals.ceo;

                    // è·å–CEOç”¨æˆ·åï¼Œå…¼å®¹å†å²æ•°æ®
                    const ceoUsername = ceoApproval.approverUsername ||
                                       ceoApproval.username ||
                                       'ceo';

                    // å¤šç§æ–¹å¼æŸ¥æ‰¾CEOç”¨æˆ·ä¿¡æ¯
                    const ceoUser = allUsers ? allUsers.find(u =>
                        u.role === 'ceo' ||
                        u.username === ceoUsername ||
                        (u.username && u.username.toLowerCase().includes('ceo')) ||
                        (ceoUsername !== 'ceo' && u.username === ceoUsername)
                    ) : null;

                    // å½»åº•ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å®¡æ‰¹è®°å½•ä¸­çš„ç­¾åï¼Œä¸ä¾èµ–ç”¨æˆ·æ•°æ®
                    const ceoSignature = ceoApproval.signature || (ceoUser && ceoUser.signature) || null;

                    // æ£€æŸ¥CEOæ˜¯å¦æœ‰è§’è‰²å˜æ›´ä¿¡æ¯
                    let ceoRoleChangeNote = '';
                    if (ceoApproval.originalRole && ceoApproval.roleChangedTo) {
                        const approverName = ceoApproval.approverUsername || 'CEO';
                        ceoRoleChangeNote = `<div class="role-change-note" style="font-size: 10px; color: #666; margin-top: 2px;">æ³¨ï¼š${approverName} å·²ä»${getRoleDisplayName(ceoApproval.originalRole)}å˜æ›´ä¸º${getRoleDisplayName(ceoApproval.roleChangedTo)}</div>`;
                    }

                    managerApproval = `
                        <div class="approval-container">
                            <div class="single-approval">
                                ${ceoApproval.comment ? `<div class="approval-comment">${sanitizeInput(ceoApproval.comment)}</div>` : ''}
                                <div class="signature-wrapper">
                                    ${ceoSignature ?
                                        `<img src="${ceoSignature}" alt="${ceoUser ? (ceoUser.displayName || 'CEO') : 'CEO'}çš„ç­¾å" class="signature-image" style="image-rendering: -webkit-optimize-contrast; filter: contrast(1.05);">` :
                                        `<div class="no-signature">æ— ç­¾å</div>`
                                    }
                                    <div class="approval-date">${formatDate(ceoApproval.date)}</div>
                                    ${ceoRoleChangeNote}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }



            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768;
            const isSmallMobile = window.innerWidth <= 480;

            // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´æ ·å¼
            let mobileClass = '';
            if (isSmallMobile) {
                mobileClass = 'mobile-small';
            } else if (isMobile) {
                mobileClass = 'mobile';
            }

            const templateHTML = `
                <table class="application-template ${mobileClass}">
                    <tr>
                        <th colspan="4" class="title">ç”³ è¯· ä¹¦</th>
                    </tr>
                    <tr style="height: 5%;">
                        <td class="label">ç”³è¯·éƒ¨é—¨</td>
                        <td>${sanitizeInput(application.department)}</td>
                        <td class="label">ç”³è¯·æ—¥æœŸ</td>
                        <td>${formattedDate}</td>
                    </tr>
                    <tr>
                        <td class="label" rowspan="2">ç”³è¯·äº‹ç”±</td>
                        <td colspan="3" class="content">${contentWithAmount.replace(/\n/g, '<br>')}</td>
                    </tr>
                    <tr style="height: 5%;">
                        <td colspan="3" class="applicant">ç”³è¯·äºº: ${sanitizeInput(application.applicant)}</td>
                    </tr>
                    <tr>
                        <td class="label">å‚é•¿æ„è§</td>
                        <td colspan="3" class="approval">${factoryApproval}</td>
                    </tr>
                    <tr>
                        <td class="label">æ€»ç›‘æ„è§</td>
                        <td colspan="3" class="approval">${directorApproval}</td>
                    </tr>
                    <tr>
                        <td class="label">ç»ç†æ ¸å‡†</td>
                        <td colspan="3" class="approval">${managerApproval}</td>
                    </tr>
                </table>
            `;

            // æ›´æ–°æ¨¡æ¿å†…å®¹
            document.getElementById('applicationTemplateContent').innerHTML = templateHTML;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('applicationTemplateModal').classList.remove('hidden');

            // è°ƒæ•´è¡¨æ ¼é«˜åº¦ä»¥å¡«æ»¡A4é¡µé¢
            adjustTableHeight();

            // æœ€ç»ˆæ£€æŸ¥ï¼šå¦‚æœCEOç­¾åä»ç„¶æ²¡æœ‰æ˜¾ç¤ºï¼Œå¼ºåˆ¶æ£€æŸ¥åŸå§‹æ•°æ®
            if (application.approvals.ceo && !application.approvals.ceo.signature) {
                const originalApp = applications.find(a => a.applicationCode === application.applicationCode || a.id === application.id);
                if (originalApp && originalApp.approvals && originalApp.approvals.ceo && originalApp.approvals.ceo.signature) {
                    application.approvals.ceo.signature = originalApp.approvals.ceo.signature;
                    // é‡æ–°ç”Ÿæˆæ¨¡æ¿
                    generateApplicationTemplate(application);
                    return;
                }
            }
        }

        // è°ƒæ•´è¡¨æ ¼é«˜åº¦ä»¥å¡«æ»¡A4é¡µé¢
        function adjustTableHeight() {
            // è·å–A4é¡µé¢çš„é«˜åº¦
            const a4Page = document.getElementById('applicationTemplatePage');
            const a4Height = a4Page.clientHeight;

            // è·å–è¡¨æ ¼
            const table = document.querySelector('.application-template');
            if (!table) return;

            // è®¾ç½®è¡¨æ ¼é«˜åº¦ä¸ºA4é¡µé¢é«˜åº¦çš„90%ï¼Œå‡å°‘åŸæ¥çš„95%ï¼Œç•™å‡ºæ›´å¤šåº•éƒ¨ç©ºé—´
            table.style.height = (a4Height * 0.90) + 'px';

            // è·å–å†…å®¹è¡Œå’Œå…¶ä»–è¡Œ
            const contentRow = table.querySelector('tr:nth-child(3)');
            const otherRows = Array.from(table.querySelectorAll('tr')).filter(row => row !== contentRow);

            // è®¡ç®—å…¶ä»–è¡Œçš„æ€»é«˜åº¦
            let otherRowsHeight = 0;
            otherRows.forEach(row => {
                otherRowsHeight += row.offsetHeight;
            });

            // è®¡ç®—å†…å®¹è¡Œåº”è¯¥çš„é«˜åº¦
            const contentHeight = (a4Height * 0.90) - otherRowsHeight;

            // è®¾ç½®å†…å®¹è¡Œçš„é«˜åº¦
            if (contentRow && contentHeight > 0) {
                contentRow.style.height = contentHeight + 'px';
                contentRow.querySelector('.content').style.height = contentHeight + 'px';
            }

            // ç§»åŠ¨è®¾å¤‡é€‚é…ï¼šç¡®ä¿åœ¨çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´
            window.addEventListener('resize', debounce(function() {
                // é‡æ–°è·å–A4é¡µé¢çš„é«˜åº¦
                const a4PageHeight = document.getElementById('applicationTemplatePage').clientHeight;

                // é‡æ–°è®¾ç½®è¡¨æ ¼é«˜åº¦
                if (table) {
                    table.style.height = (a4PageHeight * 0.90) + 'px';

                    // é‡æ–°è®¡ç®—å…¶ä»–è¡Œçš„æ€»é«˜åº¦
                    let newOtherRowsHeight = 0;
                    otherRows.forEach(row => {
                        newOtherRowsHeight += row.offsetHeight;
                    });

                    // é‡æ–°è®¡ç®—å†…å®¹è¡Œåº”è¯¥çš„é«˜åº¦
                    const newContentHeight = (a4PageHeight * 0.90) - newOtherRowsHeight;

                    // é‡æ–°è®¾ç½®å†…å®¹è¡Œçš„é«˜åº¦
                    if (contentRow && newContentHeight > 0) {
                        contentRow.style.height = newContentHeight + 'px';
                        contentRow.querySelector('.content').style.height = newContentHeight + 'px';
                    }
                }
            }, 250));
        }

        // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹è§¦å‘resizeäº‹ä»¶
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // å…³é—­ç”³è¯·ä¹¦æ¨¡æ¿
        function closeApplicationTemplate() {
            document.getElementById('applicationTemplateModal').classList.add('hidden');
        }

        // ä¸‹è½½ç”³è¯·ä¹¦æ¨¡æ¿ä¸ºPDF
        function downloadApplicationTemplate() {
            const element = document.getElementById('applicationTemplatePage');
            const filename = 'ç”³è¯·ä¹¦_' + new Date().toISOString().slice(0, 10) + '.pdf';

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'fixed top-0 left-0 w-full bg-blue-500 text-white text-center py-2 z-50';
            loadingMsg.textContent = 'æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...';
            document.body.appendChild(loadingMsg);

            // å…ˆåŠ è½½PDFåº“
            window.loadPdfLibraries().then(() => {
                // ä½¿ç”¨html2canvaså°†å…ƒç´ è½¬æ¢ä¸ºcanvas
                html2canvas(element, {
                    scale: 2, // ä¿æŒé«˜æ¸…æ™°åº¦
                    useCORS: true, // å…è®¸åŠ è½½è·¨åŸŸå›¾ç‰‡
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    // ä½¿ç”¨jsPDFå°†canvasè½¬æ¢ä¸ºPDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    // è®¡ç®—å®½é«˜æ¯”ä¾‹
                    const imgData = canvas.toDataURL('image/jpeg', 1); // JPEGæ ¼å¼ï¼Œæœ€é«˜è´¨é‡
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = Math.min(pageWidth / canvasWidth, pageHeight / canvasHeight);
                    const imgWidth = canvasWidth * ratio;
                    const imgHeight = canvasHeight * ratio;

                    // æ·»åŠ å›¾åƒåˆ°PDFï¼Œè°ƒæ•´yåæ ‡ä¸º-5mmï¼Œä½¿å†…å®¹ä¸Šç§»
                    pdf.addImage(imgData, 'JPEG', 0, -5, imgWidth, imgHeight);

                    // ä¸‹è½½PDF
                    pdf.save(filename);

                    // ç§»é™¤åŠ è½½æç¤º
                    document.body.removeChild(loadingMsg);
                }).catch(error => {
                    console.error('ç”ŸæˆPDFå¤±è´¥:', error);
                    alert('ç”ŸæˆPDFå¤±è´¥ï¼Œè¯·é‡è¯•');
                    document.body.removeChild(loadingMsg);
                });
            }).catch(error => {
                console.error('åŠ è½½PDFåº“å¤±è´¥:', error);
                alert('åŠ è½½PDFåº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                document.body.removeChild(loadingMsg);
            });
        }

        // æ‰“å°ç”³è¯·ä¹¦æ¨¡æ¿ï¼ˆä¿ç•™ä½†ä¸ä½¿ç”¨ï¼‰
        function printApplicationTemplate() {
            window.print();
        }

        // æ ¼å¼åŒ–æ—¥æœŸ (YYYY-MM-DD è½¬ä¸º YYYYå¹´MMæœˆDDæ—¥)
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // æ¨¡æ‹Ÿè·å–ç”¨æˆ·ç”µå­ç­¾åçš„æ¥å£
        // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªçœŸå®çš„åç«¯API
        async function getUserSignature(username) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªfetchè¯·æ±‚åˆ°åç«¯API
            // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªå“åº”
            return new Promise((resolve) => {
                // æŸ¥æ‰¾ç”¨æˆ·
                const user = allUsers.find(u => u.username === username);
                if (user && user.signature) {
                    resolve({ success: true, signature: user.signature });
                } else {
                    resolve({ success: false, signature: null });
                }
            });
        }

        // æ·»åŠ æ¨¡æ‹Ÿçš„APIç«¯ç‚¹
        // è¿™æ˜¯ä¸ºäº†æ¨¡æ‹Ÿåç«¯APIï¼Œåœ¨å®é™…åº”ç”¨ä¸­åº”è¯¥ç”±åç«¯æä¾›
        window.addEventListener('fetch', function(event) {
            if (event.request.url.includes('/getUserSignature')) {
                event.respondWith(
                    (async function() {
                        const url = new URL(event.request.url);
                        const username = url.searchParams.get('username');
                        const result = await getUserSignature(username);
                        return new Response(JSON.stringify(result), {
                            headers: { 'Content-Type': 'application/json' }
                        });
                    })()
                );
            }
        });

        // å›¾ç‰‡ä¼˜åŒ–å‡½æ•°
        function optimizeImage(imgElement) {
            // å¦‚æœå›¾ç‰‡å·²ç»ä¼˜åŒ–è¿‡ï¼Œåˆ™è·³è¿‡
            if (imgElement.dataset.optimized) return;

            // æ ‡è®°å›¾ç‰‡å·²ä¼˜åŒ–
            imgElement.dataset.optimized = 'true';

            // ä¿å­˜åŸå§‹å›¾ç‰‡URL
            const originalSrc = imgElement.src;

            // åˆ›å»ºä¸€ä¸ªæ–°çš„Imageå¯¹è±¡
            const img = new Image();
            img.crossOrigin = 'Anonymous';

            img.onload = function() {
                // åˆ›å»ºcanvas
                const canvas = document.createElement('canvas');

                // è®¡ç®—æ–°çš„å°ºå¯¸ï¼Œç§»åŠ¨ç«¯ä½¿ç”¨è¾ƒå°çš„å°ºå¯¸
                const maxWidth = 120;
                const maxHeight = 60;
                let width = img.width;
                let height = img.height;

                // ä¿æŒå®½é«˜æ¯”ä¾‹çš„æƒ…å†µä¸‹è°ƒæ•´å°ºå¯¸
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = width * ratio;
                    height = height * ratio;
                }

                // è®¾ç½®canvaså°ºå¯¸
                canvas.width = width;
                canvas.height = height;

                // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // å°†canvasè½¬æ¢ä¸ºè¾ƒä½è´¨é‡çš„JPEG
                try {
                    const optimizedSrc = canvas.toDataURL('image/jpeg', 0.7);
                    imgElement.src = optimizedSrc;
                } catch (e) {
                    console.error('å›¾ç‰‡ä¼˜åŒ–å¤±è´¥:', e);
                    // æ¢å¤åŸå§‹å›¾ç‰‡
                    imgElement.src = originalSrc;
                }
            };

            img.onerror = function() {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', originalSrc);
                // æ¢å¤åŸå§‹å›¾ç‰‡
                imgElement.src = originalSrc;
            };

            // åŠ è½½å›¾ç‰‡
            img.src = originalSrc;
        }

        // æ›´æ–°å½“å‰è§†å›¾
        function updateCurrentView() {
            // è·å–å½“å‰æ´»åŠ¨çš„ä¾§è¾¹æ æŒ‰é’®
            const activeBtn = document.querySelector('.side-nav-btn.active-indicator');
            if (!activeBtn) {
                // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„ä¾§è¾¹æ æŒ‰é’®ï¼Œé»˜è®¤æ›´æ–°å†å²åˆ—è¡¨
                updateHistoryList();
                return;
            }

            const section = activeBtn.dataset.section;
            if (section === 'history') {
                updateHistoryList();
            } else if (section === 'pendingApproval') {
                updatePendingApprovalList();
            } else if (section === 'approved') {
                updateApprovedList();
            } else {
                // é»˜è®¤æ›´æ–°å†å²åˆ—è¡¨
                updateHistoryList();
            }
        }

        // åˆ·æ–°æ•°æ®ä½†ä¿æŒå½“å‰é¡µé¢
        async function refreshData() {
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'refreshIndicator';
                loadingIndicator.className = 'fixed top-0 left-0 w-full bg-blue-500 text-white text-center py-2 z-50';
                loadingIndicator.textContent = 'æ­£åœ¨åˆ·æ–°æ•°æ®ï¼Œè¯·ç¨å€™...';
                document.body.appendChild(loadingIndicator);

                // ç›´æ¥ä»DOMä¸­è·å–å½“å‰æ´»åŠ¨çš„é¡µé¢
                const activeNavBtn = document.querySelector('.nav-btn.active');
                const currentSection = activeNavBtn ? activeNavBtn.dataset.section : 'new';

                // åŠ è½½æœ€æ–°æ•°æ®
                await loadApplications(1, 10, 'date', 'desc', false, true); // ä¼ å…¥falseè¡¨ç¤ºä¸è‡ªåŠ¨æ›´æ–°è§†å›¾

                // æ ¹æ®å½“å‰é¡µé¢æ‰‹åŠ¨æ›´æ–°è§†å›¾
                if (currentSection === 'history') {
                    updateHistoryList();
                } else if (currentSection === 'pendingApproval') {
                    updatePendingApprovalList();
                } else if (currentSection === 'approved') {
                    updateApprovedList();
                } else if (currentSection === 'manageUsers' && currentRole === 'admin') {
                    loadUsers();
                }

                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                setTimeout(() => {
                    const indicator = document.getElementById('refreshIndicator');
                    if (indicator) {
                        indicator.style.opacity = '0';
                        indicator.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            indicator.remove();
                        }, 500);
                    }
                }, 500);

            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                alert('åˆ·æ–°æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }
        }

        function canUserApprove(app) {
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ç”³è¯·çš„å®¡æ ¸äººæˆ–å·²ç»å®¡æ ¸è¿‡ç”³è¯·
            if (currentRole === 'director') {
                // å‚é•¿éœ€è¦æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‡å®šçš„å®¡æ ¸äºº
                const isPendingApprover = app.status === 'å¾…å‚é•¿å®¡æ ¸' &&
                       app.approvals &&
                       app.approvals.directors &&
                       app.approvals.directors[currentUser];

                // æ£€æŸ¥æ˜¯å¦å·²ç»å®¡æ ¸è¿‡
                const hasApproved = app.approvals &&
                              app.approvals.directors &&
                              app.approvals.directors[currentUser] &&
                              (app.approvals.directors[currentUser].status === 'approved' ||
                               app.approvals.directors[currentUser].status === 'rejected');

                return isPendingApprover || hasApproved;
            } else if (currentRole === 'chief') {
                // æ€»ç›‘éœ€è¦æ£€æŸ¥ç”³è¯·çŠ¶æ€
                const isPendingApprover = app.status === 'å¾…æ€»ç›‘å®¡æ‰¹';

                // æ£€æŸ¥æ˜¯å¦å·²ç»å®¡æ ¸è¿‡
                const hasApproved = app.approvals &&
                              app.approvals.chief &&
                              (app.approvals.chief.status === 'approved' ||
                               app.approvals.chief.status === 'rejected');

                return isPendingApprover || hasApproved;
            } else if (currentRole === 'manager') {
                // ç»ç†éœ€è¦æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‡å®šçš„å®¡æ ¸äºº
                const isPendingApprover = app.status === 'å¾…ç»ç†å®¡æ‰¹' &&
                       app.approvals &&
                       app.approvals.managers &&
                       app.approvals.managers[currentUser];

                // æ£€æŸ¥æ˜¯å¦å·²ç»å®¡æ ¸è¿‡
                const hasApproved = app.approvals &&
                              app.approvals.managers &&
                              app.approvals.managers[currentUser] &&
                              (app.approvals.managers[currentUser].status === 'approved' ||
                               app.approvals.managers[currentUser].status === 'rejected');

                return isPendingApprover || hasApproved;
            } else if (currentRole === 'ceo') {
                // CEOéœ€è¦æ£€æŸ¥ç”³è¯·çŠ¶æ€
                const isPendingApprover = app.status === 'å¾…CEOå®¡æ‰¹';

                // æ£€æŸ¥æ˜¯å¦å·²ç»ä½œä¸ºCEOå®¡æ ¸è¿‡
                const hasCeoApproved = app.approvals &&
                              app.approvals.ceo &&
                              (app.approvals.ceo.status === 'approved' ||
                               app.approvals.ceo.status === 'rejected');

                // æ£€æŸ¥æ˜¯å¦ä¹‹å‰ä½œä¸ºç»ç†å®¡æ ¸è¿‡
                const hasManagerApproved = app.approvals &&
                              app.approvals.managers &&
                              app.approvals.managers[currentUser] &&
                              (app.approvals.managers[currentUser].status === 'approved' ||
                               app.approvals.managers[currentUser].status === 'rejected');

                return isPendingApprover || hasCeoApproved || hasManagerApproved;
            }
            return false;
        }

        // æ¸²æŸ“å·²å®¡æ ¸åˆ—è¡¨
        function renderApprovedList(apps, tbody) {
            tbody.innerHTML = apps.map(app => {
                // è·å–å½“å‰ç”¨æˆ·çš„å®¡æ ¸ç»“æœ
                let approvalResult = 'æœªçŸ¥';

                try {
                    if (currentRole === 'director' && app.approvals && app.approvals.directors && app.approvals.directors[currentUser]) {
                        approvalResult = statusMap[app.approvals.directors[currentUser].status] || app.approvals.directors[currentUser].status;
                    } else if (currentRole === 'chief' && app.approvals && app.approvals.chief) {
                        approvalResult = statusMap[app.approvals.chief.status] || app.approvals.chief.status;
                    } else if (currentRole === 'manager' && app.approvals && app.approvals.managers && app.approvals.managers[currentUser]) {
                        approvalResult = statusMap[app.approvals.managers[currentUser].status] || app.approvals.managers[currentUser].status;
                    } else if (currentRole === 'ceo') {
                        // CEOèƒ½çœ‹åˆ°è‡ªå·±ä½œä¸ºCEOçš„å®¡æ‰¹ç»“æœï¼Œä»¥åŠä¹‹å‰ä½œä¸ºç»ç†çš„å®¡æ‰¹ç»“æœ
                        if (app.approvals && app.approvals.ceo) {
                            approvalResult = statusMap[app.approvals.ceo.status] || app.approvals.ceo.status;
                        } else if (app.approvals && app.approvals.managers && app.approvals.managers[currentUser]) {
                            approvalResult = statusMap[app.approvals.managers[currentUser].status] || app.approvals.managers[currentUser].status;
                        } else {
                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„å®¡æ‰¹è®°å½•ï¼Œæ ¹æ®ç”³è¯·çŠ¶æ€åˆ¤æ–­
                            if (app.status === 'å·²é€šè¿‡') {
                                approvalResult = 'é€šè¿‡';
                            } else if (app.status === 'å·²æ‹’ç»') {
                                approvalResult = 'æ‹’ç»';
                            } else {
                                approvalResult = 'æœªå®¡æ ¸';
                            }
                        }
                    } else if (currentRole === 'admin' || currentRole === 'user' || currentRole === 'readonly') {
                        if (app.status === 'å·²é€šè¿‡') {
                            approvalResult = 'é€šè¿‡';
                        } else if (app.status === 'å·²æ‹’ç»') {
                            approvalResult = 'æ‹’ç»';
                        } else {
                            approvalResult = 'æœªå®¡æ ¸';
                        }
                    }
                } catch (error) {
                    console.error('è·å–å®¡æ‰¹ç»“æœå‡ºé”™:', error, app);
                    // å‡ºé”™æ—¶æ ¹æ®ç”³è¯·çŠ¶æ€è®¾ç½®é»˜è®¤å€¼
                    if (app.status === 'å·²é€šè¿‡') {
                        approvalResult = 'é€šè¿‡';
                    } else if (app.status === 'å·²æ‹’ç»') {
                        approvalResult = 'æ‹’ç»';
                    } else {
                        approvalResult = 'æœªçŸ¥';
                    }
                }

                return `
                    <tr>
                        <td class="px-6 py-4">${app.applicationCode || 'æ— ç¼–å·'}</td>
                        <td class="px-6 py-4">${sanitizeInput(app.applicant)}</td>
                        <td class="px-6 py-4">${sanitizeInput(app.department)}</td>
                        <td class="px-6 py-4">
                            ${app.date}
                            <span class="block text-xs text-gray-500">${formatSubmitTime(app.id)}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded ${getPriorityClass(app.priority)}">${priorityMap[app.priority] || app.priority}</span>
                        </td>
                        <td class="px-6 py-4" style="max-width: 200px; width: 200px; white-space: normal; overflow: visible; word-break: break-word; vertical-align: top;">
                            ${createClickableContent(app.content)}
                        </td>
                        <td class="px-6 py-4">
                            ${app.status}
                            <span class="block text-xs text-gray-500">${getApplicationStatusDesc(app.status, app)}</span>
                            ${app.status === 'å¾…å‚é•¿å®¡æ ¸' && app.approvals && app.approvals.directors ?
                                `<span class="block text-xs text-blue-600">å¾…å®¡æ ¸å‚é•¿ï¼š${Object.entries(app.approvals.directors)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([director, _]) => sanitizeInput(director))
                                    .join('ã€') || 'æ— '}</span>`
                                : ''}
                            ${app.status === 'å¾…ç»ç†å®¡æ‰¹' && app.approvals && app.approvals.managers ?
                                `<span class="block text-xs text-blue-600">å¾…å®¡æ ¸ç»ç†ï¼š${Object.entries(app.approvals.managers)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([manager, _]) => sanitizeInput(manager))
                                    .join('ã€') || 'æ— '}</span>`
                                : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded ${approvalResult === 'é€šè¿‡' ? 'bg-green-100 text-green-800' : approvalResult === 'æ‹’ç»' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">${approvalResult}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="viewDetail(${app.id})" class="text-blue-600 hover:text-blue-800">æŸ¥çœ‹</button>
                            ${canWithdrawApproval(app) ?
                                `<button onclick="handleWithdrawApproval(${app.id})" class="text-orange-600 hover:text-orange-800 ml-2">æ’¤å›</button>` :
                                ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ¸²æŸ“å¾…å®¡æ ¸åˆ—è¡¨
        function renderPendingList(apps, tbody) {
            tbody.innerHTML = apps.map(app => {
                // è·å–å½“å‰ç”¨æˆ·çš„å®¡æ ¸çŠ¶æ€
                let approvalStatus = 'æœªå®¡æ ¸';
                let approvalClass = 'bg-gray-100 text-gray-800';

                try {
                    if (currentRole === 'director' && app.approvals && app.approvals.directors && app.approvals.directors[currentUser]) {
                        approvalStatus = statusMap[app.approvals.directors[currentUser].status] || app.approvals.directors[currentUser].status;
                        approvalClass = app.approvals.directors[currentUser].status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    } else if (currentRole === 'chief' && app.approvals && app.approvals.chief) {
                        approvalStatus = statusMap[app.approvals.chief.status] || app.approvals.chief.status;
                        approvalClass = app.approvals.chief.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    } else if (currentRole === 'manager' && app.approvals && app.approvals.managers && app.approvals.managers[currentUser]) {
                        approvalStatus = statusMap[app.approvals.managers[currentUser].status] || app.approvals.managers[currentUser].status;
                        approvalClass = app.approvals.managers[currentUser].status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    } else if (currentRole === 'ceo' && app.approvals && app.approvals.ceo) {
                        approvalStatus = statusMap[app.approvals.ceo.status] || app.approvals.ceo.status;
                        approvalClass = app.approvals.ceo.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    }
                } catch (error) {
                    console.error('è·å–å®¡æ‰¹çŠ¶æ€å‡ºé”™:', error, app);
                }

                return `
                    <tr>
                        <td class="px-6 py-4">${sanitizeInput(app.applicant)}</td>
                        <td class="px-6 py-4">${sanitizeInput(app.department)}</td>
                        <td class="px-6 py-4">
                            ${app.date}
                            <span class="block text-xs text-gray-500">${formatSubmitTime(app.id)}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded ${getPriorityClass(app.priority)}">${priorityMap[app.priority] || app.priority}</span>
                        </td>
                        <td class="px-6 py-4" style="max-width: 200px; width: 200px; white-space: normal; overflow: visible; word-break: break-word; vertical-align: top;">
                            ${createClickableContent(app.content)}
                        </td>
                        <td class="px-6 py-4">
                            ${app.status}
                            <span class="block text-xs text-gray-500">${getApplicationStatusDesc(app.status, app)}</span>
                            ${app.status === 'å¾…å‚é•¿å®¡æ ¸' && app.approvals && app.approvals.directors ?
                                `<span class="block text-xs text-blue-600">å¾…å®¡æ ¸å‚é•¿ï¼š${Object.entries(app.approvals.directors)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([director, _]) => sanitizeInput(director))
                                    .join('ã€') || 'æ— '}</span>`
                                : ''}
                            ${app.status === 'å¾…ç»ç†å®¡æ‰¹' && app.approvals && app.approvals.managers ?
                                `<span class="block text-xs text-blue-600">å¾…å®¡æ ¸ç»ç†ï¼š${Object.entries(app.approvals.managers)
                                    .filter(([_, approval]) => approval.status === 'pending')
                                    .map(([manager, _]) => sanitizeInput(manager))
                                    .join('ã€') || 'æ— '}</span>`
                                : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded ${approvalClass}">${approvalStatus}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="viewDetail(${app.id})" class="text-blue-600 hover:text-blue-800">æŸ¥çœ‹</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }



        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            const userInfoElement = document.getElementById('currentUserInfo');
            const mobileUserInfoElement = document.getElementById('mobileCurrentUserInfo');
            const pcUserInfoElement = document.getElementById('pcCurrentUserInfo');

            const userDisplayText = currentUser;

            if (userInfoElement) {
                userInfoElement.textContent = `å½“å‰ç”¨æˆ·: ${currentUser}`;
            }

            if (mobileUserInfoElement) {
                mobileUserInfoElement.textContent = `å½“å‰ç”¨æˆ·: ${currentUser}`;
            }

            if (pcUserInfoElement) {
                pcUserInfoElement.textContent = userDisplayText;
            }
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯ç”¨æˆ·ä¿¡æ¯ä¸‹æ‹‰èœå•
        function toggleUserInfo() {
            const dropdown = document.getElementById('userInfoDropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }



        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·ä¿¡æ¯ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userInfoDropdown');
            const userButton = document.querySelector('.md\\:hidden button');

            if (dropdown && !dropdown.classList.contains('hidden') &&
                !dropdown.contains(event.target) &&
                userButton && !userButton.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // å¯¼å‡ºç”¨æˆ·æ•°æ®ä¸ºCSV
        async function exportUsers() {
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator('æ­£åœ¨å¯¼å‡ºç”¨æˆ·æ•°æ®...');

                // ä½¿ç”¨fetchå‘èµ·è¯·æ±‚ï¼Œä½†è®¾ç½®responseTypeä¸ºblobä»¥æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®
                const response = await fetch(`/exportUsers?username=${currentUser}`);

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideLoadingIndicator();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'å¯¼å‡ºå¤±è´¥');
                }

                // è·å–blobæ•°æ®
                const blob = await response.blob();

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'users.csv';

                // æ·»åŠ åˆ°æ–‡æ¡£å¹¶è§¦å‘ç‚¹å‡»
                document.body.appendChild(a);
                a.click();

                // æ¸…ç†
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                hideLoadingIndicator();
                console.error('å¯¼å‡ºç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºç”¨æˆ·æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ—¶é—´æ§åˆ¶ç›¸å…³å‡½æ•°
        function toggleWorkingDays() {
            const checkbox = document.getElementById('enableWorkingDays');
            const settings = document.getElementById('workingDaysSettings');
            if (checkbox.checked) {
                settings.classList.remove('hidden');
            } else {
                settings.classList.add('hidden');
            }
        }

        function toggleCustomDates() {
            const checkbox = document.getElementById('enableCustomDates');
            const settings = document.getElementById('customDatesSettings');
            if (checkbox.checked) {
                settings.classList.remove('hidden');
            } else {
                settings.classList.add('hidden');
            }
        }

        function addSkipDate() {
            const dateInput = document.getElementById('newSkipDate');
            const date = dateInput.value;
            if (!date) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingDates = Array.from(document.querySelectorAll('#skipDatesList .skip-date-item')).map(item => item.dataset.date);
            if (existingDates.includes(date)) {
                alert('è¯¥æ—¥æœŸå·²å­˜åœ¨');
                return;
            }

            // æ·»åŠ åˆ°åˆ—è¡¨
            const listContainer = document.getElementById('skipDatesList');

            // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œå…ˆæ¸…é™¤æç¤ºæ–‡å­—
            if (listContainer.innerHTML.includes('æš‚æ— è·³è¿‡æ—¥æœŸ')) {
                listContainer.innerHTML = '';
            }

            const dateItem = document.createElement('div');
            dateItem.className = 'skip-date-item flex items-center justify-between bg-white p-2 rounded border text-sm';
            dateItem.dataset.date = date;
            dateItem.innerHTML = `
                <span>${date}</span>
                <button onclick="removeSkipDate('${date}')" class="text-red-600 hover:text-red-800 text-xs">åˆ é™¤</button>
            `;
            listContainer.appendChild(dateItem);

            // æ¸…ç©ºè¾“å…¥æ¡†
            dateInput.value = '';
        }

        function addDateRange() {
            const startDateInput = document.getElementById('rangeStartDate');
            const endDateInput = document.getElementById('rangeEndDate');
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            if (startDate > endDate) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            // ç”Ÿæˆæ—¥æœŸèŒƒå›´
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dates = [];

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().slice(0, 10);
                dates.push(dateStr);
            }

            // æ£€æŸ¥é‡å¤å¹¶æ·»åŠ 
            const existingDates = Array.from(document.querySelectorAll('#skipDatesList .skip-date-item')).map(item => item.dataset.date);
            const newDates = dates.filter(date => !existingDates.includes(date));

            if (newDates.length === 0) {
                alert('é€‰æ‹©çš„æ—¥æœŸèŒƒå›´å†…çš„æ‰€æœ‰æ—¥æœŸéƒ½å·²å­˜åœ¨');
                return;
            }

            // æ·»åŠ æ–°æ—¥æœŸåˆ°åˆ—è¡¨
            const listContainer = document.getElementById('skipDatesList');
            newDates.forEach(date => {
                const dateItem = document.createElement('div');
                dateItem.className = 'skip-date-item flex items-center justify-between bg-white p-2 rounded border text-sm';
                dateItem.dataset.date = date;
                dateItem.innerHTML = `
                    <span>${date}</span>
                    <button onclick="removeSkipDate('${date}')" class="text-red-600 hover:text-red-800 text-xs">åˆ é™¤</button>
                `;
                listContainer.appendChild(dateItem);
            });

            // æ¸…ç©ºè¾“å…¥æ¡†
            startDateInput.value = '';
            endDateInput.value = '';

            alert(`æˆåŠŸæ·»åŠ  ${newDates.length} ä¸ªæ—¥æœŸ`);
        }

        function removeSkipDate(date) {
            const item = document.querySelector(`#skipDatesList .skip-date-item[data-date="${date}"]`);
            if (item) {
                item.remove();
            }
        }

        // ==================== å½’æ¡£ç®¡ç†ç›¸å…³å‡½æ•° ====================

        // åŠ è½½å½’æ¡£ç»Ÿè®¡ä¿¡æ¯
        async function loadArchiveStats() {
            try {
                const response = await fetch(`/admin/archive-stats?username=${currentUser}`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.stats;

                    // æ›´æ–°ç»Ÿè®¡æ•°å­—
                    document.getElementById('activeAppsCount').textContent = stats.active.total || 0;
                    document.getElementById('archivedAppsCount').textContent = stats.archived.total || 0;
                    document.getElementById('mainFileSize').textContent = stats.mainFileSize || '-';

                    // è®¡ç®—å¯å½’æ¡£æ•°é‡ï¼ˆå·²å®Œæˆä¸”è¶…è¿‡3ä¸ªæœˆçš„ï¼‰
                    const archivableCount = stats.active.completed || 0;
                    document.getElementById('archivableCount').textContent = archivableCount;

                    // æ˜¾ç¤ºå½’æ¡£æ–‡ä»¶åˆ—è¡¨
                    if (stats.archiveFiles && stats.archiveFiles.length > 0) {
                        document.getElementById('archiveHistory').classList.remove('hidden');
                        const filesList = document.getElementById('archiveFilesList');
                        filesList.innerHTML = stats.archiveFiles.map(file => `
                            <div class="flex justify-between items-center text-xs py-1 px-2 bg-gray-50 rounded">
                                <span class="text-gray-700">${file.filename}</span>
                                <span class="text-gray-500">${file.count}ä¸ª Â· ${file.size}</span>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('archiveHistory').classList.add('hidden');
                    }

                    // å¦‚æœä¸»æ–‡ä»¶è¿‡å¤§ï¼Œæ˜¾ç¤ºè­¦å‘Š
                    const fileSizeMB = parseFloat(stats.mainFileSize);
                    if (fileSizeMB > 30) {
                        showTemporaryMessage(`ä¸»æ–‡ä»¶å¤§å°${stats.mainFileSize}ï¼Œå»ºè®®æ‰§è¡Œå½’æ¡£æ“ä½œ`, 'warning', 5000);
                    }
                } else {
                    console.error('åŠ è½½å½’æ¡£ç»Ÿè®¡å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½å½’æ¡£ç»Ÿè®¡é”™è¯¯:', error);
                showTemporaryMessage('åŠ è½½å½’æ¡£ç»Ÿè®¡å¤±è´¥', 'error');
            }
        }

        // æ‰§è¡Œå½’æ¡£æ“ä½œ
        async function executeArchive() {
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œå½’æ¡£æ“ä½œå—ï¼Ÿ\n\nå°†å½’æ¡£3ä¸ªæœˆå‰çš„å·²å®Œæˆç”³è¯·ï¼Œå½’æ¡£åæ•°æ®ä»å¯æ­£å¸¸æŸ¥è¯¢ã€‚')) {
                return;
            }

            try {
                showTemporaryMessage('æ­£åœ¨æ‰§è¡Œå½’æ¡£ï¼Œè¯·ç¨å€™...', 'info', 10000);

                const response = await fetch('/admin/archive-old-applications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser })
                });

                const result = await response.json();

                if (result.success) {
                    showTemporaryMessage(result.message, 'success', 5000);
                    // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                    setTimeout(() => loadArchiveStats(), 1000);
                } else {
                    showTemporaryMessage('å½’æ¡£å¤±è´¥: ' + result.message, 'error', 5000);
                }
            } catch (error) {
                console.error('æ‰§è¡Œå½’æ¡£é”™è¯¯:', error);
                showTemporaryMessage('å½’æ¡£æ“ä½œå¤±è´¥', 'error');
            }
        }

        // åˆ‡æ¢æ—¶é—´æ§åˆ¶è®¾ç½®æ˜¾ç¤º
        function toggleTimeControl() {
            const content = document.getElementById('timeControlContent');
            const icon = document.getElementById('timeControlIcon');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // ç³»ç»Ÿè®¾ç½®ç›¸å…³å‡½æ•°
        async function loadSystemSettings() {
            try {
                // åŠ è½½é‚®ä»¶æé†’è®¾ç½®
                const response = await fetch(`/getReminderSettings?username=${currentUser}`);
                const result = await response.json();

                if (result.success) {
                    // åŠ è½½ä¼˜å…ˆçº§ç­–ç•¥
                    const priority = result.settings.priority;
                    document.getElementById('highPriorityDelay').value = priority.high.initialDelay;
                    document.getElementById('highPriorityNormal').value = priority.high.normalInterval;
                    document.getElementById('highPriorityMedium').value = priority.high.mediumInterval;
                    document.getElementById('highPriorityUrgent').value = priority.high.urgentInterval;

                    document.getElementById('mediumPriorityDelay').value = priority.medium.initialDelay;
                    document.getElementById('mediumPriorityNormal').value = priority.medium.normalInterval;
                    document.getElementById('mediumPriorityMedium').value = priority.medium.mediumInterval;
                    document.getElementById('mediumPriorityUrgent').value = priority.medium.urgentInterval;

                    document.getElementById('lowPriorityDelay').value = priority.low.initialDelay;
                    document.getElementById('lowPriorityNormal').value = priority.low.normalInterval;
                    document.getElementById('lowPriorityMedium').value = priority.low.mediumInterval;
                    document.getElementById('lowPriorityUrgent').value = priority.low.urgentInterval;

                    // åŠ è½½æ—¶é—´æ§åˆ¶è®¾ç½®
                    const timeControl = result.settings.timeControl || {};

                    // å·¥ä½œæ—¥å’Œå·¥ä½œæ—¶é—´è®¾ç½®
                    const workingDays = timeControl.workingDays || {};

                    const enableWorkingDaysCheckbox = document.getElementById('enableWorkingDays');
                    if (enableWorkingDaysCheckbox) {
                        enableWorkingDaysCheckbox.checked = workingDays.enabled || false;
                    }

                    document.getElementById('workingStartTime').value = workingDays.startTime || '09:00';
                    document.getElementById('workingEndTime').value = workingDays.endTime || '18:00';

                    // è®¾ç½®å·¥ä½œæ—¥å¤é€‰æ¡†
                    const selectedDays = workingDays.days || [1, 2, 3, 4, 5]; // é»˜è®¤å‘¨ä¸€åˆ°å‘¨äº”
                    for (let i = 1; i <= 7; i++) {
                        const checkbox = document.getElementById(`workDay${i}`);
                        if (checkbox) {
                            checkbox.checked = selectedDays.includes(i);
                        }
                    }

                    // è‡ªå®šä¹‰æ—¥æœŸè®¾ç½®
                    const customDates = timeControl.customDates || {};
                    document.getElementById('enableCustomDates').checked = customDates.enabled || false;

                    // åŠ è½½è·³è¿‡æ—¥æœŸåˆ—è¡¨
                    const skipDates = customDates.skipDates || [];
                    const listContainer = document.getElementById('skipDatesList');
                    listContainer.innerHTML = '';
                    if (skipDates.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-500 text-xs text-center py-2">æš‚æ— è·³è¿‡æ—¥æœŸ</p>';
                    } else {
                        // æŒ‰æ—¥æœŸæ’åº
                        skipDates.sort().forEach(date => {
                            const dateItem = document.createElement('div');
                            dateItem.className = 'skip-date-item flex items-center justify-between bg-white p-2 rounded border text-sm';
                            dateItem.dataset.date = date;
                            dateItem.innerHTML = `
                                <span>${date}</span>
                                <button onclick="removeSkipDate('${date}')" class="text-red-600 hover:text-red-800 text-xs">åˆ é™¤</button>
                            `;
                            listContainer.appendChild(dateItem);
                        });
                    }

                    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const enableWorkingDaysEl = document.getElementById('enableWorkingDays');
                    const enableCustomDatesEl = document.getElementById('enableCustomDates');

                    if (enableWorkingDaysEl) {
                        enableWorkingDaysEl.removeEventListener('change', toggleWorkingDays);
                        enableWorkingDaysEl.addEventListener('change', toggleWorkingDays);
                    }

                    if (enableCustomDatesEl) {
                        enableCustomDatesEl.removeEventListener('change', toggleCustomDates);
                        enableCustomDatesEl.addEventListener('change', toggleCustomDates);
                    }

                    // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                    toggleWorkingDays();
                    toggleCustomDates();
                }

                // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                loadReminderStats();
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
                alert('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥');
            }
        }



        async function saveReminderStrategies() {
            try {
                const strategies = {
                    priority: {
                        high: {
                            initialDelay: parseInt(document.getElementById('highPriorityDelay').value),
                            normalInterval: parseInt(document.getElementById('highPriorityNormal').value),
                            mediumInterval: parseInt(document.getElementById('highPriorityMedium').value),
                            urgentInterval: parseInt(document.getElementById('highPriorityUrgent').value)
                        },
                        medium: {
                            initialDelay: parseInt(document.getElementById('mediumPriorityDelay').value),
                            normalInterval: parseInt(document.getElementById('mediumPriorityNormal').value),
                            mediumInterval: parseInt(document.getElementById('mediumPriorityMedium').value),
                            urgentInterval: parseInt(document.getElementById('mediumPriorityUrgent').value)
                        },
                        low: {
                            initialDelay: parseInt(document.getElementById('lowPriorityDelay').value),
                            normalInterval: parseInt(document.getElementById('lowPriorityNormal').value),
                            mediumInterval: parseInt(document.getElementById('lowPriorityMedium').value),
                            urgentInterval: parseInt(document.getElementById('lowPriorityUrgent').value)
                        }
                    },
                    timeControl: {
                        workingDays: {
                            enabled: document.getElementById('enableWorkingDays').checked,
                            days: Array.from(document.querySelectorAll('[id^="workDay"]:checked')).map(cb => parseInt(cb.value)),
                            startTime: document.getElementById('workingStartTime').value,
                            endTime: document.getElementById('workingEndTime').value
                        },
                        customDates: {
                            enabled: document.getElementById('enableCustomDates').checked,
                            skipDates: Array.from(document.querySelectorAll('#skipDatesList .skip-date-item')).map(item => item.dataset.date)
                        }
                    }
                };

                const response = await fetch('/saveReminderStrategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser,
                        strategies
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('æé†’ç­–ç•¥ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜æé†’ç­–ç•¥å¤±è´¥:', error);
                alert('ä¿å­˜æé†’ç­–ç•¥å¤±è´¥');
            }
        }

        // æ‰‹åŠ¨è§¦å‘æé†’æ£€æŸ¥
        async function triggerReminderCheck() {
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator('æ­£åœ¨è§¦å‘æé†’æ£€æŸ¥...');

                const response = await fetch('/triggerReminderCheck', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser
                    })
                });

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideLoadingIndicator();

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                    await loadReminderStats();
                } else {
                    alert('è§¦å‘å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                hideLoadingIndicator();
                console.error('è§¦å‘æé†’æ£€æŸ¥å¤±è´¥:', error);
                alert('è§¦å‘æé†’æ£€æŸ¥å¤±è´¥');
            }
        }

        async function loadReminderStats() {
            try {
                const response = await fetch(`/getReminderStats?username=${currentUser}`);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('totalReminders').textContent = result.stats.totalReminders;
                    document.getElementById('pendingApplications').textContent = result.stats.pendingApplications;
                    document.getElementById('urgentApplications').textContent = result.stats.urgentApplications;
                    document.getElementById('avgResponseTime').textContent = result.stats.avgResponseTime;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }



        // å¯¼å‡ºç”³è¯·è®°å½•ä¸ºExcel
        async function exportApplicationsToExcel() {
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator('æ­£åœ¨å¯¼å‡ºç”³è¯·è®°å½•...');

                // è·å–å½“å‰æ—¶é—´èŒƒå›´
                const timeRange = document.getElementById('timeRange').value;

                // æ„å»ºè¯·æ±‚URL
                let url = `/exportApplications?username=${currentUser}&role=${currentRole}&timeRange=${timeRange}`;

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†æ—¥æœŸèŒƒå›´ç­›é€‰
                const dateRangeContainer = document.getElementById('exportDateRangeContainer');
                if (!dateRangeContainer.classList.contains('hidden')) {
                    // è·å–æ—¥æœŸèŒƒå›´
                    const startDate = document.getElementById('exportStartDate').value;
                    const endDate = document.getElementById('exportEndDate').value;

                    // éªŒè¯æ—¥æœŸ
                    if (!startDate || !endDate) {
                        hideLoadingIndicator();
                        alert('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´');
                        return;
                    }

                    // éªŒè¯å¼€å§‹æ—¥æœŸä¸èƒ½å¤§äºç»“æŸæ—¥æœŸ
                    if (new Date(startDate) > new Date(endDate)) {
                        hideLoadingIndicator();
                        alert('å¼€å§‹æ—¥æœŸä¸èƒ½å¤§äºç»“æŸæ—¥æœŸ');
                        return;
                    }

                    // æ·»åŠ æ—¥æœŸèŒƒå›´å‚æ•°
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                }

                // ä½¿ç”¨fetchå‘èµ·è¯·æ±‚
                const response = await fetch(url);

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideLoadingIndicator();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'å¯¼å‡ºå¤±è´¥');
                }

                // è·å–blobæ•°æ®
                const blob = await response.blob();

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;

                // è®¾ç½®æ–‡ä»¶å
                let fileName = '';

                // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ—¥æœŸèŒƒå›´ç­›é€‰
                if (!dateRangeContainer.classList.contains('hidden')) {
                    const startDate = document.getElementById('exportStartDate').value;
                    const endDate = document.getElementById('exportEndDate').value;
                    fileName = `ç”³è¯·è®°å½•_${startDate}_è‡³_${endDate}.xlsx`;
                } else {
                    // æ ¹æ®æ—¶é—´èŒƒå›´è®¾ç½®æ–‡ä»¶å
                    let timeRangeText = '';
                    switch(timeRange) {
                        case 'week':
                            timeRangeText = 'æœ¬å‘¨';
                            break;
                        case 'month':
                            timeRangeText = 'æœ¬æœˆ';
                            break;
                        case 'year':
                            timeRangeText = 'æœ¬å¹´';
                            break;
                        default:
                            timeRangeText = 'å…¨éƒ¨';
                    }

                    // è®¾ç½®æ–‡ä»¶åï¼ŒåŒ…å«å½“å‰æ—¥æœŸ
                    const today = new Date().toISOString().slice(0, 10);
                    fileName = `ç”³è¯·è®°å½•_${timeRangeText}_${today}.xlsx`;
                }

                a.download = fileName;

                // æ·»åŠ åˆ°æ–‡æ¡£å¹¶è§¦å‘ç‚¹å‡»
                document.body.appendChild(a);
                a.click();

                // æ¸…ç†
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);

            } catch (error) {
                hideLoadingIndicator();
                console.error('å¯¼å‡ºç”³è¯·è®°å½•å¤±è´¥:', error);
                alert('å¯¼å‡ºç”³è¯·è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å…¥ç”¨æˆ·æ•°æ®
        async function importUsers(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ç¡®è®¤å¯¼å…¥
            if (!confirm('å¯¼å…¥å°†æ·»åŠ æ–°ç”¨æˆ·ï¼Œå¹¶æ›´æ–°å·²å­˜åœ¨çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯†ç ã€è§’è‰²ã€é‚®ç®±ç­‰ï¼‰ã€‚\n\næ³¨æ„ï¼šç”µå­ç­¾åä¸ä¼šé€šè¿‡å¯¼å…¥æ›´æ–°ï¼Œéœ€è¦å•ç‹¬è®¾ç½®ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator('æ­£åœ¨å¯¼å…¥ç”¨æˆ·æ•°æ®...');

                // è¯»å–æ–‡ä»¶å†…å®¹
                const fileContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(e);
                    reader.readAsText(file, 'UTF-8'); // æŒ‡å®šUTF-8ç¼–ç 
                });

                // å‘é€åˆ°æœåŠ¡å™¨
                const response = await fetch(`/importUsers?username=${currentUser}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/csv; charset=utf-8' },
                    body: fileContent
                });

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideLoadingIndicator();

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    await loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    renderUsersList();
                } else {
                    let errorMessage = result.message;
                    if (result.errors && result.errors.length > 0) {
                        errorMessage += '\n\né”™è¯¯è¯¦æƒ…:\n' + result.errors.join('\n');
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                hideLoadingIndicator();
                console.error('å¯¼å…¥ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                alert('å¯¼å…¥ç”¨æˆ·æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
            }
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator(message) {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'globalLoadingIndicator';
            loadingIndicator.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingIndicator.innerHTML = `
                <div class="bg-white p-4 rounded-md shadow-lg">
                    <div class="spinner mb-2"></div>
                    <p>${message || 'åŠ è½½ä¸­...'}</p>
                </div>
            `;
            document.body.appendChild(loadingIndicator);
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('globalLoadingIndicator');
            if (loadingIndicator) {
                document.body.removeChild(loadingIndicator);
            }
        }

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç å¼¹çª—
        function showChangePasswordModal() {
            // é‡ç½®è¡¨å•
            document.getElementById('changePasswordForm').reset();
            document.getElementById('cpError').textContent = '';
            document.getElementById('cpError').classList.add('hidden');
            document.getElementById('cpSuccess').textContent = '';
            document.getElementById('cpSuccess').classList.add('hidden');

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        // éšè—ä¿®æ”¹å¯†ç å¼¹çª—
        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
        }

        // å¤„ç†ä¿®æ”¹å¯†ç 
        async function handleChangePassword(e) {
            e.preventDefault();

            // è·å–è¡¨å•æ•°æ®
            const username = document.getElementById('cpUsername').value.trim();
            const currentPassword = document.getElementById('cpCurrentPassword').value;
            const confirmCurrentPassword = document.getElementById('cpConfirmCurrentPassword').value;
            const newPassword = document.getElementById('cpNewPassword').value;

            // éªŒè¯è¡¨å•
            if (!username || !currentPassword || !confirmCurrentPassword || !newPassword) {
                showChangePasswordError('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }

            // éªŒè¯ä¸¤æ¬¡è¾“å…¥çš„å½“å‰å¯†ç æ˜¯å¦ä¸€è‡´
            if (currentPassword !== confirmCurrentPassword) {
                showChangePasswordError('ä¸¤æ¬¡è¾“å…¥çš„å½“å‰å¯†ç ä¸ä¸€è‡´');
                return;
            }

            // éªŒè¯æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ
            if (newPassword === currentPassword) {
                showChangePasswordError('æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ');
                return;
            }

            try {
                // æ˜¾ç¤ºloading
                const cpSubmitBtn = document.querySelector('#changePasswordForm button[type="submit"]');
                const originalBtnText = cpSubmitBtn.textContent;
                cpSubmitBtn.textContent = 'å¤„ç†ä¸­...';
                cpSubmitBtn.disabled = true;

                // å‘é€ä¿®æ”¹å¯†ç è¯·æ±‚
                const response = await fetch('/changePassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        currentPassword,
                        newPassword
                    })
                });

                const result = await response.json();

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                cpSubmitBtn.textContent = originalBtnText;
                cpSubmitBtn.disabled = false;

                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    document.getElementById('cpSuccess').textContent = result.message;
                    document.getElementById('cpSuccess').classList.remove('hidden');
                    document.getElementById('cpError').classList.add('hidden');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('changePasswordForm').reset();

                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ä¸”ä¿®æ”¹çš„æ˜¯å½“å‰ç”¨æˆ·çš„å¯†ç ï¼Œåˆ™æ³¨é”€
                    if (sessionStorage.getItem('isLoggedIn') === 'true' && sessionStorage.getItem('username') === username) {
                        // å»¶è¿Ÿ3ç§’åè‡ªåŠ¨ç™»å‡º
                        setTimeout(() => {
                            logout();
                            hideChangePasswordModal();
                            alert('å¯†ç å·²ä¿®æ”¹ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•');
                        }, 3000);
                    }
                } else {
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    showChangePasswordError(result.message);
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                showChangePasswordError('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const cpSubmitBtn = document.querySelector('#changePasswordForm button[type="submit"]');
                cpSubmitBtn.textContent = 'ç¡®è®¤ä¿®æ”¹';
                cpSubmitBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç é”™è¯¯
        function showChangePasswordError(message) {
            const errorElement = document.getElementById('cpError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            document.getElementById('cpSuccess').classList.add('hidden');
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥æ’¤å›å®¡æ‰¹
        function canWithdrawApproval(app) {
            // åªæœ‰æ€»ç›‘å¯ä»¥æ’¤å›å®¡æ‰¹ï¼Œä¸”ä»…é™äºå·²é€šè¿‡çš„ç”³è¯·ï¼ˆæ€»ç›‘ç›´æ¥é€šè¿‡ä¸”æœªç»è¿‡ç»ç†å’ŒCEOå®¡æ‰¹çš„ï¼‰ï¼Œåªè¯»è§’è‰²ä¸èƒ½æ’¤å›å®¡æ‰¹
            return (
                currentRole === 'chief' &&
                app.status === 'å·²é€šè¿‡' &&
                app.approvals.chief &&
                app.approvals.chief.status === 'approved' &&
                (!app.approvals.managers || Object.keys(app.approvals.managers).length === 0) &&
                (!app.approvals.ceo || !app.approvals.ceo.status || app.approvals.ceo.status === 'pending')
            );
        }

        // å¤„ç†æ’¤å›å®¡æ‰¹æ“ä½œ
        async function handleWithdrawApproval(id) {
            if (!confirm('ç¡®è®¤æ’¤å›å®¡æ‰¹ï¼Ÿæ’¤å›åå°†é‡æ–°è¿›å…¥æ€»ç›‘å®¡æ‰¹ç¯èŠ‚ã€‚')) {
                return;
            }

            // æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
            const msgElement = document.createElement('div');
            msgElement.id = 'processingMessage';
            msgElement.className = 'fixed top-0 left-0 w-full bg-blue-500 text-white text-center py-2 z-50';
            msgElement.textContent = 'å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...';
            document.body.appendChild(msgElement);

            try {
                const response = await fetch('/withdrawApproval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        username: currentUser,
                        role: currentRole
                    }),
                });

                const result = await response.json();

                // ç§»é™¤å¤„ç†ä¸­æç¤º
                document.body.removeChild(msgElement);

                if (result.success) {
                    alert('å®¡æ‰¹å·²æˆåŠŸæ’¤å›ï¼Œç”³è¯·å°†é‡æ–°è¿›å…¥æ€»ç›‘å®¡æ‰¹ç¯èŠ‚');

                    // æ›´æ–°æœ¬åœ°åº”ç”¨æ•°æ®
                    const appIndex = applications.findIndex(a => a.id === id);
                    if (appIndex !== -1) {
                        applications[appIndex] = result.application;
                    }

                    // é‡æ–°ç”Ÿæˆè¯¦æƒ…å†…å®¹
                    generateDetailContent(result.application, false);

                    // åˆ·æ–°åº”ç”¨åˆ—è¡¨
                    loadApplications();
                } else {
                    alert('æ’¤å›å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ’¤å›å®¡æ‰¹æ—¶å‡ºé”™:', error);
                // ç§»é™¤å¤„ç†ä¸­æç¤º
                document.body.removeChild(msgElement);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
    </script>

    <style>
        /* ç”³è¯·å†…å®¹åˆ—å®½åº¦æ§åˆ¶ */
        table.min-w-full th:nth-child(6),
        table.min-w-full td:nth-child(6) {
            max-width: 200px !important;
            width: 200px !important;
            white-space: normal !important;
            overflow: visible !important;
            word-break: break-word !important;
            table-layout: fixed !important;
            vertical-align: top !important;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
        }

        /* ç¡®ä¿è¡¨æ ¼ä½¿ç”¨å›ºå®šå¸ƒå±€ */
        table.min-w-full {
            table-layout: fixed !important;
        }

        .nav-btn {
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .nav-btn.active {
            background-color: rgba(255,255,255,0.15);
            font-weight: 600;
        }
        .side-nav-btn {
            transition: all 0.2s;
        }
        .side-nav-btn.active-indicator {
            background-color: rgba(255,255,255,0.25);
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        #fileInputArea:hover, #editFileInputArea:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        #detailModal, #editModal, #previewModal, #sideMenu {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        #sideMenu::-webkit-scrollbar {
            width: 6px;
        }

        #sideMenu::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        #sideMenu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        #sideMenu::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* PCç«¯ä¾§è¾¹æ æ ·å¼ */
        #pcSidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 30;
            background: white;
            border-right: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* PCç«¯å¸ƒå±€è°ƒæ•´ - å›ºå®šä¾§è¾¹æ  */
        @media (min-width: 768px) {
            #pcSidebar {
                position: fixed !important;
                left: 1rem !important;
                top: 1rem !important;
                bottom: 1rem !important;
                width: 16rem !important;
                height: auto !important;
                z-index: 30 !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                overflow: hidden !important; /* å®Œå…¨ç¦æ­¢æ»šåŠ¨ */
            }

            /* ç¡®ä¿ä¾§è¾¹æ å†…éƒ¨å…ƒç´ ä¸ä¼šå¯¼è‡´æ»šåŠ¨ */
            #pcSidebar * {
                overflow: visible;
            }

            #pcSidebar .flex-1 {
                overflow: hidden !important;
            }
        }



        /* PCç«¯ä¾§è¾¹æ å¯¼èˆªæŒ‰é’®æ ·å¼ */
        .pc-nav-btn {
            transition: all 0.2s ease;
            font-weight: 500;
            border: none;
            background: transparent;
            text-align: left;
        }

        .pc-nav-btn:hover {
            background-color: #f3f4f6 !important;
        }

        .pc-nav-btn.active-indicator {
            background-color: #dbeafe !important;
            color: #1d4ed8 !important;
            font-weight: 600;
            border-left: 3px solid #2563eb;
        }

        .pc-nav-btn.active-indicator svg {
            color: #2563eb !important;
        }

        /* PCç«¯ä¸»å†…å®¹åŒºåŸŸè°ƒæ•´ - ä¸ºå›ºå®šä¾§è¾¹æ ç•™å‡ºç©ºé—´ */
        @media (min-width: 768px) {
            .flex-1.md\\:overflow-y-auto {
                margin-left: 18rem !important; /* 256px + 16px gap */
                margin-right: 1rem !important;
                margin-top: 1rem !important;
                margin-bottom: 1rem !important;
                height: calc(100vh - 2rem) !important;
                overflow-y: auto !important; /* ç¡®ä¿å†…å®¹åŒºåŸŸå¯ä»¥æ»šåŠ¨ */
                overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨ */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                position: relative;
                z-index: 10;
            }
        }

        /* ç§»åŠ¨ç«¯ä¿æŒåŸæœ‰å¸ƒå±€ */
        @media (max-width: 767px) {
            .flex-1.md\\:overflow-y-auto {
                margin-left: 0;
                width: 100%;
                background: #f9fafb !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            #pcSidebar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                bottom: auto !important;
                height: 100vh !important;
                border-radius: 0 !important;
                width: 16rem !important;
            }
        }



        /* ä¾§è¾¹æ æ ·å¼ - ä»…åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤º */
        #sideMenu {
            top: 0;
            height: 100%;
            z-index: 40;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ ·å¼ */
        nav.bg-blue-600 {
            z-index: 40;
            position: relative;
        }

        /* PCç«¯é¡¶éƒ¨å¯¼èˆªæŒ‰é’®æ ·å¼ */
        @media (min-width: 768px) {
            .nav-btn {
                margin: 0 2px;
            }
            .nav-btn:hover {
                background-color: rgba(255,255,255,0.1);
            }
        }

        /* ç§»åŠ¨ç«¯å¯¼èˆªæŒ‰é’®æ ·å¼ */
        @media (max-width: 767px) {
            .nav-btn {
                margin-bottom: 4px;
            }
        }

        /* ç”³è¯·ä¹¦æ¨¡æ¿æ ·å¼ */
        .application-template {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
            font-family: SimSun, serif;
            height: 100%;
        }

        .application-template.mobile {
            font-size: 14px;
        }

        .application-template.mobile-small {
            font-size: 12px;
        }

        .application-template th, .application-template td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }

        .application-template.mobile th, .application-template.mobile td {
            padding: 6px;
        }

        .application-template.mobile-small th, .application-template.mobile-small td {
            padding: 4px;
        }

        .application-template .title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            padding: 15px;
            height: 10%;
        }

        .application-template.mobile .title {
            font-size: 20px;
            padding: 10px;
        }

        .application-template.mobile-small .title {
            font-size: 18px;
            padding: 8px;
        }

        .application-template .label {
            width: 15%;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }

        .application-template.mobile .label {
            width: 20%;
        }

        .application-template.mobile-small .label {
            width: 25%;
        }

        .application-template .content {
            height: 200px;
            vertical-align: top;
            text-align: left;
            padding: 10px;
        }

        .application-template.mobile .content {
            height: 40%;
            min-height: 180px;
            padding: 8px;
        }

        .application-template.mobile-small .content {
            height: 40%;
            min-height: 160px;
            padding: 6px;
        }

        .application-template .applicant {
            text-align: right;
            padding-right: 50px;
            height: 5%;
        }

        .application-template.mobile .applicant {
            padding-right: 30px;
        }

        .application-template.mobile-small .applicant {
            padding-right: 20px;
        }

        .application-template .approval {
            min-height: 100px;
            vertical-align: top;
            height: 15%;
        }

        .application-template.mobile .approval {
            min-height: 90px;
        }

        .application-template.mobile-small .approval {
            min-height: 80px;
        }

        /* A4çº¸å¼ æ ·å¼ */
        .a4-page {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            padding: 20mm 20mm 10mm 20mm; /* å‡å°åº•éƒ¨å†…è¾¹è·ä»20mmåˆ°10mm */
            box-sizing: border-box;
        }

        /* å®¡æ‰¹å®¹å™¨æ ·å¼ */
        .approval-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .single-approval {
            flex: 1;
            min-width: 150px;
            display: flex;
            flex-direction: column;
        }

        .approval-comment {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .signature-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .signature-image {
            max-width: 120px;
            max-height: 60px;
            margin-bottom: 5px;
            image-rendering: -webkit-optimize-contrast; /* æé«˜å›¾ç‰‡æ¸…æ™°åº¦ */
            image-rendering: crisp-edges;
            object-fit: contain;
        }

        .approval-date {
            font-size: 12px;
            color: #333; /* åŠ æ·±é¢œè‰²æé«˜å¯¹æ¯”åº¦ */
            text-align: center;
            font-weight: 500; /* ç¨å¾®åŠ ç²— */
        }

        .application-template.mobile .approval-date {
            font-size: 11px;
        }

        .application-template.mobile-small .approval-date {
            font-size: 10px;
        }

        .no-signature {
            color: #666; /* åŠ æ·±é¢œè‰²æé«˜å¯¹æ¯”åº¦ */
            font-style: italic;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: 500; /* ç¨å¾®åŠ ç²— */
        }

        .application-template.mobile .no-signature {
            font-size: 11px;
        }

        .application-template.mobile-small .no-signature {
            font-size: 10px;
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body * {
                visibility: hidden;
            }

            #applicationTemplateModal, #applicationTemplateModal * {
                visibility: visible;
            }

            #applicationTemplateModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                overflow: visible;
            }

            .a4-page {
                box-shadow: none;
                margin: 0;
                padding: 20mm;
                width: 210mm;
                height: 297mm;
                overflow: hidden;
                page-break-after: always;
            }

            .application-template {
                page-break-inside: avoid;
                width: 100%;
                height: 100%;
                border-collapse: collapse;
            }

            .print-hint, .template-actions {
                display: none !important;
            }

            /* ç¡®ä¿ç­¾åå›¾ç‰‡åœ¨æ‰“å°æ—¶å¯è§ */
            .signature-image {
                max-width: 120px;
                max-height: 60px;
                display: block !important;
                visibility: visible !important;
            }
        }

        /* å“åº”å¼æ ·å¼ */
        @media (max-width: 768px) {
            #detailModal .relative, #editModal .relative, #previewModal .relative {
                margin: 1rem;
                width: calc(100% - 2rem);
            }

            #detailContent, #editForm {
                max-height: 70vh;
            }

            /* ç§»åŠ¨ç«¯å¯¼èˆªæ é€‚é… */
            nav .container {
                flex-direction: column;
                align-items: stretch;
            }

            nav .flex.items-center.space-x-4 {
                flex-direction: column;
                align-items: stretch;
                margin-top: 0.5rem;
                gap: 0.5rem;
            }

            nav .flex.items-center.space-x-4 > * {
                margin: 0.25rem 0;
            }

            /* ç§»åŠ¨ç«¯è¡¨æ ¼é€‚é… */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                font-size: 0.875rem;
            }

            /* ç”³è¯·è®°å½•å’Œå·²å®¡æ ¸é¡µé¢çš„ç”³è¯·å†…å®¹åˆ—é€‚é… */
            #applicationsList td:nth-child(6),
            #approvedList td:nth-child(6) {
                white-space: normal !important;
                min-width: 150px !important;
                max-width: 150px !important;
                width: 150px !important;
                word-break: break-word !important;
            }

            /* ç¡®ä¿ç”³è¯·å†…å®¹åˆ—çš„æ–‡æœ¬æ­£å¸¸æ˜¾ç¤º */
            #applicationsList td:nth-child(6) .text-sm,
            #approvedList td:nth-child(6) .text-sm {
                display: block !important;
                white-space: normal !important;
                word-break: break-word !important;
                line-height: 1.4 !important;
                max-height: none !important;
            }

            /* ç§»åŠ¨ç«¯ç”³è¯·å†…å®¹åˆ—çš„å®¹å™¨æ ·å¼ */
            #applicationsList td:nth-child(6) .cursor-pointer,
            #approvedList td:nth-child(6) .cursor-pointer {
                display: block !important;
                width: 100% !important;
                padding: 4px 0 !important;
            }

            /* ç§»åŠ¨ç«¯ç”³è¯·è®°å½•å’Œå·²å®¡æ ¸é¡µé¢çš„è¡¨æ ¼å•å…ƒæ ¼å†…è¾¹è·è°ƒæ•´ */
            #applicationsList td,
            #approvedList td {
                padding: 8px 6px !important;
            }

            /* ç§»åŠ¨ç«¯è¡¨å•é€‚é… */
            .space-y-4 > div, .space-y-6 > div {
                margin-bottom: 1rem;
            }

            /* ç§»åŠ¨ç«¯æ–°å»ºç”³è¯·è¡¨å•ä¼˜åŒ– */
            #newSection .flex.space-x-4 {
                flex-direction: column;
                gap: 1rem;
            }

            #newSection .flex.space-x-4 > div {
                width: 100% !important;
            }

            /* ç§»åŠ¨ç«¯è¡¨å•å­—æ®µä¼˜åŒ– */
            #newSection label {
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: #374151;
            }

            #newSection input,
            #newSection select,
            #newSection textarea {
                min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°é«˜åº¦ */
                padding: 0.75rem;
                border-radius: 0.5rem;
                border: 2px solid #e5e7eb;
                transition: border-color 0.2s ease;
            }

            #newSection input:focus,
            #newSection select:focus,
            #newSection textarea:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            /* ç§»åŠ¨ç«¯æ–‡ä»¶ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
            #newSection .border-dashed {
                padding: 1.5rem;
                border-radius: 0.75rem;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border: 2px dashed #cbd5e1;
                text-align: center;
            }

            #newSection .border-dashed:hover {
                border-color: #3b82f6;
                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            }

            #newSection #fileInputArea p {
                font-size: 14px;
                margin: 0.25rem 0;
            }

            /* ç§»åŠ¨ç«¯å‚é•¿é€‰æ‹©åˆ—è¡¨ä¼˜åŒ– */
            #newSection #directorsList {
                max-height: 200px;
                border-radius: 0.5rem;
                border: 2px solid #e5e7eb;
                background-color: #f9fafb;
            }

            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            #newSection button[type="submit"] {
                width: 100%;
                min-height: 48px;
                font-size: 16px;
                font-weight: 600;
                border-radius: 0.75rem;
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                color: white;
                border: none;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                transition: all 0.2s ease;
            }

            #newSection button[type="submit"]:hover {
                background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
                transform: translateY(-1px);
                box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
            }

            #newSection button[type="submit"]:active {
                transform: translateY(0);
            }

            /* ç§»åŠ¨ç«¯æŒ‰é’®é€‚é… */
            button, select, input[type="date"], input[type="text"], input[type="password"], input[type="email"], textarea {
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
            }

            /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†é€‚é… */
            #detailModal .relative, #editModal .relative, #previewModal .relative {
                max-height: 90vh;
                overflow-y: auto;
            }

            /* ç§»åŠ¨ç«¯ç”¨æˆ·ç®¡ç†é¡µé¢é€‚é… */
            #manageUsersSection .grid {
                grid-template-columns: 1fr;
            }

            /* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’®é€‚é… */
            td .space-x-2 {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* ç§»åŠ¨ç«¯æœç´¢æ é€‚é… */
            .mb-4.flex.space-x-4 {
                flex-direction: column;
                gap: 0.5rem;
            }

            .mb-4.flex.space-x-4 > * {
                margin: 0.25rem 0;
                width: 100%;
            }

            /* ç§»åŠ¨ç«¯ç”³è¯·ä¹¦æ¨¡æ¿é€‚é… */
            #applicationTemplateModal .p-4.overflow-auto {
                padding: 0.5rem;
                max-height: 85vh;
            }

            .a4-page {
                width: 100%;
                height: auto;
                padding: 10mm;
                transform-origin: top center;
                transform: scale(0.9);
                margin: 0 auto;
                box-sizing: border-box;
                aspect-ratio: 1 / 1.414; /* A4çº¸å¼ æ¯”ä¾‹ */
            }

            /* ç¡®ä¿è¡¨æ ¼åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½ä¿æŒæ¯”ä¾‹ */
            .application-template {
                width: 100%;
                height: 100%;
                font-size: 14px;
                table-layout: fixed;
            }

            .application-template .title {
                font-size: 20px;
                padding: 10px;
                height: 10%;
            }

            .application-template .content {
                height: 40%;
                min-height: 180px;
            }

            .application-template .approval {
                min-height: 90px;
                height: 15%;
            }

            /* ç¡®ä¿ç­¾åå›¾ç‰‡åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º */
            .signature-image {
                max-width: 100px;
                max-height: 50px;
            }

            /* è°ƒæ•´ä¸‹è½½å’Œå…³é—­æŒ‰é’® */
            .template-actions {
                padding: 0.5rem;
            }

            .template-actions button {
                padding: 0.5rem 1rem;
                font-size: 14px;
            }

            /* ç§»åŠ¨ç«¯æ–°å»ºç”³è¯·è¡¨å•äº¤äº’ä¼˜åŒ– */
            #newSection input[readonly] {
                background-color: #f3f4f6;
                cursor: not-allowed;
                opacity: 0.8;
            }

            /* ç§»åŠ¨ç«¯è¡¨å•éªŒè¯æ ·å¼ */
            #newSection input:invalid {
                border-color: #ef4444;
                box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            }

            #newSection input:valid {
                border-color: #10b981;
            }

            /* ç§»åŠ¨ç«¯æ–‡ä»¶ä¸Šä¼ æ‹–æ‹½ä¼˜åŒ– */
            #newSection .border-dashed.drag-over {
                border-color: #3b82f6;
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                transform: scale(1.02);
            }

            /* ç§»åŠ¨ç«¯å‚é•¿é€‰æ‹©é¡¹ä¼˜åŒ– */
            #newSection #directorsList .director-item {
                padding: 0.75rem;
                margin: 0.25rem 0;
                border-radius: 0.5rem;
                background-color: white;
                border: 1px solid #e5e7eb;
                transition: all 0.2s ease;
            }

            #newSection #directorsList .director-item:hover {
                background-color: #f3f4f6;
                border-color: #3b82f6;
            }

            #newSection #directorsList .director-item.selected {
                background-color: #eff6ff;
                border-color: #3b82f6;
            }

            /* å‡å°‘ç§»åŠ¨ç«¯åŠ¨ç”»æ•ˆæœï¼Œæé«˜æ€§èƒ½ */
            .reduce-animation * {
                transition-duration: 0.1s !important;
                animation-duration: 0.1s !important;
            }

            /* ä¼˜åŒ–ç§»åŠ¨ç«¯æ¸²æŸ“æ€§èƒ½ */
            .mobile-device {
                -webkit-text-size-adjust: 100%;
                -webkit-font-smoothing: antialiased;
            }

            /* ç§»åŠ¨ç«¯æ–°å»ºç”³è¯·è¡¨å•æ€§èƒ½ä¼˜åŒ– */
            .mobile-device #newSection {
                transform: translateZ(0);
                backface-visibility: hidden;
            }

            .mobile-device #newSection input,
            .mobile-device #newSection select,
            .mobile-device #newSection textarea {
                will-change: border-color, box-shadow;
            }

            /* ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ */
            .mobile-device .a4-page,
            .mobile-device #applicationTemplateModal,
            .mobile-device #detailModal,
            .mobile-device #editModal,
            .mobile-device #previewModal {
                transform: translateZ(0);
                backface-visibility: hidden;
                perspective: 1000px;
            }

            /* ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨æ€§èƒ½ */
            .mobile-device .overflow-auto,
            .mobile-device .overflow-y-auto,
            .mobile-device .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: auto;
            }

            /* ç§»åŠ¨ç«¯PDFé¢„è§ˆæ ·å¼ */
            #mobilePdfPreview {
                display: flex;
                flex-direction: column;
            }

            #pdfNavigation {
                flex-shrink: 0;
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                border-bottom: 2px solid #d1d5db;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            #pageInfo {
                font-weight: 600;
                color: #374151;
                background-color: rgba(255, 255, 255, 0.8);
                padding: 0.25rem 0.75rem;
                border-radius: 1rem;
                border: 1px solid #d1d5db;
            }

            #pdfContainer {
                flex: 1;
                background: #f9fafb;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                touch-action: pan-y pinch-zoom;
                position: relative;
            }

            #pdfCanvas {
                display: block;
                margin: 0 auto;
                max-width: 100%;
                height: auto;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                background: white;
                touch-action: pan-y pinch-zoom;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
                image-rendering: pixelated;
            }

            /* æ»‘åŠ¨æç¤ºæ ·å¼ */
            #swipeHint {
                z-index: 20;
                pointer-events: none;
                user-select: none;
            }

            #pdfLoadingIndicator {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(4px);
            }

            #pdfLoadingIndicator .animate-spin {
                border-color: #3b82f6;
                border-top-color: transparent;
            }
        }

        /* æ·»åŠ åª’ä½“æŸ¥è¯¢ï¼Œé’ˆå¯¹ç‰¹å°å±å¹•è®¾å¤‡ */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            /* ç§»åŠ¨ç«¯æ–°å»ºç”³è¯·é¡µé¢å®¹å™¨ä¼˜åŒ– */
            #newSection {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 0.75rem;
            }

            #newSection h2 {
                font-size: 1.25rem;
                margin-bottom: 1.5rem;
                text-align: center;
                color: #1f2937;
            }

            /* ç§»åŠ¨ç«¯è¡¨å•åˆ†ç»„ä¼˜åŒ– */
            #newSection .space-y-4 {
                gap: 1.5rem;
            }

            /* ç§»åŠ¨ç«¯æ–‡ä»¶åˆ—è¡¨ä¼˜åŒ– */
            #newSection #fileList .flex {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
                background-color: #f3f4f6;
                border-radius: 0.5rem;
                margin-bottom: 0.5rem;
            }

            #newSection #fileList button {
                align-self: flex-end;
                padding: 0.25rem 0.5rem;
                font-size: 12px;
                min-height: 32px;
            }

            h2 {
                font-size: 1.25rem;
            }

            /* æå°å±å¹•è¡¨æ ¼é€‚é… */
            th, td {
                padding: 0.5rem 0.25rem;
            }

            /* è°ƒæ•´è¡¨æ ¼å†…å®¹æ˜¾ç¤º - ä¸éšè—ç”¨æˆ·ç®¡ç†é¡µé¢çš„è¡¨æ ¼åˆ— */
            #historySection td:nth-child(3), #historySection th:nth-child(3),
            #historySection td:nth-child(4), #historySection th:nth-child(4),
            #pendingApprovalSection td:nth-child(3), #pendingApprovalSection th:nth-child(3),
            #pendingApprovalSection td:nth-child(4), #pendingApprovalSection th:nth-child(4),
            #approvedSection td:nth-child(3), #approvedSection th:nth-child(3),
            #approvedSection td:nth-child(4), #approvedSection th:nth-child(4) {
                display: none;
            }

            /* ç”¨æˆ·ç®¡ç†é¡µé¢çš„è¡¨æ ¼é€‚é… */
            #manageUsersSection .overflow-x-auto {
                position: relative;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 1rem;
            }

            /* å¢å¼ºæ»‘åŠ¨æç¤ºçš„å¯è§æ€§ */
            .table-scroll-hint {
                background-color: rgba(255, 255, 255, 0.8);
                padding: 0.25rem;
                margin-bottom: 0.5rem;
                border-radius: 0.25rem;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            /* æ·»åŠ æ»‘åŠ¨æŒ‡ç¤ºå™¨ */
            .table-scroll-indicator {
                position: absolute;
                bottom: 0.5rem;
                right: 0.5rem;
                background-color: rgba(59, 130, 246, 0.7);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 1rem;
                font-size: 0.75rem;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
                z-index: 10;
            }

            /* å½“è¡¨æ ¼å¯ä»¥æ»šåŠ¨æ—¶æ˜¾ç¤ºæŒ‡ç¤ºå™¨ */
            .overflow-x-auto:hover .table-scroll-indicator,
            .overflow-x-auto:active .table-scroll-indicator {
                opacity: 1;
            }

            /* ç§»åŠ¨ç«¯å¾…å®¡æ ¸å¡ç‰‡æ ·å¼ */
            #pendingApprovalTable {
                display: none;
            }

            #pendingApprovalCards {
                display: block !important;
            }

            .pending-card {
                border-radius: 0.5rem;
                overflow: hidden;
            }

            .pending-card-header {
                background-color: #f3f4f6;
                padding: 0.75rem;
                border-bottom: 1px solid #e5e7eb;
            }

            .pending-card-body {
                padding: 1rem;
            }

            .pending-card-footer {
                padding: 0.75rem;
                border-top: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
            }

            .pending-card-item {
                margin-bottom: 0.75rem;
                display: flex;
                flex-direction: column;
            }

            .pending-card-label {
                font-size: 0.75rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
            }

            .pending-card-value {
                font-size: 0.875rem;
                font-weight: 500;
            }

            .pending-card-content {
                background-color: #f9fafb;
                padding: 0.75rem;
                border-radius: 0.25rem;
                margin: 0.5rem 0;
                max-height: 120px;
                overflow-y: auto;
                font-size: 0.9rem;
                line-height: 1.4;
                color: #374151;
                border-left: 3px solid #e5e7eb;
                transition: all 0.2s ease;
            }

            .pending-card-content:hover {
                background-color: #f3f4f6;
                border-left-color: #3b82f6;
            }

            /* ç§»åŠ¨ç«¯é™„ä»¶é¢„è§ˆä¼˜åŒ– */
            .flex.items-center.justify-between.bg-gray-50.p-2.rounded,
            .flex.items-center.justify-between.bg-gray-100.p-2.rounded,
            .flex.items-center.justify-between.p-2.bg-gray-50.rounded-md {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* æ–‡ä»¶åæ˜¾ç¤ºä¼˜åŒ– */
            .flex.items-center.justify-between.bg-gray-50.p-2.rounded span,
            .flex.items-center.justify-between.bg-gray-100.p-2.rounded span,
            .flex.items-center.justify-between.p-2.bg-gray-50.rounded-md span {
                word-break: break-all;
                white-space: normal;
                width: 100%;
                display: block;
                padding-right: 0.5rem;
            }

            /* é™„ä»¶æ“ä½œæŒ‰é’®ä¼˜åŒ– */
            .flex.items-center.justify-between.bg-gray-50.p-2.rounded .flex.space-x-2,
            .flex.items-center.justify-between.bg-gray-100.p-2.rounded .flex.space-x-2 {
                width: 100%;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }

            /* è¯¦æƒ…æ¨¡æ€æ¡†å†…å®¹ä¼˜åŒ– */
            #detailContent .space-y-2 {
                margin-bottom: 1rem;
            }

            /* é™„ä»¶åˆ—è¡¨é¡¹é—´è· */
            .ml-4.space-y-2 > div {
                margin-bottom: 0.75rem;
            }

            /* ç§»åŠ¨ç«¯ç”³è¯·ä¹¦æ¨¡æ¿é€‚é…ï¼ˆç‰¹å°å±å¹•ï¼‰ */
            .a4-page {
                transform: scale(0.7);
                padding: 8mm;
                aspect-ratio: 1 / 1.414; /* ä¿æŒA4çº¸å¼ æ¯”ä¾‹ */
            }

            .application-template {
                font-size: 12px;
            }

            .application-template .title {
                font-size: 18px;
                padding: 8px;
            }

            .application-template .content {
                height: 40%;
                min-height: 160px;
            }

            .application-template .approval {
                min-height: 80px;
                height: 15%;
            }

            .signature-image {
                max-width: 80px;
                max-height: 40px;
            }

            /* ç¡®ä¿æ¨¡æ€æ¡†åœ¨å°å±å¹•ä¸Šæ­£ç¡®æ˜¾ç¤º */
            #applicationTemplateModal .p-4.border-b h2 {
                font-size: 1.2rem;
            }

            /* è°ƒæ•´ä¸‹è½½å’Œå…³é—­æŒ‰é’® */
            .template-actions button {
                padding: 0.4rem 0.8rem;
                font-size: 12px;
            }
        }

        .signature-image {
            max-width: 120px;
            max-height: 60px;
            margin-bottom: 5px;
        }

        .application-template.mobile .signature-image {
            max-width: 100px;
            max-height: 50px;
        }

        .application-template.mobile-small .signature-image {
            max-width: 80px;
            max-height: 40px;
        }

        .approval-date {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .application-template.mobile .approval-date {
            font-size: 11px;
        }

        .application-template.mobile-small .approval-date {
            font-size: 10px;
        }

        .no-signature {
            color: #999;
            font-style: italic;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .application-template.mobile .no-signature {
            font-size: 11px;
        }

        .application-template.mobile-small .no-signature {
            font-size: 10px;
        }

        /* ç”³è¯·ä¹¦æ¨¡æ¿æ ·å¼ä¼˜åŒ– */
        .application-template {
            width: 100%;
            font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            border-collapse: collapse;
            border: 1px solid #000;
        }

        .application-template th,
        .application-template td {
            border: 1px solid #000;
            padding: 8px;
        }

        .application-template .title {
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
        }

        .application-template .label {
            font-weight: bold;
            text-align: center;
            background-color: #f5f5f5;
        }

        .application-template .content {
            line-height: 1.5;
            text-align: justify;
            padding: 10px;
            vertical-align: top;
        }

        .application-template .applicant {
            text-align: right;
            padding-right: 20px;
            font-weight: normal;
        }

        .application-template .approval-comment {
            margin-bottom: 8px;
            font-weight: 400;
        }

        /* æ‰“å°ä¼˜åŒ– */
        @media print {
            .application-template {
                font-size: 12pt;
                border: 1pt solid #000;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                text-rendering: optimizeLegibility;
                -webkit-font-smoothing: antialiased;
            }

            .application-template th,
            .application-template td {
                border: 1pt solid #000;
                padding: 8pt;
            }

            .application-template .title {
                font-size: 18pt;
                font-weight: bold;
                padding: 10pt;
            }

            .application-template .content {
                font-size: 12pt;
                line-height: 1.5;
            }

            .application-template .label {
                font-weight: bold;
                background-color: #f8f8f8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .signature-image {
                max-width: 120px;
                max-height: 60px;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .signature-image {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>

    <!-- æ·»åŠ è§†å£å…ƒæ ‡è®°ä»¥ç¡®ä¿æ­£ç¡®ç¼©æ”¾ -->
    <script>
        // æ£€æµ‹ç§»åŠ¨è®¾å¤‡å¹¶è°ƒæ•´å¸ƒå±€
        function checkMobileDevice() {
            // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤æ£€æµ‹
            if (window.isMobileChecked) return;
            window.isMobileChecked = true;

            // ä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹å¼æ£€æµ‹ç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                document.body.classList.add('mobile-device');

                // å»¶è¿Ÿå¤„ç†éå…³é”®UIå…ƒç´ 
                setTimeout(() => {
                    // ä¸ºè¡¨æ ¼æ·»åŠ æ¨ªå‘æ»šåŠ¨æç¤º
                    const tables = document.querySelectorAll('.overflow-x-auto');
                    tables.forEach(tableContainer => {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æç¤º
                        if (!tableContainer.querySelector('.table-scroll-hint')) {
                            const tableWrapper = document.createElement('div');
                            tableWrapper.className = 'table-scroll-hint';
                            tableWrapper.innerHTML = '<p class="text-xs text-gray-500 text-center mb-2">â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š â†’</p>';
                            tableContainer.insertBefore(tableWrapper, tableContainer.firstChild);

                            // æ·»åŠ æ»šåŠ¨æŒ‡ç¤ºå™¨
                            const scrollIndicator = document.createElement('div');
                            scrollIndicator.className = 'table-scroll-indicator';
                            scrollIndicator.textContent = 'æ»‘åŠ¨æŸ¥çœ‹';
                            tableContainer.appendChild(scrollIndicator);

                            // ä½¿ç”¨è¢«åŠ¨äº‹ä»¶ç›‘å¬å™¨æé«˜æ»šåŠ¨æ€§èƒ½
                            tableContainer.addEventListener('scroll', function() {
                                const maxScroll = tableContainer.scrollWidth - tableContainer.clientWidth;
                                if (maxScroll > 10) {
                                    scrollIndicator.style.opacity = '1';
                                    if (tableContainer.scrollLeft >= maxScroll - 5) {
                                        scrollIndicator.style.opacity = '0';
                                    }
                                } else {
                                    scrollIndicator.style.opacity = '0';
                                }
                            }, { passive: true });
                        }
                    });

                    // ä¼˜åŒ–ç§»åŠ¨ç«¯å›¾ç‰‡åŠ è½½
                    document.querySelectorAll('img').forEach(img => {
                        if (!img.hasAttribute('loading')) {
                            img.setAttribute('loading', 'lazy');
                        }

                        // å¯¹äºç­¾åå›¾ç‰‡è¿›è¡Œä¼˜åŒ–
                        if (img.classList.contains('signature-image') && img.src) {
                            optimizeImage(img);
                        }
                    });

                    // å‡å°‘ç§»åŠ¨ç«¯åŠ¨ç”»æ•ˆæœ
                    document.body.classList.add('reduce-animation');
                }, 100);
            }
        }

        // ä¼šè¯ç›‘æ§å˜é‡
        let sessionTimer = null;
        let warningTimer = null;
        const SESSION_TIMEOUT = 10 * 60 * 1000; // 10åˆ†é’Ÿï¼Œå•ä½æ¯«ç§’
        const WARNING_BEFORE_TIMEOUT = 1 * 60 * 1000; // åœ¨è¶…æ—¶å‰1åˆ†é’Ÿæ˜¾ç¤ºè­¦å‘Š

        // åˆ›å»ºä¼šè¯è¶…æ—¶è­¦å‘Šæ¨¡æ€æ¡†
        function createSessionTimeoutWarning() {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (document.getElementById('sessionTimeoutWarning')) {
                return;
            }

            // åˆ›å»ºè­¦å‘Šæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'sessionTimeoutWarning';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                    <div class="flex justify-center mb-4">
                        <div class="h-12 w-12 bg-red-600 rounded-full flex items-center justify-center shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold mb-4 text-center">ä¼šè¯å³å°†è¶…æ—¶</h2>
                    <p class="text-center mb-6">ç”±äºé•¿æ—¶é—´æ— æ´»åŠ¨ï¼Œæ‚¨çš„ä¼šè¯å°†åœ¨<span id="timeoutCountdown">60</span>ç§’åè‡ªåŠ¨é€€å‡ºã€‚</p>
                    <div class="flex space-x-4 justify-center">
                        <button id="continueSession" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">ç»§ç»­æ“ä½œ</button>
                        <button id="logoutNow" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">ç«‹å³é€€å‡º</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°æ–‡æ¡£
            document.body.appendChild(modal);

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('continueSession').addEventListener('click', function() {
                hideSessionWarning();
                updateUserActivity();
            });

            document.getElementById('logoutNow').addEventListener('click', function() {
                hideSessionWarning();
                logout();
            });
        }

        // æ˜¾ç¤ºä¼šè¯è¶…æ—¶è­¦å‘Š
        function showSessionWarning() {
            createSessionTimeoutWarning();
            const modal = document.getElementById('sessionTimeoutWarning');
            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');

            // å¯åŠ¨å€’è®¡æ—¶
            let countdown = 60; // 60ç§’å€’è®¡æ—¶
            const countdownElement = document.getElementById('timeoutCountdown');
            countdownElement.textContent = countdown;

            const countdownInterval = setInterval(function() {
                countdown--;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    return;
                }
                countdownElement.textContent = countdown;
            }, 1000);
        }

        // éšè—ä¼šè¯è¶…æ—¶è­¦å‘Š
        function hideSessionWarning() {
            const modal = document.getElementById('sessionTimeoutWarning');
            if (modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
        }

        // å¯åŠ¨ä¼šè¯ç›‘æ§
        function startSessionMonitoring() {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }

            if (warningTimer) {
                clearTimeout(warningTimer);
            }

            // è®¾ç½®è­¦å‘Šè®¡æ—¶å™¨
            warningTimer = setTimeout(function() {
                showSessionWarning();
            }, SESSION_TIMEOUT - WARNING_BEFORE_TIMEOUT);

            // è®¾ç½®ä¼šè¯è¶…æ—¶è®¡æ—¶å™¨
            sessionTimer = setTimeout(function() {
                hideSessionWarning();
                logout();
            }, SESSION_TIMEOUT);

            // æ·»åŠ ç”¨æˆ·æ´»åŠ¨ç›‘å¬å™¨ï¼ˆå¦‚æœå°šæœªæ·»åŠ ï¼‰
            if (!window.sessionMonitoringActive) {
                // ç›‘å¬ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
                const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click', 'keydown'];

                activityEvents.forEach(function(eventName) {
                    document.addEventListener(eventName, updateUserActivity, true);
                });

                window.sessionMonitoringActive = true;
            }
        }

        // æ›´æ–°ç”¨æˆ·æ´»åŠ¨æ—¶é—´
        function updateUserActivity() {
            if (sessionStorage.getItem('isLoggedIn') !== 'true') {
                return; // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œä¸æ›´æ–°æ´»åŠ¨æ—¶é—´
            }

            // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
            const currentTime = Date.now();
            sessionStorage.setItem('lastActivity', currentTime.toString());

            // éšè—è­¦å‘Šï¼ˆå¦‚æœæ˜¾ç¤ºï¼‰
            hideSessionWarning();

            // é‡ç½®è®¡æ—¶å™¨
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }

            if (warningTimer) {
                clearTimeout(warningTimer);
            }

            // è®¾ç½®æ–°çš„è­¦å‘Šè®¡æ—¶å™¨
            warningTimer = setTimeout(function() {
                showSessionWarning();
            }, SESSION_TIMEOUT - WARNING_BEFORE_TIMEOUT);

            // è®¾ç½®æ–°çš„ä¼šè¯è¶…æ—¶è®¡æ—¶å™¨
            sessionTimer = setTimeout(function() {
                hideSessionWarning();
                logout();
            }, SESSION_TIMEOUT);
        }

        // åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ä¼šè¯çŠ¶æ€
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';

            if (isLoggedIn) {
                // æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è¿‡æœŸï¼ˆ10åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰
                const lastActivity = parseInt(sessionStorage.getItem('lastActivity') || '0');
                const currentTime = Date.now();
                const inactiveTime = currentTime - lastActivity;
                const maxInactiveTime = 10 * 60 * 1000; // 10åˆ†é’Ÿï¼Œå•ä½æ¯«ç§’

                if (inactiveTime > maxInactiveTime) {
                    // ä¼šè¯å·²è¿‡æœŸï¼Œæ‰§è¡Œç™»å‡ºæ“ä½œ
                    logout();
                    return;
                }

                // ä¼šè¯æœ‰æ•ˆï¼Œæ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
                sessionStorage.setItem('lastActivity', currentTime.toString());

                // å¯åŠ¨ä¼šè¯ç›‘æ§
                startSessionMonitoring();

                // ä»sessionStorageè·å–ç”¨æˆ·ä¿¡æ¯
                currentUser = sessionStorage.getItem('username');
                currentRole = sessionStorage.getItem('role');
                currentDepartment = sessionStorage.getItem('department');
                currentUserCanSubmitApplication = sessionStorage.getItem('canSubmitApplication') === 'true';

                // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢ä½†ä¸å¤„ç†é¡µé¢å¯¼èˆªï¼ˆé¡µé¢å¯¼èˆªåœ¨ä¸‹é¢å•ç‹¬å¤„ç†ï¼‰
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // åœ¨ç§»åŠ¨ç«¯é»˜è®¤éšè—ä¾§è¾¹æ ï¼ŒPCç«¯ä¸éœ€è¦æ˜¾ç¤ºä¾§è¾¹æ 
                const sideMenu = document.getElementById('sideMenu');
                if (window.innerWidth < 768) {
                    sideMenu.classList.add('-translate-x-full');
                    document.getElementById('menuOverlay').classList.add('hidden');
                }

                // ç¡®ä¿PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ­£ç¡®æ˜¾ç¤º
                if (window.innerWidth >= 768) {
                    const topNavMenu = document.querySelector('.hidden.md\\:block');
                    if (topNavMenu) {
                        topNavMenu.classList.remove('hidden');
                        topNavMenu.style.display = 'flex';
                    }
                }

                // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
                initFileUpload();

                // è®¾ç½®ç”³è¯·æ—¥æœŸé»˜è®¤ä¸ºå½“å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('applyDate').value = today;

                // è®¾ç½®ç”³è¯·äººå§“åä¸ºå½“å‰ç”¨æˆ·
                document.getElementById('applicant').value = currentUser;

                // è®¾ç½®ç”³è¯·éƒ¨é—¨ä¸ºå½“å‰ç”¨æˆ·çš„éƒ¨é—¨
                if (currentDepartment) {
                    const departmentInput = document.getElementById('department');
                    if (departmentInput) {
                        departmentInput.value = currentDepartment;
                    }
                }

                updateUserDisplay();
                updateNavButtons();

                // ä¼˜åŒ–å¯åŠ¨ - ä¸é¢„åŠ è½½åº”ç”¨æ•°æ®å’Œç­¾åæ•°æ®ï¼Œè®©é¡µé¢åˆ‡æ¢æ—¶æŒ‰éœ€åŠ è½½
                // åˆå§‹åŒ–ç­¾åç¼“å­˜ç³»ç»Ÿ
                initSignatureCache();

                loadApprovers();

                // ç®¡ç†å‘˜éœ€è¦åŠ è½½ç”¨æˆ·ç®¡ç†æ•°æ®
                if (currentRole === 'admin') {
                    loadUsers();
                }
                // ç§»é™¤ç­¾åé¢„åŠ è½½ï¼Œæ”¹ä¸ºæŒ‰éœ€åŠ è½½

                // å¯åŠ¨å®šæœŸåˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨çš„å®šæ—¶å™¨(ä»…å¯¹å®¡æ ¸äººå‘˜)
                if (['director', 'chief', 'manager', 'ceo'].includes(currentRole)) {
                    startPendingApprovalAutoRefresh();
                }

                // æ ¹æ®ç”¨æˆ·è§’è‰²å’ŒsessionStorageä¸­ä¿å­˜çš„sectionæ˜¾ç¤ºæ­£ç¡®çš„å†…å®¹
                // æ³¨æ„ï¼šåªä½¿ç”¨sessionStorageï¼Œç¡®ä¿æµè§ˆå™¨å…³é—­åé¡µé¢çŠ¶æ€è¢«æ¸…é™¤
                let savedSection = sessionStorage.getItem('currentSection');

                // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡ç™»å½•ï¼ˆæ²¡æœ‰ä¿å­˜çš„é¡µé¢ä¿¡æ¯ï¼‰
                // æµè§ˆå™¨å…³é—­åé‡æ–°æ‰“å¼€æ—¶ï¼ŒsessionStorageè¢«æ¸…é™¤ï¼Œè§†ä¸ºé¦–æ¬¡ç™»å½•
                const isFirstLogin = !savedSection;

                // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®é»˜è®¤é¦–é¡µï¼ˆä»…åœ¨é¦–æ¬¡ç™»å½•æ—¶ä½¿ç”¨ï¼‰
                let defaultSection;
                if (currentRole === 'admin') {
                    // ç®¡ç†å‘˜é»˜è®¤æ˜¾ç¤ºç”¨æˆ·ç®¡ç†é¡µé¢
                    defaultSection = 'manageUsers';
                } else if (['director', 'chief', 'manager', 'ceo'].includes(currentRole)) {
                    // æ‰€æœ‰å®¡æ‰¹äººé»˜è®¤æ˜¾ç¤ºå¾…å®¡æ ¸é¡µé¢
                    defaultSection = 'pendingApproval';
                } else {
                    // æ™®é€šç”¨æˆ·é»˜è®¤æ˜¾ç¤ºç”³è¯·è®°å½•é¡µé¢
                    defaultSection = 'history';
                }

                // å¦‚æœæ˜¯é¦–æ¬¡ç™»å½•æˆ–æ²¡æœ‰ä¿å­˜çš„é¡µé¢ï¼Œä½¿ç”¨é»˜è®¤é¡µé¢ï¼›å¦åˆ™ä¿æŒå½“å‰é¡µé¢
                const targetSection = isFirstLogin ? defaultSection : savedSection;

                // åªä¿å­˜åˆ°sessionStorageï¼Œç¡®ä¿æµè§ˆå™¨å…³é—­åé¡µé¢çŠ¶æ€è¢«æ¸…é™¤
                sessionStorage.setItem('currentSection', targetSection);

                showSection(targetSection);


            } else {
                showLoginForm();
            }

            // æ·»åŠ è§’è‰²å˜æ›´äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('newUserRole').addEventListener('change', toggleNewUserDepartment);

            // æ·»åŠ åˆ†é¡µæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('prevPageBtn').addEventListener('click', function() {
                if (currentUserPage > 1) {
                    currentUserPage--;
                    renderUsersList();
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', function() {
                const totalPages = Math.ceil(allUsers.length / usersPerPage);
                if (currentUserPage < totalPages) {
                    currentUserPage++;
                    renderUsersList();
                }
            });

            // æ·»åŠ ç”¨æˆ·æœç´¢æ¡†å›è½¦é”®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('userSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchUsers();
                }
            });

            // æ·»åŠ æœç´¢æ¡†å›è½¦é”®è§¦å‘æœç´¢
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchApplications();
                }
            });

            // æ·»åŠ å·²å®¡æ ¸é¡µé¢æœç´¢æ¡†å›è½¦é”®è§¦å‘æœç´¢
            document.getElementById('approvedSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchApprovedApplications();
                }
            });

            // å¤„ç†æœç´¢æ¡†æ¸…é™¤æŒ‰é’®
            function setupSearchClearButton(inputId, buttonId) {
                const input = document.getElementById(inputId);
                const clearButton = document.getElementById(buttonId);

                if (!input || !clearButton) return;

                // è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
                input.addEventListener('input', function() {
                    if (this.value) {
                        clearButton.classList.remove('hidden');
                    } else {
                        clearButton.classList.add('hidden');

                        // å½“è¾“å…¥æ¡†è¢«æ¸…ç©ºæ—¶ï¼ˆä¾‹å¦‚ç”¨æˆ·æŒ‰ä¸‹Backspaceæˆ–Deleteé”®åˆ é™¤æ‰€æœ‰å†…å®¹ï¼‰
                        // æ ¹æ®è¾“å…¥æ¡†IDåˆ¤æ–­æ˜¯å“ªä¸ªæœç´¢æ¡†ï¼Œå¹¶è§¦å‘ç›¸åº”çš„æœç´¢é‡ç½®
                        if (inputId === 'searchInput') {
                            updateHistoryList(); // é‡ç½®ç”³è¯·è®°å½•é¡µé¢çš„æœç´¢ç»“æœ
                        } else if (inputId === 'approvedSearchInput') {
                            updateApprovedList(); // é‡ç½®å·²å®¡æ ¸é¡µé¢çš„æœç´¢ç»“æœ
                        }
                    }
                });

                // ç‚¹å‡»æ¸…é™¤æŒ‰é’®æ—¶æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®æœç´¢ç»“æœ
                clearButton.addEventListener('click', function() {
                    input.value = '';
                    clearButton.classList.add('hidden');

                    // æ ¹æ®è¾“å…¥æ¡†IDåˆ¤æ–­æ˜¯å“ªä¸ªæœç´¢æ¡†ï¼Œå¹¶è§¦å‘ç›¸åº”çš„æœç´¢é‡ç½®
                    if (inputId === 'searchInput') {
                        updateHistoryList(); // é‡ç½®ç”³è¯·è®°å½•é¡µé¢çš„æœç´¢ç»“æœ
                    } else if (inputId === 'approvedSearchInput') {
                        updateApprovedList(); // é‡ç½®å·²å®¡æ ¸é¡µé¢çš„æœç´¢ç»“æœ
                    }

                    input.focus(); // ä¿æŒç„¦ç‚¹åœ¨è¾“å…¥æ¡†
                });

                // åˆå§‹æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦æœ‰å†…å®¹
                if (input.value) {
                    clearButton.classList.remove('hidden');
                }
            }

            // è®¾ç½®ç”³è¯·è®°å½•é¡µé¢çš„æœç´¢æ¡†æ¸…é™¤æŒ‰é’®
            setupSearchClearButton('searchInput', 'clearSearchInput');

            // è®¾ç½®å·²å®¡æ ¸é¡µé¢çš„æœç´¢æ¡†æ¸…é™¤æŒ‰é’®
            setupSearchClearButton('approvedSearchInput', 'clearApprovedSearchInput');

            // é”®ç›˜å¿«æ·é”®æ”¯æŒå·²ç§»é™¤ï¼Œæ¢å¤æµè§ˆå™¨é»˜è®¤åˆ·æ–°è¡Œä¸º
            // ç”¨æˆ·ç°åœ¨å¯ä»¥ä½¿ç”¨ Ctrl+R æˆ– F5 è¿›è¡Œæ­£å¸¸çš„æµè§ˆå™¨é¡µé¢åˆ·æ–°

            // æ£€æµ‹ç§»åŠ¨è®¾å¤‡å¹¶è°ƒæ•´å¸ƒå±€
            checkMobileDevice();

            // æ·»åŠ èœå•åˆ‡æ¢äº‹ä»¶ç›‘å¬
            document.getElementById('menuToggleBtn').addEventListener('click', toggleMenu);
            document.getElementById('closeMenuBtn').addEventListener('click', toggleMenu);

            // æ·»åŠ å¡ç‰‡å¯¼èˆªæŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('prevCardBtn').addEventListener('click', showPrevCard);
            document.getElementById('nextCardBtn').addEventListener('click', showNextCard);

            // æ·»åŠ çª—å£å¤§å°æ”¹å˜äº‹ä»¶ç›‘å¬å™¨
            window.addEventListener('resize', function() {
                const sideMenu = document.getElementById('sideMenu');

                if (window.innerWidth >= 768) {
                    // PCç«¯éšè—ä¾§è¾¹æ 
                    sideMenu.classList.add('-translate-x-full');
                    document.body.classList.remove('overflow-hidden');
                    document.getElementById('menuOverlay').classList.add('hidden');

                    // ç¡®ä¿PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ­£ç¡®æ˜¾ç¤º
                    const topNavMenu = document.querySelector('.hidden.md\\:block');
                    if (topNavMenu) {
                        topNavMenu.classList.remove('hidden');
                        topNavMenu.style.display = 'block';
                    }

                    // ç¡®ä¿PCç«¯ç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’®æ­£ç¡®æ˜¾ç¤º
                    const userInfoSection = document.querySelector('.hidden.md\\:flex');
                    if (userInfoSection) {
                        userInfoSection.classList.remove('hidden');
                        userInfoSection.style.display = 'flex';
                    }
                } else {
                    // ç§»åŠ¨ç«¯é»˜è®¤éšè—ä¾§è¾¹æ 
                    sideMenu.classList.add('-translate-x-full');
                    document.getElementById('menuOverlay').classList.add('hidden');
                }
            });

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤åˆ°å¾…å®¡æ ¸éƒ¨åˆ†ï¼ˆç”¨äºå®¡æ‰¹ååˆ·æ–°é¡µé¢ï¼‰
            // æ³¨æ„ï¼šè¿™ä¸ªé€»è¾‘åªåœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰§è¡Œï¼Œä¸ä¼šå½±å“æ­£å¸¸çš„é¡µé¢å¯¼èˆªé€»è¾‘
            // ä½¿ç”¨sessionStorageç¡®ä¿æµè§ˆå™¨å…³é—­åæ ‡è®°è¢«æ¸…é™¤
            const lastActiveSection = sessionStorage.getItem('lastActiveSection');
            if (lastActiveSection === 'å¾…å®¡æ ¸') {
                // æ¸…é™¤æ ‡è®°ï¼Œé˜²æ­¢ä¸‹æ¬¡åŠ è½½æ—¶å†æ¬¡è·³è½¬
                sessionStorage.removeItem('lastActiveSection');
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å·²å®Œå…¨åŠ è½½
                setTimeout(() => {
                    showSection('pendingApproval');
                    // æ›´æ–°å­˜å‚¨çŠ¶æ€
                    sessionStorage.setItem('currentSection', 'pendingApproval');
                }, 100);
            }

            // åˆå§‹åŒ–ä¿®æ”¹å¯†ç ç›¸å…³äº‹ä»¶ç›‘å¬ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
            const changePasswordBtnMain = document.getElementById('changePasswordBtn');
            const cancelChangePasswordMain = document.getElementById('cancelChangePassword');
            const changePasswordFormMain = document.getElementById('changePasswordForm');

            if (changePasswordBtnMain && !changePasswordBtnMain.hasAttribute('data-listener-added')) {
                changePasswordBtnMain.addEventListener('click', showChangePasswordModal);
                changePasswordBtnMain.setAttribute('data-listener-added', 'true');
            }

            if (cancelChangePasswordMain && !cancelChangePasswordMain.hasAttribute('data-listener-added')) {
                cancelChangePasswordMain.addEventListener('click', hideChangePasswordModal);
                cancelChangePasswordMain.setAttribute('data-listener-added', 'true');
            }

            if (changePasswordFormMain && !changePasswordFormMain.hasAttribute('data-listener-added')) {
                changePasswordFormMain.addEventListener('submit', handleChangePassword);
                changePasswordFormMain.setAttribute('data-listener-added', 'true');
            }

            // åˆå§‹åŒ–å¯¼å‡ºæ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
            initializeExportDateRange();
        });

        // åˆå§‹åŒ–å¯¼å‡ºæ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
        function initializeExportDateRange() {
            const toggleBtn = document.getElementById('toggleExportDateRange');
            const container = document.getElementById('exportDateRangeContainer');
            const startDateInput = document.getElementById('exportStartDate');
            const endDateInput = document.getElementById('exportEndDate');

            // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆå½“æœˆï¼‰
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];

            // åˆ‡æ¢æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨çš„æ˜¾ç¤º/éšè—
            toggleBtn.addEventListener('click', function() {
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    toggleBtn.classList.add('bg-blue-800');
                    toggleBtn.setAttribute('title', 'éšè—æ—¥æœŸç­›é€‰');
                } else {
                    container.classList.add('hidden');
                    toggleBtn.classList.remove('bg-blue-800');
                    toggleBtn.setAttribute('title', 'æ˜¾ç¤ºæ—¥æœŸç­›é€‰');
                }
            });
        }
    </script>

    <!-- ä¿®å¤PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ˜¾ç¤ºé—®é¢˜çš„å†…è”è„šæœ¬ -->
    <script>
        // åœ¨é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
        window.addEventListener('load', function() {
            // ç¡®ä¿PCç«¯é¡¶éƒ¨å¯¼èˆªèœå•æ­£ç¡®æ˜¾ç¤º
            if (window.innerWidth >= 768) {
                const topNavMenu = document.querySelector('.hidden.md\\:block');
                if (topNavMenu) {
                    topNavMenu.classList.remove('hidden');
                    topNavMenu.style.display = 'block';
                }

                // ç¡®ä¿PCç«¯ç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’®æ­£ç¡®æ˜¾ç¤º
                const userInfoSection = document.querySelector('.hidden.md\\:flex');
                if (userInfoSection) {
                    userInfoSection.classList.remove('hidden');
                    userInfoSection.style.display = 'flex';
                }
            }
        });
    </script>

    <!-- ç”³è¯·å†…å®¹å¼¹çª—æ˜¾ç¤ºåŠŸèƒ½ -->
    <script src="js/content-modal.js"></script>

    <!-- æ¨¡æ€æ¡†é«˜åº¦æ§åˆ¶åŠŸèƒ½ -->
    <script src="js/modal-height-control.js"></script>

    <!-- æ¨¡æ€æ¡†å¸ƒå±€ä¼˜åŒ–åŠŸèƒ½ -->
    <script src="js/modal-layout-optimizer.js"></script>

    <!-- å“åº”å¼æ¨¡æ€æ¡†å¸ƒå±€åŠŸèƒ½ -->
    <script src="js/responsive-modal-layout.js"></script>
</body>
</html>