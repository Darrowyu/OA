# OA系统功能还原计划

> **目标：** 将旧版系统的所有功能完整迁移到新版系统

---

## 一、功能对比总结

### 后端功能对比

| 功能模块 | 旧版 | 新版 | 状态 |
|---------|------|------|------|
| 四级审批流程 | 完整 | 完整 | ✅ 已迁移 |
| E10002特殊规则 | 有 | 有 | ✅ 已迁移 |
| 提醒系统 | 基础 | 完善 | ✅ 已升级 |
| 归档系统 | 基础 | 完善 | ✅ 已升级 |
| 数据完整性检查 | 无 | 有 | ✅ 新增 |
| 签名系统API | 基础 | 完整CRUD | ✅ 已升级 |
| 文件上传 | 有 | 有+验证 | ✅ 已升级 |

### 前端功能对比

| 功能模块 | 旧版 | 新版 | 状态 |
|---------|------|------|------|
| PDF预览(PC) | 有 | 无 | ❌ 需添加 |
| PDF预览(移动端) | PDF.js | 无 | ❌ 需添加 |
| 签名系统 | 完整 | 无 | ❌ 需添加 |
| 签名缓存 | localStorage | 无 | ❌ 需添加 |
| 移动端卡片视图 | 有 | 有 | ✅ 已迁移 |
| 文件名校验 | 严格 | 基础 | ⚠️ 需增强 |
| 详情页标签页 | 有 | 无 | ❌ 需添加 |
| 自动刷新 | 有 | 无 | ❌ 需添加 |

---

## 二、需要修复的功能清单

### 高优先级（必须修复）

1. **PDF预览功能**
   - 文件: `frontend-new/src/components/PdfPreview.tsx` (新建)
   - 文件: `frontend-new/src/components/PdfPreviewDialog.tsx` (新建)
   - 依赖: pdfjs-dist
   - 功能: 支持PC和移动端PDF预览

2. **电子签名系统**
   - 文件: `frontend-new/src/components/SignaturePad.tsx` (新建)
   - 文件: `frontend-new/src/components/SignatureDialog.tsx` (新建)
   - 功能: 签名绘制、保存、预览
   - 缓存: localStorage存储签名

3. **审批详情页标签页**
   - 文件: `frontend-new/src/pages/ApplicationDetail.tsx` (修改)
   - 功能: 基本信息/审批记录/附件 三个标签页

### 中优先级（建议修复）

4. **文件名校验增强**
   - 文件: `frontend-new/src/components/FileUpload.tsx` (修改)
   - 规则: 必须包含日期(20250101格式) + 至少5个中文字符

5. **自动刷新功能**
   - 文件: `frontend-new/src/pages/PendingApprovals.tsx` (修改)
   - 文件: `frontend-new/src/pages/ApprovedApplications.tsx` (修改)
   - 间隔: 60秒自动刷新

6. **签名在审批中的使用**
   - 文件: `frontend-new/src/pages/ApplicationDetail.tsx` (修改)
   - 功能: 审批时自动附加用户签名

---

## 三、详细修复步骤

### Task 1: 创建PDF预览组件

**文件:**
- 创建: `frontend-new/src/components/PdfPreview.tsx`
- 创建: `frontend-new/src/components/PdfPreviewDialog.tsx`
- 修改: `frontend-new/package.json` (添加pdfjs-dist依赖)

**步骤:**
1. 安装依赖: `npm install pdfjs-dist@3.11.174`
2. 创建PdfPreview组件(支持PC端iframe预览)
3. 创建PdfPreviewDialog组件(支持移动端PDF.js渲染)
4. 在FileUpload组件中集成预览按钮

### Task 2: 创建电子签名系统

**文件:**
- 创建: `frontend-new/src/components/SignaturePad.tsx`
- 创建: `frontend-new/src/components/SignatureDialog.tsx`
- 创建: `frontend-new/src/hooks/useSignature.ts`
- 修改: `frontend-new/src/pages/Users.tsx` (添加签名设置入口)

**步骤:**
1. 创建SignaturePad组件(基于canvas的签名绘制)
2. 创建SignatureDialog对话框组件
3. 创建useSignature hook(管理签名缓存和API调用)
4. 在用户管理页面添加签名设置功能

### Task 3: 重构审批详情页为标签页

**文件:**
- 修改: `frontend-new/src/pages/ApplicationDetail.tsx`

**步骤:**
1. 添加Tabs组件(使用shadcn/ui的Tabs)
2. 将内容分为: 基本信息/审批记录/附件 三个标签
3. 审批记录标签内显示各级审批详情
4. 附件标签内支持预览和下载

### Task 4: 增强文件名校验

**文件:**
- 修改: `frontend-new/src/components/FileUpload.tsx`

**步骤:**
1. 添加文件名验证函数
2. 检查日期格式(20250101或2025-01-01或2025/01/01)
3. 检查中文字符数量(至少5个)
4. 显示友好的错误提示

### Task 5: 添加自动刷新功能

**文件:**
- 修改: `frontend-new/src/pages/PendingApprovals.tsx`
- 修改: `frontend-new/src/pages/ApprovedApplications.tsx`

**步骤:**
1. 添加useEffect定时器(60秒间隔)
2. 组件卸载时清除定时器
3. 添加手动刷新按钮
4. 刷新时显示加载状态

### Task 6: 集成签名到审批流程

**文件:**
- 修改: `frontend-new/src/pages/ApplicationDetail.tsx`
- 修改: `frontend-new/src/pages/PendingApprovals.tsx`

**步骤:**
1. 审批时自动获取用户签名
2. 如果签名不存在,提示用户设置签名
3. 将签名数据发送到后端
4. 在审批历史中显示签名图片

---

## 四、验证清单

修复完成后,需要验证以下功能:

- [ ] PDF文件可以正常预览(PC端)
- [ ] PDF文件可以正常预览(移动端)
- [ ] 用户可以绘制并保存签名
- [ ] 签名自动缓存到localStorage
- [ ] 审批时自动附加签名
- [ ] 审批详情页有标签页切换
- [ ] 文件名不符合规范时有提示
- [ ] 待审核页面60秒自动刷新
- [ ] 所有功能在移动端正常可用

---

## 五、文件路径汇总

### 需要创建的文件
```
frontend-new/src/components/PdfPreview.tsx
frontend-new/src/components/PdfPreviewDialog.tsx
frontend-new/src/components/SignaturePad.tsx
frontend-new/src/components/SignatureDialog.tsx
frontend-new/src/hooks/useSignature.ts
```

### 需要修改的文件
```
frontend-new/package.json
frontend-new/src/components/FileUpload.tsx
frontend-new/src/pages/ApplicationDetail.tsx
frontend-new/src/pages/PendingApprovals.tsx
frontend-new/src/pages/ApprovedApplications.tsx
frontend-new/src/pages/Users.tsx
```

---

计划制定完成。建议按优先级逐个Task执行。
