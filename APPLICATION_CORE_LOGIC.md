# 申请系统核心功能逻辑说明

## 一、系统概述

申请系统是用于企业内部各类申请提交和审批流转的核心模块，支持多种申请类型，每种类型有独立的审批流程和规则。

### 1.1 支持的申请类型

| 申请类型 | 适用场景 | 审批层级 | 特殊说明 |
|---------|---------|---------|---------|
| **标准申请** | 一般业务申请、采购申请 | 多级审批 | 必须选择厂长，支持金额字段 |
| **新产品开发企划表** | 新产品开发项目提案 | 单级审批 | 独立编号规则(PD开头) |
| **新产品开发可行性评估表** | 评估新产品开发可行性 | 多部门并行 | 5个部门主管同时审批 |
| **出差申请单** | 员工出差申请 | 单级审批 | 选择主管即可，无金额字段 |

---

## 二、标准申请审批流程

### 2.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  阶段1: 申请创建                                              │
│  • 填写申请人、部门、日期、内容、金额                         │
│  • 必须选择1个或多个厂长                                      │
│  • 上传PDF附件(可选，文件名需含日期+5个汉字以上)              │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段2: 厂长审批 (多选并行)                                   │
│  • 只有被选中的厂长可见此申请                                 │
│  • 所有选中的厂长都通过后才进入下一阶段                       │
│  • 任一厂长拒绝 → 申请结束(状态:已拒绝)                       │
│  • 厂长可上传审批附件                                         │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段3: 总监审批 (单选，三种流向)                             │
│  • 总监可选择审批流向:                                        │
│    - 流转到经理审批 → 需要选择1个或多个经理                   │
│    - 直接流转到CEO审批                                        │
│    - 直接完成(不经过经理和CEO)                                │
│  • 总监审批通过后才按选择流转                                 │
│  • 总监拒绝 → 申请结束(状态:已拒绝)                           │
└─────────────────────────┬───────────────────────────────────┘
                          │ (根据总监选择分流)
          ┌───────────────┼───────────────┐
          ↓               ↓               ↓
┌─────────────────┐ ┌───────────────┐ ┌─────────────────┐
│  流向A: 经理审批  │ │ 流向B: CEO审批  │ │ 流向C: 直接完成   │
│                 │ │               │ │                 │
│ 选择多个经理     │ │ 直接进入CEO   │ │ 跳过经理和CEO   │
│ 并行审批         │ │ 审批阶段      │ │ 直接审批通过    │
│ 全部通过→CEO    │ │               │ │                 │
└────────┬────────┘ └───────┬───────┘ └────────┬────────┘
         │                  │                   │
         └──────────────────┴───────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段4: CEO审批                                               │
│  • CEO可见所有流转到本阶段的申请                              │
│  • CEO通过 → 申请完成(状态:已审批)                            │
│  • CEO拒绝 → 申请结束(状态:已拒绝)                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 状态流转规则

| 当前状态 | 触发条件 | 下一状态 | 操作人 |
|---------|---------|---------|--------|
| pending + factory_manager | 厂长通过(全部) | pending + director | 厂长 |
| pending + factory_manager | 厂长拒绝 | rejected | 厂长 |
| pending + director | 总监选择"经理审批" | pending + manager | 总监 |
| pending + director | 总监选择"CEO审批" | pending + ceo | 总监 |
| pending + director | 总监选择"直接完成" | approved | 总监 |
| pending + director | 总监拒绝 | rejected | 总监 |
| pending + manager | 经理通过(全部) | pending + ceo | 经理 |
| pending + manager | 经理拒绝 | rejected | 经理 |
| pending + ceo | CEO通过 | approved | CEO |
| pending + ceo | CEO拒绝 | rejected | CEO |

### 2.3 多人并行审批规则

**厂长阶段的多人并行：**
- 创建申请时可选择1个或多个厂长
- 只有被选中的厂长才能在待审核列表看到该申请
- 每个厂长独立审批，互不影响
- **流转条件**: 所有选中的厂长都审批通过后，才进入总监阶段
- **拒绝规则**: 任一厂长拒绝，申请立即结束

**经理阶段的多人并行：**
- 总监在审批时决定是否流转到经理阶段
- 如选择经理审批，需指定1个或多个经理
- 只有被选中的经理才能审批
- **流转条件**: 所有选中的经理都审批通过后，才进入CEO阶段
- **拒绝规则**: 任一经理拒绝，申请立即结束

---

## 三、新产品开发企划表流程

### 3.1 流程说明

```
┌─────────────────────────────────────────────────────────┐
│  申请创建                                                │
│  • 填写项目基本信息(项目名称、客户名称、提案日期等)       │
│  • 选择开发源由(可多选:市场需求/公司策略/客户要求等)      │
│  • 填写项目详细内容(7个维度)                              │
│  • 选择项目审核人                                         │
│  • 选择项目申请人                                         │
│  • 系统自动生成项目编号(PD+日期+流水号)                   │
└─────────────────────────┬───────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  项目审核人审批                                          │
│  • 只有被选中的审核人可见                                 │
│  • 审核人通过后直接完成                                   │
│  • 审核人拒绝则申请结束                                   │
│  • 审批意见和电子签名会记录在审批历史中                   │
└─────────────────────────┬───────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  完成状态                                                │
│  • 状态变为"已审批"                                      │
│  • 可导出Excel格式的企划表                                │
│  • Excel中会自动嵌入审核人和申请人的电子签名              │
└─────────────────────────────────────────────────────────┘
```

### 3.2 开发源由选项

申请时需从以下6个选项中选择(可多选):
1. 因市场需求趋势而提出开发
2. 因本公司产品策略而主动提出开发
3. 因客户需求而提出开发
4. 因本公司上级决策而提出开发
5. 因客户对现有产品进行改善开发
6. 因本公司内部产品改善建议而提出开发

### 3.3 项目内容维度

需填写以下7个维度的详细说明:
1. 新产品性质介绍(材质、规格、包装方式等)
2. 新产品开发成功可能性预估(客户接受之可能性)
3. 是否有同类型的新产品竞争
4. 新产品开发费用的预估
5. 新产品开发成本的预估
6. 新产品开发是否符合法令规定要求(NIOSH/CE/CNS/JIS/LL等)
7. 新产品开发成功量产后本公司的获利情况预估

---

## 四、可行性评估表流程

### 4.1 多部门并行审批

```
┌────────────────────────────────────────────────────────────┐
│  申请创建                                                   │
│  • 填写项目基本信息                                         │
│  • 定义12项评估内容(每项指定评估部门和评估标准)             │
│  • 评估结论填写                                             │
└─────────────────────────┬──────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│  多部门并行审批阶段                                         │
│                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │
│  │  业务部   │  │  生管部   │  │  品管部   │                 │
│  │ 卓庚霖   │  │ 周德坤   │  │ 史良萍   │                 │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                 │
│       │              │              │                       │
│       └──────────────┼──────────────┘                       │
│                      │                                      │
│  ┌──────────┐       │       ┌──────────┐                  │
│  │  研发部   │       │       │  厂务部   │                  │
│  │ 卓佩芝   │◄──────┴──────►│ 汪德良   │                  │
│  └────┬─────┘               └────┬─────┘                  │
│       │                          │                          │
│       └──────────────┬───────────┘                          │
│                      │                                      │
│                      ↓                                      │
│              全部通过后完成                                 │
└────────────────────────────────────────────────────────────┘
```

### 4.2 评估项目结构

评估表包含12个评估项目，每个项目包含:
- 评估内容(固定描述)
- 评估单位(业务/生管/品管/研发/厂务)
- 评估结果(可行/不可行)

### 4.3 通过规则

- **全部通过**: 12项全部评估为"可行" → 申请通过
- **任一不通过**: 任一项目评估为"不可行" → 申请终止
- 各主管独立审批，系统实时显示各部门的审批状态

---

## 五、出差申请单流程

### 5.1 简化流程

```
┌─────────────────────────────────────────────────────────┐
│  申请创建                                                │
│  • 填写出差人员、部门、日期                               │
│  • 填写出差事由、目的地                                   │
│  • 选择主管审批人                                         │
│  • 无需填写金额                                          │
│  • 无附件要求                                            │
└─────────────────────────┬───────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  主管审批                                                │
│  • 只有被选中的主管可见                                   │
│  • 主管通过后直接完成                                     │
│  • 主管拒绝则申请结束                                     │
│  • 无后续审批环节                                         │
└─────────────────────────┬───────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  完成                                                    │
│  • 状态变为"已审批"                                      │
│  • 可打印出差申请单                                       │
└─────────────────────────────────────────────────────────┘
```

### 5.2 特殊限制

- **不支持编辑**: 出差申请创建后只能删除，不能修改
- **单级审批**: 只需主管审批即可，无多级流程
- **无金额字段**: 不涉及金额计算和汇率换算
- **无附件**: 不需要上传附件

---

## 六、权限控制逻辑

### 6.1 数据级权限体系

系统采用三层数据权限控制:

| 权限级别 | 说明 | 适用场景 |
|---------|------|---------|
| **查看所有** | 可见全部申请 | 总监/CEO/管理员 |
| **查看部门** | 可见本部门申请 | 厂长/经理 |
| **查看自己** | 仅见自己创建的申请 | 普通员工 |

### 6.2 权限继承关系

```
application_view_all
    └─→ application_view_dept
            └─→ application_view_own

pending_approval
    └─→ application_approve
    └─→ application_reject

application_edit_all
    └─→ application_edit_own

application_delete_all
    └─→ application_delete_own
```

### 6.3 审批权限判定逻辑

**谁能看到待审核申请？**

| 审批阶段 | 可见人员 | 判定规则 |
|---------|---------|---------|
| 厂长阶段 | 被选中的厂长 | 用户的ID在selectedFactoryManagers列表中 |
| 总监阶段 | 所有总监 | 用户角色为"总监" |
| 经理阶段 | 被选中的经理 | 用户的ID在selectedManagers列表中 |
| CEO阶段 | CEO | 用户角色为"CEO" |
| 审核人阶段 | 被选中的审核人 | 用户的ID等于projectReviewer字段 |
| 可行性评估 | 5个固定人员 | 用户的username在固定名单中 |
| 主管阶段 | 被选中的主管 | 用户的ID等于selectedSupervisor.id |

**谁能审批？**

除满足上述可见条件外，还必须:
1. 拥有pending_approval或application_approve权限
2. 在当前审批阶段尚未审批过(防止重复审批)
3. 申请状态为"pending"

**谁能查看申请详情？**

满足以下任一条件即可:
- 拥有查看所有权限
- 是本部门成员且拥有查看部门权限
- 是申请人本人
- 是被选中的审批人(厂长/经理/主管/审核人)
- 已在审批历史中审批过此申请
- 是管理员

### 6.4 编辑删除权限

**编辑权限判定:**
1. 申请状态必须为"pending"
2. 审批历史必须为空(尚未有人审批过)
3. 满足以下任一:
   - 用户是管理员
   - 用户是申请人本人且拥有edit_own权限
   - 用户拥有edit_all权限
4. **例外**: 出差申请不支持编辑

**删除权限判定:**
与编辑权限相同，但使用delete_own和delete_all权限。

---

## 七、申请编号生成规则

### 7.1 编号格式

| 申请类型 | 格式示例 | 说明 |
|---------|---------|------|
| 标准申请 | 20250814-001 | 日期+当日流水号(3位) |
| 新产品开发 | PD20250814-001 | PD前缀+日期+当日流水号 |
| 可行性评估 | 20250814-005 | 与标准申请共用流水号 |
| 出差申请 | 20250814-008 | 与标准申请共用流水号 |

### 7.2 流水号计数规则

- **标准/可行性评估/出差**: 共用同一计数器，按当天创建的申请总数递增
- **新产品开发**: 独立计数器，只统计当天创建的新产品开发申请
- 流水号每天00:00重置，从001开始

---

## 八、附件管理逻辑

### 8.1 附件上传规则

| 规则项 | 限制 |
|-------|------|
| 文件格式 | 仅限PDF |
| 单个文件大小 | 最大5MB |
| 总文件大小 | 最大15MB |
| 文件数量 | 最多10个 |
| 文件名要求 | 必须包含日期格式(20250101或2025-01-01或2025/01/01) + 至少5个中文字符 |

### 8.2 附件分类

附件分为两类存储:
1. **初始附件**: 申请创建时上传的附件(attachment_type = 'initial')
2. **审批附件**: 审批过程中上传的附件(attachment_type = 'approval')

### 8.3 附件查看权限

- 只有能查看申请详情的人才能查看附件
- 附件预览使用短期Token(5分钟有效期)，防止链接泄露
- 预览时需同时验证Token和会话状态

---

## 九、通知机制

### 9.1 触发场景

| 触发事件 | 通知对象 | 通知方式 |
|---------|---------|---------|
| 申请提交 | 申请人 | 邮件 |
| 审批通过 | 申请人 | 邮件 |
| 审批拒绝 | 申请人 | 邮件 |
| 高金额审批通过 | 指定财务人员 | 邮件 |
| 流转到下一审批人 | 下一审批人 | 系统内通知 |

### 9.2 高金额判定

- **阈值**: 系统可配置，默认100,000元人民币
- **汇率**: 美元按7.2汇率换算
- **触发条件**: 申请完成审批且金额≥阈值
- **通知对象**: 固定用户ID(E10015)

---

## 十、Excel导出逻辑

### 10.1 支持的申请类型

只有以下申请类型支持导出Excel:
- 新产品开发企划表
- 可行性评估表

### 10.2 导出内容

**新产品开发企划表Excel包含:**
- 公司抬头和文档编号
- 项目基本信息(名称、编号、客户、日期)
- 开发源由(带勾选标记)
- 项目详细内容(7个维度)
- 审核人和申请人的电子签名(自动嵌入图片)

**可行性评估表Excel包含:**
- 公司抬头和文档编号
- 项目基本信息
- 12项评估内容表格
- 评估结论
- 各部门主管签名区域
- 厂务总经理审核区域

### 10.3 签名嵌入规则

- 系统自动从用户表中获取签名图片
- 优先使用Base64编码的签名数据
- 如签名不存在则显示用户姓名
- 签名按指定位置和大小嵌入单元格

---

## 十一、关键业务规则汇总

### 11.1 申请创建规则

1. **必填字段**: 申请人、部门、日期、内容(标准申请还需选择厂长)
2. **金额字段**: 可选，支持人民币和美元，美元会显示汇率换算
3. **优先级**: 可选(low/normal/high/urgent)，默认normal
4. **附件**: 可选，但如上传则必须符合命名规范

### 11.2 审批规则

1. **审批顺序**: 严格按照阶段顺序，不可跳过
2. **并行审批**: 同一阶段多人审批时，必须全部通过才能进入下一阶段
3. **拒绝规则**: 任一审批人拒绝，申请立即结束，不可恢复
4. **审批意见**: 通过时默认意见为"同意"，拒绝时必须填写原因
5. **签名**: 审批时自动记录用户电子签名

### 11.3 修改删除规则

1. **可修改条件**: pending状态 + 无审批历史 + 有权限
2. **修改限制**: 不能修改申请类型，附件上传会覆盖旧附件
3. **可删除条件**: 同修改条件
4. **删除后**: 附件文件从磁盘删除，数据从数据库删除

### 11.4 查询规则

1. **申请记录页面**: 只显示自己创建的申请
2. **待审核页面**: 只显示当前用户有权限审批的申请
3. **已审核页面**: 只显示当前用户已审批过的申请
4. **管理员视图**: 可查看所有申请，但只能删除不能审批

---

## 十二、数据关系说明

### 12.1 实体关系

```
用户(1) ────< (N) 申请
  │              │
  │              ├──< (N) 附件
  │              │
  │              └──< (N) 审批历史
  │
  └──────────────< (N) 审批历史 (作为审批人)
```

### 12.2 关键字段说明

**申请主表核心字段:**
- application_number: 唯一编号，用于展示和查询
- type: 申请类型(standard/product/feasibility/business_trip/other)
- formType: 表单类型，与type对应但更具体
- status: 申请状态(pending/approved/rejected)
- current_stage: 当前审批阶段，决定谁能审批
- custom_fields: JSON格式存储各类申请的自定义字段
- selectedFactoryManagers: JSON数组存储选中的厂长信息
- selectedManagers: JSON数组存储选中的经理信息
- selectedSupervisor: JSON对象存储选中的主管信息

**审批历史核心字段:**
- stage: 审批阶段，记录是在哪个阶段进行的审批
- action: 动作(approve/reject)
- approverId/approverName/approverRole: 审批人信息
- signaturePath: 签名图片路径，用于Excel导出
- timestamp: 审批时间

---

## 十三、异常处理逻辑

### 13.1 常见异常场景

| 异常场景 | 处理逻辑 |
|---------|---------|
| 申请不存在 | 返回404错误，提示"申请不存在" |
| 无权限查看 | 返回403错误，提示"您没有权限查看此申请" |
| 无权限审批 | 返回403错误，提示"没有权限审批此申请" |
| 申请已审批完成 | 返回403错误，提示"该申请已完成审批" |
| 已被他人审批 | 返回403错误，提示"您已审批过此申请" |
| 文件类型不支持 | 返回400错误，提示"只支持PDF格式" |
| 文件过大 | 返回400错误，提示具体大小限制 |
| 文件名不规范 | 返回400错误，提示命名要求 |

### 13.2 并发控制

- 审批操作使用数据库事务和行级锁(FOR UPDATE)
- 防止同一申请被多人同时审批导致的状态混乱
- 附件上传使用唯一文件名生成策略，防止覆盖

---

## 十四、页面流转说明

### 14.1 用户操作流程

```
创建申请流程:
申请类型选择页 → 对应申请表单页 → 填写提交 → 申请书预览/打印
     │
     ├─→ 标准申请表单
     ├─→ 新产品开发表单
     ├─→ 可行性评估表单
     └─→ 出差申请表单

审批流程:
待审核列表页 → 查看详情 → 审批操作 → 刷新列表
     │
     ├─→ 厂长: 可见被选中的申请
     ├─→ 总监: 可见流转到本阶段的申请
     ├─→ 经理: 可见被选中的申请
     └─→ CEO: 可见流转到本阶段的申请

查看流程:
申请记录页 → 查看详情 → 查看基本信息/审批记录/附件
     │
     ├─→ 基本信息: 申请内容、金额、状态等
     ├─→ 审批记录: 时间线形式的审批历史
     └─→ 附件: 下载或预览PDF附件
```

### 14.2 页面权限要求

| 页面 | 所需权限 | 说明 |
|-----|---------|------|
| 申请类型选择 | new_application | 创建申请入口 |
| 标准申请创建 | new_application | 填写标准申请 |
| 新产品开发创建 | new_application | 填写新产品开发申请 |
| 可行性评估创建 | new_application | 填写可行性评估 |
| 出差申请创建 | new_application | 填写出差申请 |
| 申请记录 | application_record | 查看自己的申请 |
| 待审核 | pending_approval | 审批他人申请 |
| 已审核 | approved_applications | 查看已审批的申请 |

---

本说明文档涵盖了申请系统的所有核心功能逻辑，可作为系统复刻、重构或优化的需求参考文档。
