generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id          String       @id @default(cuid())
  name        String
  code        String       @unique
  parentId    String?
  level       Int          @default(1)
  sortOrder   Int          @default(0)
  managerId   String?
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  users       User[]
  manager     User?        @relation("DepartmentManager", fields: [managerId], references: [id])
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")

  @@index([parentId])
  @@index([code])
  @@index([isActive])
  @@index([managerId])
  @@map("departments")
}

model User {
  id                 String              @id @default(cuid())
  username           String              @unique
  password           String
  name               String              @db.VarChar(100)
  email              String              @unique @db.VarChar(255)
  role               UserRole
  employeeId         String              @unique
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  signature          String?
  avatar             String?
  departmentId       String?
  phone              String?
  position           String?
  deletedAt          DateTime?
  applications       Application[]
  proposedProjects   Application[]       @relation("ProjectProposer")
  reviewedProjects   Application[]       @relation("ProjectReviewer")
  attachments        Attachment[]
  ceoApprovals       CeoApproval[]
  directorApprovals  DirectorApproval[]
  factoryApprovals   FactoryApproval[]
  managerApprovals   ManagerApproval[]
  reminderLogs       ReminderLog[]
  department         Department?         @relation(fields: [departmentId], references: [id])
  devices            UserDevice[]
  preference         UserPreference?
  announcementReads  AnnouncementRead[]
  announcements      Announcement[]      @relation("UserAnnouncements")
  approvals          Approval[]
  attendanceRecords  AttendanceRecord[]
  auditLogs          AuditLog[]          @relation("UserAuditLogs")
  calendarEvents     CalendarEvent[]
  configHistories    ConfigHistory[]
  managedDepartments Department[]        @relation("DepartmentManager")
  documentFolders    DocumentFolder[]
  documents          Document[]
  knowledgeArticles  KnowledgeArticle[]
  knowledgeFeedbacks KnowledgeFeedback[]
  approvedLeaves     LeaveRequest[]      @relation("LeaveApprover")
  leaveRequests      LeaveRequest[]
  meetingAttendees   MeetingAttendee[]
  meetings           Meeting[]           @relation("UserMeetings")
  notifications      Notification[]
  schedules          Schedule[]
  ownedProjects      TaskProject[]
  assignedTasks      Task[]              @relation("AssignedTasks")
  createdTasks       Task[]              @relation("CreatedTasks")
  createdWorkflows   Workflow[]          @relation("WorkflowCreator")

  @@index([departmentId])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
  @@index([email, isActive])
}

model Application {
  id                   String             @id @default(cuid())
  applicationNo        String             @unique
  title                String
  content              String
  amount               Decimal?           @db.Decimal(15, 2)
  priority             Priority           @default(NORMAL)
  status               ApplicationStatus  @default(DRAFT)
  applicantId          String
  applicantName        String
  applicantDept        String
  factoryManagerIds    String[]
  managerIds           String[]
  rejectedBy           String?
  rejectedAt           DateTime?
  rejectReason         String?
  submittedAt          DateTime?
  completedAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  deletedAt            DateTime?
  customFields         Json?
  customerName         String?
  evaluationItems      Json?
  evaluationResult     String?
  formType             String?
  highAmountNotified   Boolean            @default(false)
  projectContent       Json?
  projectName          String?
  projectNo            String?            @unique
  projectProposerId    String?
  projectReviewerId    String?
  projectSources       String[]
  selectedSupervisorId String?
  tripDestination      String?
  tripEndDate          DateTime?
  tripPurpose          String?
  tripStartDate        DateTime?
  type                 ApplicationType    @default(STANDARD)
  flowConfig           Json?
  applicant            User               @relation(fields: [applicantId], references: [id])
  projectProposer      User?              @relation("ProjectProposer", fields: [projectProposerId], references: [id])
  projectReviewer      User?              @relation("ProjectReviewer", fields: [projectReviewerId], references: [id])
  archiveRecord        ArchiveRecord?
  attachments          Attachment[]
  ceoApprovals         CeoApproval[]
  directorApprovals    DirectorApproval[]
  factoryApprovals     FactoryApproval[]
  managerApprovals     ManagerApproval[]
  reminderLogs         ReminderLog[]
  approvals            Approval[]

  @@index([status])
  @@index([priority])
  @@index([submittedAt])
  @@index([applicantId])
  @@index([deletedAt])
  @@index([status, applicantId, submittedAt])
  @@index([status, priority])
  @@index([type])
  @@index([projectNo])
}

model Approval {
  id            String         @id @default(cuid())
  applicationId String
  approverId    String
  level         Int
  action        ApprovalAction @default(PENDING)
  comment       String?
  metadata      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  application   Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  approver      User           @relation(fields: [approverId], references: [id])

  @@unique([applicationId, approverId, level])
  @@index([applicationId])
  @@index([approverId])
  @@index([level])
  @@map("approvals")
}

model FactoryApproval {
  id            String         @id @default(cuid())
  applicationId String
  approverId    String
  action        ApprovalAction @default(PENDING)
  comment       String?
  approvedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  application   Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  approver      User           @relation(fields: [approverId], references: [id])

  @@unique([applicationId, approverId])
  @@index([applicationId])
  @@index([approverId])
  @@index([action])
}

model DirectorApproval {
  id                 String         @id @default(cuid())
  applicationId      String
  approverId         String
  action             ApprovalAction @default(PENDING)
  comment            String?
  selectedManagerIds String[]
  skipManager        Boolean        @default(false)
  approvedAt         DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  flowType           String?
  application        Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  approver           User           @relation(fields: [approverId], references: [id])

  @@unique([applicationId, approverId])
  @@index([applicationId])
  @@index([approverId])
  @@index([action])
}

model ManagerApproval {
  id            String         @id @default(cuid())
  applicationId String
  approverId    String
  action        ApprovalAction @default(PENDING)
  comment       String?
  approvedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  application   Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  approver      User           @relation(fields: [approverId], references: [id])

  @@unique([applicationId, approverId])
  @@index([applicationId])
  @@index([approverId])
  @@index([action])
}

model CeoApproval {
  id            String         @id @default(cuid())
  applicationId String
  approverId    String
  action        ApprovalAction @default(PENDING)
  comment       String?
  approvedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  application   Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  approver      User           @relation(fields: [approverId], references: [id])

  @@unique([applicationId, approverId])
  @@index([applicationId])
  @@index([approverId])
  @@index([action])
}

model Attachment {
  id                   String      @id @default(cuid())
  filename             String
  storedName           String      @unique
  path                 String
  size                 Int
  mimeType             String
  applicationId        String
  uploaderId           String
  isApprovalAttachment Boolean     @default(false)
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  application          Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  uploader             User        @relation(fields: [uploaderId], references: [id])

  @@index([applicationId])
  @@index([uploaderId])
  @@index([isApprovalAttachment])
}

model ReminderLog {
  id            String       @id @default(cuid())
  applicationId String
  recipientId   String
  reminderType  ReminderType
  reminderCount Int          @default(1)
  sentAt        DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  application   Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  recipient     User         @relation(fields: [recipientId], references: [id])

  @@index([applicationId])
  @@index([recipientId])
  @@index([sentAt])
}

model ArchiveRecord {
  id            String      @id @default(cuid())
  applicationId String      @unique
  applicationNo String
  archivedAt    DateTime    @default(now())
  archivePath   String
  dataSnapshot  Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([archivedAt])
  @@index([applicationNo])
}

model Equipment {
  id                 String              @id @default(cuid())
  code               String              @unique
  name               String
  model              String
  category           String
  manufacturer       String?
  location           String
  status             EquipmentStatus     @default(RUNNING)
  healthScore        Int?                @db.SmallInt
  purchaseDate       DateTime?
  warrantyDate       DateTime?
  purchasePrice      Decimal?            @db.Decimal(15, 2)
  serialNumber       String?
  description        String?
  lastMaintenanceAt  DateTime?
  nextMaintenanceAt  DateTime?
  totalWorkHours     Int?                @default(0)
  createdBy          String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  healthMetrics      Json?
  deletedAt          DateTime?
  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]
  partUsages         PartUsage[]

  @@index([status])
  @@index([code])
  @@index([category])
  @@index([location])
  @@index([deletedAt])
  @@index([nextMaintenanceAt])
}

model MaintenanceRecord {
  id                String                  @id @default(cuid())
  code              String                  @unique
  equipmentId       String
  type              MaintenanceType
  content           String
  operator          String
  startTime         DateTime
  endTime           DateTime?
  duration          Int?
  estimatedDuration Int?
  cost              Decimal?                @db.Decimal(15, 2)
  status            MaintenanceRecordStatus @default(PENDING)
  templateId        String?
  partsUsed         Json?
  result            String?
  beforeImages      String[]
  afterImages       String[]
  createdBy         String
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  equipment         Equipment               @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  template          MaintenanceTemplate?    @relation(fields: [templateId], references: [id])

  @@index([equipmentId])
  @@index([status])
  @@index([type])
  @@index([startTime])
}

model MaintenancePlan {
  id           String                   @id @default(cuid())
  code         String                   @unique
  equipmentId  String
  planName     String
  frequency    MaintenancePlanFrequency
  intervalDays Int
  nextDate     DateTime
  responsible  String
  reminderDays Int?                     @default(7)
  status       MaintenancePlanStatus    @default(ACTIVE)
  templateId   String?
  description  String?
  createdBy    String
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  equipment    Equipment                @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  template     MaintenanceTemplate?     @relation(fields: [templateId], references: [id])

  @@index([equipmentId])
  @@index([status])
  @@index([nextDate])
  @@index([status, nextDate])
}

model MaintenanceTemplate {
  id                 String                    @id @default(cuid())
  code               String                    @unique
  name               String
  category           String
  items              Json
  estimatedTime      Int
  status             MaintenanceTemplateStatus @default(DRAFT)
  usageCount         Int                       @default(0)
  createdBy          String
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]

  @@index([status])
  @@index([category])
}

model Part {
  id             String         @id @default(cuid())
  code           String         @unique
  name           String
  model          String
  category       String
  unit           String
  stock          Int            @default(0)
  minStock       Int            @default(0)
  maxStock       Int            @default(0)
  location       String?
  supplier       String?
  status         PartStatus     @default(NORMAL)
  unitPrice      Decimal?       @db.Decimal(15, 2)
  description    String?
  createdBy      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  version        Int            @default(0)
  partLifecycles PartLifecycle?
  partScraps     PartScrap[]
  stockRecords   PartStock[]
  partUsages     PartUsage[]

  @@index([status])
  @@index([code])
  @@index([category])
  @@index([status, stock])
}

model PartUsage {
  id          String          @id @default(cuid())
  code        String          @unique
  partId      String
  quantity    Int
  applicant   String
  department  String
  purpose     String
  equipmentId String?
  applyDate   DateTime
  status      PartUsageStatus @default(PENDING)
  approvedBy  String?
  approvedAt  DateTime?
  remark      String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  equipment   Equipment?      @relation(fields: [equipmentId], references: [id])
  part        Part            @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@index([status])
  @@index([applicant])
  @@index([applyDate])
}

model PartScrap {
  id            String          @id @default(cuid())
  code          String          @unique
  partId        String
  quantity      Int
  reason        String
  originalValue Decimal         @db.Decimal(15, 2)
  residualValue Decimal         @db.Decimal(15, 2)
  applicant     String
  applyDate     DateTime
  status        PartScrapStatus @default(PENDING)
  approvedBy    String?
  approvedAt    DateTime?
  remark        String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  part          Part            @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@index([status])
  @@index([applicant])
}

model PartStock {
  id          String      @id @default(cuid())
  partId      String
  type        StockType
  quantity    Int
  beforeStock Int
  afterStock  Int
  operator    String
  documentNo  String?
  source      StockSource
  date        DateTime    @default(now())
  remark      String?
  relatedId   String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  part        Part        @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@index([type])
  @@index([date])
  @@index([source])
  @@index([partId, date(sort: Desc)])
}

model PartLifecycle {
  id              String              @id @default(cuid())
  partId          String              @unique
  totalCycles     Int
  installedCycles Int                 @default(0)
  remainingCycles Int
  avgUsage        Int
  status          PartLifecycleStatus @default(ACTIVE)
  installedAt     DateTime?
  expectedEndDate DateTime?
  equipmentId     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  part            Part                @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@index([status])
  @@index([expectedEndDate])
  @@index([status, expectedEndDate])
}

model UserPreference {
  id                    String                @id @default(cuid())
  userId                String                @unique
  theme                 Theme                 @default(SYSTEM)
  interfaceDensity      InterfaceDensity      @default(DEFAULT)
  sidebarCollapsed      Boolean               @default(false)
  emailNotifications    Boolean               @default(true)
  approvalNotifications NotificationFrequency @default(INSTANT)
  systemAnnouncements   Boolean               @default(true)
  weeklyReport          Boolean               @default(false)
  monthlyReport         Boolean               @default(false)
  profileVisibility     ProfileVisibility     @default(COLLEAGUES)
  onlineStatus          OnlineStatus          @default(VISIBLE)
  twoFactorEnabled      Boolean               @default(false)
  twoFactorSecret       String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserDevice {
  id           String   @id @default(cuid())
  userId       String
  deviceId     String   @unique
  deviceName   String
  deviceType   String?
  browser      String?
  os           String?
  ipAddress    String?
  location     String?
  lastActiveAt DateTime @default(now())
  isCurrent    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceId])
  @@index([lastActiveAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  content   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entityType  String
  entityId    String?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  description String?
  createdAt   DateTime @default(now())
  user        User     @relation("UserAuditLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

model CalendarEvent {
  id          String            @id @default(cuid())
  userId      String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  type        CalendarEventType @default(MEETING)
  isAllDay    Boolean           @default(false)
  recurrence  String?
  attendees   Json?
  isPrivate   Boolean           @default(false)
  color       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
  @@index([endTime])
  @@index([type])
  @@index([userId, startTime, endTime])
  @@map("calendar_events")
}

model DocumentFolder {
  id          String           @id @default(cuid())
  name        String
  parentId    String?
  ownerId     String
  permissions Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  owner       User             @relation(fields: [ownerId], references: [id])
  parent      DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    DocumentFolder[] @relation("FolderHierarchy")
  documents   Document[]

  @@index([parentId])
  @@index([ownerId])
  @@map("document_folders")
}

model Document {
  id        String            @id @default(cuid())
  folderId  String
  name      String
  type      String
  size      Int
  path      String
  version   Int               @default(1)
  ownerId   String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  deletedAt DateTime?
  versions  DocumentVersion[]
  folder    DocumentFolder    @relation(fields: [folderId], references: [id], onDelete: Cascade)
  owner     User              @relation(fields: [ownerId], references: [id])

  @@index([folderId])
  @@index([ownerId])
  @@index([type])
  @@index([deletedAt])
  @@map("documents")
}

model DocumentVersion {
  id         String   @id @default(cuid())
  documentId String
  version    Int
  path       String
  size       Int
  createdBy  String
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([version])
  @@map("document_versions")
}

model AttendanceRecord {
  id               String           @id @default(cuid())
  userId           String
  date             DateTime         @db.Date
  clockIn          DateTime?
  clockOut         DateTime?
  clockInLocation  Json?
  clockOutLocation Json?
  clockInType      ClockInType?
  clockOutType     ClockInType?
  status           AttendanceStatus @default(NORMAL)
  workHours        Float?
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@index([status])
  @@map("attendance_records")
}

model Schedule {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @db.Date
  shiftId   String
  isRestDay Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shift     Shift    @relation(fields: [shiftId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("schedules")
}

model Shift {
  id        String     @id @default(cuid())
  name      String
  startTime String
  endTime   String
  breakTime Int        @default(60)
  color     String?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  schedules Schedule[]

  @@map("shifts")
}

model LeaveRequest {
  id           String             @id @default(cuid())
  userId       String
  type         LeaveType
  startDate    DateTime
  endDate      DateTime
  days         Float
  reason       String
  status       LeaveRequestStatus @default(PENDING)
  approverId   String?
  approvedAt   DateTime?
  rejectReason String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  approver     User?              @relation("LeaveApprover", fields: [approverId], references: [id])
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@map("leave_requests")
}

model MeetingRoom {
  id          String    @id @default(cuid())
  name        String
  capacity    Int
  location    String?
  facilities  Json?
  image       String?
  isActive    Boolean   @default(true)
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  meetings    Meeting[]

  @@index([isActive])
  @@index([capacity])
  @@map("meeting_rooms")
}

model Meeting {
  id              String            @id @default(cuid())
  title           String
  description     String?
  roomId          String?
  startTime       DateTime
  endTime         DateTime
  organizerId     String
  attendees       Json?
  status          MeetingStatus     @default(SCHEDULED)
  minutes         String?
  attachments     Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?
  attendeeRecords MeetingAttendee[]
  organizer       User              @relation("UserMeetings", fields: [organizerId], references: [id])
  room            MeetingRoom?      @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([startTime])
  @@index([organizerId])
  @@index([status])
  @@index([roomId, startTime, endTime])
  @@index([deletedAt])
  @@map("meetings")
}

model MeetingAttendee {
  id        String         @id @default(cuid())
  meetingId String
  userId    String
  status    AttendeeStatus @default(PENDING)
  joinedAt  DateTime?
  leftAt    DateTime?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  meeting   Meeting        @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([meetingId, userId])
  @@index([userId])
  @@index([meetingId, status])
  @@index([userId, status])
  @@map("meeting_attendees")
}

model Announcement {
  id          String             @id @default(cuid())
  title       String
  content     String
  type        AnnouncementType
  targetDepts Json?
  isTop       Boolean            @default(false)
  validFrom   DateTime
  validUntil  DateTime?
  attachments Json?
  viewCount   Int                @default(0)
  authorId    String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  reads       AnnouncementRead[]
  author      User               @relation("UserAnnouncements", fields: [authorId], references: [id])

  @@index([type])
  @@index([isTop])
  @@index([validFrom])
  @@index([authorId])
  @@index([deletedAt])
  @@map("announcements")
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  userId         String
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@map("announcement_reads")
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  assigneeId  String?
  creatorId   String
  projectId   String?
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  tags        Json?
  parentId    String?
  order       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  assignee    User?        @relation("AssignedTasks", fields: [assigneeId], references: [id])
  creator     User         @relation("CreatedTasks", fields: [creatorId], references: [id], onDelete: Cascade)
  parent      Task?        @relation("SubTasks", fields: [parentId], references: [id], onDelete: Cascade)
  subTasks    Task[]       @relation("SubTasks")
  project     TaskProject? @relation(fields: [projectId], references: [id])

  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([creatorId])
  @@index([parentId])
  @@index([projectId])
  @@index([assigneeId, status])
  @@index([status, dueDate])
  @@index([assigneeId, status, dueDate])
  @@index([creatorId, createdAt(sort: Desc)])
  @@index([deletedAt])
  @@map("tasks")
}

model TaskProject {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String?
  ownerId     String
  members     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([ownerId])
  @@map("task_projects")
}

model Workflow {
  id          String             @id @default(cuid())
  name        String
  description String?
  entityType  String
  nodes       Json
  edges       Json
  version     Int                @default(1)
  status      WorkflowStatus     @default(DRAFT)
  isDefault   Boolean            @default(false)
  createdBy   String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  instances   WorkflowInstance[]
  creator     User               @relation("WorkflowCreator", fields: [createdBy], references: [id])

  @@index([entityType])
  @@index([status])
  @@index([isDefault])
  @@index([createdBy])
  @@map("workflows")
}

model WorkflowInstance {
  id            String         @id @default(cuid())
  workflowId    String
  entityId      String
  entityType    String
  currentNodeId String
  status        InstanceStatus @default(RUNNING)
  nodeHistory   Json?
  variables     Json?
  contextData   Json?
  startedAt     DateTime       @default(now())
  completedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  workflow      Workflow       @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([entityId])
  @@index([entityType])
  @@index([status])
  @@index([currentNodeId])
  @@map("workflow_instances")
}

model KnowledgeCategory {
  id          String              @id @default(cuid())
  name        String
  description String?
  icon        String?
  sortOrder   Int                 @default(0)
  parentId    String?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  articles    KnowledgeArticle[]
  parent      KnowledgeCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    KnowledgeCategory[] @relation("CategoryHierarchy")

  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("knowledge_categories")
}

model KnowledgeArticle {
  id           String              @id @default(cuid())
  title        String
  content      String
  summary      String?
  categoryId   String
  tags         Json?
  attachments  Json?
  viewCount    Int                 @default(0)
  helpfulCount Int                 @default(0)
  authorId     String
  isPublished  Boolean             @default(false)
  publishedAt  DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  author       User                @relation(fields: [authorId], references: [id])
  category     KnowledgeCategory   @relation(fields: [categoryId], references: [id])
  feedbacks    KnowledgeFeedback[]

  @@index([categoryId])
  @@index([isPublished])
  @@index([authorId])
  @@index([createdAt])
  @@map("knowledge_articles")
}

model KnowledgeFeedback {
  id        String           @id @default(cuid())
  articleId String
  userId    String
  isHelpful Boolean
  comment   String?
  createdAt DateTime         @default(now())
  article   KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id])

  @@unique([articleId, userId])
  @@index([articleId])
  @@index([userId])
  @@map("knowledge_feedback")
}

model ConfigCategory {
  id          String         @id @default(cuid())
  code        String         @unique
  name        String
  description String?
  icon        String?
  sortOrder   Int            @default(0)
  isEnabled   Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  configs     SystemConfig[]

  @@index([isEnabled])
  @@index([sortOrder])
  @@map("config_categories")
}

model SystemConfig {
  id           String          @id @default(cuid())
  categoryId   String
  key          String
  value        String
  defaultValue String?
  valueType    ConfigValueType
  label        String
  description  String?
  placeholder  String?
  options      Json?
  validation   Json?
  isSystem     Boolean         @default(false)
  isSecret     Boolean         @default(false)
  sortOrder    Int             @default(0)
  isEnabled    Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  histories    ConfigHistory[]
  category     ConfigCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, key])
  @@index([isEnabled])
  @@index([isSystem])
  @@index([sortOrder])
  @@map("system_configs")
}

model ConfigHistory {
  id           String       @id @default(cuid())
  configId     String
  oldValue     String?
  newValue     String
  changedBy    String
  changeReason String?
  createdAt    DateTime     @default(now())
  user         User         @relation(fields: [changedBy], references: [id])
  config       SystemConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([changedBy])
  @@index([createdAt])
  @@map("config_histories")
}

model SystemLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  level     String
  message   String
  source    String
  createdAt DateTime @default(now())

  @@index([level])
  @@index([timestamp])
  @@map("system_logs")
}

model Backup {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  size      String
  type      String
  status    String

  @@index([createdAt])
  @@map("backups")
}

model EmailSettings {
  id               String   @id @default("default")
  enabled          Boolean  @default(true)
  smtpHost         String   @default("")
  smtpPort         Int      @default(587)
  smtpUser         String   @default("")
  smtpPassword     String   @default("")
  taskReminder     Boolean  @default(true)
  meetingReminder  Boolean  @default(true)
  approvalReminder Boolean  @default(true)
  updatedAt        DateTime @updatedAt

  @@map("email_settings")
}

model SystemSettings {
  id                String   @id @default("default")
  autoBackupEnabled Boolean  @default(false)
  updatedAt         DateTime @updatedAt

  @@map("system_settings")
}

enum UserRole {
  USER
  FACTORY_MANAGER
  DIRECTOR
  MANAGER
  CEO
  ADMIN
  READONLY
  FINANCE
}

enum ApplicationStatus {
  DRAFT
  PENDING_FACTORY
  PENDING_DIRECTOR
  PENDING_MANAGER
  PENDING_CEO
  APPROVED
  REJECTED
  ARCHIVED
  PENDING_REVIEWER
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ReminderType {
  EMAIL
  SMS
  SYSTEM
}

enum ApprovalAction {
  APPROVE
  REJECT
  PENDING
}

enum ApplicationType {
  STANDARD
  PRODUCT_DEVELOPMENT
  FEASIBILITY_STUDY
  BUSINESS_TRIP
  OTHER
}

enum EquipmentStatus {
  RUNNING
  WARNING
  STOPPED
  MAINTENANCE
  SCRAPPED
}

enum MaintenanceType {
  MAINTENANCE
  REPAIR
}

enum MaintenanceRecordStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenancePlanStatus {
  ACTIVE
  WARNING
  OVERDUE
  PAUSED
}

enum MaintenancePlanFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
}

enum MaintenanceTemplateStatus {
  ACTIVE
  DRAFT
  DISABLED
}

enum PartStatus {
  NORMAL
  LOW
  HIGH
  DISCONTINUED
}

enum PartUsageStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum PartScrapStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StockType {
  IN
  OUT
}

enum StockSource {
  PURCHASE
  RETURN
  PRODUCE
  USAGE
  SCRAP
  ADJUST
  OTHER
}

enum PartLifecycleStatus {
  ACTIVE
  WARNING
  CRITICAL
  EXPIRED
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum InterfaceDensity {
  COMPACT
  DEFAULT
  COMFORTABLE
}

enum ProfileVisibility {
  EVERYONE
  COLLEAGUES
  DEPARTMENT
}

enum OnlineStatus {
  VISIBLE
  HIDDEN
}

enum NotificationFrequency {
  INSTANT
  DIGEST
  OFF
}

enum NotificationType {
  APPROVAL
  SYSTEM
  MESSAGE
  TASK
}

enum CalendarEventType {
  MEETING
  TASK
  REMINDER
  LEAVE
  BUSINESS
  OTHER
}

enum AttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum AttendanceStatus {
  NORMAL
  LATE
  EARLY_LEAVE
  ABSENT
  ON_LEAVE
}

enum ClockInType {
  GPS
  WIFI
  MANUAL
}

enum LeaveType {
  ANNUAL
  SICK
  PERSONAL
  MARRIAGE
  MATERNITY
  PATERNITY
  FUNERAL
  OTHER
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MeetingStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum AnnouncementType {
  COMPANY
  DEPARTMENT
  SYSTEM
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkflowStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum InstanceStatus {
  RUNNING
  COMPLETED
  REJECTED
  SUSPENDED
}

enum ConfigValueType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
  PASSWORD
}
